

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>1) Background / Theory &#8212; OHBM Educational Course on Whole-brain Models</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'materials/1_Background_Theory';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="2) Applications 1: Systems/Cognitive" href="2_Systems_Cognitive.html" />
    <link rel="prev" title="Materials" href="../materials.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../abstract.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../abstract.html">
                    Principles and Applications of Whole-brain, Connectome-based Models of Brain Dynamics: An Educational Course
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures.html">Lectures</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../materials.html">Materials</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">1) Background / Theory</a></li>







<li class="toctree-l2"><a class="reference internal" href="2_Systems_Cognitive.html">2) Applications 1: Systems/Cognitive <br/></a></li>










<li class="toctree-l2"><a class="reference internal" href="3_Clinical.html">3) Applications 2: Clinical</a></li>









</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/GriffithsLab/OHBM-whole-brain-modelling-course/blob/master/docs/materials/1_Background_Theory.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/GriffithsLab/OHBM-whole-brain-modelling-course" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/GriffithsLab/OHBM-whole-brain-modelling-course/issues/new?title=Issue%20on%20page%20%2Fmaterials/1_Background_Theory.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/materials/1_Background_Theory.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>1) Background / Theory</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">1) Background / Theory</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#sessions-s-speakers"><strong>Sessions’s Speakers</strong></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#contents">Contents</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction"><strong>Introduction</strong></a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#neural-mass-model-of-local-neural-dynamics">Neural mass model of local neural dynamics</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#available-parameters-are">Available parameters are:</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-plane-analysis"><strong>Phase plane analysis</strong></a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#stability-analysis">Stability analysis</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#network-model-of-whole-brain-anatomical-connectivity">Network model of whole-brain anatomical connectivity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions">Conclusions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-section"><strong>Bonus Section</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Available parameters are:</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <p><em><strong>Dr. Davide Momi</strong></em><br/>
​———–<br/>
Post-Doctoral Research Fellow<br/>
Whole Brain Modelling Group<br/>
Krembil Centre for Neuroinformatics - CAMH<br/>
250 College St., Toronto, ON M5T 1R8<br/>
website: <a class="reference external" href="https://davi1990.github.io/">https://davi1990.github.io/</a><br/>
Twitter: &#64;DaveMomi<br/>
<br/>
<br/>
<em><strong>Sorenza Bastiaens</strong></em><br/>
​———–<br/>
PhD Candidate<br/>
Whole Brain Modelling Group<br/>
Krembil Centre for Neuroinformatics - CAMH<br/>
250 College St., Toronto, ON M5T 1R8<br/>
<br/></p>
<div class="section" id="background-theory">
<h1>1) Background / Theory<a class="headerlink" href="#background-theory" title="Permalink to this heading">#</a></h1>
</div>
<div class="section" id="sessions-s-speakers">
<h1><strong>Sessions’s Speakers</strong><a class="headerlink" href="#sessions-s-speakers" title="Permalink to this heading">#</a></h1>
<p><img alt="alt text" src="https://drive.google.com/uc?id=1fwOHaJ_ia2HSRwLqHB5E4l3Cq_Rhq8YG" /></p>
<hr class="docutils" />
</div>
<div class="section" id="contents">
<h1>Contents<a class="headerlink" href="#contents" title="Permalink to this heading">#</a></h1>
<p><span class="xref myst">Overview</span><br/>
<span class="xref myst">Setup</span><br/>
<span class="xref myst">Neural mass model of local neural dynamics</span><br/>
<span class="xref myst">Network model of whole-brain anatomical connectivity</span><br/>
<span class="xref myst">Conclusions</span><br/>
<span class="xref myst">References</span><br/></p>
</div>
<div class="section" id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">#</a></h1>
<div class="section" id="introduction">
<h2><strong>Introduction</strong><a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p><strong>Whole-brain models</strong> encompass a collection of equations that depict the dynamics and interplay among neural populations across various brain regions.
These models concentrate on the collective development of a set of important biophysical variables through interconnected differential equations systems (although discrete time step models can also be utilized). These equations can be either formulated based on an understanding of the biophysical mechanisms that underlie diverse brain activities (physiological models), or they can be chosen based on the dynamics they generate (phenomenological models). The local dynamics between different regions are then combined with estimates of anatomical connectivity networks obtained from in vivo measurements. Specifically, statistical observables can be defined using fMRI, EEG, and MEG signals, diffusion tensor imaging (DTI) can provide information about the structural connections between brain regions through whole-brain tractography, and positron emission tomography (PET) imaging can provide insights into metabolism and generate receptor density maps for specific neuromodulators.</p>
<p>Most whole-brain models consist of three fundamental components:</p>
<ul class="simple">
<li><p><em>Local dynamics:</em> The activity of each brain region is typically determined by the selected local dynamics along with interaction terms involving other regions (e.g cellular automata, the Ising spin model, autoregressive models, stochastic linear models, non-linear oscillators, neural field theory, neural mass models, and dynamic mean-field models).</p></li>
<li><p><em>Brain parcellation:</em> A brain parcellation determines the number of regions and the spatial resolution at which the brain dynamics occur. This parcellation may include cortical, sub-cortical, and cerebellar regions.</p></li>
<li><p><em>Anatomical connectivity matrix:</em> This matrix defines the network of connections between brain regions. Many studies rely on the human connectome, which is derived by estimating the number of white-matter fibers connecting different brain areas using DTI data combined with probabilistic tractography.</p></li>
</ul>
<p>In this course we will mainly focus on neural mass models with few concepts coming from neural field theory.</p>
<p>In this tutorial we will cover some of the key components involved in computational modelling of mesoscopic, whole-brain network dynamics described.</p>
<p>The paradigm we use for mathematically and computationally describing brain organization is called <b>connectome-based neural mass modelling</b>.
Within this framework, the two main components of setting up a whole brain model are</p>
<ol class="arabic simple">
<li><p><strong>node-level dynamics</strong> <br/></p></li>
<li><p>the large-scale <strong>network topology</strong>.<br/></p></li>
</ol>
<p>We will examine each of these in term, for an exemplary neural mass model and brain network connectivity.</p>
<p>This focus is on <strong>resting</strong> or ‘steady-state’ (as opposed to task- or stimulus-evoked) neural activity, at the relatively <strong>fast timescales</strong> measured by EEG, MEG, ECoG, LFP, etc. (as opposed to slower timescale signals seen in functional MRI).</p>
<p>Demonstrations are done using a combination of pure-python code and simulations run using the <a class="reference external" href="https://thevirtualbrain.org/tvb/zwei"><strong>The Virtual Brain Toolbox (TVB)</strong></a> who has the purpose of offering modern tools to the Neurosciences community, for computing, simulating and analyzing functional and structural data of human brains, brains modeled at the level of population of neurons.</p>
</div>
</div>
<div class="section" id="setup">
<h1>Setup<a class="headerlink" href="#setup" title="Permalink to this heading">#</a></h1>
<p>If you are running this notebook in Google Colab, you will need to install some packages. If you are running in a more standard python environment, you need to ensure that these packages are installed externally (typically with <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">&lt;package&gt;</span></code> on the command line).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="o">!{</span>sys.executable<span class="o">}</span><span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>mne<span class="w"> </span>&gt;<span class="w"> </span>/dev/null
<span class="o">!{</span>sys.executable<span class="o">}</span><span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>nilearn<span class="w"> </span>&gt;<span class="w"> </span>/dev/null
<span class="o">!{</span>sys.executable<span class="o">}</span><span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>nibabel<span class="w"> </span>&gt;<span class="w"> </span>/dev/null
<span class="o">!{</span>sys.executable<span class="o">}</span><span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>tvb-library<span class="w"> </span>&gt;<span class="w"> </span>/dev/null

<span class="kn">import</span> <span class="nn">os</span>
<span class="c1">#os.chdir(&#39;/content/drive/MyDrive&#39;)</span>

<span class="c1"># @title Install dependencies</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The system cannot find the path specified.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The system cannot find the path specified.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The system cannot find the path specified.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The system cannot find the path specified.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">welch</span>

<span class="kn">import</span> <span class="nn">nilearn</span> <span class="k">as</span> <span class="nn">nl</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">cdist</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">mne</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">op</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">welch</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">fsolve</span>
<span class="kn">from</span> <span class="nn">scipy.io</span> <span class="kn">import</span> <span class="n">loadmat</span>
<span class="c1"># Suppress warnings; keeps things cleaner</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># Standard scientific python import commands</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">sys</span><span class="o">,</span><span class="nn">glob</span><span class="o">,</span><span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span><span class="o">,</span><span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span><span class="o">,</span><span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">import</span> <span class="n">GridSpec</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="c1"># TVB stuff</span>
<span class="kn">from</span> <span class="nn">tvb.simulator.lab</span> <span class="kn">import</span> <span class="p">(</span><span class="n">models</span><span class="p">,</span><span class="n">connectivity</span><span class="p">,</span><span class="n">coupling</span><span class="p">,</span><span class="n">integrators</span><span class="p">,</span><span class="n">noise</span><span class="p">,</span><span class="n">simulator</span><span class="p">,</span>
                              <span class="n">surfaces</span><span class="p">,</span><span class="n">region_mapping</span><span class="p">,</span><span class="n">monitors</span><span class="p">,</span><span class="n">equations</span><span class="p">,</span><span class="n">patterns</span><span class="p">,</span><span class="n">plot_pattern</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">nilearn.image</span> <span class="kn">import</span> <span class="n">load_img</span>
<span class="kn">from</span> <span class="nn">nilearn</span> <span class="kn">import</span> <span class="n">plotting</span> <span class="k">as</span> <span class="n">nplot</span>
<span class="kn">from</span> <span class="nn">nilearn</span> <span class="kn">import</span> <span class="n">datasets</span>


<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">tvb.simulator</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">tvb.simulator</span> <span class="kn">import</span> <span class="n">noise</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interactive</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interact</span><span class="p">,</span> <span class="n">FloatSlider</span><span class="p">,</span> <span class="n">interactive_output</span><span class="p">,</span> <span class="n">HBox</span><span class="p">,</span> <span class="n">VBox</span>


<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interactive</span><span class="p">,</span> <span class="n">FloatSlider</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="kn">import</span> <span class="n">Axes3D</span>
<span class="c1"># TVB stuff</span>
<span class="kn">from</span> <span class="nn">tvb.simulator.lab</span> <span class="kn">import</span> <span class="p">(</span><span class="n">models</span><span class="p">,</span><span class="n">connectivity</span><span class="p">,</span><span class="n">coupling</span><span class="p">,</span><span class="n">integrators</span><span class="p">,</span><span class="n">noise</span><span class="p">,</span><span class="n">simulator</span><span class="p">,</span>
                              <span class="n">surfaces</span><span class="p">,</span><span class="n">region_mapping</span><span class="p">,</span><span class="n">monitors</span><span class="p">,</span><span class="n">equations</span><span class="p">,</span><span class="n">patterns</span><span class="p">,</span><span class="n">plot_pattern</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">NormalizeData</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
         <span class="k">return</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>


<span class="kn">from</span> <span class="nn">nilearn</span> <span class="kn">import</span> <span class="n">plotting</span>
<span class="kn">from</span> <span class="nn">tvb.simulator</span> <span class="kn">import</span> <span class="n">noise</span>

<span class="c1"># @title Importage</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">line</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">welch</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="kn">import</span> <span class="nn">nilearn</span> <span class="k">as</span> <span class="nn">nl</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">cdist</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;nilearn&#39;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="neural-mass-model-of-local-neural-dynamics">
<h1>Neural mass model of local neural dynamics<a class="headerlink" href="#neural-mass-model-of-local-neural-dynamics" title="Permalink to this heading">#</a></h1>
<p><a class="reference external" href="https://link.springer.com/article/10.1007/BF00199471"><em>Jansen-Rit (1995)</em></a> is a neural mass model that represents the macroscopic electrophysiological activity within a cortical column. This circuit consists of three interconnected neural populations: one for the pyramidal projection neuron and two for excitatory and inhibitory interneurons, forming two feedback loops.</p>
<p>In the model, each neural population is described with two operators: a rate-to-potential operator describing the dynamics between synapses and dendritic trees, and a potential-to-rate operator representing the output firing rate produced at the soma. The model is thus structured in two steps to describe the populations and capture the dynamics of the circuit.</p>
<p>The first step of the model involves transforming the average pulse density of action potentials received by the population into the average post-synaptic membrane potential. This step is known as the post-synaptic potential block and involves a linear transformation using an impulse response. The impulse response describes the dynamics between the synapses and dendritic trees:
\begin{equation}
h(t)=\alpha \beta te^{-\beta t}    \qquad \text{for t} &gt; 0,
\end{equation}
The variable <span class="math notranslate nohighlight">\(\alpha\)</span> is defined as the maximum amplitude of the postsynaptic potential and <span class="math notranslate nohighlight">\(\beta\)</span> represent a sum of the reciprocal of the time constant of the passive membrane and all other spatially distributed delays present in the dendritic network, condensed into a single lumped term. For the excitatory  populations <span class="math notranslate nohighlight">\(\alpha\)</span>, <span class="math notranslate nohighlight">\(\beta\)</span> correspond to <span class="math notranslate nohighlight">\(A, a\)</span> respectively, and for the inhibitory population <span class="math notranslate nohighlight">\(\alpha\)</span>, <span class="math notranslate nohighlight">\(\beta\)</span> are <span class="math notranslate nohighlight">\(B, b\)</span>.</p>
<p>By convolving the incoming pulse with the impulse response, we can determine the relationship between the pulse rate and the corresponding membrane potential, and express it in the form of a second-order differential equation.</p>
<p>The second step transforms the average membrane potential of the population into the average rate of action potentials fired by the neurons using a non-linear operator, and in this case, a sigmoid:
\begin{equation}
S(v)=\frac{2e_0}{1+e^{r(V_0-v)}}
\end{equation}
with <span class="math notranslate nohighlight">\(e_{0}\)</span> representing the maximum firing rate, <span class="math notranslate nohighlight">\(r\)</span> denoting the variance of firing thresholds, and <span class="math notranslate nohighlight">\(V_{0}\)</span> corresponding to the mean firing threshold.</p>
<p>It is the combination of those two steps that allows the representation of the coarse grained activity of each population in the model. This results in a model with a set of non-linear second-order differential equations that can be re-expressed as sets of first order non-linear ODEs: <br/>
<br/>
\begin{eqnarray}
\dot{y}<em>{0}(t) &amp;=&amp; y</em>{3}(t)\
\dot{y}<em>{3}(t) &amp;=&amp; AaS[y</em>{1}(t)-y_{2}(t)] - 2ay_{3}(t) - a^{2}y_{0}(t)\
\dot{y}<em>{1}(t) &amp;=&amp; y</em>{4}(t)\
\dot{y}<em>{4}(t) &amp;=&amp; Aa(mu(t) + C</em>{2}S[C_{1}y_{0}(t)]) - 2ay_{4}(t) - a^{2}y_{1}(t)\
\dot{y}<em>{2}(t) &amp;=&amp; y</em>{5}(t)\
\dot{y}<em>{5}(t) &amp;=&amp; BbC</em>{4}S[C_{3}y_{0}] - 2by_{5}(t) - b^{2}y_{2}(t)
\end{eqnarray} <br/>
<br/>
with <span class="math notranslate nohighlight">\(mu(t)\)</span> representing the external input to the system, and <span class="math notranslate nohighlight">\(C_i\)</span> to the connectivity parameters (See below for graphical representation).</p>
<p>In summary, the Jansen-Rit model captures the dynamics of a local cortico-cortical circuit through a two-step process. It transforms the incoming pulse density into post-synaptic potentials using an impulse response, and then converts the impulse response into a set of differential equations to describe the neural activity of each population. This model provides insights into the complex interactions within the cortical circuitry and aids in understanding the neural dynamics observed in the brain. The output of the pyramidal postsynaptic potentials (y1-y2) is considered as the equivalent of an EEG signal.</p>
<p><img alt="alt text" src="https://drive.google.com/uc?id=1qBoKEVQi7TCeABtvov6pq_dAu1Ef8-t5" /></p>
<p>First we are gonna see the JR implementation in numpy</p>
<p>\begin{equation}
Sigm(\nu) = \frac{2 \nu_{max}}{1 + \exp^{r(\nu_{0} - \nu)}}
\end{equation}</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># JR Sigmoid function</span>
<span class="k">def</span> <span class="nf">sigm</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>
  <span class="n">action_potential</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">nu_max</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="n">v0</span><span class="o">-</span><span class="n">v</span><span class="p">)))</span>
  <span class="k">return</span> <span class="n">action_potential</span>

<span class="c1"># JR Impulse Response</span>
<span class="k">def</span> <span class="nf">imp_Jansen</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
  <span class="n">Exc</span> <span class="o">=</span> <span class="n">A</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
  <span class="n">Inh</span> <span class="o">=</span> <span class="n">B</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">Exc</span><span class="p">,</span> <span class="n">Inh</span>
<span class="k">def</span> <span class="nf">exc_imp_Jansen</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">A</span><span class="p">):</span>
  <span class="n">Exc</span> <span class="o">=</span> <span class="n">A</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">Exc</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_exc_impulse_response</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="n">t_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
    <span class="n">Exc</span> <span class="o">=</span> <span class="p">[</span><span class="n">exc_imp_Jansen</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_values</span><span class="p">]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>  <span class="c1"># Adjust the figsize to your desired width and height</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_values</span><span class="p">,</span> <span class="n">Exc</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Excitatory Potential&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Impulse Response&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Define the interactive plot</span>
<span class="n">interactive_plot</span> <span class="o">=</span> <span class="n">interactive</span><span class="p">(</span><span class="n">plot_exc_impulse_response</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span> <span class="n">a</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">150</span><span class="p">))</span>

<span class="c1"># Display the interactive plot</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">interactive_plot</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">output</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="s1">&#39;350px&#39;</span>
<span class="n">interactive_plot</span>

<span class="c1"># @title Interactive_plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "6bd9dbbc8ec9474fac8cf3a32da848d2", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interactive</span>

<span class="k">def</span> <span class="nf">plot_sigmoid</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
    <span class="n">v_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">action_potentials</span> <span class="o">=</span> <span class="p">[</span><span class="n">sigm</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">v_values</span><span class="p">]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>  <span class="c1"># Adjust the figsize to your desired width and height</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">v_values</span><span class="p">,</span> <span class="n">action_potentials</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Action Potential&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Sigmoid Function&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Define the interactive plot</span>
<span class="n">interactive_plot</span> <span class="o">=</span> <span class="n">interactive</span><span class="p">(</span><span class="n">plot_sigmoid</span><span class="p">,</span> <span class="n">nu_max</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span> <span class="n">v0</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span> <span class="n">r</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">))</span>

<span class="c1"># Display the interactive plot</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">interactive_plot</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">output</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="s1">&#39;450px&#39;</span>  <span class="c1"># Adjust the height as needed</span>
<span class="n">interactive_plot</span>

<span class="c1"># @title Interactive_plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "6d03420f9a3e4725bdf9bc03efb7ad29", "version_major": 2, "version_minor": 0}</script></div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="available-parameters-are">
<h1>Available parameters are:<a class="headerlink" href="#available-parameters-are" title="Permalink to this heading">#</a></h1>
<p><span class="math notranslate nohighlight">\(A\)</span> = Maximum amplitude of EPSP [mV]. Also called average synaptic gain.</p>
<p><span class="math notranslate nohighlight">\(B\)</span> = Maximum amplitude of IPSP [mV]. Also called average synaptic gain.</p>
<p><span class="math notranslate nohighlight">\(a\)</span> = Reciprocal of the time constant of passive membrane and all other spatially distributed delays in the dendritic network [ms^-1]. Also called average synaptic time constant.</p>
<p><span class="math notranslate nohighlight">\(b\)</span> = Reciprocal of the time constant of passive membrane and all
other spatially distributed delays in the dendritic network [ms^-1].
Also called average synaptic time constant.</p>
<p><span class="math notranslate nohighlight">\(v_0\)</span> = Firing threshold (PSP) for which a 50% firing rate is <a class="reference external" href="http://achieved.In">achieved.In</a> other words, it is the value of the average membrane potential corresponding to the inflection point of the sigmoid [mV]. The usual value for this parameter is 6.0.</p>
<p><span class="math notranslate nohighlight">\(\nu_{max}\)</span> = Determines the maximum firing rate of the neural population [s^-1].</p>
<p><span class="math notranslate nohighlight">\(r\)</span> = Steepness of the sigmoidal transformation [mV^-1].</p>
<p><span class="math notranslate nohighlight">\(J\)</span> = Average number of synapses between populations.</p>
<p><span class="math notranslate nohighlight">\(a_1\)</span> = Average probability of synaptic contacts in the feedback excitatory loop.</p>
<p><span class="math notranslate nohighlight">\(a_2\)</span> = Average probability of synaptic contacts in the slow feedback excitatory loop.</p>
<p><span class="math notranslate nohighlight">\(a_3\)</span> = Average probability of synaptic contacts in the feedback inhibitory loop.</p>
<p><span class="math notranslate nohighlight">\(a_4\)</span> = Average probability of synaptic contacts in the slow feedback inhibitory loop.</p>
<p><span class="math notranslate nohighlight">\(p_{min}\)</span> = Minimum input firing rate.</p>
<p><span class="math notranslate nohighlight">\(p_{max}\)</span> = Maximum input firing rate.</p>
<p><span class="math notranslate nohighlight">\(\mu\)</span> = Mean input firing rate</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Parameter settings</span>
<span class="n">A</span> <span class="o">=</span> <span class="mf">3.25</span>
<span class="n">B</span> <span class="o">=</span> <span class="mi">22</span>
<span class="n">C</span> <span class="o">=</span> <span class="mi">135</span>
<span class="n">C1</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">C</span>
<span class="n">C2</span> <span class="o">=</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">C</span>
<span class="n">C3</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">C</span>
<span class="n">C4</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">C</span>
<span class="n">v0</span> <span class="o">=</span> <span class="mi">6</span>         <span class="c1"># mV</span>
<span class="n">tau_e</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">tau_i</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">tau_e</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span> <span class="c1"># 100        # s^-1</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">tau_i</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span> <span class="c1"># 50         # s^-1</span>
<span class="n">nu_max</span> <span class="o">=</span> <span class="mf">2.5</span>   <span class="c1"># s^-1</span>
<span class="n">r</span> <span class="o">=</span> <span class="mf">0.56</span>       <span class="c1"># mV^-1</span>

<span class="c1"># Simulation setting</span>
<span class="n">start</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">stim_time</span> <span class="o">=</span><span class="mi">10</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="n">time_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stim_time</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
<span class="n">vec_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_array</span><span class="p">)</span>

<span class="c1"># Input</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span><span class="mi">320</span><span class="p">,</span><span class="n">vec_len</span><span class="p">)</span>

<span class="c1"># Output Initialization</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="n">vec_len</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>The equations of the Jansen-Rit model are the following:
\begin{equation}
\dot{y_{0}} = y_{3} \
\dot{y_{3}} = Aa Sigm(y_{1} -  y_{2}) - 2a y_{3} - a^{2} y_{0} \
\dot{y_{1}} = y_{4} \
\dot{y_{4}} = Aa [p(t) + \alpha_2 J Sigm[\alpha_1 J y_0] + lrc + src] -2a y_{4} - a^{2} y_{1}\
\dot{y_{2}} = y_{5} \
\dot{y_5} = Bb (\alpha_4 J Sigm[\alpha_3 J y_{0}]) - 2b y_{5} - b^{2} y_{2} \
\end{equation}</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Euler integration method to solve JR differential equations</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">vec_len</span><span class="p">):</span>
  <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span>
  <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span>
  <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span>
  <span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">sigm</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">r</span><span class="p">,(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
  <span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">noise</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">C2</span><span class="o">*</span><span class="n">sigm</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">r</span><span class="p">,(</span><span class="n">C1</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]))))</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
  <span class="n">y</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">B</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">C4</span><span class="o">*</span><span class="n">sigm</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">r</span><span class="p">,(</span><span class="n">C3</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
<span class="n">freqs_Jansen</span><span class="p">,</span><span class="n">ps_vPN_Jansen</span> <span class="o">=</span> <span class="n">welch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">fs</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">noverlap</span> <span class="o">=</span> <span class="mi">125</span><span class="p">,</span> <span class="n">nperseg</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Figures</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_array</span><span class="p">[</span><span class="mi">20000</span><span class="p">:</span><span class="mi">40000</span><span class="p">],</span><span class="n">output</span><span class="p">[</span><span class="mi">20000</span><span class="p">:</span><span class="mi">40000</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (Hz)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Output ($y_</span><span class="si">{1}</span><span class="s1">-y_</span><span class="si">{2}</span><span class="s1">$)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Power (A.U.)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freqs_Jansen</span><span class="p">,</span><span class="n">ps_vPN_Jansen</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x7ee1d2140a30&gt;]
</pre></div>
</div>
<img alt="../_images/49bcffa7d0a952da712ba11674b6c3e8b8c02c8b53bab04b66fd781b3f35444e.png" src="../_images/49bcffa7d0a952da712ba11674b6c3e8b8c02c8b53bab04b66fd781b3f35444e.png" />
</div>
</div>
<p>This can also be performed by tvb…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run JR single node in TVB</span>

<span class="n">n_step</span> <span class="o">=</span> <span class="mi">50000</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="c1"># Define initial conditions</span>
<span class="n">initconds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">4.</span><span class="p">,</span><span class="o">-</span><span class="mf">4.</span><span class="p">,</span><span class="o">-</span><span class="mf">4.</span><span class="p">,</span><span class="o">-</span><span class="mf">4.</span><span class="p">,</span><span class="o">-</span><span class="mf">4.</span><span class="p">,</span><span class="o">-</span><span class="mf">4.</span><span class="p">])[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

<span class="c1"># fixed params for these examples : oscillatory</span>
<span class="n">a</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">])</span><span class="c1">#[0.029])</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.22</span><span class="p">])</span><span class="c1">#0.1085])</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.05</span><span class="p">])</span>
<span class="c1"># Initialize model instance with fixed params</span>
<span class="n">mod</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">JansenRit</span><span class="p">(</span><span class="n">v0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">6.</span><span class="p">]),</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">p_max</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">p_min</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span>
                       <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span><span class="n">a</span><span class="p">)</span>

<span class="c1"># Execute single-node simulation run</span>
<span class="n">time</span><span class="p">,</span><span class="n">dat</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">stationary_trajectory</span><span class="p">(</span><span class="n">n_step</span><span class="o">=</span><span class="n">n_step</span><span class="p">,</span><span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
<span class="n">y_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:,:])</span>
<span class="n">y_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:,:])</span>
<span class="n">y_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dat</span><span class="p">[:,</span><span class="mi">2</span><span class="p">,:,:])</span>


<span class="n">freqs_Jansen_tvb</span><span class="p">,</span><span class="n">ps_vPN_Jansen_tvb</span> <span class="o">=</span> <span class="n">welch</span><span class="p">((</span><span class="n">y_1</span><span class="o">-</span><span class="n">y_2</span><span class="p">)[</span><span class="mi">1000</span><span class="p">:],</span><span class="n">fs</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">noverlap</span> <span class="o">=</span> <span class="mi">125</span><span class="p">,</span> <span class="n">nperseg</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Figures</span>


<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">1000</span><span class="p">:</span><span class="mi">2000</span><span class="p">],(</span><span class="n">y_1</span><span class="o">-</span><span class="n">y_2</span><span class="p">)[</span><span class="mi">1000</span><span class="p">:</span><span class="mi">2000</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (ms)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (Hz)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Output ($y_</span><span class="si">{1}</span><span class="s1">-y_</span><span class="si">{2}</span><span class="s1">$)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Power (A.U.)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freqs_Jansen_tvb</span><span class="p">,</span><span class="n">ps_vPN_Jansen_tvb</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x7ee1d634d780&gt;]
</pre></div>
</div>
<img alt="../_images/610766475ece4329a9bdbb5db4b9f504caa9b5b98e479fe0f9a5e2ba152eba11.png" src="../_images/610766475ece4329a9bdbb5db4b9f504caa9b5b98e479fe0f9a5e2ba152eba11.png" />
</div>
</div>
<p>In the following code cell, we will explore the impact of different values of <span class="math notranslate nohighlight">\(mu\)</span> (representing noise/external input) on the output of the single node model we previously created. We will focus specifically on sliding the <span class="math notranslate nohighlight">\(mu\)</span> parameter and observe how it affects the generation of alpha oscillations, with the original optimal value of 0.22 as a reference (<a class="reference external" href="https://pubmed.ncbi.nlm.nih.gov/7578475/">Jansen &amp; Rit 1995</a>)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the parameter range for bifurcation diagram</span>
<span class="n">mu_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">simulate_and_plot</span><span class="p">(</span><span class="n">mu</span><span class="p">):</span>
    <span class="c1"># Run JR single node in TVB</span>
    <span class="n">n_step</span> <span class="o">=</span> <span class="mi">50000</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="c1"># Define initial conditions</span>
    <span class="n">initconds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">4.</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.</span><span class="p">])[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

    <span class="c1"># fixed params for these examples: oscillatory</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">])</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.05</span><span class="p">])</span>

    <span class="c1"># Initialize model instance with variable mu</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">JansenRit</span><span class="p">(</span><span class="n">v0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">6.</span><span class="p">]),</span> <span class="n">mu</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mu</span><span class="p">]),</span> <span class="n">p_max</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mu</span><span class="p">]),</span>
                           <span class="n">p_min</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mu</span><span class="p">]),</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">)</span>

    <span class="c1"># Execute single-node simulation run</span>
    <span class="n">time</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">stationary_trajectory</span><span class="p">(</span><span class="n">n_step</span><span class="o">=</span><span class="n">n_step</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">y_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dat</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
    <span class="n">y_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dat</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
    <span class="n">y_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dat</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>

    <span class="n">freqs_Jansen_tvb</span><span class="p">,</span> <span class="n">ps_vPN_Jansen_tvb</span> <span class="o">=</span> <span class="n">welch</span><span class="p">((</span><span class="n">y_1</span> <span class="o">-</span> <span class="n">y_2</span><span class="p">)[</span><span class="mi">1000</span><span class="p">:],</span> <span class="n">fs</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">noverlap</span><span class="o">=</span><span class="mi">125</span><span class="p">,</span> <span class="n">nperseg</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">1000</span><span class="p">:</span><span class="mi">2000</span><span class="p">],</span> <span class="p">(</span><span class="n">y_1</span> <span class="o">-</span> <span class="n">y_2</span><span class="p">)[</span><span class="mi">1000</span><span class="p">:</span><span class="mi">2000</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (ms)&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (Hz)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Output ($y_</span><span class="si">{1}</span><span class="s1">-y_</span><span class="si">{2}</span><span class="s1">$)&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Power (A.U.)&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freqs_Jansen_tvb</span><span class="p">,</span> <span class="n">ps_vPN_Jansen_tvb</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">();</span>

<span class="c1"># Create an interactive slider for the parameter mu</span>
<span class="n">mu_slider</span> <span class="o">=</span> <span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;mu&#39;</span><span class="p">)</span>

<span class="c1"># Define the interactive function</span>
<span class="n">interactive_plot</span> <span class="o">=</span> <span class="n">interactive</span><span class="p">(</span><span class="n">simulate_and_plot</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu_slider</span><span class="p">)</span>

<span class="c1"># Display the interactive plot</span>
<span class="n">interactive_plot</span>

<span class="c1"># @title Interactive_plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "3a3d281e0a7b47768100344d2f214c95", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="section" id="phase-plane-analysis">
<h2><strong>Phase plane analysis</strong><a class="headerlink" href="#phase-plane-analysis" title="Permalink to this heading">#</a></h2>
<p>So far, we have plotted the activities of the two populations as a function of time, i.e., in the <code class="docutils literal notranslate"><span class="pre">Activity-t</span></code> plane, either the <span class="math notranslate nohighlight">\((t, y_1(t)-y_2(t))\)</span>. We also have plotted the corresponding time-frequency representation of this time-wise activity using <code class="docutils literal notranslate"><span class="pre">welch</span></code> decomposition.</p>
<p>Now instead, we can plot the two activities <span class="math notranslate nohighlight">\(y_0(t)\)</span>,  <span class="math notranslate nohighlight">\(y_1(t)\)</span> and <span class="math notranslate nohighlight">\(y_2(t)\)</span> against each other at any time point <span class="math notranslate nohighlight">\(t\)</span>. This characterization in the <code class="docutils literal notranslate"><span class="pre">y_0-y_1-y_2</span></code> plane <span class="math notranslate nohighlight">\((y_0(t), y_1(t), y_2(t))\)</span> is called the <strong>phase plane</strong>. Each line in the phase plane indicates how <span class="math notranslate nohighlight">\(y_0\)</span>, <span class="math notranslate nohighlight">\(y_1\)</span> and <span class="math notranslate nohighlight">\(y_2\)</span> evolve with time.</p>
<p>For example, we can visualize how these trajectories changes depending on the variables used. To illustrate that, we present here how the evolution of the variables can change when the connectivity parameter between the pyramidal cells and the inhibitory interneurons is different.</p>
<p>When a variable parameter changes, the dynamics are affected. For example, in the cell below we are going to explore how varying the noise/external input <span class="math notranslate nohighlight">\(mu\)</span> will affect the system dynamics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Parameter settings</span>
<span class="n">A</span> <span class="o">=</span> <span class="mf">3.25</span>
<span class="n">B</span> <span class="o">=</span> <span class="mi">22</span>
<span class="n">C</span> <span class="o">=</span> <span class="mi">135</span>
<span class="n">C1</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">C</span>
<span class="n">C2</span> <span class="o">=</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">C</span>
<span class="n">C3</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">C</span>
<span class="n">C4</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">C</span>
<span class="n">v0</span> <span class="o">=</span> <span class="mi">6</span>         <span class="c1"># mV</span>
<span class="n">tau_e</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">tau_i</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">tau_e</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span> <span class="c1"># 100        # s^-1</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">tau_i</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span> <span class="c1"># 50         # s^-1</span>
<span class="n">nu_max</span> <span class="o">=</span> <span class="mf">2.5</span>   <span class="c1"># s^-1</span>
<span class="n">r</span> <span class="o">=</span> <span class="mf">0.56</span>       <span class="c1"># mV^-1</span>

<span class="c1"># Simulation setting</span>
<span class="n">start</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">stim_time</span> <span class="o">=</span><span class="mi">10</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="n">time_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stim_time</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
<span class="n">vec_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_array</span><span class="p">)</span>

<span class="c1"># For simplicity, we set the noise as a constant</span>
<span class="n">mu</span>  <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">120</span><span class="p">]</span>

<span class="c1"># Output Initialization</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="n">vec_len</span><span class="p">))</span>
<span class="n">res_y0</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">res_y1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">res_y2</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Euler integration method to solve JR differential equations</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)):</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">vec_len</span><span class="p">):</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">sigm</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">r</span><span class="p">,(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">C2</span><span class="o">*</span><span class="n">sigm</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">r</span><span class="p">,(</span><span class="n">C1</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]))))</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">B</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">C4</span><span class="o">*</span><span class="n">sigm</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">r</span><span class="p">,(</span><span class="n">C3</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
  <span class="n">res_y0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
  <span class="n">res_y1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
  <span class="n">res_y2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

<span class="c1"># Create the 3D plot</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="c1"># Create the figure and subplots</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="c1"># First subplot</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">res_y0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res_y1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res_y2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="c1"># Set labels and title</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$y_0$&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$y_1$&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;$y_2$&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;$mu=100$&#39;</span><span class="p">)</span>

<span class="c1"># Second subplot</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">res_y0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">res_y1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">res_y2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="c1"># Set labels and title</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$y_0$&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$y_1$&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;$y_2$&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;$mu=220$&#39;</span><span class="p">)</span>


<span class="c1"># Third subplot</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">res_y0</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">res_y1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">res_y2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="c1"># Set labels and title</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$y_0$&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$y_1$&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;$y_2$&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;$mu=120$&#39;</span><span class="p">)</span>

<span class="c1"># Show the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/75c76b913e3f7541d016809945eb974371faf97c43a634cb1754cb5fb49a0806.png" src="../_images/75c76b913e3f7541d016809945eb974371faf97c43a634cb1754cb5fb49a0806.png" />
</div>
</div>
<p>In the first plot (left side), the system initially exhibits a single impulse and then converges to a stable point. Once the equilibrium or stable fixed point is reached, the system remains at that value. By increasing the value of <span class="math notranslate nohighlight">\(mu\)</span> (representing noise/external input), the system undergoes a transition. Beyond a certain threshold, the system starts to exhibit oscillatory behavior with varying frequencies. These oscillations become larger and longer in duration, as seen in the central and right plots, respectively. Similar changes in dynamics can be observed by altering the input term.</p>
<p>The key question is: how can we understand and predict these dynamics? To answer this question, we employ stability and bifurcation analysis. These analytical techniques help us examine the stability of equilibrium points and understand how the system’s behavior changes as the parameters, such as mu, are varied.</p>
<p>The same plots can be realized by varying the <span class="math notranslate nohighlight">\(C3\)</span> and <span class="math notranslate nohighlight">\(C4\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Parameter settings</span>
<span class="n">A</span> <span class="o">=</span> <span class="mf">3.25</span>
<span class="n">B</span> <span class="o">=</span> <span class="mi">22</span>
<span class="n">C</span> <span class="o">=</span> <span class="mi">135</span>
<span class="n">C1</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">C</span>
<span class="n">C2</span> <span class="o">=</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">C</span>
<span class="n">C3</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.2</span><span class="o">*</span><span class="n">C</span><span class="p">,</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">C</span><span class="p">,</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">C</span><span class="p">]</span>
<span class="n">C4</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.2</span><span class="o">*</span><span class="n">C</span><span class="p">,</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">C</span><span class="p">,</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">C</span><span class="p">]</span>
<span class="n">v0</span> <span class="o">=</span> <span class="mi">6</span>         <span class="c1"># mV</span>
<span class="n">tau_e</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">tau_i</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">tau_e</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span> <span class="c1"># 100        # s^-1</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">tau_i</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span> <span class="c1"># 50         # s^-1</span>
<span class="n">nu_max</span> <span class="o">=</span> <span class="mf">2.5</span>   <span class="c1"># s^-1</span>
<span class="n">r</span> <span class="o">=</span> <span class="mf">0.56</span>       <span class="c1"># mV^-1</span>

<span class="c1"># Simulation setting</span>
<span class="n">start</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">stim_time</span> <span class="o">=</span><span class="mi">10</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="n">time_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stim_time</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
<span class="n">vec_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_array</span><span class="p">)</span>

<span class="c1"># Input</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span><span class="mi">320</span><span class="p">,</span><span class="n">vec_len</span><span class="p">)</span>

<span class="c1"># Output Initialization</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="n">vec_len</span><span class="p">))</span>
<span class="n">res_y0</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">res_y1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">res_y2</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Euler integration method to solve JR differential equations</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">C3</span><span class="p">)):</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">vec_len</span><span class="p">):</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">sigm</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">r</span><span class="p">,(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">noise</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">C2</span><span class="o">*</span><span class="n">sigm</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">r</span><span class="p">,(</span><span class="n">C1</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]))))</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">B</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">C4</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">sigm</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">r</span><span class="p">,(</span><span class="n">C3</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
  <span class="n">res_y0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
  <span class="n">res_y1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
  <span class="n">res_y2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

<span class="c1"># Create the 3D plot</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="c1"># Create the figure and subplots</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="c1"># First subplot</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">res_y0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res_y1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res_y2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="c1"># Set labels and title</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$y_0$&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$y_1$&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;$y_2$&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;$C_{3,4} = 27$&#39;</span><span class="p">)</span>

<span class="c1"># Second subplot</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">res_y0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">res_y1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">res_y2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="c1"># Set labels and title</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$y_0$&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$y_1$&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;$y_2$&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;$C_{3,4} = 33.75$&#39;</span><span class="p">)</span>


<span class="c1"># Third subplot</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">res_y0</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">res_y1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">res_y2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="c1"># Set labels and title</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$y_0$&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$y_1$&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;$y_2$&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;$C_{3,4} = 40.5$&#39;</span><span class="p">)</span>

<span class="c1"># Show the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/41f6f02a844eddb3eb610afd876abe7c42fae794f0934451c00364919dd6348a.png" src="../_images/41f6f02a844eddb3eb610afd876abe7c42fae794f0934451c00364919dd6348a.png" />
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="stability-analysis">
<h1>Stability analysis<a class="headerlink" href="#stability-analysis" title="Permalink to this heading">#</a></h1>
<p>For this part we are going to go through the stability analysis of the system as a function of the input <span class="math notranslate nohighlight">\(mu\)</span> which a detailed analysis is also shown in “Bifurcation Analysis of Jansen’s Neural Mass Model” by François Grimbert, Olivier Faugeras (<a class="reference external" href="https://pubmed.ncbi.nlm.nih.gov/17052158/">https://pubmed.ncbi.nlm.nih.gov/17052158/</a>).</p>
<p>We can get an idea of the effect of <span class="math notranslate nohighlight">\(mu\)</span> by looking at <span class="math notranslate nohighlight">\(y_{1}-y_{2}\)</span> (voltage contribution) against <span class="math notranslate nohighlight">\(y_{4}-y_{5}\)</span> (current contribution) as a function of <span class="math notranslate nohighlight">\(mu\)</span></p>
<p><img alt="alt text" src="https://image2.slideserve.com/3898122/neural-mass-model-l.jpg" /></p>
<p>It seems like for <span class="math notranslate nohighlight">\(mu &lt; 100\)</span> and <span class="math notranslate nohighlight">\(mu\)</span> between 400 and 500 we start to see a decrease or no oscillations. Mathematically, to determine the dynamics of the system, we fist need to determine the <strong>fixed points</strong>, which refers to the states of the system where the derivative or rate of change is zero. In other words, at a fixed point, the system remains unchanged over time. Therefore we have:<br/>
<br/>
\begin{eqnarray}
0 &amp;=&amp; y_{3} \
0 &amp;=&amp; Aa Sigm(y_{1} -  y_{2}) - 2a * 0 - a^{2} y_{0} \
0 &amp;=&amp; y_{4} \
0 &amp;=&amp; Aa [mu(t) + C_{2}Sigm[C_{1} y_0]] -2a* 0 - a^{2} y_{1}\
0 &amp;=&amp; y_{5} \
0 &amp;=&amp; Bb (C_{4} Sigm[C_{3} J y_{0}]) - 2b*0 - b^{2} y_{2} \
\end{eqnarray}<br/>
<br/>
After rearraging the equations, defining <span class="math notranslate nohighlight">\(y_{0}\)</span>,<span class="math notranslate nohighlight">\(y_{1}\)</span>, and <span class="math notranslate nohighlight">\(y_{2}\)</span> by moving it to the left hand side, and setting <span class="math notranslate nohighlight">\(y = y_{1} - y_{2}\)</span>, we have:<br/>
<br/>
\begin{equation}
y =  \frac{A}{a}mu+\frac{A}{a}C_{2}S(\frac{A}{a}C_{1}S(y)) - \frac{B}{b}C_{4}S(\frac{A}{a}C_{3}S(y))
\end{equation}<br/>
<br/>
The fixed points (or equilibrium points) are then defined by solving this equation for the different p values. This can be done by determining the point of intersection between the two sides of the equation for each <span class="math notranslate nohighlight">\(mu\)</span> value:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">A</span> <span class="o">=</span> <span class="mf">3.25</span>
<span class="n">B</span> <span class="o">=</span> <span class="mi">22</span>
<span class="n">C</span> <span class="o">=</span> <span class="mi">135</span>
<span class="n">c1</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">C</span>
<span class="n">c2</span> <span class="o">=</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">C</span>  <span class="c1">#0.8</span>
<span class="n">c3</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">C</span>
<span class="n">c4</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">C</span>
<span class="n">v0</span> <span class="o">=</span> <span class="mi">6</span>         <span class="c1"># mV</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">100</span>        <span class="c1"># s^-1</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">50</span>         <span class="c1"># s^-1</span>
<span class="n">nu_max</span> <span class="o">=</span> <span class="mf">2.5</span>   <span class="c1"># s^-1</span>
<span class="n">r</span> <span class="o">=</span> <span class="mf">0.56</span>       <span class="c1"># mV^-1</span>
<span class="n">divA</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="o">/</span><span class="n">a</span><span class="p">)</span>
<span class="n">divB</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span><span class="o">/</span><span class="n">b</span><span class="p">)</span>
<span class="n">mu_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span><span class="mi">400</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mu_all</span><span class="p">))</span>

<span class="n">final_res</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">mu</span> <span class="ow">in</span> <span class="n">mu_all</span><span class="p">:</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mf">0.0001</span><span class="p">)</span>
  <span class="n">y1</span> <span class="o">=</span> <span class="n">x</span>
  <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="n">divA</span><span class="o">*</span><span class="n">mu</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">divA</span><span class="o">*</span><span class="n">c2</span><span class="o">*</span><span class="n">sigm</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span>  <span class="n">r</span><span class="p">,</span> <span class="n">divA</span><span class="o">*</span><span class="n">c1</span><span class="o">*</span><span class="n">sigm</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span>  <span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">)))</span> <span class="o">-</span> <span class="p">(</span><span class="n">divB</span><span class="o">*</span><span class="n">c4</span><span class="o">*</span><span class="n">sigm</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span>  <span class="n">r</span><span class="p">,</span> <span class="n">divA</span><span class="o">*</span><span class="n">c3</span><span class="o">*</span><span class="n">sigm</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span>  <span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">)))</span>
  <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
  <span class="n">final_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

<span class="n">new_values</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">final_res</span><span class="p">)):</span>
  <span class="n">new_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y1</span><span class="p">[</span><span class="n">final_res</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>

<span class="n">w</span> <span class="o">=</span> <span class="p">[[</span><span class="n">mu_all</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_values</span><span class="p">))]</span>

<span class="n">x_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">w</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
<span class="n">y_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">new_values</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_to_plot</span><span class="p">,</span> <span class="n">y_to_plot</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;mu - (Hrz)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$y_</span><span class="si">{1}</span><span class="s1"> - y_</span><span class="si">{2}</span><span class="s1">$ - fix points (mV)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$y_{1} - y_{2}$ - fix points (mV)&#39;)
</pre></div>
</div>
<img alt="../_images/e752c7dade3143589c9158039dd99456c7c02324d536fedc17270e8f882d1074.png" src="../_images/e752c7dade3143589c9158039dd99456c7c02324d536fedc17270e8f882d1074.png" />
</div>
</div>
<p>Now that we have the fixed points, we continue the local linear stability analysis by linearzing the dynamics around the fixed points and calculating the Jacobian matrix to study the behavior of the system around the fixed points (thus the name local stability analysis). This is achieved by looking at the eigenvalues of the Jacobian matrix. A fixed point is said to be stable if all the eigenvalues have a negative real part, and unstable if some of the eigenvalues have a positive real part.</p>
<p>In a nutshell:</p>
<ul class="simple">
<li><p>a fix point is STABLE if the first eigenvalues real part &lt; 0</p></li>
<li><p>a fix point is UNSTABLE if the first eigenval real part &gt; 0</p></li>
<li><p>a fix point is critical if one of the eigenval real part = 0 (or close)</p></li>
</ul>
<p>NOTE: if the first eigenvalue has an immaginary part the system is oscillating</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">differentiate_sigmoid</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span>  <span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="n">ds_dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">nu_max</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="n">v0</span><span class="o">-</span><span class="n">x</span><span class="p">))))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="n">v0</span><span class="o">-</span><span class="n">x</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span>
  <span class="k">return</span> <span class="n">ds_dx</span>

<span class="n">un</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">stability</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">new_values</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">me</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">new_values</span><span class="p">[</span><span class="n">j</span><span class="p">])):</span>
      <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
      <span class="n">fix_point</span> <span class="o">=</span> <span class="n">new_values</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">me</span><span class="p">]</span>
      <span class="n">first_coordinate</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">sigm</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">fix_point</span><span class="p">)</span>
      <span class="n">J</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">J</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">J</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span>
      <span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">differentiate_sigmoid</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">fix_point</span><span class="p">)</span>
      <span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">A</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">differentiate_sigmoid</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">fix_point</span><span class="p">)</span>
      <span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span>
      <span class="n">J</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">c2</span><span class="o">*</span><span class="n">c1</span><span class="p">)</span><span class="o">*</span><span class="n">differentiate_sigmoid</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c1</span><span class="o">*</span><span class="n">first_coordinate</span><span class="p">)</span>
      <span class="n">J</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span>
      <span class="c1">#J[4, 3] = -2*a</span>
      <span class="n">J</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span>
      <span class="n">J</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">B</span><span class="o">*</span><span class="n">c4</span><span class="o">*</span><span class="n">c3</span><span class="p">)</span><span class="o">*</span><span class="n">differentiate_sigmoid</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c3</span><span class="o">*</span><span class="n">first_coordinate</span><span class="p">)</span>
      <span class="n">J</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span>
      <span class="n">J</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span>
      <span class="n">evals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvals</span><span class="p">(</span><span class="n">J</span><span class="p">)</span>
      <span class="n">evals</span>
      <span class="n">stability_per</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">evals</span><span class="p">))</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">evals</span><span class="p">)):</span>
        <span class="n">real_part</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">evals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">real_part</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">un</span> <span class="o">=</span> <span class="mi">1</span>
          <span class="n">stability_per</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span><span class="n">un</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">un</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="n">stability_per</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">un</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_values</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
      <span class="k">if</span> <span class="n">stability_per</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">stability</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="n">w</span> <span class="o">=</span> <span class="p">[[</span><span class="n">mu_all</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_values</span><span class="p">))]</span>
<span class="n">index_unstable</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stability</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>

<span class="n">x_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">w</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
<span class="n">y_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">new_values</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
<span class="n">x_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_to_plot</span><span class="p">)</span>
<span class="n">y_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_to_plot</span><span class="p">)</span>
<span class="n">x_array</span><span class="p">[</span><span class="n">index_unstable</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_to_plot</span><span class="p">,</span> <span class="n">y_to_plot</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;stable&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_array</span><span class="p">[</span><span class="n">index_unstable</span><span class="p">],</span> <span class="n">y_array</span><span class="p">[</span><span class="n">index_unstable</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;unstable&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;mu - (Hrz)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$y_</span><span class="si">{1}</span><span class="s1"> - y_</span><span class="si">{2}</span><span class="s1">$ - fix points (mV)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$y_{1} - y_{2}$ - fix points (mV)&#39;)
</pre></div>
</div>
<img alt="../_images/6a63d26b8508f6eacd3fcbfe5b101b32752287cd4fe03872d726d74777a45381.png" src="../_images/6a63d26b8508f6eacd3fcbfe5b101b32752287cd4fe03872d726d74777a45381.png" />
</div>
</div>
<p>Every time the system changes stability, we have a transition point where the Jacobian matrix has eigenvalues with zero real part. After having a closer look at the eigenvalues of those transition points, further information can be gathered. In this case, on the upper unstable section (between 90 and 315 approx). at the transition points, the fixed point has two complex conjugate eigenvalues which cross the imaginary axis (first towards positive real part around 90 and then towards negative real parts around 315). This corresponds to what is called two Hopf bifurcation within which the system exhibits oscillatory behavior. For lower values of p, the system is bistable with three fixed points, and depending on the initial conditions, will tend to reach one of the stable fixed points (Further information and analaysis can be found at: <a class="reference external" href="https://pubmed.ncbi.nlm.nih.gov/17052158/">https://pubmed.ncbi.nlm.nih.gov/17052158/</a>)</p>
<p>These fixed points can now be added to the phase-plane plots seen previously:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Parameter settings</span>
<span class="n">A</span> <span class="o">=</span> <span class="mf">3.25</span>
<span class="n">B</span> <span class="o">=</span> <span class="mi">22</span>
<span class="n">C</span> <span class="o">=</span> <span class="mi">135</span>
<span class="n">C1</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">C</span>
<span class="n">C2</span> <span class="o">=</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">C</span>
<span class="n">C3</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">C</span>
<span class="n">C4</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">C</span>
<span class="n">v0</span> <span class="o">=</span> <span class="mi">6</span>         <span class="c1"># mV</span>
<span class="n">tau_e</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">tau_i</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">tau_e</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span> <span class="c1"># 100        # s^-1</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">tau_i</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span> <span class="c1"># 50         # s^-1</span>
<span class="n">nu_max</span> <span class="o">=</span> <span class="mf">2.5</span>   <span class="c1"># s^-1</span>
<span class="n">r</span> <span class="o">=</span> <span class="mf">0.56</span>       <span class="c1"># mV^-1</span>

<span class="c1"># Simulation setting</span>
<span class="n">start</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">stim_time</span> <span class="o">=</span><span class="mi">10</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="n">time_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stim_time</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
<span class="n">vec_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_array</span><span class="p">)</span>

<span class="c1"># For simplicity, we set p as a constant</span>
<span class="n">mu</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">120</span><span class="p">]</span>

<span class="c1"># Output Initialization</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="n">vec_len</span><span class="p">))</span>
<span class="n">res_y0</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">res_y1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">res_y2</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">y0coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">y1coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">y2coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>

<span class="c1"># Euler integration method to solve JR differential equations</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)):</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">vec_len</span><span class="p">):</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">sigm</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">r</span><span class="p">,(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">C2</span><span class="o">*</span><span class="n">sigm</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">r</span><span class="p">,(</span><span class="n">C1</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]))))</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">B</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">C4</span><span class="o">*</span><span class="n">sigm</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">r</span><span class="p">,(</span><span class="n">C3</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
  <span class="n">res_y0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
  <span class="n">res_y1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
  <span class="n">res_y2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

  <span class="n">value</span> <span class="o">=</span> <span class="n">mu</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
  <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_to_plot</span><span class="p">)</span> <span class="k">if</span> <span class="n">element</span> <span class="o">==</span> <span class="n">value</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">y_array</span><span class="p">[</span><span class="n">indices</span><span class="p">])):</span>
    <span class="n">y0coord</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">sigm</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">y_array</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">h</span><span class="p">]])</span>
    <span class="n">y1coord</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span> <span class="n">C2</span><span class="o">*</span><span class="n">sigm</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">C1</span><span class="o">*</span><span class="n">y0coord</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">h</span><span class="p">]))</span>
    <span class="n">y2coord</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span><span class="o">/</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">C4</span><span class="o">*</span><span class="n">sigm</span><span class="p">(</span><span class="n">nu_max</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">C3</span><span class="o">*</span><span class="n">y0coord</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">h</span><span class="p">]))</span>


<span class="c1"># Create the figure and subplots using GridSpec</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>

<span class="c1"># First row of subplots</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">C</span> <span class="o">*</span> <span class="n">res_y0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res_y1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res_y2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">C</span> <span class="o">*</span> <span class="n">y0coord</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">y1coord</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">y2coord</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$y_0$&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$y_1$&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;$y_2$&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;$\mu=50$&#39;</span><span class="p">)</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">C</span> <span class="o">*</span> <span class="n">res_y0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">res_y1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">res_y2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">C</span> <span class="o">*</span> <span class="n">y0coord</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y1coord</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y2coord</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$y_0$&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$y_1$&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;$y_2$&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;$\mu=220$&#39;</span><span class="p">)</span>

<span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">C</span> <span class="o">*</span> <span class="n">res_y0</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">res_y1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">res_y2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">C</span> <span class="o">*</span> <span class="n">y0coord</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y1coord</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y2coord</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$y_0$&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$y_1$&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;$y_2$&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;$\mu=120$&#39;</span><span class="p">)</span>

<span class="c1"># Second row of subplots</span>
<span class="n">ax4</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">res_y1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4000</span><span class="p">:</span><span class="mi">13000</span><span class="p">]</span> <span class="o">-</span> <span class="n">res_y2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4000</span><span class="p">:</span><span class="mi">13000</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Difference&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;$\mu=50$&#39;</span><span class="p">)</span>

<span class="n">ax5</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">res_y1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">4000</span><span class="p">:</span><span class="mi">13000</span><span class="p">]</span> <span class="o">-</span> <span class="n">res_y2</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">4000</span><span class="p">:</span><span class="mi">13000</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Difference&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;$\mu=220$&#39;</span><span class="p">)</span>

<span class="n">ax6</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">res_y1</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">4000</span><span class="p">:</span><span class="mi">13000</span><span class="p">]</span> <span class="o">-</span> <span class="n">res_y2</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">4000</span><span class="p">:</span><span class="mi">13000</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Difference&#39;</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;$\mu=120$&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/504c400ed37398bcb7ae8933724fcb48231abb3915f9ee6a3f0078081331543b.png" src="../_images/504c400ed37398bcb7ae8933724fcb48231abb3915f9ee6a3f0078081331543b.png" />
</div>
</div>
<div class="section" id="network-model-of-whole-brain-anatomical-connectivity">
<h2>Network model of whole-brain anatomical connectivity<a class="headerlink" href="#network-model-of-whole-brain-anatomical-connectivity" title="Permalink to this heading">#</a></h2>
<p>Having gained an understanding of single node modeling and its impact on system dynamics with different parameter configurations, we can now expand our analysis to the whole-brain level at a macro-scale. We will divide the brain into sub-regions and apply the Jansen and Ritt Model to each region. The connectivity between each node will be modeled using structural connectome data derived from Diffusion Weighted Imaging data.<br/>
<br/>
<em><strong>Parcellation</strong></em> <br/>
For this tutorial we’ll be using the Schaefer et al. 2018. This atlas was generated from fMRI data from 1000 healthy control participants. Speicifically we will be using the 200 parcels and 7 Network version of this atlas.</p>
<p><img alt="alt text" src="https://pbs.twimg.com/media/Dz2u7WCU8AIxNJ4?format=jpg&amp;name=large" /></p>
<p>To retrieve the Schaefer atlas we’ll use the <code class="docutils literal notranslate"><span class="pre">fetch_atlas_*</span></code> family of functions provided for by nilearn.datasets and download it into a local directory</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>mkdir<span class="w"> </span>rois
<span class="n">parcel_dir</span> <span class="o">=</span> <span class="s1">&#39;./rois/&#39;</span>
<span class="n">atlas_schaefer_2018</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">fetch_atlas_schaefer_2018</span><span class="p">(</span><span class="n">n_rois</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                                                         <span class="n">yeo_networks</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                                                         <span class="n">resolution_mm</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                                         <span class="n">data_dir</span><span class="o">=</span><span class="n">parcel_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dataset created in ./rois/schaefer_2018

Downloading data from https://raw.githubusercontent.com/ThomasYeoLab/CBIG/v0.14.3-Update_Yeo2011_Schaefer2018_labelname/stable_projects/brain_parcellation/Schaefer2018_LocalGlobal/Parcellations/MNI/Schaefer2018_200Parcels_7Networks_order.txt ...
Downloading data from https://raw.githubusercontent.com/ThomasYeoLab/CBIG/v0.14.3-Update_Yeo2011_Schaefer2018_labelname/stable_projects/brain_parcellation/Schaefer2018_LocalGlobal/Parcellations/MNI/Schaefer2018_200Parcels_7Networks_order_FSLMNI152_2mm.nii.gz ...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ...done. (0 seconds, 0 min)
 ...done. (0 seconds, 0 min)
</pre></div>
</div>
</div>
</div>
<p>The map key in <code class="docutils literal notranslate"><span class="pre">atlas_schaefer_2018</span></code> is a <code class="docutils literal notranslate"><span class="pre">.nii.gz</span></code> image which contains a 3D NIFTI volume with a label for a given (x,y,z) voxel. Since these images are 3D volumes (sort of like structural images), we can view them using nilearn’s plotting utilities:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Define where to slice the image</span>
<span class="n">cut_coords</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
<span class="c1">#Show a colorbar</span>
<span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span>
<span class="c1">#Color scheme to show when viewing image</span>
<span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Paired&#39;</span>

<span class="c1">#Plot the parcellation schema referred to by atlas_schaefer_2018</span>
<span class="n">nplot</span><span class="o">.</span><span class="n">plot_roi</span><span class="p">(</span><span class="n">atlas_schaefer_2018</span><span class="p">[</span><span class="s1">&#39;maps&#39;</span><span class="p">],</span> <span class="n">cut_coords</span><span class="o">=</span><span class="n">cut_coords</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="n">colorbar</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Schaefer et al. 2018&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;nilearn.plotting.displays._slicers.OrthoSlicer at 0x79c12d74ff40&gt;
</pre></div>
</div>
<img alt="../_images/57cd7decbf5be0e21c22cc5c0deb88b2be57095a4055486ad31077e3c644f7f6.png" src="../_images/57cd7decbf5be0e21c22cc5c0deb88b2be57095a4055486ad31077e3c644f7f6.png" />
</div>
</div>
<p>You’ll notice that the colour bar on the right shows the number of labels in each atlas and which colour corresponds to which network</p>
<p>The 7 Network parcellation includes the following networks:</p>
<ol class="arabic simple">
<li><p>Visual<br/></p></li>
<li><p>Somatosensory<br/></p></li>
<li><p>Dorsal Attention<br/></p></li>
<li><p>Ventral Attention<br/></p></li>
<li><p>Limbic<br/></p></li>
<li><p>Frontoparietal<br/></p></li>
<li><p>Default<br/></p></li>
</ol>
<p>The parcel areas labelled with 0 are background voxels not associated with a particular network.</p>
<p>Now that we have imported the atlas, in the next cell, we extract the label names and corresponding label coordinates in millimeters. The label names represent specific brain regions, while the label coordinates indicate their spatial locations.</p>
<p>The distance between two regions is calculated using the following formula:</p>
<p>\begin{equation}
\text{distance} = \sqrt{\sum_{i=1}^{n}(coords_{\text}^i - coords_{\text}^i)^2}
\end{equation}</p>
<p>In this formula, <span class="math notranslate nohighlight">\(coords_{\text{{roi1}}}\)</span> and <span class="math notranslate nohighlight">\(coords_{\text{{roi2}}}\)</span> represent the coordinate vectors of the two regions of interest (ROI). By substituting the appropriate indices into the formula, the Euclidean distance between the corresponding coordinates is calculated.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://raw.githubusercontent.com/ThomasYeoLab/CBIG/master/stable_projects/brain_parcellation/Schaefer2018_LocalGlobal/Parcellations/MNI/Centroid_coordinates/Schaefer2018_200Parcels_7Networks_order_FSLMNI152_2mm.Centroid_RAS.csv&#39;</span>
<span class="n">atlas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">label</span> <span class="o">=</span> <span class="n">atlas</span><span class="p">[</span><span class="s1">&#39;ROI Name&#39;</span><span class="p">]</span>

<span class="n">label_stripped</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">label</span><span class="p">)):</span>
    <span class="n">label_stripped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="n">xx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;7Networks_&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>


<span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">atlas</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">],</span> <span class="n">atlas</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">],</span> <span class="n">atlas</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
<span class="n">conduction_velocity</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1">#in ms</span>

<span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<span class="k">for</span> <span class="n">roi1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
  <span class="k">for</span> <span class="n">roi2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">distance</span><span class="p">[</span><span class="n">roi1</span><span class="p">,</span> <span class="n">roi2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">coords</span><span class="p">[</span><span class="n">roi1</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="n">roi2</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">distance</span><span class="p">[</span><span class="n">roi1</span><span class="p">,</span> <span class="n">roi2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">coords</span><span class="p">[</span><span class="n">roi1</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="n">roi2</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>numpy.ndarray
</pre></div>
</div>
</div>
</div>
<p><strong>Structural Connectivity</strong></p>
<p>As introduced before the connectivity between different nodes/parcels is modelled using the structural connectivity (SC) which scales the long-range connections between distant brain regions. Mathematically, together with the global scaling factor G, it is a factor of the long-range input onto a region.
In the simplest case, without time edelays, local connectivity and noise:
\begin{equation}
\dot{x}<em>i = N(x</em>{i}(t)) + G\sum_1^n SC_{ij} x_j
\end{equation}
Wherein <span class="math notranslate nohighlight">\(\dot{x}_i\)</span> is the derivative of the date variable, <span class="math notranslate nohighlight">\(N(x_{i}(t))\)</span> is the nerual mass model function, <span class="math notranslate nohighlight">\(G\)</span> is the global scaling factor, <span class="math notranslate nohighlight">\(SC_{ij}\)</span> is the connections strength between regions <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(j\)</span> and <span class="math notranslate nohighlight">\(x_j\)</span> is the output from region <span class="math notranslate nohighlight">\(j\)</span>.</p>
<p>In the subsequent cell, we import the SC matrix for the average of the Human Connectome Project (HCP) dataset. Additionally, we compute the conduction delay between each pair of regions by dividing the distance matrix by the conduction velocity of 5 ms, which is based on previous studies.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/GriffithsLab/PyTepFit/main/data/Schaefer2018_200Parcels_7Networks_count.csv&quot;</span>
<span class="n">count</span> <span class="o">=</span> <span class="n">NormalizeData</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">,</span>  <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)))</span>

<span class="n">delays</span> <span class="o">=</span> <span class="n">distance</span><span class="o">/</span><span class="n">conduction_velocity</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;connectome matrices&#39;</span><span class="p">)</span>

<span class="c1"># distance</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">delays</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Conduction Delays&#39;</span><span class="p">)</span>
<span class="c1">#axes.flat[0].set_xticklabels(label_stripped, rotation=90);</span>
<span class="c1"># axes.flat[0].set_yticklabels(label_stripped, rotation=0);</span>

<span class="c1"># wieghts (normalized between 0 and 3)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">count</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Normalized Streamlines Count&#39;</span><span class="p">)</span>
<span class="c1"># axes.flat[1].set_xticklabels(label_stripped, rotation=90)</span>
<span class="c1"># axes.flat[1].set_yticklabels(label_stripped, rotation=0)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Normalized Streamlines Count&#39;)
</pre></div>
</div>
<img alt="../_images/5ef1b430b68a722162c717ac27805c64f08490fde4607c5a568581b85ecc4718.png" src="../_images/5ef1b430b68a722162c717ac27805c64f08490fde4607c5a568581b85ecc4718.png" />
</div>
</div>
<p>This can also be plotted on a brain surface using  <code class="docutils literal notranslate"><span class="pre">nilearn.plotting.view_connectome</span></code> function</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plotting</span><span class="o">.</span><span class="n">view_connectome</span><span class="p">(</span>
    <span class="n">count</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">edge_threshold</span><span class="o">=</span><span class="s2">&quot;97%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Output hidden; open in https://colab.research.google.com to view.
</pre></div>
</div>
</div>
</div>
<p>We have all the information necessary for setting up our SC matrix inside TVB</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">conn</span> <span class="o">=</span> <span class="n">connectivity</span><span class="o">.</span><span class="n">Connectivity</span><span class="p">()</span>
<span class="n">conn</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">count</span>
<span class="n">conn</span><span class="o">.</span><span class="n">region_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">label_stripped</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">delays</span> <span class="o">=</span> <span class="n">delays</span>
<span class="n">conn</span><span class="o">.</span><span class="n">centres</span> <span class="o">=</span> <span class="n">coords</span>
<span class="n">conn</span><span class="o">.</span><span class="n">tract_lengths</span> <span class="o">=</span> <span class="n">distance</span>


<span class="n">Schaefer_parcel</span> <span class="o">=</span> <span class="n">nl</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">load_img</span><span class="p">(</span><span class="n">atlas_schaefer_2018</span><span class="p">[</span><span class="s1">&#39;maps&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>


<span class="n">areas</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">Schaefer_parcel</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">areas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Schaefer_parcel</span><span class="o">==</span><span class="n">value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">areas</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">areas</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">areas</span> <span class="o">=</span> <span class="n">areas</span>
<span class="n">conn</span><span class="o">.</span><span class="n">number_of_connections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>

<span class="n">conn</span><span class="o">.</span><span class="n">cortical</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">conn</span><span class="o">.</span><span class="n">orientations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">conn</span><span class="o">.</span><span class="n">centres</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

<span class="n">conn</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>

<span class="n">conn</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<thead><h3>Connectivity</h3></thead>
<tbody>

<tr><th></th><th style="text-align:left;width:80%">value</th></tr>
<tr><td>Number of connections</td><td style="text-align:left;"><pre>27722</pre></td></tr>
<tr><td>Number of regions</td><td style="text-align:left;"><pre>200</pre></td></tr>
<tr><td>Undirected</td><td style="text-align:left;"><pre>True</pre></td></tr>
<tr><td>areas</td><td style="text-align:left;"><pre> [min, median, max] = [114, 627.5, 1446] dtype = float64 shape = (200,)</pre></td></tr>
<tr><td>tract_lengths</td><td style="text-align:left;"><pre> [min, median, max] = [0, 81.5843, 164.973] dtype = float64 shape = (200, 200)</pre></td></tr>
<tr><td>tract_lengths (connections)</td><td style="text-align:left;"><pre> [min, median, max] = [7.48331, 74.4312, 160.761] dtype = float64 shape = (27722,)</pre></td></tr>
<tr><td>tract_lengths-non-zero</td><td style="text-align:left;"><pre> [min, median, max] = [7.48331, 81.7557, 164.973] dtype = float64 shape = (39800,)</pre></td></tr>
<tr><td>weights</td><td style="text-align:left;"><pre> [min, median, max] = [0, 0.000147667, 1] dtype = float64 shape = (200, 200)</pre></td></tr>
<tr><td>weights-non-zero</td><td style="text-align:left;"><pre> [min, median, max] = [4.92223e-05, 0.000492223, 1] dtype = float64 shape = (27722,)</pre></td></tr>
</tbody></table></div></div>
</div>
<p>Now that we set up the connectivity we are ready for simulating the whole-brain activity using the Jansen and Rit model. So first we are going to define the function <code class="docutils literal notranslate"><span class="pre">simulate_resting_state</span></code> arguments:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">simlength</span></code>: The duration of the simulation in milliseconds (default: 1000 ms).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tavg_per</span></code>: The temporal averaging period in milliseconds (default: 1 ms).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">conn</span></code>: The connectivity matrix representing the structural connectivity of the neural network (default: None). If conn is not provided, the function assumes that you have a connectivity file or use load_default=True to load a default connectivity matrix.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sigma</span></code>: The noise levels in the model (default: None).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">jrm_params</span></code>: Parameters for the Jansen-Rit neural mass model (default: None).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cpl_params</span></code>: Parameters for the coupling between neural masses (default: None).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">int_dt</span></code>: The integration time step in milliseconds (default: 0.5 ms).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">speed</span></code>: The conduction speed in mm/ms (default: 3 mm/ms).</p></li>
</ul>
<p>The Jansen-Rit model is instantiated with the given parameters (<code class="docutils literal notranslate"><span class="pre">jrm_params</span></code>), or default parameters if <code class="docutils literal notranslate"><span class="pre">jrm_params</span></code> is None.
The variables of interest in the Jansen-Rit model are set to (‘y0’, ‘y1’, ‘y2’, ‘y3’, ‘y4’, ‘y5’) for monitoring purposes.
The noise levels (sigma) are set to default values if not provided.
The sigmoidal coupling model (<code class="docutils literal notranslate"><span class="pre">SigmoidalJansenRit</span></code>) is instantiated with the given parameters (<code class="docutils literal notranslate"><span class="pre">cpl_params</span></code>), or default parameters if <code class="docutils literal notranslate"><span class="pre">cpl_params</span></code> is None.
Integration Scheme:</p>
<p>The HeunStochastic integrator is used with the given integration time step (<code class="docutils literal notranslate"><span class="pre">int_dt</span></code>) and noise levels (<code class="docutils literal notranslate"><span class="pre">sigma</span></code>).
Initial Conditions and Monitors:</p>
<p>The initial conditions for the simulation are set to zeros, as stochastic integration is used.
A TemporalAverage monitor is created with the specified temporal averaging period (<code class="docutils literal notranslate"><span class="pre">tavg_per</span></code>).
Simulator Configuration and Execution:</p>
<p>The simulator is configured with the Jansen-Rit model, connectivity, coupling, integrator, initial conditions, simulation length, and monitor(s).
The simulation is executed using the run() method of the simulator object.
The temporal average data from the monitor is obtained.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">simulate_resting_state</span><span class="p">(</span><span class="n">simlength</span><span class="o">=</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">tavg_per</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">conn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">jrm_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cpl_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">int_dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">speed</span><span class="o">=</span><span class="mf">3.</span><span class="p">):</span>
    <span class="c1"># Define the connectivity</span>
    <span class="k">if</span> <span class="n">conn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">connectivity</span><span class="o">.</span><span class="n">Connectivity</span><span class="o">.</span><span class="n">from_file</span><span class="p">()</span>  <span class="c1"># Assuming you have a connectivity file or use load_default=True</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">speed</span><span class="p">])</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>

    <span class="c1"># Define the model</span>
    <span class="k">if</span> <span class="n">jrm_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">jrm_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">v0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">6.</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">jrm_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">jrm_params</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">jrm</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">JansenRit</span><span class="p">(</span><span class="o">**</span><span class="n">jrm_params</span><span class="p">)</span>
    <span class="n">jrm</span><span class="o">.</span><span class="n">variables_of_interest</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;y0&#39;</span><span class="p">,</span> <span class="s1">&#39;y1&#39;</span><span class="p">,</span> <span class="s1">&#39;y2&#39;</span><span class="p">,</span> <span class="s1">&#39;y3&#39;</span><span class="p">,</span> <span class="s1">&#39;y4&#39;</span><span class="p">,</span> <span class="s1">&#39;y5&#39;</span><span class="p">)</span>
    <span class="n">jrm</span><span class="o">.</span><span class="n">stvar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>

    <span class="c1"># Set the noise</span>
    <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">phi_n_scaling</span> <span class="o">=</span> <span class="p">(</span><span class="n">jrm</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="n">jrm</span><span class="o">.</span><span class="n">A</span> <span class="o">*</span> <span class="p">(</span><span class="n">jrm</span><span class="o">.</span><span class="n">p_max</span> <span class="o">-</span> <span class="n">jrm</span><span class="o">.</span><span class="n">p_min</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">sigma</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi_n_scaling</span> <span class="o">*</span> <span class="mf">1e-5</span>  <span class="c1"># Shrink noise by 1e-5</span>

    <span class="c1"># Define the coupling</span>
    <span class="k">if</span> <span class="n">cpl_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cpl_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">0.00045</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cpl_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cpl_params</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">cpl</span> <span class="o">=</span> <span class="n">coupling</span><span class="o">.</span><span class="n">SigmoidalJansenRit</span><span class="p">(</span><span class="o">**</span><span class="n">cpl_params</span><span class="p">)</span>

    <span class="c1"># Set up the integration scheme</span>
    <span class="n">solver</span> <span class="o">=</span> <span class="n">integrators</span><span class="o">.</span><span class="n">HeunStochastic</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="n">int_dt</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="n">noise</span><span class="o">.</span><span class="n">Additive</span><span class="p">(</span><span class="n">nsig</span><span class="o">=</span><span class="n">sigma</span><span class="p">))</span>

    <span class="c1"># Define initial conditions</span>
    <span class="n">init_conds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">conn</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>  <span class="c1"># All zeros; doesn&#39;t matter as we are using stochastic integration</span>

    <span class="c1"># Define the monitor for temporal averaging</span>
    <span class="n">tavg_mon</span> <span class="o">=</span> <span class="n">monitors</span><span class="o">.</span><span class="n">TemporalAverage</span><span class="p">()</span>
    <span class="n">tavg_mon</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">tavg_per</span>

    <span class="c1"># Create the simulator object</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">simulator</span><span class="o">.</span><span class="n">Simulator</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">jrm</span><span class="p">,</span>
        <span class="n">connectivity</span><span class="o">=</span><span class="n">conn</span><span class="p">,</span>
        <span class="n">coupling</span><span class="o">=</span><span class="n">cpl</span><span class="p">,</span>
        <span class="n">integrator</span><span class="o">=</span><span class="n">solver</span><span class="p">,</span>
        <span class="n">initial_conditions</span><span class="o">=</span><span class="n">init_conds</span><span class="p">,</span>
        <span class="n">simulation_length</span><span class="o">=</span><span class="n">simlength</span><span class="p">,</span>
        <span class="n">monitors</span><span class="o">=</span><span class="p">(</span><span class="n">tavg_mon</span><span class="p">,),</span>
    <span class="p">)</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>

    <span class="c1"># Run the simulation and obtain the temporal average data</span>
    <span class="n">tavg_data</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># Return the temporal average data</span>
    <span class="k">return</span> <span class="n">tavg_data</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s run the model!!!!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tvb.simulator</span> <span class="kn">import</span> <span class="n">noise</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">simulate_resting_state</span><span class="p">(</span><span class="n">simlength</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">conn</span><span class="o">=</span><span class="n">conn</span><span class="p">,</span>  <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">jrm_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">cpl_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">int_dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">speed</span><span class="o">=</span><span class="mf">3.</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_cPN</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">0</span><span class="p">,:]),</span><span class="n">index</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">df_cPN</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
<span class="n">df_cPN</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span>
<span class="n">df_cPN</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_stripped</span><span class="p">]</span>

<span class="n">df_cEIN</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">1</span><span class="p">,:]),</span><span class="n">index</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">df_cEIN</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
<span class="n">df_cEIN</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span>
<span class="n">df_cEIN</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_stripped</span><span class="p">]</span>

<span class="n">df_cIIN</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">2</span><span class="p">,:]),</span><span class="n">index</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">df_cIIN</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
<span class="n">df_cIIN</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span>
<span class="n">df_cIIN</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_stripped</span><span class="p">]</span>

<span class="n">df_vPN</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">3</span><span class="p">,:]),</span><span class="n">index</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">df_vPN</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
<span class="n">df_vPN</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span>
<span class="n">df_vPN</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_stripped</span><span class="p">]</span>

<span class="n">df_vEIN</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">4</span><span class="p">,:]),</span><span class="n">index</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">df_vEIN</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
<span class="n">df_vEIN</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span>
<span class="n">df_vEIN</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_stripped</span><span class="p">]</span>

<span class="n">df_vIIN</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">5</span><span class="p">,:]),</span><span class="n">index</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">df_vIIN</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
<span class="n">df_vIIN</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span>
<span class="n">df_vIIN</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_stripped</span><span class="p">]</span>


<span class="o">%</span><span class="k">matplotlib</span> inline


<span class="n">df</span> <span class="o">=</span> <span class="n">df_cEIN</span> <span class="o">-</span> <span class="n">df_cIIN</span>

<span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="mi">1000</span><span class="p">:</span><span class="mi">2000</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c67586482759068720a561146e167b9fbda4ad23ce518976b6ff603663d30b5c.png" src="../_images/c67586482759068720a561146e167b9fbda4ad23ce518976b6ff603663d30b5c.png" />
</div>
</div>
<p>Now that we have simulated EEG activity at the level of the parcels we are going to move back to the EEG space and for this we need the leadfield matrix</p>
<p><strong>Leadfield</strong></p>
<p>The leadfiled matrix is used to project local field potentials from region level (inside the brain) to the scalp surface for the calculation of EEG signals.</p>
<div class="math notranslate nohighlight">
\[M = GX + E\]</div>
<p>where <span class="math notranslate nohighlight">\(M \in \mathbb{R}^{C \times T}\)</span> is the sensor data, <span class="math notranslate nohighlight">\(G \in \mathbb{R}^{C \times S}\)</span> is the lead-field (or gain) matrix, <span class="math notranslate nohighlight">\(X \in \mathbb{R}^{S \times T}\)</span> is the source time course (stc) and <span class="math notranslate nohighlight">\(E \in \mathbb{R}^{C \times T}\)</span> is additive Gaussian noise with zero mean and identity covariance</p>
<p>Here, we use pre-calculated matrix.</p>
<p>In the next cell we will move back to EEG space by performing a matrix multiplication between the leadfield matrix (leadfield) and the output of our resting-state simulation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">leadfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;/content/Data/leadfield&#39;</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">epoched</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">read_epochs</span><span class="p">(</span><span class="s1">&#39;/content/Data/all_avg.mat_avg_high_epoched&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">dataeeg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">leadfield</span> <span class="o">@</span> <span class="n">df</span><span class="p">[</span><span class="mi">2000</span><span class="p">:</span><span class="mi">4000</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">leadfield</span> <span class="o">@</span> <span class="n">df</span><span class="p">[</span><span class="mi">2000</span><span class="p">:</span><span class="mi">4000</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">)])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">62</span><span class="p">,</span><span class="mi">2000</span><span class="p">)</span>

<span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataeeg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
  <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataeeg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">dataeeg</span><span class="p">[</span><span class="n">xx</span><span class="p">,</span><span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataeeg</span><span class="p">[</span><span class="n">xx</span><span class="p">,</span><span class="n">ch</span><span class="p">]</span> <span class="o">-</span> <span class="n">dataeeg</span><span class="p">[</span><span class="n">xx</span><span class="p">,</span><span class="n">ch</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">evokeds</span><span class="o">=</span><span class="n">mne</span><span class="o">.</span><span class="n">EpochsArray</span><span class="p">(</span><span class="n">dataeeg</span><span class="p">,</span><span class="n">epoched</span><span class="o">.</span><span class="n">info</span><span class="p">,</span><span class="n">tmin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">evoked</span> <span class="o">=</span> <span class="n">evokeds</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>

<span class="n">evoked</span><span class="o">.</span><span class="n">plot_joint</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Not setting metadata
2 matching events found
No baseline correction applied
Created an SSP operator (subspace dimension = 1)
1 projection items activated
NOTE: pick_channels() is a legacy function. New code should use inst.pick(...).
Projections have already been applied. Setting proj attribute to True.
NOTE: pick_channels() is a legacy function. New code should use inst.pick(...).
</pre></div>
</div>
<img alt="../_images/ba62f9ca49d8948086f89cf63bbd4c1abeb9e85ef194c15d99b5aa72b5b7b58f.png" src="../_images/ba62f9ca49d8948086f89cf63bbd4c1abeb9e85ef194c15d99b5aa72b5b7b58f.png" />
</div>
</div>
<p>The next code snippet performs a Multitaper Power Spectral Density (PSD) analysis on EEG data. The PSD analysis helps us understand the distribution of power across different frequency bands in the EEG signal. The code utilizes the <a class="reference external" href="https://mne.tools/stable/index.html">MNE-Python</a> library, specifically the  <code class="docutils literal notranslate"><span class="pre">compute_psd()</span></code> function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">spectrum</span> <span class="o">=</span> <span class="n">evokeds</span><span class="o">.</span><span class="n">compute_psd</span><span class="p">(</span><span class="n">fmin</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="mf">40.0</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="c1"># average across epochs first</span>
<span class="n">mean_spectrum</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>
<span class="n">psds</span><span class="p">,</span> <span class="n">freqs</span> <span class="o">=</span> <span class="n">mean_spectrum</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">return_freqs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># then convert to dB and take mean &amp; standard deviation across channels</span>
<span class="n">psds</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">psds</span><span class="p">)</span>
<span class="n">psds_mean</span> <span class="o">=</span> <span class="n">psds</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">psds_std</span> <span class="o">=</span> <span class="n">psds</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">psds_mean</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">freqs</span><span class="p">,</span>
    <span class="n">psds_mean</span> <span class="o">-</span> <span class="n">psds_std</span><span class="p">,</span>
    <span class="n">psds_mean</span> <span class="o">+</span> <span class="n">psds_std</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Multitaper PSD (eeg)&quot;</span><span class="p">,</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Frequency (Hz)&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Power Spectral Density (dB)&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    Using multitaper spectrum estimation with 7 DPSS windows
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Text(0.5, 1.0, &#39;Multitaper PSD (eeg)&#39;),
 Text(0.5, 0, &#39;Frequency (Hz)&#39;),
 Text(0, 0.5, &#39;Power Spectral Density (dB)&#39;)]
</pre></div>
</div>
<img alt="../_images/6b5c9d74c42a96ccd198535cbebfac5d5bd7ef5aeb23db74fb6bacd90389090f.png" src="../_images/6b5c9d74c42a96ccd198535cbebfac5d5bd7ef5aeb23db74fb6bacd90389090f.png" />
</div>
</div>
<p>Finally, in the next cell we utilize MNE-Python’s <code class="docutils literal notranslate"><span class="pre">tfr_morlet()</span></code> function to compute time-frequency power and inter-trial coherence using Morlet wavelets and plot the spectrum for channel O1</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span> <span class="mi">35</span><span class="p">]),</span> <span class="n">num</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">n_cycles</span> <span class="o">=</span> <span class="n">freqs</span> <span class="o">/</span> <span class="mf">2.0</span>  <span class="c1"># different number of cycle per frequency</span>
<span class="n">power</span><span class="p">,</span> <span class="n">itc</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">time_frequency</span><span class="o">.</span><span class="n">tfr_morlet</span><span class="p">(</span>
    <span class="n">evokeds</span><span class="p">,</span>
    <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span>
    <span class="n">n_cycles</span><span class="o">=</span><span class="n">n_cycles</span><span class="p">,</span>
    <span class="n">use_fft</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">return_itc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">decim</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">power</span><span class="o">.</span><span class="n">plot_topo</span><span class="p">(</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;logratio&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Average power&quot;</span><span class="p">)</span>
<span class="n">power</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">evokeds</span><span class="o">.</span><span class="n">ch_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;O1&#39;</span><span class="p">)],</span>
           <span class="n">baseline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;logratio&quot;</span><span class="p">,</span>
           <span class="n">title</span><span class="o">=</span><span class="n">power</span><span class="o">.</span><span class="n">ch_names</span><span class="p">[</span><span class="n">epoched</span><span class="o">.</span><span class="n">ch_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;O1&#39;</span><span class="p">)])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">topomap_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">ch_type</span><span class="o">=</span><span class="s2">&quot;eeg&quot;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="n">epoched</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tmax</span><span class="o">=</span><span class="n">epoched</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">baseline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;logratio&quot;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
<span class="n">plot_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">Alpha</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">fmin</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span> <span class="n">Beta</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">fmin</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="mi">25</span><span class="p">))</span>

<span class="c1"># Plot the Alpha topomap</span>
<span class="n">power</span><span class="o">.</span><span class="n">plot_topomap</span><span class="p">(</span><span class="o">**</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;Alpha&quot;</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">topomap_kw</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Alpha&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>No baseline correction applied
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Parallel(n_jobs=1)]: Done  17 tasks      | elapsed:    0.1s
</pre></div>
</div>
<img alt="../_images/9f057a844459ad730818ea0e38055078c7f77c4ef8394725d38cc01942d90973.png" src="../_images/9f057a844459ad730818ea0e38055078c7f77c4ef8394725d38cc01942d90973.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>NOTE: pick_channels() is a legacy function. New code should use inst.pick(...).
No baseline correction applied
</pre></div>
</div>
<img alt="../_images/218f7b30b1e27be2c78aa568e92796f188098b7d86de8e005652e05c31886db5.png" src="../_images/218f7b30b1e27be2c78aa568e92796f188098b7d86de8e005652e05c31886db5.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>No baseline correction applied
</pre></div>
</div>
<img alt="../_images/af6044641285cf294240b258639ba71e031fb938d6995030af41e18cdd04c77e.png" src="../_images/af6044641285cf294240b258639ba71e031fb938d6995030af41e18cdd04c77e.png" />
</div>
</div>
<p>If the model we use for the nodes remains constant, with identical parameters, the alpha oscillations observed in specific brain regions can solely arise from the structural connectivity between those regions.</p>
<p>Let’s explore this further by modifying the connectome and see how this changing will affect the alpha oscillations</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vis</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">region_labels</span><span class="p">))</span> <span class="k">if</span> <span class="s1">&#39;Vis&#39;</span> <span class="ow">in</span> <span class="n">word</span><span class="p">]</span>
<span class="n">backup</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">conn</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">Vis</span><span class="p">,:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>
<span class="n">conn</span><span class="o">.</span><span class="n">weights</span><span class="p">[:,</span><span class="n">Vis</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tvb.simulator</span> <span class="kn">import</span> <span class="n">noise</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">simulate_resting_state</span><span class="p">(</span><span class="n">simlength</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">conn</span><span class="o">=</span><span class="n">conn</span><span class="p">,</span>  <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">jrm_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">cpl_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">int_dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">speed</span><span class="o">=</span><span class="mf">3.</span><span class="p">)</span>


<span class="n">df_cPN</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">0</span><span class="p">,:]),</span><span class="n">index</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">df_cPN</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
<span class="n">df_cPN</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span>
<span class="n">df_cPN</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_stripped</span><span class="p">]</span>

<span class="n">df_cEIN</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">1</span><span class="p">,:]),</span><span class="n">index</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">df_cEIN</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
<span class="n">df_cEIN</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span>
<span class="n">df_cEIN</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_stripped</span><span class="p">]</span>

<span class="n">df_cIIN</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">2</span><span class="p">,:]),</span><span class="n">index</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">df_cIIN</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
<span class="n">df_cIIN</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span>
<span class="n">df_cIIN</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_stripped</span><span class="p">]</span>

<span class="n">df_vPN</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">3</span><span class="p">,:]),</span><span class="n">index</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">df_vPN</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
<span class="n">df_vPN</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span>
<span class="n">df_vPN</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_stripped</span><span class="p">]</span>

<span class="n">df_vEIN</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">4</span><span class="p">,:]),</span><span class="n">index</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">df_vEIN</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
<span class="n">df_vEIN</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span>
<span class="n">df_vEIN</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_stripped</span><span class="p">]</span>

<span class="n">df_vIIN</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">5</span><span class="p">,:]),</span><span class="n">index</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">df_vIIN</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
<span class="n">df_vIIN</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span>
<span class="n">df_vIIN</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_stripped</span><span class="p">]</span>


<span class="o">%</span><span class="k">matplotlib</span> inline


<span class="n">df</span> <span class="o">=</span> <span class="n">df_cEIN</span> <span class="o">-</span> <span class="n">df_cIIN</span>

<span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>



<span class="n">leadfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;/content/Data/leadfield&#39;</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">epoched</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">read_epochs</span><span class="p">(</span><span class="s1">&#39;/content/Data/all_avg.mat_avg_high_epoched&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">dataeeg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">leadfield</span> <span class="o">@</span> <span class="n">df</span><span class="p">[</span><span class="mi">2000</span><span class="p">:</span><span class="mi">4000</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">leadfield</span> <span class="o">@</span> <span class="n">df</span><span class="p">[</span><span class="mi">2000</span><span class="p">:</span><span class="mi">4000</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">)])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">62</span><span class="p">,</span><span class="mi">2000</span><span class="p">)</span>

<span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataeeg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
  <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataeeg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">dataeeg</span><span class="p">[</span><span class="n">xx</span><span class="p">,</span><span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataeeg</span><span class="p">[</span><span class="n">xx</span><span class="p">,</span><span class="n">ch</span><span class="p">]</span> <span class="o">-</span> <span class="n">dataeeg</span><span class="p">[</span><span class="n">xx</span><span class="p">,</span><span class="n">ch</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">evokeds</span><span class="o">=</span><span class="n">mne</span><span class="o">.</span><span class="n">EpochsArray</span><span class="p">(</span><span class="n">dataeeg</span><span class="p">,</span><span class="n">epoched</span><span class="o">.</span><span class="n">info</span><span class="p">,</span><span class="n">tmin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">evoked</span> <span class="o">=</span> <span class="n">evokeds</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>

<span class="n">evoked</span><span class="o">.</span><span class="n">plot_joint</span><span class="p">();</span>


<span class="c1"># @title Run the model with lesioned connectome</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Not setting metadata
2 matching events found
No baseline correction applied
Created an SSP operator (subspace dimension = 1)
1 projection items activated
NOTE: pick_channels() is a legacy function. New code should use inst.pick(...).
Projections have already been applied. Setting proj attribute to True.
NOTE: pick_channels() is a legacy function. New code should use inst.pick(...).
</pre></div>
</div>
<img alt="../_images/0e1f439ec2a6e5fffa1d90cc734a3ed3c80069933e085b8140371e55b773bedb.png" src="../_images/0e1f439ec2a6e5fffa1d90cc734a3ed3c80069933e085b8140371e55b773bedb.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span> <span class="mi">35</span><span class="p">]),</span> <span class="n">num</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">n_cycles</span> <span class="o">=</span> <span class="n">freqs</span> <span class="o">/</span> <span class="mf">2.0</span>  <span class="c1"># different number of cycle per frequency</span>
<span class="n">power</span><span class="p">,</span> <span class="n">itc</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">time_frequency</span><span class="o">.</span><span class="n">tfr_morlet</span><span class="p">(</span>
    <span class="n">evokeds</span><span class="p">,</span>
    <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span>
    <span class="n">n_cycles</span><span class="o">=</span><span class="n">n_cycles</span><span class="p">,</span>
    <span class="n">use_fft</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">return_itc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">decim</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">power</span><span class="o">.</span><span class="n">plot_topo</span><span class="p">(</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;logratio&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Average power&quot;</span><span class="p">)</span>
<span class="n">power</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">evokeds</span><span class="o">.</span><span class="n">ch_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;O1&#39;</span><span class="p">)],</span>
           <span class="n">baseline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;logratio&quot;</span><span class="p">,</span>
           <span class="n">title</span><span class="o">=</span><span class="n">power</span><span class="o">.</span><span class="n">ch_names</span><span class="p">[</span><span class="n">epoched</span><span class="o">.</span><span class="n">ch_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;O1&#39;</span><span class="p">)])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">topomap_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">ch_type</span><span class="o">=</span><span class="s2">&quot;eeg&quot;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="n">epoched</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tmax</span><span class="o">=</span><span class="n">epoched</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">baseline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;logratio&quot;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
<span class="n">plot_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">Alpha</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">fmin</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span> <span class="n">Beta</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">fmin</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="mi">25</span><span class="p">))</span>

<span class="c1"># Plot the Alpha topomap</span>
<span class="n">power</span><span class="o">.</span><span class="n">plot_topomap</span><span class="p">(</span><span class="o">**</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;Alpha&quot;</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">topomap_kw</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Alpha&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>No baseline correction applied
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Parallel(n_jobs=1)]: Done  17 tasks      | elapsed:    0.1s
</pre></div>
</div>
<img alt="../_images/728aebd5b4ef2d842882d7e9dbd5406a30ac496b3da5cb07ddc4c6326d94ac6d.png" src="../_images/728aebd5b4ef2d842882d7e9dbd5406a30ac496b3da5cb07ddc4c6326d94ac6d.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>NOTE: pick_channels() is a legacy function. New code should use inst.pick(...).
No baseline correction applied
</pre></div>
</div>
<img alt="../_images/06ae9fa32cc4cb652f9b40f05194e98a80b047d09d0090fa88cad44564d60afd.png" src="../_images/06ae9fa32cc4cb652f9b40f05194e98a80b047d09d0090fa88cad44564d60afd.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>No baseline correction applied
</pre></div>
</div>
<img alt="../_images/fb7ec836e629f17a3492b70279a26343f49ccbb8e66cac981bfb02f3cf089c1b.png" src="../_images/fb7ec836e629f17a3492b70279a26343f49ccbb8e66cac981bfb02f3cf089c1b.png" />
</div>
</div>
<p>###<strong>Simulation of stimulus-evoked activity</strong></p>
<p>In order to investigate the effects of external input on the system dynamics, we have developed a function called <code class="docutils literal notranslate"><span class="pre">run_stimulus_evoked_activity()</span></code>. This function shares a similar structure to the one used for simulating resting-state activity. However, in this case, the function focuses on configuring and applying a stimulus pattern to the simulation. The stimulus pattern is determined by the equation and weight parameters provided, and it is applied to the specified connectivity. Just like before, the simulation is then set up using the appropriate components (model, connectivity, coupling, integrator, monitors, and stimulus) utilizing the <code class="docutils literal notranslate"><span class="pre">simulator.Simulator</span></code> class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_stimulus_evoked_activity</span><span class="p">(</span><span class="n">simlength</span> <span class="o">=</span> <span class="mf">1000.</span><span class="p">,</span><span class="n">tavg_per</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span><span class="n">conn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
           <span class="n">jrm_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cpl_params</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">int_dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">speed</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span>
           <span class="n">stim_eqn_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">onset</span><span class="o">=</span><span class="mf">1.5e3</span><span class="p">,</span><span class="n">T</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">tau</span><span class="o">=</span><span class="mi">50</span><span class="p">),</span> <span class="n">do_stim</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span><span class="n">stim_weighting</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>


    <span class="c1"># Define the connectivity</span>

    <span class="k">if</span> <span class="n">conn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">connectivity</span><span class="o">.</span><span class="n">Connectivity</span><span class="o">.</span><span class="n">from_file</span><span class="p">()</span><span class="c1">#(load_default=True)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">speed</span><span class="p">])</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>
        <span class="n">w_orig</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">w_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_orig</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">w_orig</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">w_norm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">w_norm</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>


    <span class="c1"># Define the model</span>

    <span class="k">if</span> <span class="n">jrm_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">jrm_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">v0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">6.</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">jrm_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">jrm_params</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">jrm</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">JansenRit</span><span class="p">(</span><span class="o">**</span><span class="n">jrm_params</span><span class="p">)</span>
    <span class="n">jrm</span><span class="o">.</span><span class="n">variables_of_interest</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;y0&#39;</span><span class="p">,</span> <span class="s1">&#39;y1&#39;</span><span class="p">,</span> <span class="s1">&#39;y2&#39;</span><span class="p">,</span> <span class="s1">&#39;y3&#39;</span><span class="p">,</span> <span class="s1">&#39;y4&#39;</span><span class="p">,</span> <span class="s1">&#39;y5&#39;</span><span class="p">)</span>
    <span class="n">jrm</span><span class="o">.</span><span class="n">stvar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>

    <span class="c1"># Set the noise</span>

    <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">phi_n_scaling</span> <span class="o">=</span> <span class="p">(</span><span class="n">jrm</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="n">jrm</span><span class="o">.</span><span class="n">A</span> <span class="o">*</span> <span class="p">(</span><span class="n">jrm</span><span class="o">.</span><span class="n">p_max</span><span class="o">-</span><span class="n">jrm</span><span class="o">.</span><span class="n">p_min</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">sigma</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">sigma</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>      <span class="o">=</span> <span class="n">phi_n_scaling</span> <span class="o">*</span><span class="mf">1e-5</span> <span class="c1">#shrank noise by 1e-5</span>


    <span class="c1"># Define a stimulus</span>

    <span class="k">if</span> <span class="n">do_stim</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">stimulus</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stim_eqn_t</span> <span class="o">=</span> <span class="n">equations</span><span class="o">.</span><span class="n">PulseTrain</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">stim_eqn_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="n">stim_eqn_t</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">stimulus</span> <span class="o">=</span> <span class="n">patterns</span><span class="o">.</span><span class="n">StimuliRegion</span><span class="p">(</span><span class="n">temporal</span><span class="o">=</span><span class="n">stim_eqn_t</span><span class="p">,</span>
                                        <span class="n">connectivity</span><span class="o">=</span><span class="n">conn</span><span class="p">,</span>
                                        <span class="n">weight</span><span class="o">=</span><span class="n">stim_weighting</span><span class="p">)</span>

    <span class="n">stimulus</span><span class="o">.</span><span class="n">configure_time</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">3e3</span><span class="p">,</span> <span class="mi">2</span><span class="o">**-</span><span class="mi">4</span><span class="p">))</span>


    <span class="c1"># Define the coupling</span>

    <span class="k">if</span> <span class="n">cpl_params</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cpl_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">0.00045</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cpl_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">cpl_params</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">cpl</span> <span class="o">=</span> <span class="n">coupling</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="o">**</span><span class="n">cpl_params</span><span class="p">)</span>


    <span class="c1"># Set up the integration scheme</span>

    <span class="n">solver</span> <span class="o">=</span> <span class="n">integrators</span><span class="o">.</span><span class="n">HeunStochastic</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="n">int_dt</span><span class="p">,</span><span class="n">noise</span><span class="o">=</span><span class="n">noise</span><span class="o">.</span><span class="n">Additive</span><span class="p">(</span><span class="n">nsig</span><span class="o">=</span><span class="n">sigma</span><span class="p">))</span> <span class="c1">#integrator dt is bottleneck</span>


    <span class="c1"># Define initial conditions</span>

    <span class="n">init_conds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># all zeros; doesn&#39;t really matter as we are using stochastic integration</span>
    <span class="c1">#                                     dimensions are specific to jansen-rit model (namely 6 state variables)</span>


    <span class="n">tavg_mon</span> <span class="o">=</span> <span class="n">monitors</span><span class="o">.</span><span class="n">TemporalAverage</span><span class="p">()</span>
    <span class="n">tavg_mon</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">tavg_per</span>

    <span class="n">mons</span><span class="o">=</span><span class="p">(</span><span class="n">tavg_mon</span><span class="p">,)</span>






    <span class="c1"># Create the simulator object</span>

    <span class="n">sim</span> <span class="o">=</span> <span class="n">simulator</span><span class="o">.</span><span class="n">Simulator</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">jrm</span><span class="p">,</span>
        <span class="n">connectivity</span><span class="o">=</span><span class="n">conn</span><span class="p">,</span>
        <span class="n">coupling</span><span class="o">=</span><span class="n">cpl</span><span class="p">,</span>
        <span class="n">integrator</span><span class="o">=</span><span class="n">solver</span><span class="p">,</span>
        <span class="n">initial_conditions</span><span class="o">=</span><span class="n">init_conds</span><span class="p">,</span>
        <span class="n">simulation_length</span><span class="o">=</span><span class="n">simlength</span><span class="p">,</span>
        <span class="n">monitors</span><span class="o">=</span><span class="n">mons</span><span class="p">,</span>
        <span class="n">stimulus</span><span class="o">=</span><span class="n">stimulus</span>
    <span class="p">)</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>



    <span class="c1"># Run the sim and put results into dataframes</span>

    <span class="n">tavg_data</span><span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>



    <span class="c1"># Return a bunch of simulation outputs</span>

    <span class="k">return</span> <span class="n">tavg_data</span>
</pre></div>
</div>
</div>
</div>
<p>Now we are going to inject the external perturbation to the left Somato-Motor Network</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SomMot</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">region_labels</span><span class="p">))</span> <span class="k">if</span> <span class="s1">&#39;SomMot&#39;</span> <span class="ow">in</span> <span class="n">word</span><span class="p">]</span>

<span class="n">stim_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">conn</span><span class="o">.</span><span class="n">region_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">stim_weights</span><span class="p">[</span><span class="n">SomMot</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">16</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">5.</span> <span class="c1">#inject stimulus to left hemi</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plotting</span><span class="o">.</span><span class="n">view_markers</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stim_weights</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Output hidden; open in https://colab.research.google.com to view.
</pre></div>
</div>
</div>
</div>
<p>We are ready to run the simulation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">node2use</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stim_weights</span><span class="o">!=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">stim_weighting</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">region_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># configure stimulus spatial pattern</span>
<span class="n">stim_weight</span> <span class="o">=</span> <span class="n">stim_weights</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stim_weights</span><span class="o">!=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
<span class="n">stim_weighting</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stim_weights</span><span class="o">!=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">stim_weight</span>



<span class="n">jrm_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">v0</span><span class="o">=</span><span class="mf">6.</span><span class="p">,</span><span class="n">a_1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">a_2</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">a_3</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span><span class="n">a_4</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>


<span class="n">res</span> <span class="o">=</span> <span class="n">run_stimulus_evoked_activity</span><span class="p">(</span><span class="n">simlength</span> <span class="o">=</span> <span class="mf">5000.</span><span class="p">,</span><span class="n">tavg_per</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span><span class="n">conn</span><span class="o">=</span><span class="n">conn</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
                                   <span class="n">jrm_params</span><span class="o">=</span><span class="n">jrm_params</span><span class="p">,</span> <span class="n">cpl_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">0.00045</span><span class="p">)),</span><span class="n">int_dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">speed</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span>
                                   <span class="n">stim_eqn_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">onset</span><span class="o">=</span><span class="mi">1250</span><span class="p">,</span><span class="n">T</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span><span class="n">tau</span><span class="o">=</span><span class="mi">50</span><span class="p">),</span> <span class="n">do_stim</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">,</span><span class="n">stim_weighting</span><span class="o">=</span><span class="n">stim_weighting</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_cPN</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">0</span><span class="p">,:]),</span><span class="n">index</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">df_cPN</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
<span class="n">df_cPN</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span>


<span class="n">df_cEIN</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">1</span><span class="p">,:]),</span><span class="n">index</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">df_cEIN</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
<span class="n">df_cEIN</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span>


<span class="n">df_cIIN</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">2</span><span class="p">,:]),</span><span class="n">index</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">df_cIIN</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
<span class="n">df_cIIN</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span>


<span class="n">df_vPN</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">3</span><span class="p">,:]),</span><span class="n">index</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">df_vPN</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
<span class="n">df_vPN</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span>


<span class="n">df_vEIN</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">4</span><span class="p">,:]),</span><span class="n">index</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">df_vEIN</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
<span class="n">df_vEIN</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span>

<span class="n">df_vIIN</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">5</span><span class="p">,:]),</span><span class="n">index</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">df_vIIN</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
<span class="n">df_vIIN</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span>


<span class="n">df</span> <span class="o">=</span> <span class="n">df_cEIN</span> <span class="o">-</span> <span class="n">df_cIIN</span>

<span class="n">df_norm</span> <span class="o">=</span> <span class="n">df</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">1250</span><span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df_norm</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">df_norm</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_norm</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_norm</span><span class="p">[</span><span class="mi">1250</span><span class="p">:</span><span class="mi">2000</span><span class="p">])</span>
<span class="n">fig</span><span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_norm</span><span class="p">[</span><span class="mi">1250</span><span class="p">:</span><span class="mi">2000</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mf">1.1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1.0, 1.1)
</pre></div>
</div>
<img alt="../_images/5c9385e674c1023f685c4a78cb9f1826d9764e47d0e7d26decdd7a0c2f6aa0af.png" src="../_images/5c9385e674c1023f685c4a78cb9f1826d9764e47d0e7d26decdd7a0c2f6aa0af.png" />
</div>
</div>
<p>Now are are going to use to stuck this activity into an mne object for doing a nice visualization</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">source_eeg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_norm</span><span class="p">)[</span><span class="mi">250</span><span class="p">:</span><span class="mi">2250</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span>
<span class="n">cutted_EEG</span> <span class="o">=</span> <span class="n">leadfield</span> <span class="o">@</span> <span class="n">source_eeg</span>


<span class="n">leadfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;/content/Data/leadfield&#39;</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">epoched</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">read_epochs</span><span class="p">(</span><span class="s1">&#39;/content/Data/all_avg.mat_avg_high_epoched&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epoched</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
  <span class="n">epoched</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">trial</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">cutted_EEG</span>

<span class="n">evoked</span> <span class="o">=</span> <span class="n">epoched</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>


<span class="n">ts_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.2</span><span class="p">])</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs1</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=-</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.004</span><span class="p">)</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs2</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.008</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs3</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.030</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">peak_locs1</span><span class="p">,</span> <span class="n">peak_locs2</span><span class="p">,</span> <span class="n">peak_locs3</span><span class="p">]</span>

<span class="n">evoked</span><span class="o">.</span><span class="n">plot_joint</span><span class="p">(</span><span class="n">ts_args</span><span class="o">=</span><span class="n">ts_args</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Propagation pattern&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>NOTE: pick_channels() is a legacy function. New code should use inst.pick(...).
Projections have already been applied. Setting proj attribute to True.
NOTE: pick_channels() is a legacy function. New code should use inst.pick(...).
</pre></div>
</div>
<img alt="../_images/fd2f590b69d7c22f7ccd6172ddc8aac0cdd4a33c9a39e3bd41deae7b7aca3153.png" src="../_images/fd2f590b69d7c22f7ccd6172ddc8aac0cdd4a33c9a39e3bd41deae7b7aca3153.png" />
</div>
</div>
</div>
<div class="section" id="conclusions">
<h2>Conclusions<a class="headerlink" href="#conclusions" title="Permalink to this heading">#</a></h2>
<p>This collaborative notebook has provided a comprehensive exploration of:</p>
<p>-**Introducing neural mass modeling: **The notebook provided an introduction to neural mass modeling, a powerful technique for capturing the collective behavior of large populations of neurons.</p>
<ul class="simple">
<li><p><strong>Implementing single node dynamics in numpy and the Virtual Brain library:</strong>
We successfully implemented the dynamics of a single node using numpy and the Virtual Brain library. This implementation allowed us to simulate and analyze the behavior of individual brain regions, providing insights into their functional dynamics.</p></li>
<li><p><strong>Introducing connectivity between nodes for modeling brain activity at the whole-brain level:</strong> Building upon the single node dynamics, we extended our modeling approach by incorporating connectivity between nodes. By considering the network of connections in the brain, we simulated and studied brain activity across multiple regions. This approach enabled us to explore the emergence of complex patterns and dynamics resulting from the interactions between different brain regions.</p></li>
<li><p><strong>Modeling the effects of brain stimulation on resting state dynamics:</strong>
Leveraging our comprehensive model, we investigated the impact of brain stimulation on resting state dynamics. By simulating various stimulation scenarios, we gained insights into how external influences can modulate and alter the intrinsic dynamics of the brain.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span>

<span class="c1"># Replace the form_link with your Google Form link</span>
<span class="n">form_link</span> <span class="o">=</span> <span class="s2">&quot;https://forms.gle/CHZtikdEg3UHymaS6&quot;</span>

<span class="c1"># Create the hyperlink and open the form in a new tab with increased font size</span>
<span class="n">HTML</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&lt;a href=&quot;</span><span class="si">{</span><span class="n">form_link</span><span class="si">}</span><span class="s1">&quot; target=&quot;_blank&quot; style=&quot;font-size: 30px;&quot;&gt;Click here to access the survey&lt;/a&gt;&#39;</span><span class="p">)</span>


<span class="c1">#@title #Survey</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><a href="https://forms.gle/CHZtikdEg3UHymaS6" target="_blank" style="font-size: 30px;">Click here to access the survey</a></div></div>
</div>
<p>##References</p>
<blockquote>
<div><p>Ahmadizadeh S., Karoly PJ., Nešić D., Grayden DB, Cook MJ, Soudry D., Freestone DR. (2018) <strong>Bifurcation analysis of two coupled Jansen-Rit neural mass models.</strong> <em>PLoS One</em>, 13(3):e0192842. doi: 10.1371/journal.pone.0192842.</p>
</div></blockquote>
<blockquote>
<div><p>Jansen, B.H. and Rit, V.G. (1995) <strong>Electroencephalogram and visual evoked potential generation in a mathematical model of coupled cortical columns.</strong> <em>Biological cybernetics</em>, 73(4), pp.357-366.</p>
</div></blockquote>
<blockquote>
<div><p>Da Silva, F.L., Hoeks, A., Smits, H. and Zetterberg, L.H. (1974). <strong>Model of brain rhythmic activity.</strong> <em>Kybernetik</em>, 15(1), pp.27-37.</p>
</div></blockquote>
<blockquote>
<div><p>David, O. and Friston, K.J. (2003) <strong>A neural mass model for MEG/EEG: coupling and neuronal dynamics.</strong> <em>NeuroImage</em>, 20(3), pp.1743-1755.</p>
</div></blockquote>
<blockquote>
<div><p>Griffiths, J.D., Bastiaens SP., Kaboodvand N. (2022). <strong>Whole-Brain Modelling: Past, Present, and Future.</strong> <em>Adv Exp Med Biol</em>, 1359:313-355. doi: 10.1007/978-3-030-89439-9_13.</p>
</div></blockquote>
<blockquote>
<div><p>Momi, D., Wang, Z., Griffiths, J.D. (2023). <strong>TMS-Evoked Responses Are Driven by Recurrent Large-Scale Network Dynamics.</strong> <em>eLife</em>, 111, pp.385-430.</p>
</div></blockquote>
<blockquote>
<div><p>Schirner M., McIntosh AR., Jirsa V., Deco G., Ritter P.(2018). <strong>Inferring multi-scale neural mechanisms with brain network modelling.</strong> <em>eLife</em>, 7:e28927. doi:10.7554/eLife.28927.</p>
</div></blockquote>
<blockquote>
<div><p>Spiegler, A., Knösche, T.R., Schwab, K., Haueisen, J. and Atay, F.M. (2011). <strong>Modeling brain resonance phenomena using a neural mass model.</strong> <em>PLoS Comput Biol</em>, 7(12), p.e1002298.</p>
</div></blockquote>
</div>
<div class="section" id="bonus-section">
<h2><strong>Bonus Section</strong><a class="headerlink" href="#bonus-section" title="Permalink to this heading">#</a></h2>
<p>The scope of this part is to show that the it is also possible to model fMRI data using whole-brain modelling. Specifically we are going to use the
<a class="reference external" href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4044249/">Reduced Wang-Wang Deco Model</a></p>
<p><img alt="alt text" src="https://drive.google.com/uc?id=1BQ1K9NHKr_AXZnWmacbK6nV8cNGjJnpV" /></p>
<p>####<strong>Excitatory (NMDA)</strong>
\begin{equation}
I_i^E = W_E I_0 + \ w J_{NMDA} S_i^E + J_{NMDA} \sum_{j} W_{ij}^{LRE} C_{ij} S_j^E - J_i S_i^I
\end{equation}
<br/></p>
<p>####<strong>Inhibitory (GABA)</strong>
\begin{equation}
I_i^I = W_I I_0 + J_{NMDA} S_i^E - S_i^I + J_{NMDA} \sum_{j} W_{ij}^{FFI} C_{ij} S_j^E - S_i^I
\end{equation}</p>
<div class="section" id="id1">
<h3>Available parameters are:<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(I_i^E\)</span> and <span class="math notranslate nohighlight">\(I_i^I\)</span> = input currents</p></li>
<li><p><span class="math notranslate nohighlight">\(w\)</span> = local excitatory recurrence</p></li>
<li><p><span class="math notranslate nohighlight">\(J_{NMDA}\)</span> = excitatory synaptic coupling</p></li>
<li><p><span class="math notranslate nohighlight">\(S_i^E\)</span> and <span class="math notranslate nohighlight">\(S_i^I\)</span> = synaptic gating variable</p></li>
<li><p><span class="math notranslate nohighlight">\(C\)</span> = structural connectivity (SC)</p></li>
<li><p><span class="math notranslate nohighlight">\(G\)</span> = global coupling</p></li>
<li><p><span class="math notranslate nohighlight">\(J_i\)</span> = inhibitory synaptic coupling</p></li>
<li><p><span class="math notranslate nohighlight">\(W^{LRE}\)</span> and <span class="math notranslate nohighlight">\(W^{FFI}\)</span> are matrices with the same dimensions as the structural connectivity matrix <span class="math notranslate nohighlight">\(C\)</span>, that describe the strengths of long-range excitation and feedforward inhibition.</p></li>
</ul>
<p><img alt="alt text" src="https://www.jneurosci.org/content/jneuro/33/27/11239/F1.large.jpg?width=800&amp;height=600&amp;carousel=1" /></p>
<p>Specifically, in the fist part we are going to use TVB to model the BOLD fMRI timeseries of 1 subect of the <a class="reference external" href="https://www.humanconnectome.org/">Human Connectome Project Database (HCP)</a>. After that we are going to compare simulated and empirical functional connectivity profiles.</p>
<p>In the second part instead we will use <a class="reference external" href="https://github.com/GriffithsLab/whobpyt"><em>WhoBPyT - Whole-Brain Modelling in PyTorch</em></a>, a package that allows you to estimate the parameters of the model using a deep-learning framework</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">del</span> <span class="n">noise</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">scipy.io</span><span class="o">,</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span><span class="o">,</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span><span class="o">,</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">from</span> <span class="nn">nilearn.plotting</span> <span class="kn">import</span> <span class="n">plot_surf</span><span class="p">,</span> <span class="n">plot_surf_stat_map</span><span class="p">,</span> <span class="n">plot_roi</span><span class="p">,</span> <span class="n">plot_anat</span><span class="p">,</span> <span class="n">plot_surf_roi</span>
<span class="kn">from</span> <span class="nn">nilearn.image</span> <span class="kn">import</span> <span class="n">index_img</span>

<span class="kn">from</span> <span class="nn">tvb.simulator.lab</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">tvb.datatypes.time_series</span> <span class="kn">import</span> <span class="n">TimeSeriesRegion</span>
<span class="kn">from</span> <span class="nn">tvb.simulator.lab</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">nilearn</span> <span class="kn">import</span> <span class="n">plotting</span>

<span class="k">def</span> <span class="nf">NormalizeData</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
         <span class="k">return</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">MyRWW</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">ReducedWongWangExcInh</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">dfun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">coupling</span><span class="p">,</span> <span class="n">local_coupling</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="c1"># save the x and H value as attribute on object</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">state</span>
        <span class="n">c_0</span> <span class="o">=</span> <span class="n">coupling</span>
        <span class="n">lc_0</span> <span class="o">=</span> <span class="n">local_coupling</span> <span class="o">*</span> <span class="n">S</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_N</span> <span class="o">*</span> <span class="n">S</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">I_o</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_N</span> <span class="o">*</span> <span class="n">c_0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_N</span> <span class="o">*</span> <span class="n">lc_0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)))</span>
        <span class="c1"># call the default implementation</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MyRWW</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">dfun</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">coupling</span><span class="p">,</span> <span class="n">local_coupling</span><span class="o">=</span><span class="n">local_coupling</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">__</span><span class="p">(</span><span class="n">num</span><span class="p">):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">num</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">run_rww_sim_pcc_test</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">regime</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">simlen</span><span class="p">,</span> <span class="n">noise_term</span><span class="p">):</span>

    <span class="c1"># put regime dict vals into np arrays</span>
    <span class="n">regime</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">__</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">regime</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="c1"># Initialise Simulator.</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">simulator</span><span class="o">.</span><span class="n">Simulator</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">ReducedWongWangExcInh</span><span class="p">(</span><span class="o">**</span><span class="n">regime</span><span class="p">),</span>
        <span class="n">connectivity</span><span class="o">=</span><span class="n">con</span><span class="p">,</span>
        <span class="n">coupling</span><span class="o">=</span><span class="n">coupling</span><span class="o">.</span><span class="n">Scaling</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">__</span><span class="p">(</span><span class="n">G</span><span class="p">)),</span>
<span class="c1">#         mynoise = noise.Additive(nsig=__((D**2)/2),noise_seed=np.random.randint(0,1000)),</span>
        <span class="n">integrator</span><span class="o">=</span><span class="n">integrators</span><span class="o">.</span><span class="n">HeunStochastic</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="n">noise_term</span><span class="p">),</span>
        <span class="n">monitors</span><span class="o">=</span><span class="p">(</span><span class="n">monitors</span><span class="o">.</span><span class="n">TemporalAverage</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mf">1.</span><span class="p">),</span>
                  <span class="n">monitors</span><span class="o">.</span><span class="n">Bold</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mf">2000.0</span><span class="p">),)</span> <span class="c1"># was 200, &#39;twas incorrect, but doesn&#39;t affect S only BOLD</span>
    <span class="p">)</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">initial_conditions</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.3</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">nregions</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="c1">#np.random.rand(nregions,1) #(0.001)*np.ones((1, 1, nregions, 1))</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>


    <span class="c1"># Launch simulation</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">simulation_length</span><span class="o">=</span><span class="n">simlen</span><span class="p">)</span>
    <span class="p">(</span><span class="n">Sts</span><span class="p">,</span> <span class="n">Ss</span><span class="p">),(</span><span class="n">Bts</span><span class="p">,</span><span class="n">Bs</span><span class="p">)</span> <span class="o">=</span> <span class="n">res</span>

    <span class="c1"># Bts and Sts contain 2 sets of data -- one excitatory and one inhibitory? ask JG.</span>
    <span class="c1"># Regardless, you need split the 2 sets of data and store them seprately, as this model uses 2 neuronal popn. types.</span>

    <span class="n">test_Bs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">Bs</span><span class="p">)</span>
    <span class="n">test_Ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">Ss</span><span class="p">)</span>

    <span class="n">df_B_e</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">test_Bs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:]),</span><span class="n">index</span><span class="o">=</span><span class="n">Bts</span><span class="p">)</span>
    <span class="n">df_S_e</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">test_Ss</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:]),</span><span class="n">index</span><span class="o">=</span><span class="n">Sts</span><span class="p">)</span>

    <span class="n">df_B_i</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">test_Bs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:]),</span><span class="n">index</span><span class="o">=</span><span class="n">Bts</span><span class="p">)</span>
    <span class="n">df_S_i</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">test_Ss</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:]),</span><span class="n">index</span><span class="o">=</span><span class="n">Sts</span><span class="p">)</span>

    <span class="c1"># Remove transient time</span>

    <span class="n">_test_Bs_e</span> <span class="o">=</span> <span class="n">Bs</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">simlen</span><span class="o">/</span><span class="mi">2000</span><span class="p">),</span><span class="mi">0</span><span class="p">,:,:]</span>
    <span class="n">_test_Bs_i</span> <span class="o">=</span> <span class="n">Bs</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">simlen</span><span class="o">/</span><span class="mi">2000</span><span class="p">),</span><span class="mi">1</span><span class="p">,:,:]</span>

    <span class="n">_test_Bts</span> <span class="o">=</span> <span class="n">Bts</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">simlen</span><span class="o">/</span><span class="mi">2000</span><span class="p">)]</span>

    <span class="c1"># Build a TimeSeries Datatype</span>
    <span class="n">tsr_e</span> <span class="o">=</span> <span class="n">TimeSeriesRegion</span><span class="p">(</span><span class="n">connectivity</span><span class="o">=</span><span class="n">con</span><span class="p">,</span>
                       <span class="n">data</span><span class="o">=</span><span class="n">_test_Bs_e</span><span class="p">,</span>
                       <span class="n">sample_period</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">monitors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">period</span><span class="p">)</span>

    <span class="n">tsr_i</span> <span class="o">=</span> <span class="n">TimeSeriesRegion</span><span class="p">(</span><span class="n">connectivity</span><span class="o">=</span><span class="n">con</span><span class="p">,</span>
                       <span class="n">data</span><span class="o">=</span><span class="n">_test_Bs_i</span><span class="p">,</span>
                       <span class="n">sample_period</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">monitors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">period</span><span class="p">)</span>
    <span class="n">tsr_e</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>
    <span class="n">tsr_i</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>

    <span class="c1"># Compute FC</span>
    <span class="n">FC_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tsr_e</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">FC_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tsr_i</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="c1">#     savemat(&#39;FC_&#39; + str(G) + &#39;_&#39; + str(simlen) + &#39;.mat&#39;, {&#39;B&#39;: Bs, &#39;FC&#39;: FC})</span>

    <span class="c1"># Take triangular upper part of connectivity matrices and compute pearson correlations</span>
    <span class="n">pcc_FC_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">HCP_FC</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">FC_e</span><span class="p">[</span><span class="n">mask</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">pcc_SC_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">HCP_SC</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">FC_e</span><span class="p">[</span><span class="n">mask</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">pcc_FC_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">HCP_FC</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">FC_i</span><span class="p">[</span><span class="n">mask</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">pcc_SC_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">HCP_SC</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">FC_i</span><span class="p">[</span><span class="n">mask</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1">#return pcc</span>
    <span class="k">return</span> <span class="n">pcc_FC_e</span><span class="p">,</span> <span class="n">pcc_SC_e</span><span class="p">,</span> <span class="n">df_B_e</span><span class="p">,</span> <span class="n">df_S_e</span><span class="p">,</span> <span class="n">tsr_e</span><span class="p">,</span> <span class="n">pcc_FC_i</span><span class="p">,</span> <span class="n">pcc_SC_i</span><span class="p">,</span> <span class="n">df_B_i</span><span class="p">,</span> <span class="n">df_S_i</span><span class="p">,</span> <span class="n">tsr_i</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Authors: Zheng Wang, Davide, Momi, Andrew Clappison, John Griffiths</span>


<span class="sd">emp: length_ts x node_size or data_size x length_ts x node_size</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/content/drive/MyDrive/OHBM_Educational_course/Data/02_Systems_Cognitive/whobpyt/&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">def</span> <span class="nf">dataloader</span><span class="p">(</span><span class="n">emp</span><span class="p">,</span> <span class="n">epoch_size</span><span class="p">,</span> <span class="n">TRperwindow</span><span class="p">):</span>
    <span class="n">window_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">emp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">TRperwindow</span><span class="p">)</span>
    <span class="n">data_out</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">emp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">node_size</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">length_ts</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">window_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">length_ts</span> <span class="o">/</span> <span class="n">TRperwindow</span><span class="p">)</span>
        <span class="n">data_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">epoch_size</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">node_size</span><span class="p">,</span> <span class="n">TRperwindow</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i_epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epoch_size</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i_win</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">window_size</span><span class="p">):</span>
                <span class="n">data_out</span><span class="p">[</span><span class="n">i_epoch</span><span class="p">,</span> <span class="n">i_win</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">T</span><span class="p">[:,</span> <span class="n">i_win</span> <span class="o">*</span> <span class="n">TRperwindow</span><span class="p">:(</span><span class="n">i_win</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">TRperwindow</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">emp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">node_size</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">length_ts</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">data_size</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">window_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">length_ts</span> <span class="o">/</span> <span class="n">TRperwindow</span><span class="p">)</span>
        <span class="n">data_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">epoch_size</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">node_size</span><span class="p">,</span> <span class="n">TRperwindow</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i_epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epoch_size</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i_win</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">window_size</span><span class="p">):</span>
                <span class="n">data_out</span><span class="p">[</span><span class="n">i_epoch</span><span class="p">,</span> <span class="n">i_win</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> \
                    <span class="n">emp</span><span class="p">[</span><span class="n">i_epoch</span> <span class="o">%</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">i_win</span> <span class="o">*</span> <span class="n">TRperwindow</span><span class="p">:(</span><span class="n">i_win</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">TRperwindow</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">data_out</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Neural Mass Model fitting</span>
<span class="sd">module for wong-wang model</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Neural Mass Model fitting</span>
<span class="sd">module for functions used in the model</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>  <span class="c1"># for numerical operations</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.nn.parameter</span> <span class="kn">import</span> <span class="n">Parameter</span>


<span class="k">def</span> <span class="nf">sys2nd</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">A</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">u</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="n">a</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span>


<span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">vmax</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="p">(</span><span class="n">v0</span> <span class="o">-</span> <span class="n">x</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">h_tf</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Neuronal input-output functions of excitatory pools and inhibitory pools.</span>
<span class="sd">    Take the variables a, x, and b and convert them to a linear equation (a*x - b) while adding a small</span>
<span class="sd">    amount of noise 0.00001 while dividing that term to an exponential of the linear equation multiplied by the</span>
<span class="sd">    d constant for the appropriate dimensions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num</span> <span class="o">=</span> <span class="mf">0.00001</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">z</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">den</span> <span class="o">=</span> <span class="mf">0.00001</span> <span class="o">*</span> <span class="n">d</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mf">1.0000</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">d</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">z</span> <span class="o">-</span> <span class="n">b</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">den</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">setModelParameters</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="n">param_reg</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">param_hyper</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;RWW&#39;</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_Gaussian_EI</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">E_m</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.16</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="n">param_hyper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">E_m</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">I_m</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="n">param_hyper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">I_m</span><span class="p">)</span>
            <span class="c1"># model.f_m = Parameter(torch.tensor(1.0, dtype=torch.float32))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">v_m</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="n">param_hyper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">v_m</span><span class="p">)</span>
            <span class="c1"># model.x_m = Parameter(torch.tensor(0.16, dtype=torch.float32))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">q_m</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="n">param_hyper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">q_m</span><span class="p">)</span>

            <span class="n">model</span><span class="o">.</span><span class="n">E_v_inv</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">2500</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="n">param_hyper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">E_v_inv</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">I_v_inv</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">2500</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="n">param_hyper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">I_v_inv</span><span class="p">)</span>
            <span class="c1"># model.f_v = Parameter(torch.tensor(100, dtype=torch.float32))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">v_v_inv</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="n">param_hyper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">v_v_inv</span><span class="p">)</span>
            <span class="c1"># model.x_v = Parameter(torch.tensor(100, dtype=torch.float32))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">q_v_inv</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="n">param_hyper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">v_v_inv</span><span class="p">)</span>

        <span class="c1"># hyper parameters (variables: need to calculate gradient) to fit density</span>
        <span class="c1"># of gEI and gIE (the shape from the bifurcation analysis on an isolated node)</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_Bifurcation</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">sup_ca</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="n">param_hyper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sup_ca</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">sup_cb</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="n">param_hyper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sup_cb</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">sup_cc</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="n">param_hyper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sup_cc</span><span class="p">)</span>

        <span class="c1"># set gains_con as Parameter if fit_gain is True</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_fit_gains</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">gains_con</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span>
                                                     <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>  <span class="c1"># connenction gain to modify empirical sc</span>
            <span class="n">param_reg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">gains_con</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">gains_con</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">vars_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">a</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)))</span>
                <span class="n">param_reg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_Bifurcation</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;std_in&#39;</span><span class="p">,</span> <span class="s1">&#39;g_IE&#39;</span><span class="p">,</span> <span class="s1">&#39;g_EI&#39;</span><span class="p">]:</span>
                        <span class="n">dict_nv</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">}</span>

                        <span class="n">dict_np</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;_m&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;_v_inv&#39;</span><span class="p">}</span>

                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dict_nv</span><span class="p">:</span>
                            <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dict_np</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dict_nv</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)))</span>
                            <span class="n">param_hyper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dict_np</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;std_in&#39;</span><span class="p">]:</span>
                        <span class="n">dict_nv</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">}</span>

                        <span class="n">dict_np</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;_m&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;_v_inv&#39;</span><span class="p">}</span>

                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dict_nv</span><span class="p">:</span>
                            <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dict_np</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dict_nv</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)))</span>
                            <span class="n">param_hyper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dict_np</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">params_fitted</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;modelparameter&#39;</span><span class="p">:</span> <span class="n">param_reg</span><span class="p">,</span><span class="s1">&#39;hyperparameter&#39;</span><span class="p">:</span> <span class="n">param_hyper</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;JR&#39;</span><span class="p">:</span>
        <span class="c1"># set model parameters (variables: need to calculate gradient) as Parameter others : tensor</span>
        <span class="c1"># set w_bb as Parameter if fit_gain is True</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_fit_gains</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">w_bb</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span>
                                                <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>  <span class="c1"># connenction gain to modify empirical sc</span>
            <span class="n">model</span><span class="o">.</span><span class="n">w_ff</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span>
                                                <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">w_ll</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span>
                                                <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="n">param_reg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">w_ll</span><span class="p">)</span>
            <span class="n">param_reg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">w_ff</span><span class="p">)</span>
            <span class="n">param_reg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">w_bb</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">w_bb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">w_ff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">w_ll</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_fit_lfm</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">lm</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lm</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>  <span class="c1"># leadfield matrix from sourced data to eeg</span>
            <span class="n">param_reg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lm</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">lm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lm</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># leadfield matrix from sourced data to eeg</span>

        <span class="n">vars_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">a</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="c1"># print(type(getattr(param, var)[1]))</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;lm&#39;</span><span class="p">:</span>
                        <span class="n">size</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">(</span>
                            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
                                         <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)))</span>
                        <span class="n">param_reg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">size</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">(</span>
                            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                                <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)))</span>
                        <span class="n">param_reg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">))</span>
                        <span class="c1"># print(getattr(self, var))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">(</span>
                        <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                     <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)))</span>
                    <span class="n">param_reg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">var</span> <span class="o">!=</span> <span class="s1">&#39;std_in&#39;</span><span class="p">:</span>
                    <span class="n">dict_nv</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">}</span>

                    <span class="n">dict_np</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;_m&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;_v_inv&#39;</span><span class="p">}</span>

                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dict_nv</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dict_np</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dict_nv</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)))</span>
                        <span class="n">param_hyper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dict_np</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">params_fitted</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;modelparameter&#39;</span><span class="p">:</span> <span class="n">param_reg</span><span class="p">,</span><span class="s1">&#39;hyperparameter&#39;</span><span class="p">:</span> <span class="n">param_hyper</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;LIN&#39;</span><span class="p">:</span>
        <span class="c1"># set gains_con as Parameter if fit_gain is True</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_fit_gains</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">gains_con</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span>
                                                     <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>  <span class="c1"># connenction gain to modify empirical sc</span>
            <span class="n">param_reg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">gains_con</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">gains_con</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">vars_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">a</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)))</span>
                <span class="n">param_reg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;std_in&#39;</span><span class="p">]:</span>
                    <span class="n">dict_nv</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">}</span>

                    <span class="n">dict_np</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;_m&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;_v_inv&#39;</span><span class="p">}</span>

                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dict_nv</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dict_np</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dict_nv</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)))</span>
                        <span class="n">param_hyper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dict_np</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">params_fitted</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;modelparameter&#39;</span><span class="p">:</span> <span class="n">param_reg</span><span class="p">,</span><span class="s1">&#39;hyperparameter&#39;</span><span class="p">:</span> <span class="n">param_hyper</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">integration_forward</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">external</span><span class="p">,</span> <span class="n">hx</span><span class="p">,</span> <span class="n">hE</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;RWW&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forward step in simulating the BOLD signal.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        external: tensor with node_size x steps_per_TR x TRs_per_window x input_size</span>
<span class="sd">            noise for states</span>

<span class="sd">        hx: tensor with node_size x state_size</span>
<span class="sd">            states of WWD model</span>
<span class="sd">        Outputs</span>
<span class="sd">        -------</span>
<span class="sd">        next_state: dictionary with keys:</span>
<span class="sd">        &#39;current_state&#39;&#39;bold_window&#39;&#39;E_window&#39;&#39;I_window&#39;&#39;x_window&#39;&#39;f_window&#39;&#39;v_window&#39;&#39;q_window&#39;</span>
<span class="sd">            record new states and BOLD</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">next_state</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># hx is current state (6) 0: E 1:I (neural activities) 2:x 3:f 4:v 5:f (BOLD)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">step_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Generate the ReLU module for model parameters gEE gEI and gIE</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>

        <span class="c1"># Update the Laplacian based on the updated connection gains gains_con.</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">sc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

            <span class="c1"># Update the Laplacian based on the updated connection gains gains_con.</span>
            <span class="n">sc_mod</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">gains_con</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">sc_mod_normalized</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sc_mod</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">sc_mod</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sc_mod</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">sc_mod</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">sc_fitted</span> <span class="o">=</span> <span class="n">sc_mod_normalized</span>

            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_Laplacian</span><span class="p">:</span>
                <span class="n">lap_adj</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sc_mod_normalized</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">sc_mod_normalized</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lap_adj</span> <span class="o">=</span> <span class="n">sc_mod_normalized</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">lap_adj</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># placeholder for the updated current state</span>
        <span class="n">current_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">hx</span><span class="p">)</span>

        <span class="c1"># placeholders for output BOLD, history of E I x f v and q</span>
        <span class="c1"># placeholders for output BOLD, history of E I x f v and q</span>
        <span class="n">bold_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">))</span>
        <span class="c1"># E_window = torch.zeros((model.node_size,model.TRs_per_window))</span>
        <span class="c1"># I_window = torch.zeros((model.node_size,model.TRs_per_window))</span>

        <span class="n">x_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">))</span>
        <span class="n">f_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">))</span>
        <span class="n">v_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">))</span>
        <span class="n">q_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">))</span>

        <span class="n">E_hist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">steps_per_TR</span><span class="p">))</span>
        <span class="n">I_hist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">steps_per_TR</span><span class="p">))</span>
        <span class="n">E_mean</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">I_mean</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># print(E_m.shape)</span>
        <span class="c1"># Use the forward model to get neural activity at ith element in the window.</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_dynamic_boundary</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">TR_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">):</span>

                <span class="c1"># print(E.shape)</span>

                <span class="c1"># Since tr is about second we need to use a small step size like 0.05 to integrate the model states.</span>
                <span class="k">for</span> <span class="n">step_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">steps_per_TR</span><span class="p">):</span>
                    <span class="n">E</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">sampling_size</span><span class="p">))</span>
                    <span class="n">I</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">sampling_size</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">sample_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sampling_size</span><span class="p">):</span>
                        <span class="n">E</span><span class="p">[:,</span> <span class="n">sample_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">E_mean</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.00</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">)</span>
                        <span class="n">I</span><span class="p">[:,</span> <span class="n">sample_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">I_mean</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.00</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">)</span>

                    <span class="c1"># Calculate the input recurrent.</span>
                    <span class="n">IE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W_E</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">I_0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.001</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g_EE</span><span class="p">))</span> <span class="o">*</span> <span class="n">E</span>
                                      <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">lap_adj</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span>
                                              <span class="mf">0.001</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g_IE</span><span class="p">))</span> <span class="o">*</span> <span class="n">I</span><span class="p">))</span>  <span class="c1"># input currents for E</span>
                    <span class="n">II</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W_I</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">I_0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.001</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g_EI</span><span class="p">))</span> <span class="o">*</span> <span class="n">E</span> <span class="o">-</span> <span class="n">I</span><span class="p">))</span>  <span class="c1"># input currents for I</span>

                    <span class="c1"># Calculate the firing rates.</span>
                    <span class="n">rE</span> <span class="o">=</span> <span class="n">h_tf</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">aE</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">bE</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">dE</span><span class="p">,</span> <span class="n">IE</span><span class="p">)</span>  <span class="c1"># firing rate for E</span>
                    <span class="n">rI</span> <span class="o">=</span> <span class="n">h_tf</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">aI</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">bI</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">dI</span><span class="p">,</span> <span class="n">II</span><span class="p">)</span>  <span class="c1"># firing rate for I</span>
                    <span class="c1"># Update the states by step-size 0.05.</span>
                    <span class="n">E_next</span> <span class="o">=</span> <span class="n">E</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">E</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_E</span><span class="p">)</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">gamma_E</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">E</span><span class="p">)</span> <span class="o">*</span> <span class="n">rE</span><span class="p">)</span> \
                             <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">sampling_size</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.02</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">std_in</span><span class="p">))</span>  <span class="c1">### equlibrim point at E=(tau_E*gamma_E*rE)/(1+tau_E*gamma_E*rE)</span>
                    <span class="n">I_next</span> <span class="o">=</span> <span class="n">I</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">I</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_I</span><span class="p">)</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">gamma_I</span> <span class="o">*</span> <span class="n">rI</span><span class="p">)</span> \
                             <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">sampling_size</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                                     <span class="mf">0.02</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">std_in</span><span class="p">))</span>

                    <span class="c1"># Calculate the saturation for model states (for stability and gradient calculation).</span>

                    <span class="c1"># E_next[E_next&gt;=0.9] = torch.tanh(1.6358*E_next[E_next&gt;=0.9])</span>
                    <span class="n">E</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="mf">0.0000</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">E_next</span><span class="p">))</span>
                    <span class="n">I</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="mf">0.0000</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">I_next</span><span class="p">))</span>

                    <span class="n">I_mean</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                    <span class="n">E_mean</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                    <span class="n">I_mean</span><span class="p">[</span><span class="n">I_mean</span> <span class="o">&lt;</span> <span class="mf">0.00001</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00001</span>
                    <span class="n">E_mean</span><span class="p">[</span><span class="n">E_mean</span> <span class="o">&lt;</span> <span class="mf">0.00001</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00001</span>

                    <span class="n">E_hist</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">,</span> <span class="n">step_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">E_mean</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="n">I_hist</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">,</span> <span class="n">step_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">I_mean</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">TR_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">):</span>

                <span class="k">for</span> <span class="n">step_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">steps_per_TR</span><span class="p">):</span>
                    <span class="n">x_next</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">E_hist</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">,</span> <span class="n">step_i</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">tau_s</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_f</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">f_next</span> <span class="o">=</span> <span class="n">f</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">x</span>
                    <span class="n">v_next</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">alpha</span><span class="p">)))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">tau_0</span><span class="p">)</span>
                    <span class="n">q_next</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span>
                            <span class="n">f</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">f</span><span class="p">)))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">rho</span><span class="p">)</span> <span class="o">-</span> <span class="n">q</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">alpha</span><span class="p">))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> \
                             <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_0</span><span class="p">)</span>

                    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">x_next</span><span class="p">)</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">f_next</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">v_next</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">q_next</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="c1"># Put x f v q from each tr to the placeholders for checking them visually.</span>
                <span class="n">x_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">f_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">v_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">q_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

                <span class="c1"># Put the BOLD signal each tr to the placeholder being used in the cost calculation.</span>

                <span class="n">bold_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mf">0.00</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">std_out</span><span class="p">))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                                        <span class="mf">100.0</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">V</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">E0</span><span class="p">)</span> <span class="o">*</span>
                                        <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">k1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">k2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">q</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">k3</span> <span class="o">*</span> <span class="p">(</span>
                                                <span class="mi">1</span> <span class="o">-</span> <span class="n">v</span><span class="p">)))[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">TR_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">):</span>

                <span class="c1"># print(E.shape)</span>

                <span class="c1"># Since tr is about second we need to use a small step size like 0.05 to integrate the model states.</span>
                <span class="k">for</span> <span class="n">step_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">steps_per_TR</span><span class="p">):</span>
                    <span class="n">E</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">sampling_size</span><span class="p">))</span>
                    <span class="n">I</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">sampling_size</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">sample_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sampling_size</span><span class="p">):</span>
                        <span class="n">E</span><span class="p">[:,</span> <span class="n">sample_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">E_mean</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.02</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">)</span>
                        <span class="n">I</span><span class="p">[:,</span> <span class="n">sample_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">I_mean</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.001</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">)</span>

                    <span class="c1"># Calculate the input recurrent.</span>
                    <span class="n">IE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W_E</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">I_0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.001</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g_EE</span><span class="p">))</span> <span class="o">*</span> <span class="n">E</span> \
                                          <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">lap_adj</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span>
                                                  <span class="mf">0.001</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g_IE</span><span class="p">))</span> <span class="o">*</span> <span class="n">I</span><span class="p">))</span>  <span class="c1"># input currents for E</span>
                    <span class="n">II</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span>
                        <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W_I</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">I_0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.001</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g_EI</span><span class="p">))</span> <span class="o">*</span> <span class="n">E</span> <span class="o">-</span> <span class="n">I</span><span class="p">))</span>  <span class="c1"># input currents for I</span>

                    <span class="c1"># Calculate the firing rates.</span>
                    <span class="n">rE</span> <span class="o">=</span> <span class="n">h_tf</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">aE</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">bE</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">dE</span><span class="p">,</span> <span class="n">IE</span><span class="p">)</span>  <span class="c1"># firing rate for E</span>
                    <span class="n">rI</span> <span class="o">=</span> <span class="n">h_tf</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">aI</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">bI</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">dI</span><span class="p">,</span> <span class="n">II</span><span class="p">)</span>  <span class="c1"># firing rate for I</span>
                    <span class="c1"># Update the states by step-size 0.05.</span>
                    <span class="n">E_next</span> <span class="o">=</span> <span class="n">E</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">E</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_E</span><span class="p">)</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">gamma_E</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">E</span><span class="p">)</span> <span class="o">*</span> <span class="n">rE</span><span class="p">)</span> \
                             <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">sampling_size</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.02</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">std_in</span><span class="p">))</span>  <span class="c1">### equlibrim point at E=(tau_E*gamma_E*rE)/(1+tau_E*gamma_E*rE)</span>
                    <span class="n">I_next</span> <span class="o">=</span> <span class="n">I</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">I</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_I</span><span class="p">)</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">gamma_I</span> <span class="o">*</span> <span class="n">rI</span><span class="p">)</span> \
                             <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">sampling_size</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                                     <span class="mf">0.02</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">std_in</span><span class="p">))</span>

                    <span class="c1"># Calculate the saturation for model states (for stability and gradient calculation).</span>
                    <span class="n">E_next</span><span class="p">[</span><span class="n">E_next</span> <span class="o">&lt;</span> <span class="mf">0.00001</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00001</span>
                    <span class="n">I_next</span><span class="p">[</span><span class="n">I_next</span> <span class="o">&lt;</span> <span class="mf">0.00001</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00001</span>
                    <span class="c1"># E_next[E_next&gt;=0.9] = torch.tanh(1.6358*E_next[E_next&gt;=0.9])</span>
                    <span class="n">E</span> <span class="o">=</span> <span class="n">E_next</span>  <span class="c1"># torch.tanh(0.00001+m(1.0*E_next))</span>
                    <span class="n">I</span> <span class="o">=</span> <span class="n">I_next</span>  <span class="c1"># torch.tanh(0.00001+m(1.0*I_next))</span>

                    <span class="n">I_mean</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                    <span class="n">E_mean</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                    <span class="n">E_hist</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">,</span> <span class="n">step_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">E_mean</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="n">I_hist</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">,</span> <span class="n">step_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">I_mean</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>

                <span class="c1"># E_window[:,TR_i]=E_mean[:,0]</span>
                <span class="c1"># I_window[:,TR_i]=I_mean[:,0]</span>

            <span class="k">for</span> <span class="n">TR_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">):</span>

                <span class="k">for</span> <span class="n">step_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">steps_per_TR</span><span class="p">):</span>
                    <span class="n">x_next</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">E_hist</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">,</span> <span class="n">step_i</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">tau_s</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_f</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">f_next</span> <span class="o">=</span> <span class="n">f</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">x</span>
                    <span class="n">v_next</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">alpha</span><span class="p">)))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">tau_0</span><span class="p">)</span>
                    <span class="n">q_next</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span>
                            <span class="n">f</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">f</span><span class="p">)))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">rho</span><span class="p">)</span> <span class="o">-</span> <span class="n">q</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">alpha</span><span class="p">))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> \
                             <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_0</span><span class="p">)</span>

                    <span class="n">f_next</span><span class="p">[</span><span class="n">f_next</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.001</span>
                    <span class="n">v_next</span><span class="p">[</span><span class="n">v_next</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.001</span>
                    <span class="n">q_next</span><span class="p">[</span><span class="n">q_next</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.001</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">x_next</span>  <span class="c1"># torch.tanh(x_next)</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">f_next</span>  <span class="c1"># (1 + torch.tanh(f_next - 1))</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">v_next</span>  <span class="c1"># (1 + torch.tanh(v_next - 1))</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="n">q_next</span>  <span class="c1"># (1 + torch.tanh(q_next - 1))</span>
                <span class="c1"># Put x f v q from each tr to the placeholders for checking them visually.</span>
                <span class="n">x_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">f_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">v_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">q_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Put the BOLD signal each tr to the placeholder being used in the cost calculation.</span>

                <span class="n">bold_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mf">0.00</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">std_out</span><span class="p">))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                                        <span class="mf">100.0</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">V</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span>
                            <span class="n">model</span><span class="o">.</span><span class="n">E0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">k1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">k2</span> <span class="o">*</span> <span class="p">(</span>
                                <span class="mi">1</span> <span class="o">-</span> <span class="n">q</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">k3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">v</span><span class="p">)))[:,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Update the current state.</span>
        <span class="c1"># print(E_m.shape)</span>
        <span class="n">current_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">E_mean</span><span class="p">,</span> <span class="n">I_mean</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">q</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;current_state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_state</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;bold_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bold_window</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;E_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">E_hist</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;I_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">I_hist</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;x_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_window</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;f_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f_window</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;v_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_window</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;q_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_window</span>

        <span class="k">return</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">hE</span>

    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;JR&#39;</span><span class="p">:</span>

        <span class="c1"># define some constants</span>
        <span class="n">conduct_lb</span> <span class="o">=</span> <span class="mf">1.5</span>  <span class="c1"># lower bound for conduct velocity</span>
        <span class="n">u_2ndsys_ub</span> <span class="o">=</span> <span class="mi">500</span>  <span class="c1"># the bound of the input for second order system</span>
        <span class="n">noise_std_lb</span> <span class="o">=</span> <span class="mi">150</span>  <span class="c1"># lower bound of std of noise</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># lower bound of local gains</span>
        <span class="n">s2o_coef</span> <span class="o">=</span> <span class="mf">0.0001</span>  <span class="c1"># coefficient from states (source EEG) to EEG</span>
        <span class="n">k_lb</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># lower bound of coefficient of external inputs</span>

        <span class="n">next_state</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">M</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># current of main population</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># current of excitory population</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># current of inhibitory population</span>

        <span class="n">Mv</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>  <span class="c1"># voltage of main population</span>
        <span class="n">Ev</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>  <span class="c1"># voltage of exictory population</span>
        <span class="n">Iv</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>  <span class="c1"># voltage of inhibitory population</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">step_size</span>
        <span class="c1"># Generate the ReLU module for model parameters gEE gEI and gIE</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>

        <span class="c1"># define constant 1 tensor</span>
        <span class="n">con_1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">sc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

            <span class="c1"># Update the Laplacian based on the updated connection gains w_bb.</span>
            <span class="n">w_b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">w_bb</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">w_n_b</span> <span class="o">=</span> <span class="n">w_b</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">w_b</span><span class="p">)</span>

            <span class="n">model</span><span class="o">.</span><span class="n">sc_m_b</span> <span class="o">=</span> <span class="n">w_n_b</span>
            <span class="n">dg_b</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w_n_b</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="c1"># Update the Laplacian based on the updated connection gains w_bb.</span>
            <span class="n">w_f</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">w_ff</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">w_n_f</span> <span class="o">=</span> <span class="n">w_f</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">w_f</span><span class="p">)</span>

            <span class="n">model</span><span class="o">.</span><span class="n">sc_m_f</span> <span class="o">=</span> <span class="n">w_n_f</span>
            <span class="n">dg_f</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w_n_f</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="c1"># Update the Laplacian based on the updated connection gains w_bb.</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">w_ll</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">w_n_l</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">w</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">w</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

            <span class="n">model</span><span class="o">.</span><span class="n">sc_fitted</span> <span class="o">=</span> <span class="n">w_n_l</span>
            <span class="n">dg_l</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w_n_l</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l_s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">dg_l</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">dg_b</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">dg_f</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">w_n_l</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">w_n_b</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">w_n_f</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">model</span><span class="o">.</span><span class="n">delays</span> <span class="o">=</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">dist</span> <span class="o">/</span> <span class="p">(</span><span class="n">conduct_lb</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">mu</span><span class="p">)))</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="c1"># print(torch.max(model.delays), model.delays.shape)</span>

        <span class="c1"># placeholder for the updated current state</span>
        <span class="n">current_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">hx</span><span class="p">)</span>

        <span class="c1"># placeholders for output BOLD, history of E I x f v and q</span>
        <span class="n">eeg_window</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">E_window</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">I_window</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">M_window</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Ev_window</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Iv_window</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Mv_window</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Use the forward model to get EEG signal at ith element in the window.</span>
        <span class="k">for</span> <span class="n">i_window</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">):</span>

            <span class="k">for</span> <span class="n">step_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">steps_per_TR</span><span class="p">):</span>
                <span class="n">Ed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># delayed E</span>

<span class="w">                </span><span class="sd">&quot;&quot;&quot;for ind in range(model.node_size):</span>
<span class="sd">                    #print(ind, hE[ind,:].shape, model.delays[ind,:].shape)</span>
<span class="sd">                    Ed[ind] = torch.index_select(hE[ind,:], 0, model.delays[ind,:])&quot;&quot;&quot;</span>
                <span class="n">hE_new</span> <span class="o">=</span> <span class="n">hE</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                <span class="n">Ed</span> <span class="o">=</span> <span class="n">hE_new</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">delays</span><span class="p">)</span>  <span class="c1"># delayed E</span>

                <span class="n">LEd_b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w_n_b</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Ed</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
                                      <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># weights on delayed E</span>
                <span class="n">LEd_f</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w_n_f</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Ed</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
                                      <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># weights on delayed E</span>
                <span class="n">LEd_l</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w_n_l</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Ed</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
                                      <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># weights on delayed E</span>
                <span class="c1"># Input noise for M.</span>

                <span class="n">u_tms</span> <span class="o">=</span> <span class="n">external</span><span class="p">[:,</span> <span class="n">step_i</span><span class="p">:</span><span class="n">step_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i_window</span><span class="p">]</span>
                <span class="c1">#u_aud = external[:, i_hidden:i_hidden + 1, i_window, 1]</span>
                <span class="c1">#u_0 = external[:, i_hidden:i_hidden + 1, i_window, 2]</span>

                <span class="c1"># LEd+torch.matmul(dg,E): Laplacian on delayed E</span>

                <span class="n">rM</span> <span class="o">=</span> <span class="p">(</span><span class="n">k_lb</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">ki</span> <span class="o">*</span> <span class="n">u_tms</span> <span class="o">+</span> \
                     <span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">std_in</span><span class="p">))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> \
                     <span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">lb</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span>
                             <span class="n">LEd_l</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">dg_l</span><span class="p">,</span> <span class="n">M</span><span class="p">))</span> <span class="o">+</span> \
                     <span class="n">sigmoid</span><span class="p">(</span><span class="n">E</span> <span class="o">-</span> <span class="n">I</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">vmax</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">v0</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>  <span class="c1"># firing rate for Main population</span>
                <span class="n">rE</span> <span class="o">=</span> <span class="p">(</span><span class="mf">.1</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">std_in</span><span class="p">))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> \
                     <span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">lb</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g_f</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">LEd_f</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">dg_f</span><span class="p">,</span> <span class="n">E</span> <span class="o">-</span> <span class="n">I</span><span class="p">))</span> <span class="o">+</span> \
                     <span class="p">(</span><span class="n">lb</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">c2</span><span class="p">))</span> <span class="o">*</span> <span class="n">sigmoid</span><span class="p">((</span><span class="n">lb</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">c1</span><span class="p">))</span> <span class="o">*</span> <span class="n">M</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">vmax</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">v0</span><span class="p">,</span>
                                                          <span class="n">model</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>  <span class="c1"># firing rate for Excitory population</span>
                <span class="n">rI</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">std_in</span><span class="p">))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> \
                     <span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">lb</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g_b</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">LEd_b</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">dg_b</span><span class="p">,</span> <span class="n">E</span> <span class="o">-</span> <span class="n">I</span><span class="p">))</span> <span class="o">+</span> \
                     <span class="p">(</span><span class="n">lb</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">c4</span><span class="p">))</span> <span class="o">*</span> <span class="n">sigmoid</span><span class="p">((</span><span class="n">lb</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">c3</span><span class="p">))</span> <span class="o">*</span> <span class="n">M</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">vmax</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">v0</span><span class="p">,</span>
                                                          <span class="n">model</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>  <span class="c1"># firing rate for Inhibitory population</span>

                <span class="c1"># Update the states by step-size.</span>
                <span class="n">ddM</span> <span class="o">=</span> <span class="n">M</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">Mv</span>
                <span class="n">ddE</span> <span class="o">=</span> <span class="n">E</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">Ev</span>
                <span class="n">ddI</span> <span class="o">=</span> <span class="n">I</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">Iv</span>
                <span class="n">ddMv</span> <span class="o">=</span> <span class="n">Mv</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">sys2nd</span><span class="p">(</span><span class="mi">0</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">),</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span>
                                        <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">a</span><span class="p">),</span>
                                        <span class="n">u_2ndsys_ub</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">rM</span> <span class="o">/</span> <span class="n">u_2ndsys_ub</span><span class="p">),</span> <span class="n">M</span><span class="p">,</span> <span class="n">Mv</span><span class="p">)</span>

                <span class="n">ddEv</span> <span class="o">=</span> <span class="n">Ev</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">sys2nd</span><span class="p">(</span><span class="mi">0</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">),</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span>
                                        <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">a</span><span class="p">),</span>
                                        <span class="n">u_2ndsys_ub</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">rE</span> <span class="o">/</span> <span class="n">u_2ndsys_ub</span><span class="p">),</span> <span class="n">E</span><span class="p">,</span> <span class="n">Ev</span><span class="p">)</span>

                <span class="n">ddIv</span> <span class="o">=</span> <span class="n">Iv</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">sys2nd</span><span class="p">(</span><span class="mi">0</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">B</span><span class="p">),</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">b</span><span class="p">),</span>
                                        <span class="n">u_2ndsys_ub</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">rI</span> <span class="o">/</span> <span class="n">u_2ndsys_ub</span><span class="p">),</span> <span class="n">I</span><span class="p">,</span> <span class="n">Iv</span><span class="p">)</span>

                <span class="c1"># Calculate the saturation for model states (for stability and gradient calculation).</span>
                <span class="n">E</span> <span class="o">=</span> <span class="n">ddE</span>  <span class="c1"># 1000*torch.tanh(ddE/1000)#torch.tanh(0.00001+torch.nn.functional.relu(ddE))</span>
                <span class="n">I</span> <span class="o">=</span> <span class="n">ddI</span>  <span class="c1"># 1000*torch.tanh(ddI/1000)#torch.tanh(0.00001+torch.nn.functional.relu(ddI))</span>
                <span class="n">M</span> <span class="o">=</span> <span class="n">ddM</span>  <span class="c1"># 1000*torch.tanh(ddM/1000)</span>
                <span class="n">Ev</span> <span class="o">=</span> <span class="n">ddEv</span>  <span class="c1"># 1000*torch.tanh(ddEv/1000)#(con_1 + torch.tanh(df - con_1))</span>
                <span class="n">Iv</span> <span class="o">=</span> <span class="n">ddIv</span>  <span class="c1"># 1000*torch.tanh(ddIv/1000)#(con_1 + torch.tanh(dv - con_1))</span>
                <span class="n">Mv</span> <span class="o">=</span> <span class="n">ddMv</span>  <span class="c1"># 1000*torch.tanh(ddMv/1000)#(con_1 + torch.tanh(dq - con_1))</span>

                <span class="c1"># update placeholders for E buffer</span>
                <span class="n">hE</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="c1"># hE = torch.cat([M, hE[:, :-1]], axis=1)</span>

            <span class="c1"># Put M E I Mv Ev and Iv at every tr to the placeholders for checking them visually.</span>
            <span class="n">M_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
            <span class="n">I_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
            <span class="n">E_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
            <span class="n">Mv_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mv</span><span class="p">)</span>
            <span class="n">Iv_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Iv</span><span class="p">)</span>
            <span class="n">Ev_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ev</span><span class="p">)</span>
            <span class="n">hE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">M</span><span class="p">,</span> <span class="n">hE</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># update placeholders for E buffer</span>

            <span class="c1"># Put the EEG signal each tr to the placeholder being used in the cost calculation.</span>
            <span class="n">lm_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lm</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lm</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

            <span class="n">model</span><span class="o">.</span><span class="n">lm_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">lm_t</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">model</span><span class="o">.</span><span class="n">output_size</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">output_size</span><span class="p">)),</span>
                                                                      <span class="n">lm_t</span><span class="p">))</span>  <span class="c1"># s2o_coef *</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">cy0</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lm_t</span><span class="p">,</span> <span class="n">M</span><span class="p">[:</span><span class="mi">200</span><span class="p">,</span> <span class="p">:])</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">y0</span>
            <span class="n">eeg_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>  <span class="c1"># torch.abs(E) - torch.abs(I) + 0.0*noiseEEG)</span>

        <span class="c1"># Update the current state.</span>
        <span class="n">current_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">M</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">Mv</span><span class="p">,</span> <span class="n">Ev</span><span class="p">,</span> <span class="n">Iv</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;current_state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_state</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;eeg_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">eeg_window</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;E_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">E_window</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;I_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">I_window</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;P_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">M_window</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;Ev_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">Ev_window</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;Iv_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">Iv_window</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;Pv_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">Mv_window</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">hE</span>

    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;LIN&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forward step in simulating the BOLD signal.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        external: tensor with node_size x steps_per_TR x TRs_per_window x input_size</span>
<span class="sd">            noise for states</span>

<span class="sd">        hx: tensor with node_size x state_size</span>
<span class="sd">            states of WWD model</span>
<span class="sd">        Outputs</span>
<span class="sd">        -------</span>
<span class="sd">        next_state: dictionary with keys:</span>
<span class="sd">        &#39;current_state&#39;&#39;bold_window&#39;&#39;E_window&#39;&#39;I_window&#39;&#39;x_window&#39;&#39;f_window&#39;&#39;v_window&#39;&#39;q_window&#39;</span>
<span class="sd">            record new states and BOLD</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">next_state</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># hx is current state (6) 0: E 1:I (neural activities) 2:x 3:f 4:v 5:f (BOLD)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">step_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Generate the ReLU module for model parameters gEE gEI and gIE</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>

        <span class="c1"># Update the Laplacian based on the updated connection gains gains_con.</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">sc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

            <span class="c1"># Update the Laplacian based on the updated connection gains gains_con.</span>
            <span class="n">sc_mod</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">gains_con</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">sc_mod_normalized</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sc_mod</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">sc_mod</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sc_mod</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">sc_mod</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">sc_fitted</span> <span class="o">=</span> <span class="n">sc_mod_normalized</span>

            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_Laplacian</span><span class="p">:</span>
                <span class="n">lap_adj</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sc_mod_normalized</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">sc_mod_normalized</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lap_adj</span> <span class="o">=</span> <span class="n">sc_mod_normalized</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">lap_adj</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># placeholder for the updated current state</span>
        <span class="n">current_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">hx</span><span class="p">)</span>

        <span class="c1"># placeholders for output BOLD, history of E I x f v and q</span>
        <span class="c1"># placeholders for output BOLD, history of E I x f v and q</span>
        <span class="n">bold_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">))</span>
        <span class="n">E_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">))</span>
        <span class="c1"># I_window = torch.zeros((model.node_size,model.TRs_per_window))</span>

        <span class="n">x_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">))</span>
        <span class="n">f_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">))</span>
        <span class="n">v_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">))</span>
        <span class="n">q_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">))</span>

        <span class="c1"># E_hist = torch.zeros((model.node_size, model.TRs_per_window, model.steps_per_TR))</span>

        <span class="n">E</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># print(E_m.shape)</span>
        <span class="c1"># Use the forward model to get neural activity at ith element in the window.</span>

        <span class="k">for</span> <span class="n">TR_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">):</span>

            <span class="c1"># print(E.shape)</span>

            <span class="c1"># Since tr is about second we need to use a small step size like 0.05 to integrate the model states.</span>
            <span class="k">for</span> <span class="n">step_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">steps_per_TR</span><span class="p">):</span>
                <span class="c1"># Calculate the input recurrents.</span>
                <span class="n">IE</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">lap_adj</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span>  <span class="c1"># input currents for E</span>

                <span class="n">E_next</span> <span class="o">=</span> <span class="n">E</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">E</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">IE</span><span class="p">))</span> \
                         <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">std_in</span><span class="p">))</span>  <span class="c1">### equlibrim point at E=(tau_E*gamma_E*rE)/(1+tau_E*gamma_E*rE)</span>

                <span class="n">x_next</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">E</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_s</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_f</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">f_next</span> <span class="o">=</span> <span class="n">f</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">x</span>
                <span class="n">v_next</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">alpha</span><span class="p">)))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_0</span><span class="p">)</span>
                <span class="n">q_next</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="n">f</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">f</span><span class="p">)))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">rho</span><span class="p">)</span>
                        <span class="o">-</span> <span class="n">q</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">alpha</span><span class="p">))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> \
                         <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_0</span><span class="p">)</span>

                <span class="c1"># f_next[f_next &lt; 0.001] = 0.001</span>
                <span class="c1"># v_next[v_next &lt; 0.001] = 0.001</span>
                <span class="c1"># q_next[q_next &lt; 0.001] = 0.001</span>

                <span class="n">E</span> <span class="o">=</span> <span class="n">E_next</span>  <span class="c1"># torch.tanh(0.00001+1.0*E_next)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x_next</span>  <span class="c1"># torch.tanh(x_next)</span>
                <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">f_next</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">v_next</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">q_next</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="c1"># Put x f v q from each tr to the placeholders for checking them visually.</span>
            <span class="n">E_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">E</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">x_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">f_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">v_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">q_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Put the BOLD signal each tr to the placeholder being used in the cost calculation.</span>

            <span class="n">bold_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mf">0.001</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">std_out</span><span class="p">))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                                    <span class="mf">100.0</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">V</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">E0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">k1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">q</span><span class="p">)</span>
                                                                                    <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">k2</span> <span class="o">*</span> <span class="p">(</span>
                                                                                            <span class="mi">1</span> <span class="o">-</span> <span class="n">q</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span>
                                                                                        <span class="n">v</span><span class="p">))</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">k3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">v</span><span class="p">)))[:,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Update the current state.</span>
        <span class="c1"># print(E_m.shape)</span>
        <span class="n">current_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">E</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">q</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;current_state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_state</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;bold_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bold_window</span>  <span class="c1"># E_window#</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;E_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">E_window</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;x_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_window</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;f_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f_window</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;v_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_window</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;q_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_window</span>

        <span class="k">return</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">hE</span>

<span class="k">class</span> <span class="nc">ParamsModel</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">param</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;g&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">]}</span>

        <span class="k">if</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;RWW&#39;</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="p">{</span>

                <span class="s2">&quot;std_in&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.02</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># standard deviation of the Gaussian noise</span>
                <span class="s2">&quot;std_out&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.02</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># standard deviation of the Gaussian noise</span>
                <span class="c1"># Parameters for the ODEs</span>
                <span class="c1"># Excitatory population</span>
                <span class="s2">&quot;W_E&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># scale of the external input</span>
                <span class="s2">&quot;tau_E&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">100.</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># decay time</span>
                <span class="s2">&quot;gamma_E&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.641</span> <span class="o">/</span> <span class="mf">1000.</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># other dynamic parameter (?)</span>

                <span class="c1"># Inhibitory population</span>
                <span class="s2">&quot;W_I&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># scale of the external input</span>
                <span class="s2">&quot;tau_I&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">10.</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># decay time</span>
                <span class="s2">&quot;gamma_I&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.</span> <span class="o">/</span> <span class="mf">1000.</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># other dynamic parameter (?)</span>

                <span class="c1"># External input</span>
                <span class="s2">&quot;I_0&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.32</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># external input</span>
                <span class="s2">&quot;I_external&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># external stimulation</span>

                <span class="c1"># Coupling parameters</span>
                <span class="s2">&quot;g&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">20.</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># global coupling (from all nodes E_j to single node E_i)</span>
                <span class="s2">&quot;g_EE&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># local self excitatory feedback (from E_i to E_i)</span>
                <span class="s2">&quot;g_IE&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># local inhibitory coupling (from I_i to E_i)</span>
                <span class="s2">&quot;g_EI&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># local excitatory coupling (from E_i to I_i)</span>

                <span class="s2">&quot;aE&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">310</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;bE&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">125</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;dE&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.16</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;aI&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">615</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;bI&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">177</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;dI&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.087</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>

                <span class="c1"># Output (BOLD signal)</span>

                <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.32</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;rho&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.34</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;k1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.38</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;k2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;k3&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.48</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># adjust this number from 0.48 for BOLD fluctruate around zero</span>
                <span class="s2">&quot;V&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">.02</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;E0&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.34</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;tau_s&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="mf">0.65</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;tau_f&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="mf">0.41</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;tau_0&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.98</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;mu&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;JR&quot;</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;A &quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.25</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">22</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;g&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;c1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">135</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="s2">&quot;c2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">135</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="s2">&quot;c3 &quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">135</span> <span class="o">*</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="s2">&quot;c4&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">135</span> <span class="o">*</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
                <span class="s2">&quot;std_in&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;vmax&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;v0&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.56</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;y0&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;mu&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;cy0&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;ki&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">param</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">RNNRWW</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A module for forward model (WWD) to simulate a window of BOLD signals</span>
<span class="sd">    Attibutes</span>
<span class="sd">    ---------</span>
<span class="sd">    state_size : int</span>
<span class="sd">        the number of states in the WWD model</span>
<span class="sd">    input_size : int</span>
<span class="sd">        the number of states with noise as input</span>
<span class="sd">    tr : float</span>
<span class="sd">        tr of fMRI image</span>
<span class="sd">    step_size: float</span>
<span class="sd">        Integration step for forward model</span>
<span class="sd">    steps_per_TR: int</span>
<span class="sd">        the number of step_size in a tr</span>
<span class="sd">    TRs_per_window: int</span>
<span class="sd">        the number of BOLD signals to simulate</span>
<span class="sd">    node_size: int</span>
<span class="sd">        the number of ROIs</span>
<span class="sd">    sc: float node_size x node_size array</span>
<span class="sd">        structural connectivity</span>
<span class="sd">    fit_gains: bool</span>
<span class="sd">        flag for fitting gains 1: fit 0: not fit</span>
<span class="sd">    g, g_EE, gIE, gEI: tensor with gradient on</span>
<span class="sd">        model parameters to be fit</span>
<span class="sd">    gains_con: tensor with node_size x node_size (grad on depends on fit_gains)</span>
<span class="sd">        connection gains exp(gains_con)*sc</span>
<span class="sd">    std_in std_out: tensor with gradient on</span>
<span class="sd">        std for state noise and output noise</span>
<span class="sd">    g_m g_v f_EE_m g_EE_v sup_ca sup_cb sup_cc: tensor with gradient on</span>
<span class="sd">        hyper parameters for prior distribution of g gEE gIE and gEI</span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    forward(input, external, hx, hE)</span>
<span class="sd">        forward model (WWD) for generating a number of BOLD signals with current model parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">state_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">]</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;RWW&quot;</span>
    <span class="n">use_fit_lfm</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">input_size</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">TRs_per_window</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">step_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sampling_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">tr</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sc</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">use_fit_gains</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                 <span class="n">param</span><span class="p">:</span> <span class="n">ParamsModel</span><span class="p">,</span> <span class="n">use_Bifurcation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_Gaussian_EI</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_Laplacian</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">use_dynamic_boundary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        tr : float</span>
<span class="sd">            tr of fMRI image</span>
<span class="sd">        step_size: float</span>
<span class="sd">            Integration step for forward model</span>
<span class="sd">        TRs_per_window: int</span>
<span class="sd">            the number of BOLD signals to simulate</span>
<span class="sd">        node_size: int</span>
<span class="sd">            the number of ROIs</span>
<span class="sd">        sc: float node_size x node_size array</span>
<span class="sd">            structural connectivity</span>
<span class="sd">        use_fit_gains: bool</span>
<span class="sd">            flag for fitting gains 1: fit 0: not fit</span>
<span class="sd">        use_Laplacian: bool</span>
<span class="sd">            using Laplacian or not</span>
<span class="sd">        param: ParamsModel</span>
<span class="sd">            define model parameters(var:0 constant var:non-zero Parameter)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RNNRWW</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_size</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># 6 states WWD model</span>
        <span class="c1"># self.input_size = input_size  # 1 or 2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span>  <span class="c1"># tr fMRI image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_size</span> <span class="o">=</span> <span class="n">step_size</span>  <span class="c1"># integration step 0.05</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps_per_TR</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tr</span> <span class="o">/</span> <span class="n">step_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TRs_per_window</span> <span class="o">=</span> <span class="n">TRs_per_window</span>  <span class="c1"># size of the batch used at each step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_size</span> <span class="o">=</span> <span class="n">node_size</span>  <span class="c1"># num of ROI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sampling_size</span> <span class="o">=</span> <span class="n">sampling_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sc</span> <span class="o">=</span> <span class="n">sc</span>  <span class="c1"># matrix node_size x node_size structure connectivity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sc_fitted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># placeholder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_fit_gains</span> <span class="o">=</span> <span class="n">use_fit_gains</span>  <span class="c1"># flag for fitting gains</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_Laplacian</span> <span class="o">=</span> <span class="n">use_Laplacian</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_Bifurcation</span> <span class="o">=</span> <span class="n">use_Bifurcation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_Gaussian_EI</span> <span class="o">=</span> <span class="n">use_Gaussian_EI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_dynamic_boundary</span> <span class="o">=</span> <span class="n">use_dynamic_boundary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="n">param</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">node_size</span>  <span class="c1"># number of EEG channels</span>

    <span class="k">def</span> <span class="nf">setModelParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># set states E I f v mean and 1/sqrt(variance)</span>
        <span class="k">return</span> <span class="n">setModelParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external</span><span class="p">,</span> <span class="n">hx</span><span class="p">,</span> <span class="n">hE</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">integration_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external</span><span class="p">,</span> <span class="n">hx</span><span class="p">,</span> <span class="n">hE</span><span class="p">)</span>



<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Neural Mass Model fitting</span>
<span class="sd">module for cost calculation</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>  <span class="c1"># for numerical operations</span>
<span class="kn">import</span> <span class="nn">torch</span>


<span class="k">class</span> <span class="nc">Costs</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>

    <span class="k">def</span> <span class="nf">cost_dist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="n">emp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the Pearson Correlation between the simFC and empFC.</span>
<span class="sd">        From there, the probability and negative log-likelihood.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sim: tensor with node_size X datapoint</span>
<span class="sd">            simulated EEG</span>
<span class="sd">        emp: tensor with node_size X datapoint</span>
<span class="sd">            empirical EEG</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">losses</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">sim</span> <span class="o">-</span> <span class="n">emp</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1">#</span>
        <span class="k">return</span> <span class="n">losses</span>

    <span class="k">def</span> <span class="nf">cost_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logits_series_tf</span><span class="p">,</span> <span class="n">labels_series_tf</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the Pearson Correlation between the simFC and empFC.</span>
<span class="sd">        From there, the probability and negative log-likelihood.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        logits_series_tf: tensor with node_size X datapoint</span>
<span class="sd">            simulated BOLD</span>
<span class="sd">        labels_series_tf: tensor with node_size X datapoint</span>
<span class="sd">            empirical BOLD</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get node_size() and TRs_per_window()</span>
        <span class="n">node_size</span> <span class="o">=</span> <span class="n">logits_series_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">truncated_backprop_length</span> <span class="o">=</span> <span class="n">logits_series_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># remove mean across time</span>
        <span class="n">labels_series_tf_n</span> <span class="o">=</span> <span class="n">labels_series_tf</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">labels_series_tf</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                                              <span class="p">[</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>  <span class="c1"># - torch.matmul(</span>

        <span class="n">logits_series_tf_n</span> <span class="o">=</span> <span class="n">logits_series_tf</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logits_series_tf</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                                              <span class="p">[</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>  <span class="c1"># - torch.matmul(</span>

        <span class="c1"># correlation</span>
        <span class="n">cov_sim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">logits_series_tf_n</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">logits_series_tf_n</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">cov_def</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">labels_series_tf_n</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">labels_series_tf_n</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># fc for sim and empirical BOLDs</span>
        <span class="n">FC_sim_T</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov_sim</span><span class="p">)))),</span> <span class="n">cov_sim</span><span class="p">),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov_sim</span><span class="p">)))))</span>
        <span class="n">FC_T</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov_def</span><span class="p">)))),</span> <span class="n">cov_def</span><span class="p">),</span>
                            <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov_def</span><span class="p">)))))</span>

        <span class="c1"># mask for lower triangle without diagonal</span>
        <span class="n">ones_tri</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">FC_T</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">zeros</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">FC_T</span><span class="p">)</span>  <span class="c1"># create a tensor all ones</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">ones_tri</span><span class="p">,</span> <span class="n">zeros</span><span class="p">)</span>  <span class="c1"># boolean tensor, mask[i] = True iff x[i] &gt; 1</span>

        <span class="c1"># mask out fc to vector with elements of the lower triangle</span>
        <span class="n">FC_tri_v</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">FC_T</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="n">FC_sim_tri_v</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">FC_sim_T</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>

        <span class="c1"># remove the mean across the elements</span>
        <span class="n">FC_v</span> <span class="o">=</span> <span class="n">FC_tri_v</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">FC_tri_v</span><span class="p">)</span>
        <span class="n">FC_sim_v</span> <span class="o">=</span> <span class="n">FC_sim_tri_v</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">FC_sim_tri_v</span><span class="p">)</span>

        <span class="c1"># corr_coef</span>
        <span class="n">corr_FC</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">FC_v</span><span class="p">,</span> <span class="n">FC_sim_v</span><span class="p">))</span> \
                  <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">FC_v</span><span class="p">,</span> <span class="n">FC_v</span><span class="p">))))</span> \
                  <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">FC_sim_v</span><span class="p">,</span> <span class="n">FC_sim_v</span><span class="p">))))</span>

        <span class="c1"># use surprise: corr to calculate probability and -log</span>
        <span class="n">losses_corr</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.5000</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">corr_FC</span><span class="p">)</span>  <span class="c1"># torch.mean((FC_v -FC_sim_v)**2)#</span>
        <span class="k">return</span> <span class="n">losses_corr</span>

    <span class="k">def</span> <span class="nf">cost_eff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="n">emp</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">next_window</span><span class="p">):</span>
        <span class="c1"># define some constants</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="mf">0.001</span>

        <span class="n">w_cost</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="c1"># define the relu function</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>

        <span class="n">exclude_param</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_fit_gains</span><span class="p">:</span>
            <span class="n">exclude_param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;gains_con&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;JR&quot;</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">use_fit_lfm</span><span class="p">:</span>
            <span class="n">exclude_param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;lm&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">loss_main</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_dist</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">emp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loss_main</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_r</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">emp</span><span class="p">)</span>
        <span class="n">loss_EI</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;RWW&#39;</span><span class="p">:</span>
            <span class="n">E_window</span> <span class="o">=</span> <span class="n">next_window</span><span class="p">[</span><span class="s1">&#39;E_window&#39;</span><span class="p">]</span>
            <span class="n">I_window</span> <span class="o">=</span> <span class="n">next_window</span><span class="p">[</span><span class="s1">&#39;I_window&#39;</span><span class="p">]</span>
            <span class="n">f_window</span> <span class="o">=</span> <span class="n">next_window</span><span class="p">[</span><span class="s1">&#39;f_window&#39;</span><span class="p">]</span>
            <span class="n">v_window</span> <span class="o">=</span> <span class="n">next_window</span><span class="p">[</span><span class="s1">&#39;v_window&#39;</span><span class="p">]</span>
            <span class="n">x_window</span> <span class="o">=</span> <span class="n">next_window</span><span class="p">[</span><span class="s1">&#39;x_window&#39;</span><span class="p">]</span>
            <span class="n">q_window</span> <span class="o">=</span> <span class="n">next_window</span><span class="p">[</span><span class="s1">&#39;q_window&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_Gaussian_EI</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">use_Bifurcation</span><span class="p">:</span>
                <span class="n">loss_EI</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">E_v_inv</span> <span class="o">*</span> <span class="p">(</span><span class="n">E_window</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">E_m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> \
                          <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">E_v_inv</span><span class="p">))</span> <span class="o">+</span> \
                          <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">I_v_inv</span> <span class="o">*</span> <span class="p">(</span><span class="n">I_window</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">I_m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> \
                          <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">I_v_inv</span><span class="p">))</span> <span class="o">+</span> \
                          <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">q_v_inv</span> <span class="o">*</span> <span class="p">(</span><span class="n">q_window</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">q_m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> \
                          <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">q_v_inv</span><span class="p">))</span> <span class="o">+</span> \
                          <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">v_v_inv</span> <span class="o">*</span> <span class="p">(</span><span class="n">v_window</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">v_m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> \
                          <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">v_v_inv</span><span class="p">))</span> \
                          <span class="o">+</span> <span class="mf">5.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sup_ca</span><span class="p">)</span> <span class="o">*</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g_IE</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                                   <span class="o">-</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sup_cb</span><span class="p">)</span> <span class="o">*</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g_IE</span><span class="p">)</span>
                                   <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sup_cc</span><span class="p">)</span> <span class="o">-</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g_EI</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_Gaussian_EI</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">use_Bifurcation</span><span class="p">:</span>
                <span class="n">loss_EI</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">E_v_inv</span> <span class="o">*</span> <span class="p">(</span><span class="n">E_window</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">E_m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> \
                          <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">E_v_inv</span><span class="p">))</span> <span class="o">+</span> \
                          <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">I_v_inv</span> <span class="o">*</span> <span class="p">(</span><span class="n">I_window</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">I_m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> \
                          <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">I_v_inv</span><span class="p">))</span> <span class="o">+</span> \
                          <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">q_v_inv</span> <span class="o">*</span> <span class="p">(</span><span class="n">q_window</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">q_m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> \
                          <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">q_v_inv</span><span class="p">))</span> <span class="o">+</span> \
                          <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">v_v_inv</span> <span class="o">*</span> <span class="p">(</span><span class="n">v_window</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">v_m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> \
                          <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">v_v_inv</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">use_Gaussian_EI</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">use_Bifurcation</span><span class="p">:</span>
                <span class="n">loss_EI</span> <span class="o">=</span> <span class="mf">.1</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">E_window</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">E_window</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">E_window</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">E_window</span><span class="p">)</span> \
                               <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">I_window</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">I_window</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">I_window</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="mi">1</span> <span class="o">-</span> <span class="n">I_window</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> \
                          <span class="o">+</span> <span class="mf">5.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sup_ca</span><span class="p">)</span> <span class="o">*</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g_IE</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                                   <span class="o">-</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sup_cb</span><span class="p">)</span> <span class="o">*</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g_IE</span><span class="p">)</span>
                                   <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sup_cc</span><span class="p">)</span> <span class="o">-</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g_EI</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">use_Gaussian_EI</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">use_Bifurcation</span><span class="p">:</span>
                <span class="n">loss_EI</span> <span class="o">=</span> <span class="mf">.1</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">E_window</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">E_window</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">E_window</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">E_window</span><span class="p">)</span> \
                               <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">I_window</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">I_window</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">I_window</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="mi">1</span> <span class="o">-</span> <span class="n">I_window</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

            <span class="n">loss_prior</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">variables_p</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">)</span> <span class="k">if</span>
                           <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">a</span><span class="p">))]</span>
            <span class="c1"># get penalty on each model parameters due to prior distribution</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables_p</span><span class="p">:</span>
                <span class="c1"># print(var)</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_Bifurcation</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;std_in&#39;</span><span class="p">,</span> <span class="s1">&#39;g_EI&#39;</span><span class="p">,</span> <span class="s1">&#39;g_IE&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                            <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_param</span><span class="p">:</span>
                        <span class="c1"># print(var)</span>
                        <span class="n">dict_np</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;_m&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;_v_inv&#39;</span><span class="p">}</span>
                        <span class="n">loss_prior</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">lb</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">dict_np</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">])))</span> <span class="o">*</span> \
                                                    <span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">var</span><span class="p">))</span> <span class="o">-</span> <span class="n">m</span><span class="p">(</span>
                                                        <span class="n">model</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">dict_np</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">])))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> \
                                          <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lb</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">dict_np</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">])))))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;std_in&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                            <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_param</span><span class="p">:</span>
                        <span class="c1"># print(var)</span>
                        <span class="n">dict_np</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;_m&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;_v_inv&#39;</span><span class="p">}</span>
                        <span class="n">loss_prior</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">lb</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">dict_np</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">])))</span> <span class="o">*</span> \
                                                    <span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">var</span><span class="p">))</span> <span class="o">-</span> <span class="n">m</span><span class="p">(</span>
                                                        <span class="n">model</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">dict_np</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">])))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> \
                                          <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lb</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">dict_np</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">])))))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lose_EI</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loss_prior</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">variables_p</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">)</span> <span class="k">if</span>
                           <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">a</span><span class="p">))]</span>

            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables_p</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;std_in&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                        <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_param</span><span class="p">:</span>
                    <span class="c1"># print(var)</span>
                    <span class="n">dict_np</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;_m&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;_v_inv&#39;</span><span class="p">}</span>
                    <span class="n">loss_prior</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">lb</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">dict_np</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">])))</span> <span class="o">*</span> \
                                                <span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">var</span><span class="p">))</span> <span class="o">-</span> <span class="n">m</span><span class="p">(</span>
                                                    <span class="n">model</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">dict_np</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">])))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> \
                                      <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lb</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">dict_np</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">])))))</span>
        <span class="c1"># total loss</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;RWW&#39;</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">w_cost</span> <span class="o">*</span> <span class="n">loss_main</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="n">loss_prior</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">loss_EI</span>
        <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;JR&#39;</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">w_cost</span> <span class="o">*</span> <span class="n">loss_main</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">loss_prior</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">loss_EI</span>
        <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;LIN&#39;</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">w_cost</span> <span class="o">*</span> <span class="n">loss_main</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">loss_prior</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">loss_EI</span>
        <span class="k">return</span> <span class="n">loss</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Neural Mass Model fitting</span>
<span class="sd">module for output datatype</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>  <span class="c1"># for numerical operations</span>


<span class="k">class</span> <span class="nc">OutputNM</span><span class="p">:</span>
    <span class="n">mode_all</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span>
    <span class="n">stat_vars_all</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;v_inv&#39;</span><span class="p">]</span>
    <span class="n">output_name</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bold&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">fit_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fit_lfm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">state_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">if</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;RWW&#39;</span><span class="p">:</span>
            <span class="n">state_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_name</span> <span class="o">=</span> <span class="s2">&quot;bold&quot;</span>
        <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;JR&quot;</span><span class="p">:</span>
            <span class="n">state_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;Ev&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;Iv&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;Pv&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_name</span> <span class="o">=</span> <span class="s2">&quot;eeg&quot;</span>
        <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;LIN&#39;</span><span class="p">:</span>
            <span class="n">state_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_name</span> <span class="o">=</span> <span class="s2">&quot;bold&quot;</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">state_names</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_name</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_all</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">vars_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">a</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">var</span> <span class="o">!=</span> <span class="s1">&#39;std_in&#39;</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]))</span>
                    <span class="k">for</span> <span class="n">stat_var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_vars_all</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">stat_var</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">fit_weights</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;JR&#39;</span> <span class="ow">and</span> <span class="n">fit_lfm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">leadfield</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>



<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Neural Mass Model fitting</span>
<span class="sd">module for model parameters inital values</span>
<span class="sd">&quot;&quot;&quot;</span>





<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Neural Mass Model fitting</span>
<span class="sd">module for model fitting using pytorch</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>  <span class="c1"># for numerical operations</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">cosine_similarity</span>


<span class="k">class</span> <span class="nc">Model_fitting</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Using ADAM and AutoGrad to fit JansenRit to empirical EEG</span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model: instance of class RNNJANSEN</span>
<span class="sd">        forward model JansenRit</span>
<span class="sd">    ts: array with num_tr x node_size</span>
<span class="sd">        empirical EEG time-series</span>
<span class="sd">    num_epoches: int</span>
<span class="sd">        the times for repeating trainning</span>
<span class="sd">    cost: choice of the cost function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># external input</span>

    <span class="c1"># from sklearn.metrics.pairwise import cosine_similarity</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">num_epoches</span><span class="p">,</span> <span class="n">cost</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model: instance of class RNNJANSEN</span>
<span class="sd">            forward model JansenRit</span>
<span class="sd">        ts: array with num_tr x node_size</span>
<span class="sd">            empirical EEG time-series</span>
<span class="sd">        num_epoches: int</span>
<span class="sd">            the times for repeating trainning</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_epoches</span> <span class="o">=</span> <span class="n">num_epoches</span>
        <span class="c1"># placeholder for output(EEG and histoty of model parameters and loss)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span> <span class="o">=</span> <span class="n">OutputNM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_fit_gains</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_fit_lfm</span><span class="p">)</span>
        <span class="c1"># self.u = u</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;if ts.shape[1] != model.node_size:</span>
<span class="sd">            print(&#39;ts is a matrix with the number of datapoint X the number of node&#39;)</span>
<span class="sd">        else:</span>
<span class="sd">            self.ts = ts&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cost</span> <span class="o">=</span> <span class="n">Costs</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">learningrate</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        learningrate : for machine learing speed</span>
<span class="sd">        u: stimulus</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">delays_max</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="n">state_ub</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">state_lb</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;RWW&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_dynamic_boundary</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_fit_gains</span><span class="p">:</span>
                    <span class="n">epoch_min</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># run minimum epoch # part of stop criteria</span>
                    <span class="n">r_lb</span> <span class="o">=</span> <span class="mf">0.85</span>  <span class="c1"># lowest pearson correlation # part of stop criteria</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">epoch_min</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># run minimum epoch # part of stop criteria</span>
                    <span class="n">r_lb</span> <span class="o">=</span> <span class="mf">0.85</span>  <span class="c1"># lowest pearson correlation # part of stop criteria</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epoch_min</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># run minimum epoch # part of stop criteria</span>
                <span class="n">r_lb</span> <span class="o">=</span> <span class="mf">0.85</span>  <span class="c1"># lowest pearson correlation # part of stop criteria</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">epoch_min</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># run minimum epoch # part of stop criteria</span>
            <span class="n">r_lb</span> <span class="o">=</span> <span class="mf">0.95</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">u</span>

        <span class="c1"># define an optimizer(ADAM)</span>
        <span class="c1">#optimizer = optim.Adam([{&#39;params&#39;: self.model.params_fitted[&#39;modelparameter&#39;]},</span>
        <span class="c1">#            {&#39;params&#39;: self.model.params_fitted[&#39;hyperparameter&#39;], &#39;lr&#39;: learningrate/40}], lr=learningrate, eps=1e-7)</span>
        <span class="c1">#optimizer = optim.Adam(self.model.parameters(), lr=learningrate, eps=1e-7)</span>
        <span class="n">optimizer_mp</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params_fitted</span><span class="p">[</span><span class="s1">&#39;modelparameter&#39;</span><span class="p">],</span> <span class="n">lr</span><span class="o">=</span><span class="n">learningrate</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span>
        <span class="n">optimizer_hp</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params_fitted</span><span class="p">[</span><span class="s1">&#39;hyperparameter&#39;</span><span class="p">],</span> <span class="n">lr</span><span class="o">=</span><span class="n">learningrate</span><span class="o">/</span><span class="mi">50</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span>
        <span class="c1"># add lr scheduler</span>
        <span class="n">total_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">num_epoches</span>
        <span class="c1">#schedular = optim.lr_scheduler.OneCycleLR(optimizer, [learningrate, learningrate/40], total_steps)</span>
        <span class="n">schedular_mp</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">OneCycleLR</span><span class="p">(</span><span class="n">optimizer_mp</span><span class="p">,</span> <span class="n">learningrate</span><span class="p">,</span> <span class="n">total_steps</span><span class="p">)</span>
        <span class="n">schedular_hp</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">OneCycleLR</span><span class="p">(</span><span class="n">optimizer_hp</span><span class="p">,</span> <span class="n">learningrate</span><span class="o">/</span><span class="mi">50</span><span class="p">,</span> <span class="n">total_steps</span><span class="p">)</span>
        <span class="c1"># initial state</span>
        <span class="n">X</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;RWW&#39;</span><span class="p">:</span>
            <span class="c1"># initial state</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_size</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;LIN&#39;</span><span class="p">:</span>
            <span class="c1"># initial state</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;JR&#39;</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">state_lb</span><span class="p">,</span> <span class="n">state_ub</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_size</span><span class="p">)),</span>
                             <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="c1"># initials of history of E</span>
        <span class="n">hE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">state_lb</span><span class="p">,</span> <span class="n">state_ub</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">delays_max</span><span class="p">)),</span>
                          <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># define masks for getting lower triangle matrix indices</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mask_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">output_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># placeholders for the history of model parameters</span>
        <span class="n">fit_param</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">exclude_param</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fit_sc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fit_lm</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_fit_gains</span><span class="p">:</span>
            <span class="n">exclude_param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;gains_con&#39;</span><span class="p">)</span>
            <span class="n">fit_sc</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>  <span class="c1"># sc weights history</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;JR&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_fit_lfm</span><span class="p">:</span>
            <span class="n">exclude_param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;lm&#39;</span><span class="p">)</span>
            <span class="n">fit_lm</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">lm</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>  <span class="c1"># leadfield matrix history</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_param</span><span class="p">:</span>
                <span class="n">fit_param</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>

        <span class="n">loss_his</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># loss placeholder</span>

        <span class="c1"># define constant 1 tensor</span>

        <span class="c1"># define num_windows</span>
        <span class="n">num_windows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i_epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_epoches</span><span class="p">):</span>
            <span class="n">optimizer_hp</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="c1"># Create placeholders for the simulated states and outputs of entire time series.</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_names</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span><span class="p">]:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_train&#39;</span><span class="p">,</span> <span class="p">[])</span>

            <span class="c1"># initial the external inputs</span>
            <span class="n">external</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps_per_TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">]),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="c1"># Perform the training in windows.</span>

            <span class="k">for</span> <span class="n">TR_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_windows</span><span class="p">):</span>

                <span class="c1"># Reset the gradient to zeros after update model parameters.</span>
                <span class="c1">#optimizer.zero_grad()</span>
                <span class="n">optimizer_mp</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

                <span class="c1"># if the external not empty</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">external</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">TR_i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">:(</span><span class="n">TR_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">]),</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

                <span class="c1"># Use the model.forward() function to update next state and get simulated EEG in this batch.</span>

                <span class="n">next_window</span><span class="p">,</span> <span class="n">hE_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">external</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">hE</span><span class="p">)</span>

                <span class="c1"># Get the batch of empirical EEG signal.</span>
                <span class="n">ts_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="p">[</span><span class="n">i_epoch</span><span class="p">,</span> <span class="n">TR_i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

                <span class="c1"># total loss calculation</span>
                <span class="n">sim</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;RWW&#39;</span><span class="p">:</span>
                    <span class="n">sim</span> <span class="o">=</span> <span class="n">next_window</span><span class="p">[</span><span class="s1">&#39;bold_window&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;JR&#39;</span><span class="p">:</span>
                    <span class="n">sim</span> <span class="o">=</span> <span class="n">next_window</span><span class="p">[</span><span class="s1">&#39;eeg_window&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;LIN&#39;</span><span class="p">:</span>
                    <span class="n">sim</span> <span class="o">=</span> <span class="n">next_window</span><span class="p">[</span><span class="s1">&#39;bold_window&#39;</span><span class="p">]</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">cost_eff</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">ts_window</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">next_window</span><span class="p">)</span>
                <span class="c1"># Put the batch of the simulated EEG, E I M Ev Iv Mv in to placeholders for entire time-series.</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_names</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span><span class="p">]:</span>
                    <span class="n">name_next</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_window&#39;</span>
                    <span class="n">tmp_ls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_train&#39;</span><span class="p">)</span>
                    <span class="n">tmp_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_window</span><span class="p">[</span><span class="n">name_next</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_train&#39;</span><span class="p">,</span> <span class="n">tmp_ls</span><span class="p">)</span>

                <span class="n">loss_his</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

                <span class="c1"># Calculate gradient using backward (backpropagation) method of the loss function.</span>
                <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">retain_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Optimize the model based on the gradient method in updating the model parameters.</span>
                <span class="n">optimizer_mp</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                <span class="c1"># schedular step</span>
                <span class="n">schedular_mp</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                <span class="n">optimizer_hp</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                <span class="n">schedular_hp</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>


                <span class="c1"># Put the updated model parameters into the history placeholders.</span>
                <span class="c1"># sc_par.append(self.model.sc[mask].copy())</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_param</span><span class="p">:</span>
                        <span class="n">fit_param</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_fit_gains</span><span class="p">:</span>
                    <span class="n">fit_sc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sc_fitted</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;JR&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_fit_lfm</span><span class="p">:</span>
                    <span class="n">fit_lm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">lm</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

                <span class="c1"># last update current state using next state...</span>
                <span class="c1"># (no direct use X = X_next, since gradient calculation only depends on one batch no history)</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">next_window</span><span class="p">[</span><span class="s1">&#39;current_state&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">hE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">hE_new</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="c1"># print(hE_new.detach().numpy()[20:25,0:20])</span>
                <span class="c1"># print(hE.shape)</span>


            <span class="n">ts_emp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="p">[</span><span class="n">i_epoch</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">fc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">ts_emp</span><span class="p">)</span>

            <span class="n">tmp_ls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span> <span class="o">+</span> <span class="s1">&#39;_train&#39;</span><span class="p">)</span>
            <span class="n">ts_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">tmp_ls</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">fc_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">ts_sim</span><span class="p">[:,</span> <span class="mi">10</span><span class="p">:])</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;epoch: &#39;</span><span class="p">,</span> <span class="n">i_epoch</span><span class="p">,</span> <span class="n">loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;epoch: &#39;</span><span class="p">,</span> <span class="n">i_epoch</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">fc_sim</span><span class="p">[</span><span class="n">mask_e</span><span class="p">],</span> <span class="n">fc</span><span class="p">[</span><span class="n">mask_e</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;cos_sim: &#39;</span><span class="p">,</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cosine_similarity</span><span class="p">(</span><span class="n">ts_sim</span><span class="p">,</span> <span class="n">ts_emp</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">schedular_mp</span><span class="o">.</span><span class="n">get_last_lr</span><span class="p">(),</span> <span class="n">schedular_hp</span><span class="o">.</span><span class="n">get_last_lr</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_names</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span><span class="p">]:</span>
                <span class="n">tmp_ls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_train&#39;</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_train&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">tmp_ls</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss_his</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">i_epoch</span> <span class="o">&gt;</span> <span class="n">epoch_min</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">fc_sim</span><span class="p">[</span><span class="n">mask_e</span><span class="p">],</span> <span class="n">fc</span><span class="p">[</span><span class="n">mask_e</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">r_lb</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_fit_gains</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fit_sc</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;JR&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_fit_lfm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">leadfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fit_lm</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fit_param</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_window_num</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        base_window_num: int</span>
<span class="sd">            length of num_windows for resting</span>
<span class="sd">        u : external or stimulus</span>
<span class="sd">        -----------</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># define some constants</span>
        <span class="n">state_lb</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">state_ub</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">delays_max</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="n">transient_num</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">u</span>

        <span class="c1"># initial state</span>
        <span class="n">X</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;RWW&#39;</span><span class="p">:</span>
            <span class="c1"># initial state</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_size</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;LIN&#39;</span><span class="p">:</span>
            <span class="c1"># initial state</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;JR&#39;</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">state_lb</span><span class="p">,</span> <span class="n">state_ub</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_size</span><span class="p">)),</span>
                             <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">hE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">state_lb</span><span class="p">,</span> <span class="n">state_ub</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">500</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># placeholders for model parameters</span>

        <span class="c1"># define mask for getting lower triangle matrix</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mask_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">output_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># define num_windows</span>
        <span class="n">num_windows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Create placeholders for the simulated BOLD E I x f and q of entire time series.</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_names</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span><span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">u_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps_per_TR</span><span class="p">,</span>
             <span class="n">base_window_num</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">u_hat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">base_window_num</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>

        <span class="c1"># Perform the training in batches.</span>

        <span class="k">for</span> <span class="n">TR_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_windows</span> <span class="o">+</span> <span class="n">base_window_num</span><span class="p">):</span>

            <span class="c1"># Get the input and output noises for the module.</span>

            <span class="n">external</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                <span class="p">(</span><span class="n">u_hat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">TR_i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">:(</span><span class="n">TR_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">]),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="c1"># Use the model.forward() function to update next state and get simulated EEG in this batch.</span>
            <span class="n">next_window</span><span class="p">,</span> <span class="n">hE_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">external</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">hE</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">TR_i</span> <span class="o">&gt;</span> <span class="n">base_window_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_names</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span><span class="p">]:</span>
                    <span class="n">name_next</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_window&#39;</span>
                    <span class="n">tmp_ls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">)</span>
                    <span class="n">tmp_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_window</span><span class="p">[</span><span class="n">name_next</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">,</span> <span class="n">tmp_ls</span><span class="p">)</span>

            <span class="c1"># last update current state using next state...</span>
            <span class="c1"># (no direct use X = X_next, since gradient calculation only depends on one batch no history)</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">next_window</span><span class="p">[</span><span class="s1">&#39;current_state&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">hE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">hE_new</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="c1"># print(hE_new.detach().numpy()[20:25,0:20])</span>
            <span class="c1"># print(hE.shape)</span>

        <span class="n">ts_emp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">ts_emp</span><span class="p">)</span>
        <span class="n">tmp_ls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">)</span>
        <span class="n">ts_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">tmp_ls</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">fc_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">ts_sim</span><span class="p">[:,</span> <span class="n">transient_num</span><span class="p">:])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">fc_sim</span><span class="p">[</span><span class="n">mask_e</span><span class="p">],</span> <span class="n">fc</span><span class="p">[</span><span class="n">mask_e</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;cos_sim: &#39;</span><span class="p">,</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cosine_similarity</span><span class="p">(</span><span class="n">ts_sim</span><span class="p">,</span> <span class="n">ts_emp</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_names</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span><span class="p">]:</span>
            <span class="n">tmp_ls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">tmp_ls</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_realtime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tr_p</span><span class="p">,</span> <span class="n">step_size_n</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">num_windows</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;RWW&#39;</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">X_np</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_size</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
            <span class="n">variables_p</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">)</span> <span class="k">if</span>
                           <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">a</span><span class="p">))]</span>
            <span class="c1"># get penalty on each model parameters due to prior distribution</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables_p</span><span class="p">:</span>
                <span class="c1"># print(var)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">des</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
                    <span class="n">des</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">des</span><span class="p">)</span>
            <span class="n">model_np</span> <span class="o">=</span> <span class="n">WWD_np</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">,</span> <span class="n">step_size_n</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">tr_p</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sc_fitted</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_dynamic_boundary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_Laplacian</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">)</span>

            <span class="c1"># Create placeholders for the simulated BOLD E I x f and q of entire time series.</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_names</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span><span class="p">]:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">,</span> <span class="p">[])</span>

            <span class="c1"># Perform the training in batches.</span>

            <span class="k">for</span> <span class="n">TR_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_windows</span> <span class="o">+</span> <span class="mi">10</span><span class="p">):</span>

                <span class="n">noise_in_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">tr_p</span> <span class="o">/</span> <span class="n">step_size_n</span><span class="p">),</span>
                                              <span class="mi">2</span><span class="p">)</span>

                <span class="n">noise_BOLD_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">)</span>

                <span class="n">next_window_np</span> <span class="o">=</span> <span class="n">model_np</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">X_np</span><span class="p">,</span> <span class="n">noise_in_np</span><span class="p">,</span> <span class="n">noise_BOLD_np</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">TR_i</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="c1"># Put the batch of the simulated BOLD, E I x f v q in to placeholders for entire time-series.</span>
                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_names</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span><span class="p">]:</span>
                        <span class="n">name_next</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_window&#39;</span>
                        <span class="n">tmp_ls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">)</span>
                        <span class="n">tmp_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_window_np</span><span class="p">[</span><span class="n">name_next</span><span class="p">])</span>

                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">,</span> <span class="n">tmp_ls</span><span class="p">)</span>

                <span class="c1"># last update current state using next state...</span>
                <span class="c1"># (no direct use X = X_next, since gradient calculation only depends on one batch no history)</span>
                <span class="n">X_np</span> <span class="o">=</span> <span class="n">next_window_np</span><span class="p">[</span><span class="s1">&#39;current_state&#39;</span><span class="p">]</span>
            <span class="n">tmp_ls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_names</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span><span class="p">]:</span>
                <span class="n">tmp_ls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">tmp_ls</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;only WWD model for the test_realtime function&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">import</span> <span class="nn">nilearn</span>
<span class="kn">from</span> <span class="nn">nilearn.input_data</span> <span class="kn">import</span> <span class="n">NiftiLabelsMasker</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">op</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">pearsonr</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># @title Importage</span>
</pre></div>
</div>
</div>
</div>
<p>Initialise the Deco 2014 Model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rww_2014</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ReducedWongWangExcInh</span><span class="p">()</span>
<span class="n">rww_2014</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<thead><h3>ReducedWongWangExcInh</h3></thead>
<tbody>
<tr><td colspan="2"><p><div class="document" id="c03ff65e-26a3-11ee-8ed4-0242ac1c000c">
<blockquote>
<p>Equations taken from <a href="#id2"><span class="problematic" id="id1">[DPA_2013]_</span></a> , page 11242</p>
<div class="math">
\begin{align*}
x_{ek}       &amp;=   w_p\,J_N \, S_{ek} - J_iS_{ik} + W_eI_o + GJ_N \mathbf\Gamma(S_{ek}, S_{ej}, u_{kj}) \\
H(x_{ek})    &amp;=  \dfrac{a_ex_{ek}- b_e}{1 - \exp(-d_e(a_ex_{ek} -b_e))} \\
\dot{S}_{ek} &amp;= -\dfrac{S_{ek}}{\tau_e} + (1 - S_{ek}){\gamma}H(x_{ek}) \\
\end{align*}
</div>
<div class="math">
\begin{align*}
x_{ik}       &amp;=   J_N \, S_{ek} - S_{ik} + W_iI_o + {\lambda}GJ_N \mathbf\Gamma(S_{ik}, S_{ej}, u_{kj}) \\
H(x_{ik})    &amp;=  \dfrac{a_ix_{ik} - b_i}{1 - \exp(-d_i(a_ix_{ik} -b_i))} \\
\dot{S}_{ik} &amp;= -\dfrac{S_{ik}}{\tau_i} + \gamma_iH(x_{ik}) \\
\end{align*}
</div>
</blockquote>
</div>
<script>MathJax.Hub.Queue(["Typeset", MathJax.Hub, "c03ff65e-26a3-11ee-8ed4-0242ac1c000c"]);</script></p></td></tr>
<tr><th></th><th style="text-align:left;width:80%">value</th></tr>
<tr><td>G</td><td style="text-align:left;"><pre>2.0</pre></td></tr>
<tr><td>I_ext</td><td style="text-align:left;"><pre>0.0</pre></td></tr>
<tr><td>I_o</td><td style="text-align:left;"><pre>0.382</pre></td></tr>
<tr><td>J_N</td><td style="text-align:left;"><pre>0.15</pre></td></tr>
<tr><td>J_i</td><td style="text-align:left;"><pre>1.0</pre></td></tr>
<tr><td>Type</td><td style="text-align:left;"><pre>ReducedWongWangExcInh</pre></td></tr>
<tr><td>W_e</td><td style="text-align:left;"><pre>1.0</pre></td></tr>
<tr><td>W_i</td><td style="text-align:left;"><pre>0.7</pre></td></tr>
<tr><td>a_e</td><td style="text-align:left;"><pre>310.0</pre></td></tr>
<tr><td>a_i</td><td style="text-align:left;"><pre>615.0</pre></td></tr>
<tr><td>b_e</td><td style="text-align:left;"><pre>125.0</pre></td></tr>
<tr><td>b_i</td><td style="text-align:left;"><pre>177.0</pre></td></tr>
<tr><td>d_e</td><td style="text-align:left;"><pre>0.16</pre></td></tr>
<tr><td>d_i</td><td style="text-align:left;"><pre>0.087</pre></td></tr>
<tr><td>gamma_e</td><td style="text-align:left;"><pre>0.000641</pre></td></tr>
<tr><td>gamma_i</td><td style="text-align:left;"><pre>0.001</pre></td></tr>
<tr><td>gid</td><td style="text-align:left;"><pre>UUID('f1d2523d-2728-46ae-b842-a4723f79bf00')</pre></td></tr>
<tr><td>lamda</td><td style="text-align:left;"><pre>0.0</pre></td></tr>
<tr><td>state_variable_boundaries</td><td style="text-align:left;"><pre>{'S_e': array([0., 1.]), 'S_i': array([0., 1.])}</pre></td></tr>
<tr><td>state_variable_range</td><td style="text-align:left;"><pre>{'S_e': array([0., 1.]), 'S_i': array([0., 1.])}</pre></td></tr>
<tr><td>tau_e</td><td style="text-align:left;"><pre>100.0</pre></td></tr>
<tr><td>tau_i</td><td style="text-align:left;"><pre>10.0</pre></td></tr>
<tr><td>title</td><td style="text-align:left;"><pre>ReducedWongWangExcInh gid: f1d2523d-2728-46ae-b842-a4723f79bf00</pre></td></tr>
<tr><td>variables_of_interest</td><td style="text-align:left;"><pre>('S_e', 'S_i')</pre></td></tr>
<tr><td>w_p</td><td style="text-align:left;"><pre>1.4</pre></td></tr>
</tbody></table></div></div>
</div>
<p>Then we will set up the map and start to import the files necessary for the simulation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fmri_data_path</span> <span class="o">=</span> <span class="s1">&#39;/content/Data/resting_state_fMRI/&#39;</span>

<span class="n">sub_id</span> <span class="o">=</span> <span class="s1">&#39;102513&#39;</span>
<span class="n">parcs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s start importing the structural connectome of this subjects</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_gg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">fmri_data_path</span> <span class="o">+</span> <span class="s2">&quot;/</span><span class="si">{0}</span><span class="s2">_SC_wts.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sub_id</span><span class="p">))</span>

<span class="c1"># Structural Connectivity</span>
<span class="n">HCP_SC1</span> <span class="o">=</span> <span class="n">_gg</span><span class="p">[</span><span class="n">parcs</span><span class="p">][:,</span><span class="n">parcs</span><span class="p">]</span>

<span class="n">HCP_SC1</span> <span class="o">=</span> <span class="n">HCP_SC1</span> <span class="o">+</span> <span class="n">HCP_SC1</span><span class="o">.</span><span class="n">T</span> <span class="c1"># --&gt; Symmetric</span>
<span class="n">HCP_SC</span> <span class="o">=</span> <span class="n">HCP_SC1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Generate the heatmap</span>
<span class="n">heatmap</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">HCP_SC</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">HCP_SC</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="c1"># Set the label for the color bar</span>
<span class="n">heatmap</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">colorbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Streamline&#39;</span><span class="p">)</span>

<span class="c1"># Display the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1687de4f14bacc38cf70ea323d46e6d7676f0fe424b8d0d503006be911d96e22.png" src="../_images/1687de4f14bacc38cf70ea323d46e6d7676f0fe424b8d0d503006be911d96e22.png" />
</div>
</div>
<p>Next, we will proceed with importing the fMRI resting state FCs. In this case, the subject has undergone four runs, and we will import all of them for further analysis. To obtain a comprehensive representation, we will calculate the average of these runs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get pconns</span>
<span class="n">pconn1LR</span> <span class="o">=</span> <span class="n">fmri_data_path</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_rfMRI_REST1_LR_Schaefer200_cifti_correlated.pconn.nii&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sub_id</span><span class="p">)</span>
<span class="n">pconn1RL</span> <span class="o">=</span> <span class="n">fmri_data_path</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_rfMRI_REST1_RL_Schaefer200_cifti_correlated.pconn.nii&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sub_id</span><span class="p">)</span>
<span class="n">pconn2LR</span> <span class="o">=</span> <span class="n">fmri_data_path</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_rfMRI_REST2_LR_Schaefer200_cifti_correlated.pconn.nii&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sub_id</span><span class="p">)</span>
<span class="n">pconn2RL</span> <span class="o">=</span> <span class="n">fmri_data_path</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_rfMRI_REST2_RL_Schaefer200_cifti_correlated.pconn.nii&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sub_id</span><span class="p">)</span>

<span class="c1"># Load pconns</span>
<span class="n">_pconn_img1LR</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pconn1LR</span><span class="p">)</span>
<span class="n">_pconn_dat1LR</span> <span class="o">=</span> <span class="n">_pconn_img1LR</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
<span class="n">_pconn_dat1LR</span> <span class="o">=</span> <span class="n">_pconn_dat1LR</span><span class="o">/</span><span class="mi">1</span>

<span class="n">_pconn_img1RL</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pconn1RL</span><span class="p">)</span>
<span class="n">_pconn_dat1RL</span> <span class="o">=</span> <span class="n">_pconn_img1RL</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
<span class="n">_pconn_img2LR</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pconn2LR</span><span class="p">)</span>
<span class="n">_pconn_dat2LR</span> <span class="o">=</span> <span class="n">_pconn_img2LR</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
<span class="n">_pconn_img2RL</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pconn2RL</span><span class="p">)</span>
<span class="n">_pconn_dat2RL</span> <span class="o">=</span> <span class="n">_pconn_img2RL</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
<span class="n">HCP_FC</span> <span class="o">=</span> <span class="p">(</span><span class="n">_pconn_dat1LR</span> <span class="o">+</span> <span class="n">_pconn_dat1LR</span> <span class="o">+</span> <span class="n">_pconn_dat2LR</span> <span class="o">+</span> <span class="n">_pconn_dat2RL</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span>
</pre></div>
</div>
</div>
</div>
<p>after that we are going to import the atlas and extract the labels</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://raw.githubusercontent.com/ThomasYeoLab/CBIG/master/stable_projects/brain_parcellation/Schaefer2018_LocalGlobal/Parcellations/MNI/Centroid_coordinates/Schaefer2018_200Parcels_7Networks_order_FSLMNI152_2mm.Centroid_RAS.csv&#39;</span>
<span class="n">atlas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">label</span> <span class="o">=</span> <span class="n">atlas</span><span class="p">[</span><span class="s1">&#39;ROI Name&#39;</span><span class="p">]</span>

<span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">label</span><span class="p">)):</span>
    <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="n">xx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;7Networks_&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s plot the empirical FC</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Mask out the major diagonal</span>
<span class="kn">import</span> <span class="nn">nilearn.plotting</span> <span class="k">as</span> <span class="nn">plotting</span>
<span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">HCP_FC</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">plot_matrix</span><span class="p">(</span>
    <span class="n">HCP_FC</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.8</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x7ae99823e830&gt;
</pre></div>
</div>
<img alt="../_images/d4b36efdaba905d0bc4d457ecab3f5da50a7d6d1852d8ab4de4c29aef274a3ad.png" src="../_images/d4b36efdaba905d0bc4d457ecab3f5da50a7d6d1852d8ab4de4c29aef274a3ad.png" />
</div>
</div>
<p>Now that we have the empirical SC and FC we are going to setup the tvb parameter to run the simulation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tract_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">fmri_data_path</span> <span class="o">+</span> <span class="s2">&quot;/tract_lengths.txt&quot;</span><span class="p">)</span>

<span class="c1"># Centroids</span>
<span class="n">centroids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">fmri_data_path</span> <span class="o">+</span> <span class="s2">&quot;/all_centroids.txt&quot;</span><span class="p">)</span>
<span class="c1">#centroids = centroids[parcs,:]</span>

<span class="n">nregions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parcs</span><span class="p">)</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parcs</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">HCP_con</span> <span class="o">=</span> <span class="n">connectivity</span><span class="o">.</span><span class="n">Connectivity</span><span class="p">()</span>

<span class="n">HCP_con</span><span class="o">.</span><span class="n">tract_lengths</span> <span class="o">=</span> <span class="n">tract_lengths</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">HCP_con</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
<span class="n">HCP_con</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">HCP_SC</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">HCP_con</span><span class="o">.</span><span class="n">centres</span> <span class="o">=</span> <span class="n">centroids</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">HCP_con</span><span class="o">.</span><span class="n">areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">HCP_con</span><span class="o">.</span><span class="n">cortical</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="n">HCP_con</span><span class="o">.</span><span class="n">orientations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">HCP_con</span><span class="o">.</span><span class="n">hemispheres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)))</span>
<span class="n">HCP_con</span><span class="o">.</span><span class="n">region_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

<span class="n">HCP_con</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">((</span><span class="n">HCP_con</span><span class="o">.</span><span class="n">weights</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">HCP_con</span><span class="o">.</span><span class="n">weights</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">HCP_con</span><span class="o">.</span><span class="n">weights</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">HCP_con</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>

<span class="n">HCP_con</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Gs</span> <span class="o">=</span> <span class="mi">46</span>
<span class="n">regime</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;J_N&#39;</span><span class="p">:</span> <span class="mf">0.18</span><span class="p">,</span> <span class="s1">&#39;J_i&#39;</span><span class="p">:</span> <span class="mf">1.03</span><span class="p">}</span>

<span class="n">D1</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="c1"># default</span>
<span class="n">mynoise</span> <span class="o">=</span> <span class="n">noise</span><span class="o">.</span><span class="n">Additive</span><span class="p">(</span><span class="n">nsig</span><span class="o">=</span><span class="n">__</span><span class="p">((</span><span class="n">D1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="n">noise_seed</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">))</span>

<span class="n">test_pcc_FC_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_pcc_SC_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_df_B_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_df_S_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_tsr_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">test_pcc_FC_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_pcc_SC_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_df_B_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_df_S_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_tsr_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The next line of code is taking long time to run!!!!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_pcc_FC_e</span><span class="p">,</span> <span class="n">test_pcc_SC_e</span><span class="p">,</span> <span class="n">test_df_B_e</span><span class="p">,</span> <span class="n">test_df_S_e</span><span class="p">,</span> <span class="n">test_tsr_e</span><span class="p">,</span> <span class="n">test_pcc_FC_i</span><span class="p">,</span> <span class="n">test_pcc_SC_i</span><span class="p">,</span> <span class="n">test_df_B_i</span><span class="p">,</span> <span class="n">test_df_S_i</span><span class="p">,</span> <span class="n">test_tsr_i</span> <span class="o">=</span> <span class="n">run_rww_sim_pcc_test</span><span class="p">(</span><span class="n">HCP_con</span><span class="p">,</span> <span class="n">Gs</span><span class="p">,</span> <span class="n">regime</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">300000</span><span class="p">,</span> <span class="n">mynoise</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Whobpyt</p>
<p>In this section we are going to import already fitted fMRI timeseries</p>
<p>For the sake of time (parameters estimatation is time consuming), the dataset has been already modelled for you using <a class="reference external" href="https://github.com/GriffithsLab/whobpyt"><em>WhoBPyT - Whole-Brain Modelling in PyTorch</em></a>, (pronounce as ‘hobbit’), a Python library for PyTorch-based whole-brain modeling in Python.</p>
<p>The nature and purpose of the simulation is not really the main focus of this tutorial but - in a nutshell - we cast the differential equations of the model in a   <code class="docutils literal notranslate"><span class="pre">PyTorch</span></code> enviroment and using a deep-learning framework for finding the optimal paraters of the model which gave a good resemble of the empirical functional connectivity in model generated functional connectivity.</p>
<p><img alt="alt text" src="https://drive.google.com/uc?id=1oLxNr4UklMLM7nJrPyJvV82ZoXvdbCsZ" /></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;/content/drive/MyDrive/OHBM_Educational_course/Data/01_Background_and_Theory/resting_state_fMRI/&#39;</span>

<span class="n">atlas_file</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">+</span> <span class="s1">&#39;atlas_Schaefer2018_200Parcels_7Networks.nii.gz&#39;</span>
<span class="n">ts_file</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">+</span> <span class="s1">&#39;empirical_resting_state.nii.gz&#39;</span>
<span class="n">sc_file</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">+</span> <span class="s1">&#39;whobpyt_SC_Schaefer2018_200Parcels_7Networks.csv&#39;</span>

<span class="n">atlas</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">atlas_file</span><span class="p">)</span>
<span class="n">fmri</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ts_file</span><span class="p">)</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">sc_file</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">+</span> <span class="n">sc</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sc</span><span class="p">))</span>
<span class="n">masker</span> <span class="o">=</span> <span class="n">NiftiLabelsMasker</span><span class="p">(</span><span class="n">labels_img</span><span class="o">=</span><span class="n">atlas</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">memory</span><span class="o">=</span><span class="s1">&#39;nilearn_cache&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ts</span> <span class="o">=</span> <span class="n">masker</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">fmri</span><span class="p">)</span>
<span class="n">ts</span> <span class="o">=</span><span class="n">ts</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
<span class="n">fc_emp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nplot</span><span class="o">.</span><span class="n">plot_roi</span><span class="p">(</span><span class="n">atlas</span><span class="p">,</span> <span class="n">fmri</span><span class="o">.</span><span class="n">slicer</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">54</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://raw.githubusercontent.com/ThomasYeoLab/CBIG/master/stable_projects/brain_parcellation/Schaefer2018_LocalGlobal/Parcellations/MNI/Centroid_coordinates/Schaefer2018_200Parcels_7Networks_order_FSLMNI152_2mm.Centroid_RAS.csv&#39;</span>
<span class="n">atlas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">label</span> <span class="o">=</span> <span class="n">atlas</span><span class="p">[</span><span class="s1">&#39;ROI Name&#39;</span><span class="p">]</span>

<span class="n">label_stripped</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">label</span><span class="p">)):</span>
    <span class="n">label_stripped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="n">xx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;7Networks_&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;connectome matrices&#39;</span><span class="p">)</span>

<span class="n">plotting</span><span class="o">.</span><span class="n">plot_matrix</span><span class="p">(</span><span class="n">fc_emp</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">label_stripped</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                     <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">reorder</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Empirical Functional Connectome&#39;</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">NormalizeData</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Empirical Structural Connectome&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fittingresults_exp</span> <span class="o">=</span><span class="n">data_dir</span> <span class="o">+</span> <span class="s1">&#39;whobpyt_resting_state_fittingresults_exp.pkl&#39;</span>

<span class="n">sim_FC_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">fc_emp</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fittingresults_exp</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">sim_FC_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">bold_test</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;connectome matrices&#39;</span><span class="p">)</span>

<span class="c1"># FC Awake</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">fc_emp</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Empirical FC&#39;</span><span class="p">)</span>

<span class="c1"># FC deep</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">sim_FC_test</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mf">0.06</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Simulated FC&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>##References</p>
<blockquote>
<div><p>Deco, G., Ponce, A.A., Mantini, D., Romani, G., Hagmann, P., Corbetta, M. (2011). <strong>Resting-State Functional Connectivity Emerges from Structurally and Dynamically Shaped Slow Linear Fluctuations.</strong> <em>The Journal of Neuroscience</em>, 32(27), 11239-11252, 2013.</p>
</div></blockquote>
<blockquote>
<div><p>Friston, K., Mechelli, A., Turner, R., and Price, C. (2000). <strong>Nonlinear Responses in fMRI: The Balloon Model, Volterra Kernels, and Other Hemodynamics.</strong> <em>NeuroImage</em>, 12, 466 - 477.</p>
</div></blockquote>
<blockquote>
<div><p>Geoffrey M. Boynton, Stephen A. Engel, Gary H. Glover and David J. Heeger (1996). <strong>Linear Systems Analysis of Functional Magnetic Resonance Imaging in Human V1.</strong> <em>J Neurosci</em> 16: 4207-4221</p>
</div></blockquote>
<blockquote>
<div><p>Alex Polonsky, Randolph Blake, Jochen Braun and David J. Heeger (2000). <strong>Neuronal activity in human primary visual cortex correlates with perception during binocular rivalry.</strong> <em>Nature Neuroscience</em> 3: 1153-1159</p>
</div></blockquote>
<blockquote>
<div><p>Glover, G. (1999). <strong>Deconvolution of Impulse Response in Event-Related BOLD fMRI.</strong> <em>NeuroImage</em> 9, 416-429.</p>
</div></blockquote>
<blockquote>
<div><p>Have a look at this tutorial: <a class="reference external" href="http://nbviewer.ipython.org/github/practical-neuroimaging/pna-notebooks/blob/master/convolution.ipynb">http://nbviewer.ipython.org/github/practical-neuroimaging/pna-notebooks/blob/master/convolution.ipynb</a></p>
</div></blockquote>
<blockquote>
<div><p>Drysdale, P. M.; Huber, J. P.; Robinson, P. A. &amp; Aquino, K. M. (2010). <strong>Spatiotemporal BOLD dynamics from a poroelastic hemodynamic model.</strong> <em>J Theor Biol</em>, 265, 524–534</p>
</div></blockquote>
<blockquote>
<div><p><a class="reference external" href="http://en.wikibooks.org/wiki/SPM/Haemodynamic_Response_Function">http://en.wikibooks.org/wiki/SPM/Haemodynamic_Response_Function</a></p>
</div></blockquote>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./materials"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="../materials.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Materials</p>
      </div>
    </a>
    <a class="right-next"
       href="2_Systems_Cognitive.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">2) Applications 1: Systems/Cognitive <br></p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">1) Background / Theory</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#sessions-s-speakers"><strong>Sessions’s Speakers</strong></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#contents">Contents</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction"><strong>Introduction</strong></a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#neural-mass-model-of-local-neural-dynamics">Neural mass model of local neural dynamics</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#available-parameters-are">Available parameters are:</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-plane-analysis"><strong>Phase plane analysis</strong></a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#stability-analysis">Stability analysis</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#network-model-of-whole-brain-anatomical-connectivity">Network model of whole-brain anatomical connectivity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions">Conclusions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-section"><strong>Bonus Section</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Available parameters are:</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By GriffLab
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>