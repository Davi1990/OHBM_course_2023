

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>2) Applications 1: Systems/Cognitive &#8212; OHBM Educational Course on Whole-brain Models</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'materials/2_Systems_Cognitive';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3) Applications 2: Clinical" href="3_Clinical.html" />
    <link rel="prev" title="1) Background / Theory" href="1_Background_Theory.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../abstract.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../abstract.html">
                    Principles and Applications of Whole-brain, Connectome-based Models of Brain Dynamics: An Educational Course
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures.html">Lectures</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../materials.html">Materials</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="1_Background_Theory.html">1) Background / Theory</a></li>







<li class="toctree-l2 current active"><a class="current reference internal" href="#">2) Applications 1: Systems/Cognitive <br/></a></li>










<li class="toctree-l2"><a class="reference internal" href="3_Clinical.html">3) Applications 2: Clinical</a></li>









</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/GriffithsLab/OHBM-whole-brain-modelling-course/blob/master/docs/materials/2_Systems_Cognitive.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/GriffithsLab/OHBM-whole-brain-modelling-course" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/GriffithsLab/OHBM-whole-brain-modelling-course/issues/new?title=Issue%20on%20page%20%2Fmaterials/2_Systems_Cognitive.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/materials/2_Systems_Cognitive.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>2) Applications 1: Systems/Cognitive <br></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">2) Applications 1: Systems/Cognitive <br/></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#sessions-s-speakers"><strong>Sessions’s Speakers</strong></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#contents">Contents</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#nftsim-implementation-of-corticothalamic-model">NFTsim implementation of corticothalamic model</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#energy-landscape">Energy Landscape</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#traveling-brain-waves"><strong>Traveling brain waves</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-to-resting-state-activity-simulation"><strong>Introduction to Resting-State Activity Simulation</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-eigenmodes-and-eigenvalues"><strong>Loading Eigenmodes and Eigenvalues</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simulation-parameters"><strong>Simulation Parameters</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#wave-model-solution-method"><strong>Wave Model Solution Method</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gaussian-white-noise-external-input"><strong>Gaussian White Noise External Input</strong></a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#dissect-the-signal-propagation-spreading"><strong>Dissect the signal propagation spreading</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#propagation-spreading-of-simulated-stimulated-evoked-activity"><strong>Propagation spreading of simulated stimulated-evoked activity</strong></a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions">Conclusions</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gdown</span>

<span class="n">gdown</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;1TnYzAnouh3cA0pD6ad-SNGHQqRCHbyh8&#39;</span><span class="p">)</span>
<span class="o">!</span>mv<span class="w"> </span>/content/sub-02_run-01_fittingresults_stim_exp.pkl<span class="w"> </span>/content/Data/EEG_stim/
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading...
From (uriginal): https://drive.google.com/uc?id=1TnYzAnouh3cA0pD6ad-SNGHQqRCHbyh8
From (redirected): https://drive.google.com/uc?id=1TnYzAnouh3cA0pD6ad-SNGHQqRCHbyh8&amp;confirm=t&amp;uuid=c447b5c2-ca20-4b8a-afa4-e8be9013d43d
To: C:\Users\davide_momi\Desktop\Dave\repo\WBM_educational_course\wbm_book\materials\sub-02_run-01_fittingresults_stim_exp.pkl
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 0.00/2.30G [00:00&lt;?, ?B/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 524k/2.30G [00:00&lt;08:35, 4.45MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 1.05M/2.30G [00:00&lt;09:02, 4.23MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 2.10M/2.30G [00:00&lt;06:10, 6.19MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 3.15M/2.30G [00:00&lt;05:59, 6.38MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 4.19M/2.30G [00:00&lt;05:59, 6.38MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 5.24M/2.30G [00:00&lt;05:47, 6.60MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 6.29M/2.30G [00:01&lt;05:49, 6.55MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 7.34M/2.30G [00:01&lt;05:43, 6.67MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 8.39M/2.30G [00:01&lt;05:40, 6.72MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 9.44M/2.30G [00:01&lt;05:30, 6.92MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 10.5M/2.30G [00:01&lt;05:14, 7.26MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|          | 11.5M/2.30G [00:01&lt;05:03, 7.53MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|          | 12.6M/2.30G [00:01&lt;04:56, 7.70MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|          | 13.6M/2.30G [00:01&lt;04:50, 7.86MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|          | 14.7M/2.30G [00:02&lt;04:49, 7.88MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|          | 15.7M/2.30G [00:02&lt;04:49, 7.88MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|          | 16.8M/2.30G [00:02&lt;04:48, 7.89MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|          | 17.8M/2.30G [00:02&lt;04:47, 7.91MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|          | 18.9M/2.30G [00:02&lt;04:49, 7.88MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|          | 19.9M/2.30G [00:02&lt;04:47, 7.92MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|          | 21.0M/2.30G [00:02&lt;04:47, 7.90MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|          | 22.0M/2.30G [00:03&lt;04:47, 7.92MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|          | 23.1M/2.30G [00:03&lt;04:47, 7.90MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|          | 24.1M/2.30G [00:03&lt;05:01, 7.54MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|          | 25.2M/2.30G [00:03&lt;04:58, 7.60MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|          | 26.2M/2.30G [00:03&lt;05:06, 7.41MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|          | 27.3M/2.30G [00:03&lt;05:14, 7.20MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|          | 28.3M/2.30G [00:03&lt;05:12, 7.26MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|▏         | 29.4M/2.30G [00:04&lt;05:11, 7.28MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|▏         | 30.4M/2.30G [00:04&lt;05:09, 7.32MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|▏         | 31.5M/2.30G [00:04&lt;04:59, 7.55MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|▏         | 32.5M/2.30G [00:04&lt;04:52, 7.75MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|▏         | 33.6M/2.30G [00:04&lt;04:47, 7.87MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  2%|▏         | 34.6M/2.30G [00:04&lt;04:44, 7.95MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  2%|▏         | 35.7M/2.30G [00:04&lt;04:48, 7.84MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  2%|▏         | 36.7M/2.30G [00:04&lt;04:40, 8.07MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  2%|▏         | 37.7M/2.30G [00:05&lt;04:44, 7.94MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  2%|▏         | 38.8M/2.30G [00:05&lt;04:48, 7.83MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  2%|▏         | 39.8M/2.30G [00:05&lt;04:51, 7.74MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  2%|▏         | 40.9M/2.30G [00:05&lt;04:53, 7.69MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  2%|▏         | 41.9M/2.30G [00:05&lt;04:55, 7.64MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  2%|▏         | 43.0M/2.30G [00:05&lt;06:16, 5.99MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  2%|▏         | 44.0M/2.30G [00:06&lt;05:45, 6.51MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  2%|▏         | 45.1M/2.30G [00:06&lt;05:24, 6.93MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  2%|▏         | 46.1M/2.30G [00:06&lt;05:09, 7.26MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  2%|▏         | 47.2M/2.30G [00:06&lt;05:13, 7.16MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  2%|▏         | 48.2M/2.30G [00:06&lt;04:46, 7.85MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  2%|▏         | 49.3M/2.30G [00:06&lt;04:45, 7.86MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  2%|▏         | 50.3M/2.30G [00:06&lt;04:45, 7.87MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  2%|▏         | 51.4M/2.30G [00:06&lt;04:45, 7.87MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  2%|▏         | 52.4M/2.30G [00:07&lt;04:44, 7.89MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  2%|▏         | 53.5M/2.30G [00:07&lt;04:44, 7.87MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  2%|▏         | 54.5M/2.30G [00:07&lt;04:45, 7.84MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  2%|▏         | 55.6M/2.30G [00:07&lt;04:42, 7.92MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  2%|▏         | 56.6M/2.30G [00:07&lt;04:44, 7.88MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3%|▎         | 57.7M/2.30G [00:07&lt;04:52, 7.65MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3%|▎         | 58.7M/2.30G [00:07&lt;04:45, 7.84MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3%|▎         | 59.8M/2.30G [00:08&lt;04:45, 7.84MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3%|▎         | 60.8M/2.30G [00:08&lt;04:41, 7.94MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3%|▎         | 61.9M/2.30G [00:08&lt;04:55, 7.56MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3%|▎         | 62.9M/2.30G [00:08&lt;04:50, 7.69MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3%|▎         | 64.0M/2.30G [00:08&lt;04:48, 7.75MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3%|▎         | 65.0M/2.30G [00:08&lt;04:46, 7.79MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3%|▎         | 66.1M/2.30G [00:08&lt;04:41, 7.92MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3%|▎         | 67.1M/2.30G [00:08&lt;04:38, 8.00MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3%|▎         | 68.2M/2.30G [00:09&lt;04:36, 8.05MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3%|▎         | 69.2M/2.30G [00:09&lt;04:39, 7.97MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3%|▎         | 70.3M/2.30G [00:09&lt;04:40, 7.93MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3%|▎         | 71.3M/2.30G [00:09&lt;04:41, 7.89MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3%|▎         | 72.4M/2.30G [00:09&lt;04:42, 7.86MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3%|▎         | 73.4M/2.30G [00:09&lt;04:43, 7.85MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3%|▎         | 74.4M/2.30G [00:09&lt;04:44, 7.82MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3%|▎         | 75.5M/2.30G [00:10&lt;04:44, 7.82MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3%|▎         | 76.5M/2.30G [00:10&lt;04:42, 7.84MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3%|▎         | 77.6M/2.30G [00:10&lt;04:39, 7.94MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3%|▎         | 78.6M/2.30G [00:10&lt;04:48, 7.67MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3%|▎         | 79.7M/2.30G [00:10&lt;04:31, 8.17MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4%|▎         | 80.7M/2.30G [00:10&lt;04:30, 8.19MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4%|▎         | 81.8M/2.30G [00:10&lt;04:31, 8.14MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4%|▎         | 82.8M/2.30G [00:11&lt;05:28, 6.75MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4%|▎         | 83.9M/2.30G [00:11&lt;05:36, 6.57MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4%|▎         | 84.9M/2.30G [00:11&lt;05:16, 6.98MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4%|▎         | 86.0M/2.30G [00:11&lt;05:03, 7.29MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4%|▍         | 87.0M/2.30G [00:11&lt;05:06, 7.21MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4%|▍         | 88.1M/2.30G [00:11&lt;04:41, 7.84MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4%|▍         | 89.1M/2.30G [00:11&lt;04:49, 7.61MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4%|▍         | 90.2M/2.30G [00:11&lt;04:37, 7.96MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4%|▍         | 91.2M/2.30G [00:12&lt;04:36, 7.97MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4%|▍         | 92.3M/2.30G [00:12&lt;04:37, 7.95MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4%|▍         | 93.3M/2.30G [00:12&lt;04:37, 7.94MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4%|▍         | 94.4M/2.30G [00:12&lt;04:37, 7.92MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4%|▍         | 95.4M/2.30G [00:12&lt;04:40, 7.83MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4%|▍         | 96.5M/2.30G [00:12&lt;04:36, 7.94MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4%|▍         | 97.5M/2.30G [00:12&lt;04:39, 7.86MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4%|▍         | 98.6M/2.30G [00:13&lt;04:42, 7.79MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4%|▍         | 99.6M/2.30G [00:13&lt;04:34, 7.99MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4%|▍         | 101M/2.30G [00:13&lt;04:35, 7.96MB/s] 
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4%|▍         | 102M/2.30G [00:13&lt;04:36, 7.94MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4%|▍         | 103M/2.30G [00:13&lt;04:36, 7.94MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▍         | 104M/2.30G [00:13&lt;04:36, 7.93MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▍         | 105M/2.30G [00:13&lt;04:41, 7.78MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▍         | 106M/2.30G [00:13&lt;04:37, 7.91MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▍         | 107M/2.30G [00:14&lt;04:35, 7.94MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▍         | 108M/2.30G [00:14&lt;04:36, 7.91MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▍         | 109M/2.30G [00:14&lt;04:35, 7.94MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▍         | 110M/2.30G [00:14&lt;04:35, 7.92MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▍         | 111M/2.30G [00:14&lt;04:36, 7.90MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▍         | 112M/2.30G [00:14&lt;04:35, 7.93MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▍         | 113M/2.30G [00:14&lt;04:36, 7.90MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▍         | 114M/2.30G [00:15&lt;04:35, 7.92MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▌         | 115M/2.30G [00:15&lt;04:35, 7.92MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▌         | 116M/2.30G [00:15&lt;04:43, 7.69MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▌         | 117M/2.30G [00:15&lt;04:38, 7.82MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▌         | 118M/2.30G [00:15&lt;04:47, 7.58MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▌         | 120M/2.30G [00:15&lt;04:28, 8.11MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▌         | 121M/2.30G [00:15&lt;04:30, 8.04MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▌         | 122M/2.30G [00:15&lt;04:31, 8.02MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▌         | 123M/2.30G [00:16&lt;04:32, 7.97MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▌         | 124M/2.30G [00:16&lt;05:53, 6.15MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▌         | 125M/2.30G [00:16&lt;05:27, 6.64MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▌         | 126M/2.30G [00:16&lt;05:09, 7.02MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  6%|▌         | 127M/2.30G [00:16&lt;05:13, 6.92MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  6%|▌         | 128M/2.30G [00:16&lt;05:34, 6.48MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  6%|▌         | 129M/2.30G [00:17&lt;05:42, 6.33MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  6%|▌         | 130M/2.30G [00:17&lt;05:48, 6.22MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  6%|▌         | 131M/2.30G [00:17&lt;05:52, 6.14MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  6%|▌         | 132M/2.30G [00:17&lt;05:37, 6.41MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  6%|▌         | 133M/2.30G [00:17&lt;05:15, 6.86MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  6%|▌         | 134M/2.30G [00:17&lt;05:25, 6.64MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  6%|▌         | 135M/2.30G [00:18&lt;05:18, 6.78MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  6%|▌         | 136M/2.30G [00:18&lt;05:15, 6.84MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  6%|▌         | 137M/2.30G [00:18&lt;05:19, 6.76MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  6%|▌         | 138M/2.30G [00:18&lt;05:23, 6.68MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  6%|▌         | 139M/2.30G [00:18&lt;05:24, 6.64MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  6%|▌         | 141M/2.30G [00:18&lt;05:26, 6.60MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  6%|▌         | 142M/2.30G [00:18&lt;05:24, 6.65MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  6%|▌         | 143M/2.30G [00:19&lt;05:06, 7.04MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  6%|▋         | 144M/2.30G [00:19&lt;04:53, 7.34MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  6%|▋         | 145M/2.30G [00:19&lt;04:43, 7.59MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  6%|▋         | 146M/2.30G [00:19&lt;04:37, 7.74MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  6%|▋         | 147M/2.30G [00:19&lt;04:34, 7.82MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  6%|▋         | 148M/2.30G [00:19&lt;05:01, 7.13MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  6%|▋         | 149M/2.30G [00:19&lt;04:41, 7.63MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  7%|▋         | 150M/2.30G [00:20&lt;04:40, 7.66MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  7%|▋         | 151M/2.30G [00:20&lt;04:40, 7.64MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  7%|▋         | 152M/2.30G [00:20&lt;04:40, 7.65MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  7%|▋         | 153M/2.30G [00:20&lt;05:02, 7.07MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  7%|▋         | 155M/2.30G [00:20&lt;04:22, 8.15MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  7%|▋         | 156M/2.30G [00:20&lt;04:22, 8.16MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  7%|▋         | 157M/2.30G [00:20&lt;04:25, 8.06MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  7%|▋         | 158M/2.30G [00:21&lt;04:38, 7.69MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  7%|▋         | 159M/2.30G [00:21&lt;04:24, 8.09MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  7%|▋         | 160M/2.30G [00:21&lt;04:41, 7.59MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  7%|▋         | 161M/2.30G [00:21&lt;05:33, 6.39MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  7%|▋         | 162M/2.30G [00:21&lt;05:12, 6.84MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  7%|▋         | 163M/2.30G [00:21&lt;04:56, 7.20MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  7%|▋         | 164M/2.30G [00:21&lt;04:45, 7.46MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  7%|▋         | 165M/2.30G [00:22&lt;04:38, 7.65MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  7%|▋         | 166M/2.30G [00:22&lt;04:33, 7.79MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  7%|▋         | 167M/2.30G [00:22&lt;04:31, 7.84MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  7%|▋         | 168M/2.30G [00:22&lt;04:30, 7.86MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  7%|▋         | 169M/2.30G [00:22&lt;04:29, 7.90MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  7%|▋         | 170M/2.30G [00:22&lt;04:29, 7.89MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  7%|▋         | 171M/2.30G [00:22&lt;04:33, 7.78MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|▊         | 172M/2.30G [00:23&lt;04:55, 7.19MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|▊         | 174M/2.30G [00:23&lt;05:09, 6.85MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|▊         | 175M/2.30G [00:23&lt;05:09, 6.86MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|▊         | 176M/2.30G [00:23&lt;05:29, 6.44MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|▊         | 177M/2.30G [00:23&lt;05:28, 6.45MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|▊         | 178M/2.30G [00:23&lt;05:45, 6.12MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|▊         | 179M/2.30G [00:24&lt;05:55, 5.95MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|▊         | 180M/2.30G [00:24&lt;05:26, 6.47MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|▊         | 181M/2.30G [00:24&lt;05:07, 6.87MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|▊         | 182M/2.30G [00:24&lt;04:53, 7.20MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|▊         | 183M/2.30G [00:24&lt;04:42, 7.47MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|▊         | 184M/2.30G [00:24&lt;04:35, 7.66MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|▊         | 185M/2.30G [00:24&lt;04:32, 7.74MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|▊         | 186M/2.30G [00:25&lt;04:43, 7.45MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|▊         | 187M/2.30G [00:25&lt;04:24, 7.97MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|▊         | 188M/2.30G [00:25&lt;04:25, 7.93MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|▊         | 189M/2.30G [00:25&lt;04:25, 7.94MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|▊         | 190M/2.30G [00:25&lt;04:26, 7.91MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|▊         | 191M/2.30G [00:25&lt;04:25, 7.92MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|▊         | 192M/2.30G [00:25&lt;04:33, 7.70MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|▊         | 193M/2.30G [00:25&lt;04:23, 7.97MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|▊         | 195M/2.30G [00:26&lt;04:23, 7.97MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  9%|▊         | 196M/2.30G [00:26&lt;04:24, 7.94MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  9%|▊         | 197M/2.30G [00:26&lt;04:24, 7.93MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  9%|▊         | 198M/2.30G [00:26&lt;04:24, 7.92MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  9%|▊         | 199M/2.30G [00:26&lt;04:24, 7.92MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  9%|▊         | 200M/2.30G [00:26&lt;04:24, 7.92MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  9%|▊         | 201M/2.30G [00:26&lt;04:24, 7.91MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  9%|▉         | 202M/2.30G [00:27&lt;04:24, 7.92MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  9%|▉         | 203M/2.30G [00:27&lt;04:38, 7.51MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  9%|▉         | 204M/2.30G [00:27&lt;04:20, 8.05MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  9%|▉         | 205M/2.30G [00:27&lt;04:21, 7.98MB/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  9%|▉         | 206M/2.30G [00:27&lt;04:22, 7.96MB/s]
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="kn">import</span> <span class="nn">gdown</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">gdown</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;1TnYzAnouh3cA0pD6ad-SNGHQqRCHbyh8&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mv /content/sub-02_run-01_fittingresults_stim_exp.pkl /content/Data/EEG_stim/&#39;</span><span class="p">)</span>

<span class="nn">File ~\Anaconda3\envs\OHBM_Course\Lib\site-packages\gdown\download.py:334,</span> in <span class="ni">download</span><span class="nt">(url, output, quiet, proxy, speed, use_cookies, verify, id, fuzzy, resume, format)</span>
<span class="g g-Whitespace">    </span><span class="mi">332</span>     <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">unit_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">333</span> <span class="n">t_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="ne">--&gt; </span><span class="mi">334</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="n">CHUNK_SIZE</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">335</span>     <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">336</span>     <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>

<span class="nn">File ~\Anaconda3\envs\OHBM_Course\Lib\site-packages\requests\models.py:816,</span> in <span class="ni">Response.iter_content.&lt;locals&gt;.generate</span><span class="nt">()</span>
<span class="g g-Whitespace">    </span><span class="mi">814</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="s2">&quot;stream&quot;</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">815</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">816</span>         <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">,</span> <span class="n">decode_content</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">817</span>     <span class="k">except</span> <span class="n">ProtocolError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">818</span>         <span class="k">raise</span> <span class="n">ChunkedEncodingError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="nn">File ~\Anaconda3\envs\OHBM_Course\Lib\site-packages\urllib3\response.py:940,</span> in <span class="ni">HTTPResponse.stream</span><span class="nt">(self, amt, decode_content)</span>
<span class="g g-Whitespace">    </span><span class="mi">938</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">939</span>     <span class="k">while</span> <span class="ow">not</span> <span class="n">is_fp_closed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_decoded_buffer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">940</span>         <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">amt</span><span class="o">=</span><span class="n">amt</span><span class="p">,</span> <span class="n">decode_content</span><span class="o">=</span><span class="n">decode_content</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">942</span>         <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">943</span>             <span class="k">yield</span> <span class="n">data</span>

<span class="nn">File ~\Anaconda3\envs\OHBM_Course\Lib\site-packages\urllib3\response.py:879,</span> in <span class="ni">HTTPResponse.read</span><span class="nt">(self, amt, decode_content, cache_content)</span>
<span class="g g-Whitespace">    </span><span class="mi">876</span>     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_decoded_buffer</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">amt</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">877</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decoded_buffer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">amt</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">879</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_read</span><span class="p">(</span><span class="n">amt</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">881</span> <span class="n">flush_decoder</span> <span class="o">=</span> <span class="kc">False</span>
<span class="g g-Whitespace">    </span><span class="mi">882</span> <span class="k">if</span> <span class="n">amt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

<span class="nn">File ~\Anaconda3\envs\OHBM_Course\Lib\site-packages\urllib3\response.py:814,</span> in <span class="ni">HTTPResponse._raw_read</span><span class="nt">(self, amt)</span>
<span class="g g-Whitespace">    </span><span class="mi">811</span> <span class="n">fp_closed</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="p">,</span> <span class="s2">&quot;closed&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">813</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_catcher</span><span class="p">():</span>
<span class="ne">--&gt; </span><span class="mi">814</span>     <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fp_read</span><span class="p">(</span><span class="n">amt</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">fp_closed</span> <span class="k">else</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">815</span>     <span class="k">if</span> <span class="n">amt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">amt</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">816</span>         <span class="c1"># Platform-specific: Buggy versions of Python.</span>
<span class="g g-Whitespace">    </span><span class="mi">817</span>         <span class="c1"># Close the connection when no data is returned</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">822</span>         <span class="c1"># not properly close the connection in all cases. There is</span>
<span class="g g-Whitespace">    </span><span class="mi">823</span>         <span class="c1"># no harm in redundantly calling close.</span>
<span class="g g-Whitespace">    </span><span class="mi">824</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="nn">File ~\Anaconda3\envs\OHBM_Course\Lib\site-packages\urllib3\response.py:799,</span> in <span class="ni">HTTPResponse._fp_read</span><span class="nt">(self, amt)</span>
<span class="g g-Whitespace">    </span><span class="mi">796</span>     <span class="k">return</span> <span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">797</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">798</span>     <span class="c1"># StringIO doesn&#39;t like amt=None</span>
<span class="ne">--&gt; </span><span class="mi">799</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">amt</span><span class="p">)</span> <span class="k">if</span> <span class="n">amt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="nn">File ~\Anaconda3\envs\OHBM_Course\Lib\http\client.py:466,</span> in <span class="ni">HTTPResponse.read</span><span class="nt">(self, amt)</span>
<span class="g g-Whitespace">    </span><span class="mi">463</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">amt</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">464</span>     <span class="c1"># clip the read to the &quot;end of response&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">465</span>     <span class="n">amt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span>
<span class="ne">--&gt; </span><span class="mi">466</span> <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">amt</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">467</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span> <span class="ow">and</span> <span class="n">amt</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">468</span>     <span class="c1"># Ideally, we would raise IncompleteRead if the content-length</span>
<span class="g g-Whitespace">    </span><span class="mi">469</span>     <span class="c1"># wasn&#39;t satisfied, but it might break compatibility.</span>
<span class="g g-Whitespace">    </span><span class="mi">470</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_close_conn</span><span class="p">()</span>

<span class="nn">File ~\Anaconda3\envs\OHBM_Course\Lib\socket.py:706,</span> in <span class="ni">SocketIO.readinto</span><span class="nt">(self, b)</span>
<span class="g g-Whitespace">    </span><span class="mi">704</span> <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">705</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">706</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sock</span><span class="o">.</span><span class="n">recv_into</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">707</span>     <span class="k">except</span> <span class="n">timeout</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">708</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_timeout_occurred</span> <span class="o">=</span> <span class="kc">True</span>

<span class="nn">File ~\Anaconda3\envs\OHBM_Course\Lib\ssl.py:1278,</span> in <span class="ni">SSLSocket.recv_into</span><span class="nt">(self, buffer, nbytes, flags)</span>
<span class="g g-Whitespace">   </span><span class="mi">1274</span>     <span class="k">if</span> <span class="n">flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1275</span>         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1276</span>           <span class="s2">&quot;non-zero flags not allowed in calls to recv_into() on </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
<span class="g g-Whitespace">   </span><span class="mi">1277</span>           <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1278</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">nbytes</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1279</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1280</span>     <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">recv_into</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>

<span class="nn">File ~\Anaconda3\envs\OHBM_Course\Lib\ssl.py:1134,</span> in <span class="ni">SSLSocket.read</span><span class="nt">(self, len, buffer)</span>
<span class="g g-Whitespace">   </span><span class="mi">1132</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1133</span>     <span class="k">if</span> <span class="n">buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1134</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sslobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1135</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1136</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sslobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<p><em><strong>Dr. Davide Momi</strong></em><br/>
​———–<br/>
Post-Doctoral Research Fellow<br/>
Whole Brain Modelling Group<br/>
Krembil Centre for Neuroinformatics - CAMH<br/>
250 College St., Toronto, ON M5T 1R8<br/>
website: <a class="reference external" href="https://davi1990.github.io/">https://davi1990.github.io/</a><br/>
Twitter: &#64;DaveMomi<br/></p>
<div class="section" id="applications-1-systems-cognitive-br">
<h1>2) Applications 1: Systems/Cognitive <br><a class="headerlink" href="#applications-1-systems-cognitive-br" title="Permalink to this heading">#</a></h1>
</div>
<div class="section" id="sessions-s-speakers">
<h1><strong>Sessions’s Speakers</strong><a class="headerlink" href="#sessions-s-speakers" title="Permalink to this heading">#</a></h1>
<p><img alt="alt text" src="https://drive.google.com/uc?id=1vim0EhdXEZb7MjE1UOEVdNNvNLO0Eadq" /></p>
<hr class="docutils" />
</div>
<div class="section" id="contents">
<h1>Contents<a class="headerlink" href="#contents" title="Permalink to this heading">#</a></h1>
<p><span class="xref myst">Overview</span><br/>
<span class="xref myst">Setup</span><br/>
<span class="xref myst">Corticothalamic model</span><br/>
<span class="xref myst">Travelling Brain Waves</span><br/>
<span class="xref myst">Dissecting signal propagation dynamics</span><br/>
<span class="xref myst">Conclusions</span><br/>
<span class="xref myst">References</span><br/></p>
</div>
<div class="section" id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">#</a></h1>
<p>In this notebook, we are going to investigate the propagation of the signal in the brain using different modalities of investigation (e.g. fMRI and EEG) and different framework (e.g. travelling brain waves and brain stimulation).</p>
</div>
<div class="section" id="setup">
<h1>Setup<a class="headerlink" href="#setup" title="Permalink to this heading">#</a></h1>
<p>If you are running this notebook in Google Colab, you will need to install some packages. If you are running in a more standard python environment, you need to ensure that these packages are installed externally (typically with <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">&lt;package&gt;</span></code> on the command line).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>


<span class="o">!{</span>sys.executable<span class="o">}</span><span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>mne<span class="w"> </span>&gt;<span class="w"> </span>/dev/null
<span class="o">!{</span>sys.executable<span class="o">}</span><span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>nilearn<span class="w"> </span>&gt;<span class="w"> </span>/dev/null
<span class="o">!{</span>sys.executable<span class="o">}</span><span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>nibabel<span class="w"> </span>&gt;<span class="w"> </span>/dev/null
<span class="o">!{</span>sys.executable<span class="o">}</span><span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>tvb-data<span class="w"> </span>&gt;<span class="w"> </span>/dev/null
<span class="o">!{</span>sys.executable<span class="o">}</span><span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>tvb-library<span class="w"> </span>&gt;<span class="w"> </span>/dev/null
<span class="o">!{</span>sys.executable<span class="o">}</span><span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>fooof<span class="w"> </span>&gt;<span class="w"> </span>/dev/null

<span class="c1"># @title Install dependencies</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="o">%</span><span class="k">pylab</span> inline

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">welch</span>
<span class="kn">from</span> <span class="nn">tvb.simulator.lab</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">tvb.basic.neotraits.api</span> <span class="kn">import</span> <span class="n">NArray</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Range</span><span class="p">,</span> <span class="n">Final</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">sio</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">sig</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">zscore</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">import</span> <span class="n">GridSpec</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">tvb.simulator.plot.phase_plane_interactive</span> <span class="kn">import</span> <span class="n">PhasePlaneInteractive</span>
<span class="kn">import</span> <span class="nn">os</span>


<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="c1"># @title Import packages</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Populating the interactive namespace from numpy and matplotlib
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h1>
<p><a class="reference external" href="https://journals.aps.org/pre/abstract/10.1103/PhysRevE.56.826"><em>Robison et al., - (1997)</em></a>, proposed by Peter Robinson in 1997, is a computational cortico-thalamic neural field model that aims to capture the dynamics of neural activity between the cortex and the thalamus. It provides insights into the interactions and feedback loops between these two brain regions and their role in generating oscillatory patterns observed in neural activity.</p>
<br/>
\begin{equation}
\left(\frac{{d^2}}{{dt^2}} +2a\frac{{d}}{{dt}} + a^2 \right) V_{e,i} (\mathbf{r}, t) = ga^2 Q_{ae,ai}(\mathbf{r}, t)
\end{equation}
<br/>
<p>The model incorporates the connectivity and functional properties of the cortico-thalamic circuitry. It includes populations of excitatory and inhibitory neurons in the cortex and in the thalamus. The interactions between these populations is described through a set of differential equations.</p>
<p>One key aspect of the Robinson model is the consideration of different thalamic nuclei and their specific roles in information processing. The model includes specific thalamic relay and reticular nuclei, which play distinct roles in transmitting and modulating neural signals between the cortex and thalamus.</p>
<p>The dynamics of the model are characterized by the interplay between excitatory and inhibitory interactions within and between the cortical and thalamic populations. The model incorporates synaptic connectivity, neural firing rates, and synaptic transmission properties to capture the complex dynamics of the cortico-thalamic system.</p>
<p>By simulating the interactions and feedback loops within the cortico-thalamic circuitry, the Robinson model provides a framework for understanding various neural phenomena, including sleep-wake transitions, sensory processing, and the generation of different oscillatory patterns, such as alpha, beta, and gamma rhythms.</p>
<p>The Robinson cortico-thalamic model has been instrumental in studying brain dynamics, investigating neurological disorders, and exploring the effects of neuromodulation techniques. It contributes to our understanding of how the cortex and thalamus interact to shape neural activity and ultimately influence cognitive processes and behavior.</p>
<p>In summary, the Robinson cortico-thalamic model offers a computational framework that captures the dynamics of neural activity between the cortex and thalamus. It provides valuable insights into the cortico-thalamic interactions and their role in generating oscillatory patterns, contributing to our understanding of brain function and its underlying mechanisms.</p>
<p><img alt="alt text" src="https://drive.google.com/uc?id=1yCMelQ8WZdqiARaBCVj8qI3r6mNozaJb" /></p>
<p>Start with numpy implementation of the Robinson Model</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sig</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">Qmax</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">sigma</span><span class="p">):</span>
 <span class="c1"># sigmoid for voltage-rate relationship</span>
 <span class="n">firing_rate</span> <span class="o">=</span> <span class="n">Qmax</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">v</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">))</span>
 <span class="k">return</span> <span class="n">firing_rate</span>
<span class="k">def</span> <span class="nf">sigr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">Qmax_r</span><span class="p">,</span><span class="n">modtheta</span><span class="p">,</span><span class="n">sigma_r</span><span class="p">):</span>
 <span class="c1"># sigmoid for voltage-rate relationship in reticular nucleus</span>
 <span class="n">firing_rate</span> <span class="o">=</span> <span class="n">Qmax_r</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">v</span><span class="o">-</span><span class="n">modtheta</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma_r</span><span class="p">));</span>
 <span class="k">return</span> <span class="n">firing_rate</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">default_Robison_model_pars</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="c1">#Parameters resting state</span>

  <span class="n">pars</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">116</span> <span class="c1"># s-1</span>
  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;t0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">80e-3</span> <span class="c1"># s</span>
  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Qmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">340</span> <span class="c1"># s-1</span>
  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">12.92e-3</span> <span class="c1"># V</span>
  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.8e-3</span> <span class="c1"># V</span>
  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Qmax_r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># s-1</span>
  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma_r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.8e-3</span> <span class="c1"># V</span>
  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;phin_0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># s-1</span>
  <span class="c1">#MODIFIED: State-dependent parameters for resting state from (Table 3)</span>
  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;nu_ee&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00303</span> <span class="c1">#0.00303 # V s</span>
  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;nu_ei&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.006</span> <span class="c1">#-0.006</span>
  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;nu_es&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00206</span>
  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;nu_ie&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00303</span>
  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;nu_ii&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.006</span>
  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;nu_is&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00206</span>
  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;nu_re&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00033</span>
  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;nu_rs&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="mf">0.00003</span>
  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;nu_se&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00218</span>
  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;nu_sr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.00083</span>
  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;nu_sn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00098</span>
  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">83.33</span> <span class="c1"># s-1</span>
  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">769.23</span> <span class="c1"># s-1</span>
  <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;phin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5e-4</span>

  <span class="k">return</span> <span class="n">pars</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>116
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pars</span> <span class="o">=</span> <span class="n">default_Robison_model_pars</span><span class="p">()</span>

<span class="c1"># Time (s)</span>
<span class="n">start</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">stop</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">+</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;t0&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="n">k0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;t0&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span> <span class="c1"># the delay in timesteps</span>
<span class="n">time_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
<span class="n">vec_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_array</span><span class="p">)</span>

<span class="c1"># Noise</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;nu_sn&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;phin&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">vec_len</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>


<span class="c1"># Outputs</span>
<span class="n">phie</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">vec_len</span><span class="p">)</span>
<span class="n">Ve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">vec_len</span><span class="p">)</span>
<span class="n">Vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">vec_len</span><span class="p">)</span>
<span class="n">Vs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">vec_len</span><span class="p">)</span>
<span class="n">phiedot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">vec_len</span><span class="p">)</span>
<span class="n">Vedot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">vec_len</span><span class="p">)</span>
<span class="n">Vrdot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">vec_len</span><span class="p">)</span>
<span class="n">Vsdot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">vec_len</span><span class="p">)</span>


<span class="c1"># Initialize output</span>
<span class="n">phie</span><span class="p">[</span><span class="mi">0</span><span class="p">:(</span><span class="n">k0</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">3.175</span>
<span class="n">Ve</span><span class="p">[</span><span class="mi">0</span><span class="p">:(</span><span class="n">k0</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>  <span class="o">=</span> <span class="mf">0.0006344</span><span class="p">;</span>
<span class="n">Vr</span><span class="p">[</span><span class="mi">0</span><span class="p">:(</span><span class="n">k0</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>  <span class="o">=</span> <span class="mf">0.005676</span><span class="p">;</span>
<span class="n">Vs</span><span class="p">[</span><span class="mi">0</span><span class="p">:(</span><span class="n">k0</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>  <span class="o">=</span> <span class="o">-</span><span class="mf">0.003234</span><span class="p">;</span>

<span class="c1"># Delay-differential equations</span>
<span class="c1"># Solved using Euler-Maruyama scheme</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">((</span><span class="n">k0</span><span class="o">+</span><span class="mi">1</span><span class="p">),(</span><span class="nb">int</span><span class="p">(</span><span class="n">stop</span><span class="o">/</span><span class="n">dt</span><span class="p">))):</span>
    <span class="n">Ve</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ve</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">Vedot</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span>
    <span class="n">Vedot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Vedot</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span><span class="p">(</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;nu_ee&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">phie</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;nu_ei&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">sig</span><span class="p">(</span><span class="n">Ve</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Qmax&#39;</span><span class="p">],</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">],</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;nu_es&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">sig</span><span class="p">(</span><span class="n">Vs</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">k0</span><span class="p">],</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Qmax&#39;</span><span class="p">],</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">],</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">Vedot</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Ve</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">Vr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Vr</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">Vrdot</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span>
    <span class="n">Vrdot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Vrdot</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="p">(</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;nu_re&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">phie</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">k0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;nu_rs&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">sig</span><span class="p">(</span><span class="n">Vs</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Qmax&#39;</span><span class="p">],</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">],</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">Vrdot</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Vr</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">))</span>
    <span class="n">Vs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Vs</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">Vsdot</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span>
    <span class="n">Vsdot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Vsdot</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="p">(</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;nu_se&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">phie</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">k0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;nu_sr&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">sigr</span><span class="p">(</span><span class="n">Vr</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Qmax&#39;</span><span class="p">],</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">],</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma_r&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">Vsdot</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Vs</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;nu_sn&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;phin_0&#39;</span><span class="p">]</span> <span class="p">))</span> <span class="o">+</span> <span class="n">noise</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">phie</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">phie</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">phiedot</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span>
    <span class="n">phiedot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">phiedot</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="p">(</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">sig</span><span class="p">(</span><span class="n">Ve</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Qmax&#39;</span><span class="p">],</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">],</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">2</span><span class="o">/</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">phiedot</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">phie</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">))</span>


<span class="c1"># Remove initial t0-length from outputs</span>
<span class="n">phie</span> <span class="o">=</span> <span class="n">phie</span><span class="p">[(</span><span class="n">k0</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="nb">len</span><span class="p">(</span><span class="n">phie</span><span class="p">)]</span>
<span class="n">Ve</span> <span class="o">=</span> <span class="n">Ve</span><span class="p">[(</span><span class="n">k0</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="nb">len</span><span class="p">(</span><span class="n">Ve</span><span class="p">)]</span>
<span class="n">Vr</span> <span class="o">=</span> <span class="n">Vr</span><span class="p">[(</span><span class="n">k0</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="nb">len</span><span class="p">(</span><span class="n">Vr</span><span class="p">)]</span>
<span class="n">Vs</span> <span class="o">=</span> <span class="n">Vs</span><span class="p">[(</span><span class="n">k0</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="nb">len</span><span class="p">(</span><span class="n">Vs</span><span class="p">)];</span>
<span class="n">time_array</span> <span class="o">=</span> <span class="n">time_array</span><span class="p">[(</span><span class="n">k0</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="nb">len</span><span class="p">(</span><span class="n">time_array</span><span class="p">)];</span>

<span class="n">X</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">phie</span><span class="p">,</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">freqs</span><span class="p">,</span><span class="n">ps_vPN</span> <span class="o">=</span> <span class="n">welch</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">1000</span><span class="p">:],</span><span class="n">fs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">noverlap</span> <span class="o">=</span> <span class="mi">125</span><span class="p">,</span> <span class="n">nperseg</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Time Series and Power Spectrum&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_array</span><span class="p">,</span> <span class="n">phie</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span><span class="n">ps_vPN</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Output&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Power&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Power&#39;)
</pre></div>
</div>
<img alt="../_images/ab7617b856325901574af479343f374fe58313522e803665c11eb9ce089ef57c.png" src="../_images/ab7617b856325901574af479343f374fe58313522e803665c11eb9ce089ef57c.png" />
</div>
</div>
</div>
<div class="section" id="nftsim-implementation-of-corticothalamic-model">
<h1>NFTsim implementation of corticothalamic model<a class="headerlink" href="#nftsim-implementation-of-corticothalamic-model" title="Permalink to this heading">#</a></h1>
<p><a class="reference external" href="https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1006387"><em>NFTsim</em></a> is a package that facilitates the numerical simulations of a wide range of brain systems using continuum neural field modeling, including the Robinson model. The inherent multiscale characteristics of the neural activity generated by NFTsim offer the possibility to model and simulate observable quantities that can be measured using diverse neuroimaging techniques.</p>
<p>This is the package we are going to be using in the following sections to first model a single-node, and then multiple nodes. Classes of NFTsim are written in C++ . The code works by running configuration files (.conf: found in the <em>conf</em> folder) which sets all the parameters and connectivities of the populations. Once the simulation as ran, the output is then visualized using python functions</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%capture
os.chdir(&#39;/content/Data/Robinson_model/SynPy/&#39;)

!git clone https://github.com/BrainDynamicsUSYD/nftsim.git
%cd nftsim
!make

# @title Install nftsim
</pre></div>
</div>
</div>
</div>
<p><strong>Spatial uniform Robinson Model implementation (Resting state)</strong></p>
<p>In the spatial uniform case, we consider only one node and the details of the model are defined in <em>eirs-corticothalamic.conf</em> file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">utils.nftsim</span>
<span class="n">single_node</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">nftsim</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;/content/Data/Robinson_model/SynPy/confs/eirs-corticothalamic.conf&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Time Series and Power Spectrum&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">single_node</span><span class="o">.</span><span class="n">time</span><span class="p">,</span><span class="n">single_node</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;propagator.1.phi&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Output&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Output&#39;)
</pre></div>
</div>
<img alt="../_images/5d6a24ae8225dee9dd6b240363c9631b2e60d39a9596fbd8962bd4ad6811f3bd.png" src="../_images/5d6a24ae8225dee9dd6b240363c9631b2e60d39a9596fbd8962bd4ad6811f3bd.png" />
</div>
</div>
<p><strong>Whole-brain corticothalamic simulation</strong></p>
<p>In this part we will explore the effect of a node coupling to the dynamics of the system as demonstrated in <a class="reference external" href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7729877/">Müller et al., 2020</a>.</p>
<p>In the mentioned paper, the authors utilized the Robinson model as a basis and constructed a network structure resembling a donut shape. Notably, this network configuration was designed without boundaries, meaning that there are no edges or boundaries where the system can reach or fall off.</p>
<p>Subsequently, the authors proceeded to connect the nodes of the network with local connectivity, represented by the color red. They they manipulated the level of diffuse coupling in order to investigate the effect it has on the dynamics of the network. This allowed them to explore the impact of diffuse coupling on the overall behavior and characteristics of the network.</p>
<p><img alt="alt text" src="https://media.springernature.com/full/springer-static/image/art%3A10.1038%2Fs41467-020-19716-7/MediaObjects/41467_2020_19716_Fig1_HTML.png" /></p>
<p>To help illustrate this concept, let’s consider a glass of water at room temperature. Water can exist in three phases: liquid, solid (ice), and gas (vapor). At room temperature, the water is predominantly in the liquid phase. However, due to the inherent stochastic nature of molecular motion, a small number of water molecules may transition to the vapor phase, even though, on average, the system remains below the critical point for vaporization. As we increase the temperature, the occurrence of such transitions to the vapor phase becomes more frequent.</p>
<p>This analogy can help us understand the concept we want to demonstrate with our model. By gradually increasing the diffusion coupling in our system, we aim to replicate the effect of raising the temperature in the glass of water. We refer to this phenomenon as “spatial heterogeneity” in our system, where the dynamics are initially highly segregated, similar to the predominantly liquid phase of the water. However, as we increase the diffusion coupling, some of the nodes in our system temporarily cross the bifurcation boundary. Consequently, we observe diversities in the brain state, similar to the presence of both liquid and vapor phases in the glass of water.</p>
<p>Increasing the diffusion coupling effectively shifts all nodes in our system towards their local saddle-node bifurcation point. In the middle of this continuum, the introduction of heterogeneous inputs allows a specific subset of nodes (highlighted in orange) to cross this bifurcation point. Consequently, the activity of these nodes begins to move towards the high firing attractor, akin to the increased occurrence of water molecules transitioning to the vapor phase as the temperature rises in the glass of water.</p>
<p>The hypothesis we aim to demonstrate is as follows: at a low level of diffuse coupling, minimal changes or effects are observed within the system. Conversely, at a high level of diffuse coupling, the system enters a state of saturation, resembling characteristics seen in epilepsy. However, what is particularly intriguing is the intermediate zone, where a blend of the extreme states is explored:
a) an extreme where the reticular nucleus actively inhibits the thalamus, resulting in a more damped state
b) an extreme where instead the thalamus can become involved and activate the excitatory population in the cortex, leading to a different dynamic within the system.</p>
<p>This intermediate zone offers a fascinating exploration of the interplay between the inhibitory and excitatory elements of the system and the resulting connectivity that arise from it.</p>
<p><img alt="alt text" src="https://media.springernature.com/lw685/springer-static/image/art%3A10.1038%2Fs41467-020-19716-7/MediaObjects/41467_2020_19716_Fig2_HTML.png" /></p>
<p>To test this hypothesis we are going to run the model using two different configuration files (<code class="docutils literal notranslate"><span class="pre">.conf</span></code>) for whole-brain simulation:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">eirs-model_subcritical.conf</span></code>: low level of diffuse coupling</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">eirs-model_quasicritical.conf</span></code>: intermediate level of diffuse coupling</p></li>
</ol>
<p>In a nutshell, the only difference between the two (<code class="docutils literal notranslate"><span class="pre">.conf</span></code>) files is the level of diffuse synaptic connectivity.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">nftsim</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;/content/Data/Robinson_model/SynPy/confs/eirs-model_subcritical.conf&#39;</span><span class="p">)</span>
<span class="n">cort_phi_e_1</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;pop.1.q&#39;</span><span class="p">]</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">nftsim</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;/content/Data/Robinson_model/SynPy/confs/eirs-model_quasicritical.conf&#39;</span><span class="p">)</span>

<span class="n">cort_phi_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">cort_phi_e_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cort_phi_e_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
<span class="n">cort_phi_e</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cort_phi_e_1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">cort_phi_e</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;pop.1.q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.005</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_points</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;propagator.1.phi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">nodes</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;propagator.1.phi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The data has &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">time_points</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; time points and &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; nodes&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The data has 5594 time points and 144 nodes
</pre></div>
</div>
</div>
</div>
<p>Having executed the two models, our next objective is to convert the firing rate activity into a blood-oxygen-level-dependent (BOLD) signal that closely resembles the signals typically recorded during fMRI acquisitions.</p>
<p>We are going to define some function for calculating the BOLD signal using the Balloon model <a class="reference external" href="https://www.sciencedirect.com/science/article/abs/pii/S105381190090630X">Friston et al., 2000</a>, and a Parameter class to define the parameters used in this function.</p>
<p>The Balloon model is a mathematical framework that explains the relationship between neural activity, blood flow, and the BOLD signal measured in fMRI. It is based on the assumption that neural activity leads to local changes in cerebral blood flow (CBF), cerebral blood volume (CBV), and the oxygen extraction fraction (OEF) in a specific brain region which in turn influence the BOLD signal.</p>
<p>According to the Balloon model, increased neural activity triggers increased blood flow to the corresponding brain region. This elevated blood flow causes vasodilation of blood vessels, resulting in an increase in blood volume and changes in the concentration of deoxyhemoglobin. These changes in hemodynamics affect the magnetic properties of blood and lead to variations in the BOLD signal detected by <a class="reference external" href="http://fMRI.It">fMRI.It</a> involves two state variables: volume (v) and deoxyhemoglobin content (q), and takes blood flow (fin) as input and produces the BOLD signal (y) as output.</p>
<p>This conversion process allows us to bridge the gap between the neuronal-level activity simulated by the models and the macroscopic BOLD signals obtained from fMRI measurements. By simulating the BOLD signal, we can analyze and compare the model outputs with empirical fMRI data, facilitating a better understanding of the relationship between neuronal activity and the observed BOLD signals in the brain.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_BOLD_balloon</span><span class="p">(</span><span class="n">input_ts</span><span class="p">):</span>
<span class="c1">#  Simulate BOLD balloon model</span>

    <span class="n">nT</span> <span class="o">=</span> <span class="n">input_ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">input_ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">param</span> <span class="o">=</span> <span class="n">loadParameters_balloon_func</span><span class="p">()</span>

    <span class="c1"># Time parameters</span>
    <span class="n">param</span><span class="o">.</span><span class="n">tstep</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># time step</span>
    <span class="n">param</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="n">nT</span> <span class="o">*</span> <span class="mf">0.01</span>  <span class="c1"># maximum time</span>
    <span class="n">param</span><span class="o">.</span><span class="n">tspan</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">tmax</span><span class="p">]</span>  <span class="c1"># time period limits</span>
    <span class="n">param</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">tmax</span> <span class="o">+</span> <span class="n">param</span><span class="o">.</span><span class="n">tstep</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">tstep</span><span class="p">)</span>  <span class="c1"># time vector</span>

    <span class="c1"># initialize activity vectors</span>
    <span class="n">sol</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">sol</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span>
    <span class="n">sol</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span>
    <span class="n">sol</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span>
    <span class="n">sol</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span>
    <span class="n">sol</span><span class="p">[</span><span class="s1">&#39;BOLD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span>

    <span class="c1"># setting initial condition</span>
    <span class="n">F0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="mf">0.001</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

    <span class="n">F</span> <span class="o">=</span> <span class="n">F0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">sol</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">sol</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">sol</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">sol</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">T</span><span class="p">)):</span>
        <span class="n">dF</span> <span class="o">=</span> <span class="n">balloon_ODE</span><span class="p">(</span><span class="n">input_ts</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">F</span> <span class="o">+</span> <span class="n">dF</span> <span class="o">*</span> <span class="n">param</span><span class="o">.</span><span class="n">tstep</span>
        <span class="n">sol</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">sol</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">][:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">sol</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">][:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">sol</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">][:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>

    <span class="n">sol</span><span class="p">[</span><span class="s1">&#39;BOLD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">param</span><span class="o">.</span><span class="n">V0</span> <span class="o">*</span> <span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">k1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sol</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">param</span><span class="o">.</span><span class="n">k2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sol</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">sol</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">param</span><span class="o">.</span><span class="n">k3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sol</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]))</span>

    <span class="n">BOLD_activity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">sol</span><span class="p">[</span><span class="s1">&#39;BOLD&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">BOLD_activity</span>


<span class="k">def</span> <span class="nf">balloon_ODE</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
<span class="c1"># Calculate the temporal activity by solving an ODE.</span>

<span class="c1"># Inputs: S          : spatiotemporal external input [V x 1]</span>
<span class="c1">#         F          : solutions at one time point</span>
<span class="c1">#         param      : model parameters (struct)</span>

<span class="c1"># Output: dF         : time derivative of variables [4 x 1]</span>

<span class="c1"># Original: James Pang, Monash University, 2022</span>


    <span class="n">z</span> <span class="o">=</span> <span class="n">F</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">F</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">F</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">F</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>

    <span class="n">dF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
    <span class="n">dF</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span> <span class="o">-</span> <span class="n">param</span><span class="o">.</span><span class="n">kappa</span> <span class="o">*</span> <span class="n">z</span> <span class="o">-</span> <span class="n">param</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">dF</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>
    <span class="n">dF</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">param</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">v</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">param</span><span class="o">.</span><span class="n">alpha</span><span class="p">))</span>
    <span class="n">dF</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">param</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">f</span> <span class="o">/</span> <span class="n">param</span><span class="o">.</span><span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">param</span><span class="o">.</span><span class="n">rho</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">f</span><span class="p">))</span> <span class="o">-</span> <span class="n">q</span> <span class="o">*</span> <span class="n">v</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">param</span><span class="o">.</span><span class="n">alpha</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">dF</span>


<span class="k">def</span> <span class="nf">balloon_Fourier</span><span class="p">(</span><span class="n">input_ts</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
    <span class="n">Nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    <span class="n">Nw</span> <span class="o">=</span> <span class="n">Nt</span>
    <span class="n">wsamp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">tstep</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">jvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Nw</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">wsamp</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">Nw</span> <span class="o">*</span> <span class="p">(</span><span class="n">jvec</span> <span class="o">-</span> <span class="n">Nw</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># mode_coeff_fft = ctfft(mode_coeff, param.T);</span>
    <span class="n">mode_coeff_fft</span> <span class="o">=</span> <span class="n">coord2freq_1D</span><span class="p">(</span><span class="n">mode_coeff</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>

    <span class="c1"># Transfer functions from Robinson et al. 2006, Aquino et al. 2012, 2014,</span>
    <span class="c1"># Pang et al. 2016, 2018</span>
    <span class="n">T_Fz</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">w</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">param</span><span class="o">.</span><span class="n">kappa</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">param</span><span class="o">.</span><span class="n">w_f</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">T_yF</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">V_0</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">param</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">k2</span> <span class="o">+</span> <span class="n">param</span><span class="o">.</span><span class="n">k3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">param</span><span class="o">.</span><span class="n">tau</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span>
            <span class="n">param</span><span class="o">.</span><span class="n">k1</span> <span class="o">+</span> <span class="n">param</span><span class="o">.</span><span class="n">k2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">alpha</span> <span class="o">+</span> <span class="n">param</span><span class="o">.</span><span class="n">beta</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">param</span><span class="o">.</span><span class="n">tau</span> <span class="o">*</span> <span class="n">param</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">param</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="n">w</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">param</span><span class="o">.</span><span class="n">tau</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">param</span><span class="o">.</span><span class="n">tau</span> <span class="o">*</span> <span class="n">param</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">w</span><span class="p">))</span>
    <span class="n">T_yz</span> <span class="o">=</span> <span class="n">T_yF</span> <span class="o">*</span> <span class="n">T_Fz</span>

    <span class="n">out_fft</span> <span class="o">=</span> <span class="n">T_yz</span> <span class="o">*</span> <span class="n">mode_coeff_fft</span>

    <span class="c1"># calculate inverse Fourier transform</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">freq2coord_1D</span><span class="p">(</span><span class="n">out_fft</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">Parameters</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kappa</span> <span class="o">=</span> <span class="mf">0.65</span>  <span class="c1"># signal decay rate [s^-1]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.41</span>  <span class="c1"># rate of elimination [s^-1]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="mf">0.98</span>  <span class="c1"># hemodynamic transit time [s]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.32</span>  <span class="c1"># Grubb&#39;s exponent [unitless]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="mf">0.34</span>  <span class="c1"># resting oxygen extraction fraction [unitless]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V0</span> <span class="o">=</span> <span class="mf">0.02</span>  <span class="c1"># resting blood volume fraction [unitless]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_f</span> <span class="o">=</span> <span class="mf">0.56</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q0</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho_f</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xi_0</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V_0</span> <span class="o">=</span> <span class="mf">0.02</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k1</span> <span class="o">=</span> <span class="mf">3.72</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k2</span> <span class="o">=</span> <span class="mf">0.527</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k3</span> <span class="o">=</span> <span class="mf">0.48</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tstep</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># time step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># maximum time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tspan</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">]</span>  <span class="c1"># time period limits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstep</span><span class="p">)</span>  <span class="c1"># time vector</span>


<span class="k">def</span> <span class="nf">loadParameters_balloon_func</span><span class="p">():</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">param</span>


<span class="c1"># Function to calculate the probability distribution and energy for each dt using the kernel density estimation (KDE) method</span>
<span class="kn">from</span> <span class="nn">statsmodels.nonparametric.kernel_density</span> <span class="kn">import</span> <span class="n">KDEMultivariate</span>

<span class="k">def</span> <span class="nf">PdistGaussKern</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">bandwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">bandwidth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bandwidth</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">kde</span> <span class="o">=</span> <span class="n">KDEMultivariate</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">bw</span><span class="o">=</span><span class="p">[</span><span class="n">bandwidth</span><span class="p">],</span> <span class="n">var_type</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
    <span class="n">yLC</span> <span class="o">=</span> <span class="n">kde</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
    <span class="n">nrg</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">yLC</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nrg</span>

<span class="c1"># @title Functions</span>
</pre></div>
</div>
</div>
</div>
<p>In this cell we are going to convert the firining rate for subcritical and quasicritical cases into BOLD time series.
For doing that we are going to use the function <code class="docutils literal notranslate"><span class="pre">model_BOLD_balloon</span></code> we have just defined and the outputs for both condition (subcritical and quasicritical) is saved in the same variable <em>cort_phi_e</em> with dimensions as: time_points x nodes x case.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bold_ts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">bold_burn</span> <span class="o">=</span> <span class="mi">2000</span>  <span class="c1"># Timescale of initial transients - needs to be fit</span>
<span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cort_phi_e</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">model_BOLD_balloon</span><span class="p">(</span><span class="n">cort_phi_e</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">pp</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="n">bold_burn</span><span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># Remove burn-in</span>

    <span class="c1"># Save BOLD data</span>
    <span class="n">bold_ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">bold_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bold_ts</span><span class="p">)</span>
<span class="n">bold_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">bold_ts</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">t_burn</span> <span class="o">=</span> <span class="mi">1500</span><span class="p">;</span>
<span class="n">cort_phi_e</span> <span class="o">=</span> <span class="n">cort_phi_e</span><span class="p">[</span><span class="n">t_burn</span><span class="p">:,:,:]</span>
</pre></div>
</div>
</div>
</div>
<p>Now that we have BOLD timeseries we are going to plots the cortical phi e output and the correlation coefficient, as well as the BOLD signal and the functional connectivity (FC) to explore differences between the two conditions</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cort_phi_e</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">dt</span>
<span class="n">t_bold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">bold_ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">dt</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Plot for the first set of data</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">cort_phi_e</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Firing rate&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Q [Hz]&#39;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">cort_phi_e</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Correlation&#39;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_bold</span><span class="p">,</span> <span class="n">zscore</span><span class="p">(</span><span class="n">bold_ts</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;BOLD signal&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;F/F_0&#39;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">bold_ts</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Functional Connectivity&#39;</span><span class="p">)</span>

<span class="c1"># Plot for the second set of data</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">cort_phi_e</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Firing rate&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Q [Hz]&#39;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">cort_phi_e</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Correlation&#39;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_bold</span><span class="p">,</span> <span class="n">zscore</span><span class="p">(</span><span class="n">bold_ts</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;BOLD signal&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;F/F_0&#39;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">bold_ts</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Functional Connectivity&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/9da1678c704dac5ca8d1dd82cc6b9d20fe42cbba08dd048f5896eb2e8bbde373.png" src="../_images/9da1678c704dac5ca8d1dd82cc6b9d20fe42cbba08dd048f5896eb2e8bbde373.png" />
</div>
</div>
<p>As it is evident the system tends to be more integrated when we increased the value of diffusion coupling (bottom row) compared to low level of diffusion coupling</p>
</div>
<div class="section" id="energy-landscape">
<h1>Energy Landscape<a class="headerlink" href="#energy-landscape" title="Permalink to this heading">#</a></h1>
<p>The energy landscape provides a visual representation of the energy required to transition between different brain states. It is defined as the natural logarithm of the inverse probability of observing a specific BOLD mean-squared displacement (MSD) at a given time-lag, expressed by the equation:</p>
<br/>
\begin{equation}
E = \ln \left( \frac{{P(MSD, t)}}{1} \right)
\end{equation}
<br/>
<p>To calculate the MSD, denoted as <span class="math notranslate nohighlight">\(MSD(t, t0)\)</span>, we consider the BOLD signal,<code class="docutils literal notranslate"> <span class="pre">xt</span> <span class="pre">=</span> <span class="pre">[x1,t,</span> <span class="pre">x2,t,</span> <span class="pre">...,</span> <span class="pre">xr,t]</span></code>, which represents the signal across r voxels at time t. Here, t0 refers to a reference time point. The MSD is computed as the average squared displacement of the BOLD signal over time-lags of size TR, where TR represents the time resolution. The mathematical expression for <span class="math notranslate nohighlight">\(MSD(t, t0)\)</span> is given by:</p>
<br/>
\begin{equation}
MSD_{t,t_0} = \langle |x_{t_0+t} - x_{t_0}|^2 \rangle_r
\end{equation}
<br/>
<p>and represents the probability of observing the MSD at time-lag t.</p>
<p>Here we are going to plot the empirical BOLD energy landscape as a function of MSD and time. This means that the energy landscape is characterized by the energy associated with a given mean change in BOLD activity (i.e., MSD) at a particular time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ndt</span> <span class="o">=</span> <span class="mi">400</span>  <span class="c1"># Number of lags</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Number of MSD divisions</span>

<span class="n">nrgSig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">ndt</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="p">),</span> <span class="n">cort_phi_e</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
<span class="n">nrgSig</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">nrgBase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">ndt</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="p">),</span> <span class="n">cort_phi_e</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
<span class="n">nrgBase</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

<span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cort_phi_e</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bold_ts</span><span class="p">[::</span><span class="mi">5</span><span class="p">,</span> <span class="p">:,</span> <span class="n">mm</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">cortSig</span> <span class="o">=</span> <span class="n">zscore</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">MSD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">cortSig</span><span class="p">[</span><span class="n">tt</span><span class="p">:]</span> <span class="o">-</span> <span class="n">cortSig</span><span class="p">[:</span><span class="o">-</span><span class="n">tt</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">nrgSigdt</span> <span class="o">=</span> <span class="n">PdistGaussKern</span><span class="p">(</span><span class="n">MSD</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">nrgSig</span><span class="p">[</span><span class="n">tt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="n">mm</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrgSigdt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="kn">import</span> <span class="n">Axes3D</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">ds</span>
<span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">xmin</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">xmax</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">zmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nrgSig</span><span class="p">))),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Subplot 1</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">nrgSig</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [s]&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;MSD&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;MSD energy&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">zmax</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span>  <span class="c1"># XZ</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Subcritical&#39;</span><span class="p">)</span>

<span class="c1"># Subplot 2</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">nrgSig</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [s]&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;MSD&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;MSD energy&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">zmax</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span>  <span class="c1"># XZ</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Quasicritical&#39;</span><span class="p">)</span>

<span class="c1"># Subplot 3</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="p">(</span><span class="n">nrgSig</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">nrgSig</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [s]&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;MSD&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;MSD energy&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span>  <span class="c1"># XZ</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Quasicritical minus Subcritical&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5f8c4f67ee4b5cd9ba2d169dc356864e8151e079806e1b810b62f049456722cb.png" src="../_images/5f8c4f67ee4b5cd9ba2d169dc356864e8151e079806e1b810b62f049456722cb.png" />
</div>
</div>
<p>The quasi-critical zone is associated with an integrated, flexible, and relatively low-dimensional network architecture which has implications in information processing.</p>
</div>
<div class="section" id="traveling-brain-waves">
<h1><strong>Traveling brain waves</strong><a class="headerlink" href="#traveling-brain-waves" title="Permalink to this heading">#</a></h1>
<p>The scope of this part is showing the role of geometry in shaping function. Specifically this part replicate the analyses done in</p>
<blockquote>
<div><p>Pang JC., Aquino KM, Oldehinkel M., Robinson PA., Fulcher BD., Breakspear M., Fornito A. (2023) <strong>Geometric constraints on human brain function.</strong> <em>Nature</em>, 618(7965):566-574. doi: 10.1038/s41586-023-06098-1.</p>
</div></blockquote>
<p><img alt="alt text" src="https://media.springernature.com/full/springer-static/image/art%3A10.1038%2Fs41586-023-06098-1/MediaObjects/41586_2023_6098_Fig4_HTML.png?as=webp" /></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calc_eigendecomposition</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">eigenvectors</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;matrix&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decompose data using eigenvectors and calculate the coefficient of contribution of each vector.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    - data: data [M x P]</span>
<span class="sd">            M = number of points, P = number of independent data</span>
<span class="sd">    - eigenvectors: eigenvectors [M x N]</span>
<span class="sd">                    M = number of points, N = number of eigenvectors</span>
<span class="sd">    - method: type of calculation (string)</span>
<span class="sd">              &#39;matrix&#39;, &#39;matrix_separate&#39;, &#39;regression&#39;</span>

<span class="sd">    Output:</span>
<span class="sd">    - coeffs: coefficient values [N x P]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">M</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">eigenvectors</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;matrix&#39;</span><span class="p">:</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">eigenvectors</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;matrix_separate&#39;</span><span class="p">:</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">P</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">P</span><span class="p">):</span>
            <span class="n">coeffs</span><span class="p">[:,</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">eigenvectors</span><span class="p">,</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">p</span><span class="p">],</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">P</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">P</span><span class="p">):</span>
            <span class="n">coeffs</span><span class="p">[:,</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">eigenvectors</span><span class="p">,</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">p</span><span class="p">],</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">coeffs</span>


<span class="k">def</span> <span class="nf">coord2freq_1D</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">padN</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the 1D continuous Fourier transform of T.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    - T: array of 1D transfer function or signal in coordinate space</span>
<span class="sd">         size(T) = [1, length(w)]</span>
<span class="sd">    - w: vector of temporal frequencies</span>
<span class="sd">    - padN: number extending the length of T to N by padding zeros</span>
<span class="sd">            (not a required input)</span>

<span class="sd">    Output:</span>
<span class="sd">    - out: array of transfer function or signal in frequency space</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># calculating the -1 vectors needed for the Fourier transform</span>
    <span class="n">wM</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># performing the Fourier transform</span>
    <span class="k">if</span> <span class="n">padN</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">wM</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">wM</span> <span class="o">*</span> <span class="n">T</span><span class="p">,</span> <span class="n">padN</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">wM</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">wM</span> <span class="o">*</span> <span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">freq2coord_1D</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">padN</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the continuous 1D inverse Fourier transform of T.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    - T: array of 1D transfer function or signal in frequency space</span>
<span class="sd">         size(T) = [1, length(w)]</span>
<span class="sd">    - w: vector of temporal frequencies</span>
<span class="sd">    - padN: number extending the length of T to N by padding zeros</span>
<span class="sd">            (not a required input)</span>

<span class="sd">    Output:</span>
<span class="sd">    - out: array of transfer function or signal in coordinate space</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># calculating the -1 vectors needed for the Fourier transform</span>
    <span class="n">wM</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># performing the inverse Fourier transform</span>
    <span class="k">if</span> <span class="n">padN</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">wM</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">wM</span> <span class="o">*</span> <span class="n">T</span><span class="p">,</span> <span class="n">padN</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">wM</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">wM</span> <span class="o">*</span> <span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">model_neural_waves_python</span><span class="p">(</span><span class="n">eig_vec</span><span class="p">,</span> <span class="n">eig_val</span><span class="p">,</span> <span class="n">ext_input</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ODE&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulate neural waves on a surface using eigenmodes.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    - eig_vec: eigenvectors (eigenmodes) [V x num_modes]</span>
<span class="sd">                V = number of vertices</span>
<span class="sd">                num_modes = number of modes</span>
<span class="sd">    - eig_val: eigenvalues [num_modes x 1]</span>
<span class="sd">    - ext_input: spatiotemporal external input [V x T]</span>
<span class="sd">                T = number of time points</span>
<span class="sd">    - param: model parameters (dictionary)</span>
<span class="sd">    - method: method for calculating the activity (string)</span>
<span class="sd">              &#39;ODE&#39; = via solving ODEs</span>
<span class="sd">              &#39;Fourier&#39; = via solving Fourier transform</span>

<span class="sd">    Outputs:</span>
<span class="sd">    - mode_activity: simulated mode activity [num_modes x T]</span>
<span class="sd">    - sim_activity: simulated wave activity [V x T]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">num_modes</span> <span class="o">=</span> <span class="n">eig_vec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ODE&#39;</span><span class="p">:</span>
        <span class="c1"># Mode decomposition of external input</span>
        <span class="n">ext_input_coeffs</span> <span class="o">=</span> <span class="n">calc_eigendecomposition</span><span class="p">(</span><span class="n">ext_input</span><span class="p">,</span> <span class="n">eig_vec</span><span class="p">,</span> <span class="s1">&#39;matrix&#39;</span><span class="p">)</span>

        <span class="c1"># Initialize simulated activity vector</span>
        <span class="n">sim_activity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_modes</span><span class="p">,</span> <span class="n">ext_input_coeffs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">mode_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_modes</span><span class="p">):</span>
            <span class="n">mode_coeff</span> <span class="o">=</span> <span class="n">ext_input_coeffs</span><span class="p">[</span><span class="n">mode_ind</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">lambda_val</span> <span class="o">=</span> <span class="n">eig_val</span><span class="p">[</span><span class="n">mode_ind</span><span class="p">]</span>

            <span class="c1"># Solve the ODE system</span>
            <span class="n">yout</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">wave_ODE_python</span><span class="p">,</span> <span class="p">[</span><span class="n">mode_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">mode_coeff</span><span class="p">,</span> <span class="n">lambda_val</span><span class="p">,</span> <span class="n">param</span><span class="p">))</span>

            <span class="n">sim_activity</span><span class="p">[</span><span class="n">mode_ind</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">yout</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;Fourier&#39;</span><span class="p">:</span>
        <span class="c1"># Append time vector with negative values to have a zero center</span>
        <span class="n">T_append</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="o">-</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;tmax&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]),</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]))</span>
        <span class="n">Nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">T_append</span><span class="p">)</span>
        <span class="n">t0_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">T_append</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Mode decomposition of external input</span>
        <span class="n">ext_input_coeffs_temp</span> <span class="o">=</span> <span class="n">calc_eigendecomposition</span><span class="p">(</span><span class="n">ext_input</span><span class="p">,</span> <span class="n">eig_vec</span><span class="p">,</span> <span class="s1">&#39;matrix&#39;</span><span class="p">)</span>

        <span class="c1"># Append external input coefficients for negative time values</span>
        <span class="n">ext_input_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_modes</span><span class="p">,</span> <span class="n">Nt</span><span class="p">))</span>
        <span class="n">ext_input_coeffs</span><span class="p">[:,</span> <span class="n">t0_ind</span><span class="p">:]</span> <span class="o">=</span> <span class="n">ext_input_coeffs_temp</span>

        <span class="c1"># Initialize simulated activity vector</span>
        <span class="n">sim_activity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_modes</span><span class="p">,</span> <span class="n">ext_input_coeffs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">mode_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_modes</span><span class="p">):</span>
            <span class="n">mode_coeff</span> <span class="o">=</span> <span class="n">ext_input_coeffs</span><span class="p">[</span><span class="n">mode_ind</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">lambda_val</span> <span class="o">=</span> <span class="n">eig_val</span><span class="p">[</span><span class="n">mode_ind</span><span class="p">]</span>

            <span class="c1"># Solve the Fourier transformed system</span>
            <span class="n">yout</span> <span class="o">=</span> <span class="n">wave_Fourier_python</span><span class="p">(</span><span class="n">mode_coeff</span><span class="p">,</span> <span class="n">lambda_val</span><span class="p">,</span> <span class="n">T_append</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>

            <span class="n">sim_activity</span><span class="p">[</span><span class="n">mode_ind</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">yout</span>

        <span class="n">sim_activity</span> <span class="o">=</span> <span class="n">sim_activity</span><span class="p">[:,</span> <span class="n">t0_ind</span><span class="p">:]</span>

    <span class="n">mode_activity</span> <span class="o">=</span> <span class="n">sim_activity</span>

    <span class="c1"># Combine mode time series with mode spatial map</span>
    <span class="n">sim_activity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">eig_vec</span><span class="p">,</span> <span class="n">sim_activity</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mode_activity</span><span class="p">,</span> <span class="n">sim_activity</span>


<span class="k">def</span> <span class="nf">wave_ODE_python</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">mode_coeff</span><span class="p">,</span> <span class="n">lambda_val</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the temporal activity of one mode via solving an ODE.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    - y: activity variable</span>
<span class="sd">    - t: time variable</span>
<span class="sd">    - mode_coeff: coefficient of the mode [1 x T]</span>
<span class="sd">    - lambda_val: eigenvalue of the mode (float)</span>
<span class="sd">    - param: model parameters (dictionary)</span>

<span class="sd">    Output:</span>
<span class="sd">    - out: activity and its first-order derivative [2 x 1]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">coef_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span> <span class="n">mode_coeff</span><span class="p">)</span>  <span class="c1"># Interpolated coefficient at t</span>

    <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;gamma_s&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">coef_interp</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;gamma_s&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;r_s&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">lambda_val</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">wave_Fourier_python</span><span class="p">(</span><span class="n">mode_coeff</span><span class="p">,</span> <span class="n">lambda_val</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the temporal activity of one mode via Fourier transform.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    - mode_coeff: coefficient of the mode [1 x T]</span>
<span class="sd">    - lambda_val: eigenvalue of the mode (float)</span>
<span class="sd">    - T: time vector with zero center [1 x T]</span>
<span class="sd">    - param: model parameters (dictionary)</span>

<span class="sd">    Output:</span>
<span class="sd">    - out: activity [1 x T]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    <span class="n">Nw</span> <span class="o">=</span> <span class="n">Nt</span>
    <span class="n">wsamp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;tstep&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">jvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Nw</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">wsamp</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">Nw</span> <span class="o">*</span> <span class="p">(</span><span class="n">jvec</span> <span class="o">-</span> <span class="n">Nw</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">mode_coeff_fft</span> <span class="o">=</span> <span class="n">coord2freq_1D</span><span class="p">(</span><span class="n">mode_coeff</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>

    <span class="n">out_fft</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;gamma_s&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mode_coeff_fft</span> <span class="o">/</span> <span class="p">(</span><span class="o">-</span><span class="n">w</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">w</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;gamma_s&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;gamma_s&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;r_s&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">lambda_val</span><span class="p">))</span>

    <span class="c1"># Calculate inverse Fourier transform</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">freq2coord_1D</span><span class="p">(</span><span class="n">out_fft</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">loadParameters_wave_func</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Contains all the parameters of the wave model and the computational parameters for the simulations/calculations.</span>
<span class="sd">    It is necessary to make an instance of the function before you can use the parameters.</span>

<span class="sd">    Some important notes:</span>
<span class="sd">    1. All the parameters can be changed by overwriting the existing instance (example: param.r_s = 10 if you want to change the length scale).</span>
<span class="sd">    2. The dependent parameters need to be manually updated when other independent parameters are changed.</span>

<span class="sd">    Returns:</span>
<span class="sd">    param (dict): Dictionary containing the model parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">param</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># DEFAULT INDEPENDENT MODEL PARAMETERS</span>
    <span class="n">param</span><span class="p">[</span><span class="s1">&#39;r_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># length scale [mm]</span>
    <span class="n">param</span><span class="p">[</span><span class="s1">&#39;gamma_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">116</span>  <span class="c1"># damping rate [s^-1]</span>

    <span class="c1"># COMPUTATIONAL PARAMETERS</span>
    <span class="n">param</span><span class="p">[</span><span class="s1">&#39;is_time_ms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 1 = if time is in ms; 0 = if time is in s</span>
    <span class="n">param</span><span class="p">[</span><span class="s1">&#39;tstep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># time step [s]</span>
    <span class="n">param</span><span class="p">[</span><span class="s1">&#39;tmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># maximum time [s]</span>

    <span class="c1"># DEPENDENT PARAMETERS</span>
    <span class="n">param</span><span class="p">[</span><span class="s1">&#39;tspan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;tmax&#39;</span><span class="p">]]</span>  <span class="c1"># time period limits</span>
    <span class="n">param</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;tmax&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;tstep&#39;</span><span class="p">],</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;tstep&#39;</span><span class="p">])</span>  <span class="c1"># time vector</span>

    <span class="k">return</span> <span class="n">param</span>


<span class="k">def</span> <span class="nf">list_communities</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">keep_all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Convert networkx dict of communities to list.</span>

<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    p : dict</span>
<span class="sd">        Dictionary where keys are network nodes and values are</span>
<span class="sd">        community indicies.</span>

<span class="sd">    keep_all : bool, optional</span>
<span class="sd">        If keep_all then then include communities with only one node</span>
<span class="sd">        otherwise only keep communities with 2 or more nodes.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    c : list</span>
<span class="sd">        List of communities. Each list element contains a list of node</span>
<span class="sd">        labels for the corresponding community.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">c</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># assemblies (partition elements with size of at least 2)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">comm</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">==</span><span class="n">j</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comm</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comm</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c</span>


<span class="k">def</span> <span class="nf">adjacency_communities</span><span class="p">(</span>
        <span class="n">G</span><span class="p">,</span>
        <span class="n">c</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">props</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Plot network adjacency matrix with coloured communities.</span>

<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    G : networkx.classes.graph.Graph</span>
<span class="sd">        A networkx graph.</span>

<span class="sd">    c : list</span>
<span class="sd">        List of communities. Each list element contains a list of node</span>
<span class="sd">        labels for the corresponding community.</span>

<span class="sd">    cmap : array_like, shape (M,4), optional</span>
<span class="sd">        RGBA array. Each row corresponds to a community.</span>

<span class="sd">    vmin : float, optional</span>
<span class="sd">        Minimum value for adjacency matrix visualisation.</span>

<span class="sd">    vmax : float, optional</span>
<span class="sd">        Maximum value for adjacency matrix visualisation.</span>

<span class="sd">    ax : axes (matplotlib.axes._subplots.AxesSubplot), optional</span>
<span class="sd">        Axes handle to plot.</span>

<span class="sd">    props : dict, optional</span>
<span class="sd">        Dictionary of figure and axes properties.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig : figure (matplotlib.figure.Figure)</span>
<span class="sd">        Figure handle to plot.</span>

<span class="sd">    ax : axes (matplotlib.axes._subplots.AxesSubplot)</span>
<span class="sd">        Axes handle to plot.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Keyword arguments</span>
    <span class="n">defaultprops</span> <span class="o">=</span> <span class="p">{</span>
                       <span class="s2">&quot;figsize&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span>
                       <span class="s2">&quot;zlabel&quot;</span> <span class="p">:</span> <span class="s2">&quot;$w_{i,j}$&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;fontsize&quot;</span> <span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                       <span class="s2">&quot;labelpad&quot;</span> <span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                   <span class="p">}</span>
    <span class="n">defaultprops</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
    <span class="n">props</span> <span class="o">=</span> <span class="n">defaultprops</span>

    <span class="c1"># Set up figure and axes</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ax</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;figsize&#39;</span><span class="p">])</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">inset_axes</span><span class="p">(</span>
                  <span class="n">ax</span><span class="p">,</span>
                  <span class="n">width</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span>  <span class="c1"># width = 8% of parent_bbox width</span>
                  <span class="n">height</span><span class="o">=</span><span class="s2">&quot;100%&quot;</span><span class="p">,</span>  <span class="c1"># height : 50%</span>
                  <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span>
                  <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.075</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                  <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                  <span class="n">borderpad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
              <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>

    <span class="c1"># Get adjacency</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">to_numpy_array</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>

    <span class="c1"># Sort adjacency by communities</span>
    <span class="n">label_to_index</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">community</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">community</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">label_to_index</span><span class="p">:</span>
                <span class="n">label_to_index</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Map community labels to integer indices</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">label_to_index</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">for</span> <span class="n">community</span> <span class="ow">in</span> <span class="n">c</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">community</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">idx</span><span class="p">)]</span>

    <span class="c1"># Plot adjacency matrix</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
             <span class="n">A</span><span class="p">,</span>
             <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
             <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
             <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
             <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span>
         <span class="p">)</span>

    <span class="c1"># Specify colormap</span>
    <span class="k">if</span> <span class="n">cmap</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">tab20</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)))</span>

    <span class="c1"># Plot community structure</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">cc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
        <span class="c1"># Plot bar on y-axis</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span>
            <span class="p">[</span><span class="n">offset</span><span class="p">,</span><span class="n">offset</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">cc</span><span class="p">)],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Plot transparent overlay</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
            <span class="p">[</span><span class="n">offset</span><span class="p">,</span><span class="n">offset</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">cc</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">offset</span><span class="p">,</span><span class="n">offset</span><span class="p">],</span>
            <span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">cc</span><span class="p">),</span><span class="n">offset</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">cc</span><span class="p">)],</span>
            <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="n">offset</span><span class="o">+=</span><span class="nb">len</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>

    <span class="c1"># Format adjacency image</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="c1"># Format communities axis</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">())</span>

    <span class="n">ax2</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="n">axins</span> <span class="o">=</span> <span class="n">inset_axes</span><span class="p">(</span>
                <span class="n">ax</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="s2">&quot;8%&quot;</span><span class="p">,</span>  <span class="c1"># width = 8% of parent_bbox width</span>
                <span class="n">height</span><span class="o">=</span><span class="s2">&quot;50%&quot;</span><span class="p">,</span>  <span class="c1"># height : 50%</span>
                <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span>
                <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                <span class="n">borderpad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">cax</span><span class="o">=</span><span class="n">axins</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">outline</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">vmin</span><span class="p">:</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">vmax</span><span class="p">:</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">cticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">item</span><span class="si">:</span><span class="s1">.2</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cticks</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">vmin</span><span class="o">&gt;</span><span class="n">A</span><span class="o">.</span><span class="n">min</span><span class="p">():</span>
        <span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\leq$&#39;</span> <span class="o">+</span> <span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">vmax</span><span class="o">&lt;</span><span class="n">A</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
        <span class="n">labels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\geq$&#39;</span> <span class="o">+</span> <span class="n">labels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">cticks</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span>
        <span class="n">props</span><span class="p">[</span><span class="s1">&#39;zlabel&#39;</span><span class="p">],</span>
        <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">],</span>
        <span class="n">labelpad</span><span class="o">=</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;labelpad&#39;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>


<span class="k">def</span> <span class="nf">hex_to_rgb</span><span class="p">(</span><span class="n">hex_code</span><span class="p">):</span>
    <span class="c1"># Remove the &#39;#&#39; character from the hex code</span>
    <span class="n">hex_code</span> <span class="o">=</span> <span class="n">hex_code</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>

    <span class="c1"># Convert the hex values to integers</span>
    <span class="n">red</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hex_code</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span><span class="o">/</span><span class="mf">255.0</span>
    <span class="n">green</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hex_code</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span><span class="o">/</span><span class="mf">255.0</span>
    <span class="n">blue</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hex_code</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span><span class="o">/</span><span class="mf">255.0</span>

    <span class="k">return</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span>


<span class="k">def</span> <span class="nf">NormalizeData</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
         <span class="k">return</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

<span class="c1"># @title Functions</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%capture

!pip install pyvista
!pip install nilearn
!pip install nibabel
!pip install networkx

# @title Install Packages
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pyvista</span> <span class="k">as</span> <span class="nn">pv</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">odeint</span>
<span class="kn">from</span> <span class="nn">nilearn</span> <span class="kn">import</span> <span class="n">datasets</span>
<span class="kn">from</span> <span class="nn">nilearn</span> <span class="kn">import</span> <span class="n">plotting</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.inset_locator</span> <span class="kn">import</span> <span class="n">inset_axes</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">nilearn</span> <span class="kn">import</span> <span class="n">plotting</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;/content/Data/travelling_brain_waves/&#39;</span><span class="p">)</span>

<span class="c1"># @title Importage</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="introduction-to-resting-state-activity-simulation">
<h2><strong>Introduction to Resting-State Activity Simulation</strong><a class="headerlink" href="#introduction-to-resting-state-activity-simulation" title="Permalink to this heading">#</a></h2>
<p>We are going to simulate resting-state activity in order to gain insights into the dynamics and interactions of brain networks.</p>
<br/>
\begin{equation}
\left[\frac{1}{{\gamma_s}^2} \frac{{\partial^2 \phi}}{{\partial t^2}} + \frac{2}{\gamma_s} \frac{{\partial^2 \phi}}{{\partial t \partial s}} + 1 - {r_s}^2 {\nabla}^2 \phi\right] \phi(\mathbf{r}, t) = Q(\mathbf{r}, t)
\end{equation}
<br/>
<p>For the cerebral cortex, which we consider as a two-dimensional (2D) model embedded within 3D Euclidean space, the LBO in equation (below) captures intrinsic geometry, which includes the curvature of the cortical surface.</p>
<p>\begin{equation}
{\nabla}^2 \psi = {\Delta} \psi = - \lambda\psi
\end{equation}
<br/></p>
<p>where <span class="math notranslate nohighlight">\({\nabla}\)</span> is the gradient operator, <span class="math notranslate nohighlight">\({\Delta}\)</span> is the LBO and {<span class="math notranslate nohighlight">\({\psi={\psi_{1}(r),\psi_{2}(r),…}}\)</span>} is the family of geometric eigenmodes with the corresponding family of eigenvalues <span class="math notranslate nohighlight">\(\lambda\)</span>={<span class="math notranslate nohighlight">\({\lambda_{1},\lambda_{2},…}\)</span>}.<br/>
The eigenvalues are ordered sequentially according to the spatial frequency or wavelength of the spatial patterns of each mode, such that <span class="math notranslate nohighlight">\(\psi_{1}\)</span> is the mode with the longest wavelength.</p>
<p><span class="math notranslate nohighlight">\({\nabla}^2\)</span> is the Laplace–Beltrami operator (LBO) from the surface mesh, which captures local vertex-to-vertex spatial relations and curvature, and solve the eigenvalue problem.</p>
</div>
<div class="section" id="loading-eigenmodes-and-eigenvalues">
<h2><strong>Loading Eigenmodes and Eigenvalues</strong><a class="headerlink" href="#loading-eigenmodes-and-eigenvalues" title="Permalink to this heading">#</a></h2>
<p>To simulate resting-state activity, we need to load surface-based eigenmodes and eigenvalues. Eigenmodes represent the spatial patterns of brain activity, while eigenvalues indicate their corresponding frequencies or energies. In this notebook, we’ll load the eigenmodes and eigenvalues from text files. For the purpose of this tutorial we are going to use 50 eigenmodes that has been already computed for you.</p>
<hr class="docutils" />
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hemisphere</span> <span class="o">=</span> <span class="s1">&#39;lh&#39;</span>
<span class="n">num_modes</span> <span class="o">=</span> <span class="mi">50</span>

<span class="c1"># Load eigenmodes and eigenvalues data</span>
<span class="n">eigenmodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fsLR_32k_midthickness-</span><span class="si">{</span><span class="n">hemisphere</span><span class="si">}</span><span class="s1">_emode_</span><span class="si">{</span><span class="n">num_modes</span><span class="si">}</span><span class="s1">.txt&#39;</span><span class="p">)</span>
<span class="n">eigenvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fsLR_32k_midthickness-</span><span class="si">{</span><span class="n">hemisphere</span><span class="si">}</span><span class="s1">_eval_</span><span class="si">{</span><span class="n">num_modes</span><span class="si">}</span><span class="s1">.txt&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="simulation-parameters">
<h2><strong>Simulation Parameters</strong><a class="headerlink" href="#simulation-parameters" title="Permalink to this heading">#</a></h2>
<p>Next, we’ll define the simulation parameters. These parameters determine the duration and resolution of the simulation, as well as the characteristics of the model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simulate resting-state activity using Gaussian white noise</span>
<span class="n">param</span> <span class="o">=</span> <span class="n">loadParameters_wave_func</span><span class="p">()</span>
<span class="n">param</span><span class="p">[</span><span class="s1">&#39;tstep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># in ms</span>
<span class="n">param</span><span class="p">[</span><span class="s1">&#39;tmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># in ms</span>
<span class="n">param</span><span class="p">[</span><span class="s1">&#39;tspan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;tmax&#39;</span><span class="p">]]</span>
<span class="n">param</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;tmax&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;tstep&#39;</span><span class="p">],</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;tstep&#39;</span><span class="p">])</span>

<span class="c1"># Change value of param.is_time_ms to 1 because the time defined above is</span>
<span class="c1"># in ms. This is necessary as param.gamma_s needs to match the scale.</span>
<span class="n">param</span><span class="p">[</span><span class="s1">&#39;is_time_ms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>


<span class="n">param</span><span class="p">[</span><span class="s1">&#39;r_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># (default) in mm</span>
<span class="n">param</span><span class="p">[</span><span class="s1">&#39;gamma_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">116</span>  <span class="c1"># (default) in s^-1</span>
<span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;is_time_ms&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">param</span><span class="p">[</span><span class="s1">&#39;gamma_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">116</span> <span class="o">*</span> <span class="mf">1e-3</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="wave-model-solution-method">
<h2><strong>Wave Model Solution Method</strong><a class="headerlink" href="#wave-model-solution-method" title="Permalink to this heading">#</a></h2>
<p>We have two options for solving the wave model: the ODE (ordinary differential equation) method and the Fourier method. Uncomment the preferred method below</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Method for solving the wave model (either &#39;ODE&#39; or &#39;Fourier&#39;)</span>
<span class="c1"># &#39;Fourier&#39; is faster for long time series</span>
<span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;ODE&#39;</span>
<span class="c1"># method = &#39;Fourier&#39;</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="gaussian-white-noise-external-input">
<h2><strong>Gaussian White Noise External Input</strong><a class="headerlink" href="#gaussian-white-noise-external-input" title="Permalink to this heading">#</a></h2>
<p>To simulate the resting-state activity, we generate a Gaussian white noise external input.  The Gaussian white noise external input is a random signal with values that follow a Gaussian distribution and have equal power across all frequencies. It is commonly used in simulations and modeling to introduce stochastic or random components into the system, allowing for the exploration of the system’s response to unpredictable fluctuations. In this case, it is used to simulate the spontaneous activity and variability observed in resting-state brain networks.
This input represents the random fluctuations that drive the dynamics of the brain networks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create Gaussian white noise external input</span>
<span class="c1"># random number is set for now for reproducibility</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ext_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">eigenmodes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ext_input</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x7d99674ae8f0&gt;]
</pre></div>
</div>
<img alt="../_images/fa4bd8e1a9fc7d68b76727dec91aa57eb98f3484cf85ac73882866dcd6213fad.png" src="../_images/fa4bd8e1a9fc7d68b76727dec91aa57eb98f3484cf85ac73882866dcd6213fad.png" />
</div>
</div>
<p>Now were going to use the function <code class="docutils literal notranslate"><span class="pre">model_neural_waves_python</span></code> which simulates neural waves on a surface using eigenmodes. It takes several input parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">eigenmodes</span></code>: The spatial patterns of brain activity represented as eigenmodes.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">eigenvalues</span></code>: The corresponding eigenvalues that determine the influence of each eigenmode.
-<code class="docutils literal notranslate"><span class="pre">ext_input</span></code>: The spatiotemporal external input, which in this case is Gaussian white noise.
-<code class="docutils literal notranslate"><span class="pre">param</span></code>: A dictionary containing model parameters such as the length scale and damping rate.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">method</span></code>: A string specifying the method to calculate the activity, either ‘ODE’ or ‘Fourier’.<br/>
<br/>
The function performs the simulation and returns two values:</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lh_mode_activity_rest</span></code>: The simulated activity of the eigenmodes, representing the mode activity.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lh_simulated_activity_rest</span></code>: The simulated wave activity on the surface, obtained by combining the mode activity with the eigenmodes.<br/>
<br/>
We are going to simulate neural waves based on the provided eigenmodes, eigenvalues, external input, and model parameters, for the specified hemisphere (starting with left). <br/>
<br/>
How this stimulation is performed?<br/>
Before the simulation starts, the external input is decomposed into coefficients using the eigenmodes. Specifically we calculate the coefficient values that represent the contribution of each eigenmode to the external input. <br/>
The simulation iterates over each eigenmode. For each eigenmode, the corresponding coefficient and eigenvalue are retrieved. Then depending on the method choose the simulated activity for every eigenmodes is performed.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lh_mode_activity_rest</span><span class="p">,</span> <span class="n">lh_simulated_activity_rest</span> <span class="o">=</span> <span class="n">model_neural_waves_python</span><span class="p">(</span><span class="n">eigenmodes</span><span class="p">,</span> <span class="n">eigenvalues</span><span class="p">,</span> <span class="n">ext_input</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s plot the simulated activity in the cortex</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tp</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">hemisphere</span> <span class="o">=</span> <span class="s1">&#39;lh&#39;</span>
<span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">lh_simulated_activity_rest</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">stat_map</span> <span class="o">=</span><span class="n">data_to_plot</span><span class="p">[:,</span> <span class="n">tp</span><span class="p">]</span>

<span class="n">plotting</span><span class="o">.</span><span class="n">plot_surf_stat_map</span><span class="p">(</span><span class="s1">&#39;fsLR_32kmidthickness-&#39;</span> <span class="o">+</span> <span class="n">hemisphere</span> <span class="o">+</span> <span class="s1">&#39;.gii&#39;</span><span class="p">,</span> <span class="n">stat_map</span><span class="o">=</span><span class="n">stat_map</span><span class="p">,</span> <span class="n">hemi</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="s1">&#39;lateral&#39;</span><span class="p">,</span>
                            <span class="c1">#axes=col, threshold=thr,</span>
                            <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0335fce0243618f35461bcb35749c7bfcd3311b495ef3b81ef782708caaa2c56.png" src="../_images/0335fce0243618f35461bcb35749c7bfcd3311b495ef3b81ef782708caaa2c56.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hemisphere</span> <span class="o">=</span> <span class="s1">&#39;rh&#39;</span>
<span class="n">num_modes</span> <span class="o">=</span> <span class="mi">50</span>

<span class="c1"># Load eigenmodes and eigenvalues data</span>
<span class="n">eigenmodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fsLR_32k_midthickness-</span><span class="si">{</span><span class="n">hemisphere</span><span class="si">}</span><span class="s1">_emode_</span><span class="si">{</span><span class="n">num_modes</span><span class="si">}</span><span class="s1">.txt&#39;</span><span class="p">)</span>
<span class="n">eigenvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fsLR_32k_midthickness-</span><span class="si">{</span><span class="n">hemisphere</span><span class="si">}</span><span class="s1">_eval_</span><span class="si">{</span><span class="n">num_modes</span><span class="si">}</span><span class="s1">.txt&#39;</span><span class="p">)</span>

<span class="c1"># Replace above lines with the ones below and set num_modes = 200 if using the 200 modes provided at data/template_eigenmodes</span>
<span class="c1"># eigenmodes = np.loadtxt(f&#39;data/template_eigenmodes/fsLR_32k_midthickness-{hemisphere}_emode_{num_modes}.txt&#39;)</span>
<span class="c1"># eigenvalues = np.loadtxt(f&#39;data/template_eigenmodes/fsLR_32k_midthickness-{hemisphere}_eval_{num_modes}.txt&#39;)</span>

<span class="c1"># Simulate resting-state activity using Gaussian white noise</span>
<span class="n">param</span> <span class="o">=</span> <span class="n">loadParameters_wave_func</span><span class="p">()</span>
<span class="n">param</span><span class="p">[</span><span class="s1">&#39;tstep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># in ms</span>
<span class="n">param</span><span class="p">[</span><span class="s1">&#39;tmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># in ms</span>
<span class="n">param</span><span class="p">[</span><span class="s1">&#39;tspan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;tmax&#39;</span><span class="p">]]</span>
<span class="n">param</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;tmax&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;tstep&#39;</span><span class="p">],</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;tstep&#39;</span><span class="p">])</span>

<span class="c1"># Change value of param.is_time_ms to 1 because the time defined above is</span>
<span class="c1"># in ms. This is necessary as param.gamma_s needs to match the scale.</span>
<span class="n">param</span><span class="p">[</span><span class="s1">&#39;is_time_ms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Method for solving the wave model (either &#39;ODE&#39; or &#39;Fourier&#39;)</span>
<span class="c1"># &#39;Fourier&#39; is faster for long time series</span>
<span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;ODE&#39;</span>
<span class="c1"># method = &#39;Fourier&#39;</span>

<span class="n">param</span><span class="p">[</span><span class="s1">&#39;r_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># (default) in mm</span>
<span class="n">param</span><span class="p">[</span><span class="s1">&#39;gamma_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">116</span>  <span class="c1"># (default) in s^-1</span>
<span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;is_time_ms&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">param</span><span class="p">[</span><span class="s1">&#39;gamma_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">116</span> <span class="o">*</span> <span class="mf">1e-3</span>

<span class="c1"># Create Gaussian white noise external input</span>
<span class="c1"># random number is set for now for reproducibility</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ext_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">eigenmodes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]))</span>

<span class="n">rh_mode_activity_rest</span><span class="p">,</span> <span class="n">rh_simulated_activity_rest</span> <span class="o">=</span> <span class="n">model_neural_waves_python</span><span class="p">(</span><span class="n">eigenmodes</span><span class="p">,</span> <span class="n">eigenvalues</span><span class="p">,</span> <span class="n">ext_input</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>


<span class="n">tp</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">rh_simulated_activity_rest</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">stat_map</span> <span class="o">=</span><span class="n">data_to_plot</span><span class="p">[:,</span> <span class="n">tp</span><span class="p">]</span>



<span class="n">plotting</span><span class="o">.</span><span class="n">plot_surf_stat_map</span><span class="p">(</span><span class="s1">&#39;fsLR_32kmidthickness-&#39;</span> <span class="o">+</span> <span class="n">hemisphere</span> <span class="o">+</span> <span class="s1">&#39;.gii&#39;</span><span class="p">,</span> <span class="n">stat_map</span><span class="o">=</span><span class="n">stat_map</span><span class="p">,</span> <span class="n">hemi</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="s1">&#39;lateral&#39;</span><span class="p">,</span>
                            <span class="c1">#axes=col, threshold=thr,</span>
                            <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu&#39;</span><span class="p">);</span>



<span class="c1"># @title Do the same but for the right hemisphere</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1fc4077fb3fcf99ca18c39cf6d297ab05d288860a07781c5c95b538b5a5ee725.png" src="../_images/1fc4077fb3fcf99ca18c39cf6d297ab05d288860a07781c5c95b538b5a5ee725.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="c1"># Specify the path of the .gif file</span>
<span class="n">gif_path</span> <span class="o">=</span> <span class="s1">&#39;travelling_brain_waves.gif&#39;</span>

<span class="c1"># Display the .gif file</span>
<span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">gif_path</span><span class="p">))</span>

<span class="c1">#@title #plot movie</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Output hidden; open in https://colab.research.google.com to view.
</pre></div>
</div>
</div>
</div>
<p>Now that we have the activity on the surface, is interesting to investigate if the functional dynamics we simulate using the surface eigenmodes has some functional connectivity structure. <br/>
To achieve this, we will map that activity into an atlas to see if the functional networks dynamics will emerge. For this we are going to use the Schaefer et al. 2018 parcellation, which divides the brain into 200 parcels and 7 Network.</p>
<blockquote>
<div><p>Schaefer A. et al. Local-global parcellation of the human cerebral cortex from intrinsic functional connectivity MRI. <em>Cerebral Cortex</em> 28:3095–3114. (2018), doi: 10.1093/cercor/bhx179.</p>
</div></blockquote>
<p>Let’s start loading a parcellation files. The files contains information about the anatomical regions or parcels in the both left and right hemisphere.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load eigenmodes and eigenvalues data</span>
<span class="n">hemisphere</span> <span class="o">=</span> <span class="s1">&#39;lh&#39;</span>
<span class="n">lh_eigenmodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fsLR_32k_midthickness-</span><span class="si">{</span><span class="n">hemisphere</span><span class="si">}</span><span class="s1">_emode_</span><span class="si">{</span><span class="n">num_modes</span><span class="si">}</span><span class="s1">.txt&#39;</span><span class="p">)</span>
<span class="n">lh_eigenvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fsLR_32k_midthickness-</span><span class="si">{</span><span class="n">hemisphere</span><span class="si">}</span><span class="s1">_eval_</span><span class="si">{</span><span class="n">num_modes</span><span class="si">}</span><span class="s1">.txt&#39;</span><span class="p">)</span>

<span class="n">hemisphere</span> <span class="o">=</span> <span class="s1">&#39;rh&#39;</span>
<span class="n">rh_eigenmodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fsLR_32k_midthickness-</span><span class="si">{</span><span class="n">hemisphere</span><span class="si">}</span><span class="s1">_emode_</span><span class="si">{</span><span class="n">num_modes</span><span class="si">}</span><span class="s1">.txt&#39;</span><span class="p">)</span>
<span class="n">rh_eigenvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fsLR_32k_midthickness-</span><span class="si">{</span><span class="n">hemisphere</span><span class="si">}</span><span class="s1">_eval_</span><span class="si">{</span><span class="n">num_modes</span><span class="si">}</span><span class="s1">.txt&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Simulate the activity for both hemisphere together</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">both_ext_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">eigenmodes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]))</span>

<span class="n">both_mode_activity_rest</span><span class="p">,</span> <span class="n">both_simulated_activity_rest</span> <span class="o">=</span> <span class="n">model_neural_waves_python</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">lh_eigenmodes</span><span class="p">,</span> <span class="n">rh_eigenmodes</span><span class="p">]),</span>
                                                                                  <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">lh_eigenvalues</span><span class="p">,</span> <span class="n">rh_eigenvalues</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                                                                                  <span class="n">both_ext_input</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next we are going to extract the activity for every parcels</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transient</span> <span class="o">=</span> <span class="mi">400</span> <span class="c1">#Get rid of transient time</span>

<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;fsLR_32k_Schaefer200-lh.txt&#39;</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">contents</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">lh_numbers</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">contents</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">num</span><span class="p">])</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;fsLR_32k_Schaefer200-rh.txt&#39;</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">contents</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">rh_numbers</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">contents</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">num</span><span class="p">])</span>

<span class="n">both_numbers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">lh_numbers</span><span class="p">,</span> <span class="n">rh_numbers</span><span class="p">])</span>

<span class="n">parcels_simulated_activity_rest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">both_numbers</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">both_simulated_activity_rest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">transient</span><span class="p">))</span>

<span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">both_numbers</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
  <span class="n">idx2use</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">both_numbers</span><span class="o">==</span><span class="n">roi</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">parcels_simulated_activity_rest</span><span class="p">[</span><span class="n">roi</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">both_simulated_activity_rest</span><span class="p">[</span><span class="n">idx2use</span><span class="p">,</span><span class="n">transient</span><span class="p">:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Plot the parcels BOLD dynamics</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">parcels_simulated_activity_rest</span><span class="o">.</span><span class="n">T</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/576cd95bc1f32f4e3318f5ab8a07c41a044be7cd18d57b7a9ce537c95063dc21.png" src="../_images/576cd95bc1f32f4e3318f5ab8a07c41a044be7cd18d57b7a9ce537c95063dc21.png" />
</div>
</div>
<p>Now we are ready to compute the functional connectivity matrix</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">correlation_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">parcels_simulated_activity_rest</span><span class="p">)</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">convert_matrix</span><span class="o">.</span><span class="n">from_numpy_array</span><span class="p">(</span><span class="n">correlation_matrix</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>In the next cell we are pulling atlas information. Specifically, the <code class="docutils literal notranslate"><span class="pre">pd.read_csv()</span></code> function from the Pandas library is used to read a CSV file from Schaefer2018 repo. From that .csv file we are going to collect the ‘ROI Name’ column of the atlas DataFrame is extracted and stored in the label variable. The code then removes the 7Networks_’ prefix from each label by iterating over the label values and using the <code class="docutils literal notranslate"><span class="pre">replace()</span></code> method. The stripped labels are stored in the <code class="docutils literal notranslate"><span class="pre">label_stripped</span></code> list.
second, we create  a NumPy array named <code class="docutils literal notranslate"><span class="pre">coords</span></code> by combining the ‘R’, ‘A’, and ‘S’ columns of the atlas DataFrame. The resulting array represents the coordinate positions (x, y, z) of the atlas centroids.
Lastly, we collect the network colour from <a class="reference external" href="https://github.com/Davi1990/DissNet/tree/main">DissNet</a> repo</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://raw.githubusercontent.com/ThomasYeoLab/CBIG/master/stable_projects/brain_parcellation/Schaefer2018_LocalGlobal/Parcellations/MNI/Centroid_coordinates/Schaefer2018_200Parcels_7Networks_order_FSLMNI152_2mm.Centroid_RAS.csv&#39;</span>
<span class="n">atlas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="n">label</span> <span class="o">=</span> <span class="n">atlas</span><span class="p">[</span><span class="s1">&#39;ROI Name&#39;</span><span class="p">]</span>
<span class="n">label_stripped</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">label</span><span class="p">)):</span>
    <span class="n">label_stripped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="n">xx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;7Networks_&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>

<span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">atlas</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">],</span> <span class="n">atlas</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">],</span> <span class="n">atlas</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>


<span class="n">coords_net</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s1">&#39;https://github.com/Davi1990/DissNet/raw/10755322a87e8ce8d22f0641651334f86088fc6d/examples/new_atlas_coords.xlsx&#39;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">8</span><span class="p">][:</span><span class="mi">200</span><span class="p">]</span>
<span class="n">coords_net</span><span class="p">[</span><span class="mi">100</span><span class="p">:]</span> <span class="o">=</span> <span class="n">coords_net</span><span class="p">[</span><span class="mi">100</span><span class="p">:]</span><span class="o">+</span><span class="mi">7</span>
<span class="n">net_colours</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s1">&#39;https://github.com/Davi1990/DissNet/raw/main/examples/network_colour.xlsx&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;openpyxl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Set some variable for a fancy plot 😊</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">coords_net</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
  <span class="n">p</span><span class="p">[</span><span class="n">label_stripped</span><span class="p">[</span><span class="n">roi</span><span class="p">]]</span> <span class="o">=</span> <span class="n">coords_net</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">list_communities</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">keep_all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Re-order colour map for easier visualisation</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">tab20</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>

<span class="k">for</span> <span class="n">net</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
  <span class="n">cmap</span><span class="p">[</span><span class="n">net</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span> <span class="n">rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hex_to_rgb</span><span class="p">(</span><span class="n">net_colours</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">net</span><span class="p">]))</span>

<span class="n">cmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Then plot the functional connectivity matrix using <code class="docutils literal notranslate"><span class="pre">adjacency_communities()</span></code> function which create a color-coded plot to visualize the adjacency communities in a graph.
The parameters used in the function are as follows:<br/>
<br/></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">G</span></code>: The graph object representing the network.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">c</span></code>: The array or list of community assignments for each node in the graph.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cmap</span></code>: The colormap used for coloring the communities.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vmax</span></code>: The maximum value used for scaling the colormap.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vmin</span></code>: The minimum value used for scaling the colormap.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">zlabel</span></code>: The label for the z-axis in the plot, representing the squared correlation value (‘R’²).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">figsize</span></code>: The size of the figure in inches (width, height).</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">adjacency_communities</span><span class="p">(</span>
              <span class="n">G</span><span class="p">,</span>
              <span class="n">c</span><span class="p">,</span>
              <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
              <span class="n">vmax</span><span class="o">=</span><span class="n">correlation_matrix</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
              <span class="n">vmin</span> <span class="o">=</span><span class="n">correlation_matrix</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
              <span class="n">zlabel</span><span class="o">=</span><span class="s2">&quot;R&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\u00b2</span><span class="s1">&#39;</span><span class="p">,</span>
              <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
          <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8513a7933253e2606555830ace0bad26c36738bec13e99e9ff637a7da3267c8b.png" src="../_images/8513a7933253e2606555830ace0bad26c36738bec13e99e9ff637a7da3267c8b.png" />
</div>
</div>
<p>we can also use the function <code class="docutils literal notranslate"><span class="pre">plotting.plot_matrix</span></code> for <code class="docutils literal notranslate"><span class="pre">nilearn</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Mask out the major diagonal</span>
<span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">correlation_matrix</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">plot_matrix</span><span class="p">(</span>
    <span class="n">correlation_matrix</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">label_stripped</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.8</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x79925413aa70&gt;
</pre></div>
</div>
<img alt="../_images/d0341ea65ca8f9cba828c2b9add978e8cc11e4cabed246c545639f854c15531e.png" src="../_images/d0341ea65ca8f9cba828c2b9add978e8cc11e4cabed246c545639f854c15531e.png" />
</div>
</div>
<p>Now that we have the functional connectivity matrix and interesting thing is to see if we can extract map siminar to functional networks. In the code below, we are going to identify a node of the Default Mode Network (DMN) and explore if its simulated spontaneous activity is correlated with regions that belong to the same network <br/>
<br/>
<br/></p>
<p><img alt="alt text" src="https://journals.physiology.org/cms/10.1152/jn.00338.2011/asset/images/medium/z9k0091109040011.jpeg" /></p>
<p>Now we are going to run a seed-based functional connectivity analysis using the pre-cuneus (‘LH_Default_Par_3’ in the parcellation) which is an pivotal DMN node that emerge from empirical resting-state fMRI.
This to investigate if the DMN will emerge for the simulation that we run</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hemisphere</span> <span class="o">=</span> <span class="s1">&#39;lh&#39;</span>

<span class="n">source</span> <span class="o">=</span> <span class="n">parcels_simulated_activity_rest</span><span class="p">[</span><span class="n">label_stripped</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;LH_Default_Par_3&#39;</span><span class="p">),:]</span>

<span class="n">roi_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">parcels_simulated_activity_rest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parcels_simulated_activity_rest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
  <span class="n">roi_corr</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">parcels_simulated_activity_rest</span><span class="p">[</span><span class="n">roi</span><span class="p">,:])[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>


<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;fsLR_32k_Schaefer200-lh.txt&#39;</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">contents</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">numbers</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">contents</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">num</span><span class="p">])</span>


<span class="n">roi_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">lh_simulated_activity_rest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
  <span class="n">idx2use</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">numbers</span><span class="o">==</span><span class="n">roi</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">roi_map</span><span class="p">[</span><span class="n">idx2use</span><span class="p">]</span> <span class="o">=</span> <span class="n">roi_corr</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s plot this on a surface and see (Drum rolls 🥁🥁🥁)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="s1">&#39;3d&#39;</span><span class="p">},</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>


<span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">view</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;lateral&#39;</span><span class="p">,</span> <span class="s1">&#39;medial&#39;</span><span class="p">]):</span>
    <span class="c1">#for n, (col, hemi) in enumerate(zip(row, [&#39;infl_left&#39;, &#39;infl_left&#39;])):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;fsLR_32kmidthickness-&#39;</span> <span class="o">+</span> <span class="n">hemisphere</span> <span class="o">+</span> <span class="s1">&#39;.gii&#39;</span>
        <span class="n">hemi</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span>

        <span class="n">plotting</span><span class="o">.</span><span class="n">plot_surf_stat_map</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span>
                            <span class="n">stat_map</span><span class="o">=</span><span class="n">roi_map</span><span class="p">,</span> <span class="n">hemi</span><span class="o">=</span><span class="n">hemi</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="n">view</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">row</span><span class="p">,</span>
                            <span class="n">threshold</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                            <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;blue_red&#39;</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>


<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/a0d7f695b46125a3c7eaa7d4ac8e842dd19c930af05e7d0988968bd6d4d8d9d3.png" src="../_images/a0d7f695b46125a3c7eaa7d4ac8e842dd19c930af05e7d0988968bd6d4d8d9d3.png" />
</div>
</div>
</div>
</div>
<div class="section" id="dissect-the-signal-propagation-spreading">
<h1><strong>Dissect the signal propagation spreading</strong><a class="headerlink" href="#dissect-the-signal-propagation-spreading" title="Permalink to this heading">#</a></h1>
<p>The scope of this part is to characterize the signal propagation induced by an external pertuarbation.
Specifically this part replicate the analyses done in</p>
<blockquote>
<div><p>Momi, D. et al. TMS-evoked responses are driven by recurrent large-scale network dynamicst. <em>eLife</em> e83232 (2023), doi: 10.7554/eLife.83232.</p>
</div></blockquote>
<p>First we are going to model empirical EEG timeseries. This EEG data are characterized by an external perturbation that was applied at a certain time point. For the sake of time (parameters estimatation is time consuming), the dataset has been already modelled for you using <a class="reference external" href="https://github.com/GriffithsLab/whobpyt"><em>WhoBPyT - Whole-Brain Modelling in PyTorch</em></a>, (pronounce as ‘hobbit’), a Python library for PyTorch-based whole-brain modeling in Python.</p>
<p>We will evaluate the ‘goodness-of-the-fit’ comparing the simulated timeseries with the empirical one.
Ater that we will selectively modifying the structural connectome and apply lesions to specific regions at specific time points in order to explore the effect of those virtual lesion to the propagation of the signal induced by the external perturbation</p>
<p><img alt="alt text" src="https://iiif.elifesciences.org/lax:83232%2Felife-83232-fig6-v1.tif/full/1500,/0/default.jpg" /></p>
<p>First we are going to import several function</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;/content/Data/whobpyt/&#39;</span><span class="p">)</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/content/Data/whobpyt/&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mne</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">signal</span>
<span class="kn">from</span> <span class="nn">whobpyt.optimization.modelfitting</span> <span class="kn">import</span> <span class="n">Model_fitting</span>
<span class="kn">from</span> <span class="nn">whobpyt.datatypes.modelparameters</span> <span class="kn">import</span> <span class="n">ParamsModel</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">nilearn</span> <span class="kn">import</span> <span class="n">plotting</span>
<span class="kn">from</span> <span class="nn">nilearn</span> <span class="kn">import</span> <span class="n">datasets</span>
<span class="kn">from</span> <span class="nn">nibabel.freesurfer.io</span> <span class="kn">import</span> <span class="n">read_annot</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">save_path</span><span class="p">):</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Extract the file name from the URL</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>  <span class="c1"># Create the complete file path</span>
    <span class="k">with</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">8192</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>  <span class="c1"># Filter out keep-alive new chunks</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File &#39;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&#39; downloaded successfully.&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">RNNJANSEN</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A module for forward model (JansenRit) to simulate a batch of EEG signals</span>
<span class="sd">    Attibutes</span>
<span class="sd">    ---------</span>
<span class="sd">    state_size : int</span>
<span class="sd">        the number of states in the JansenRit model</span>
<span class="sd">    input_size : int</span>
<span class="sd">        the number of states with noise as input</span>
<span class="sd">    tr : float</span>
<span class="sd">        tr of image</span>
<span class="sd">    step_size: float</span>
<span class="sd">        Integration step for forward model</span>
<span class="sd">    hidden_size: int</span>
<span class="sd">        the number of step_size in a tr</span>
<span class="sd">    TRs_per_window: int</span>
<span class="sd">        the number of EEG signals to simulate</span>
<span class="sd">    node_size: int</span>
<span class="sd">        the number of ROIs</span>
<span class="sd">    sc: float node_size x node_size array</span>
<span class="sd">        structural connectivity</span>
<span class="sd">    fit_gains: bool</span>
<span class="sd">        flag for fitting gains 1: fit 0: not fit</span>
<span class="sd">    g, c1, c2, c3,c4: tensor with gradient on</span>
<span class="sd">        model parameters to be fit</span>
<span class="sd">    w_bb: tensor with node_size x node_size (grad on depends on fit_gains)</span>
<span class="sd">        connection gains</span>
<span class="sd">    std_in std_out: tensor with gradient on</span>
<span class="sd">        std for state noise and output noise</span>
<span class="sd">    hyper parameters for prior distribution of model parameters</span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    forward(input, noise_out, hx)</span>
<span class="sd">        forward model (JansenRit) for generating a number of EEG signals with current model parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">state_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;Ev&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;Iv&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;Pv&#39;</span><span class="p">]</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;JR&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">TRs_per_window</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">step_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">output_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">tr</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sc</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">dist</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                 <span class="n">use_fit_gains</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">use_fit_lfm</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">param</span><span class="p">:</span> <span class="n">ParamsModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        tr : float</span>
<span class="sd">            tr of image</span>
<span class="sd">        step_size: float</span>
<span class="sd">            Integration step for forward model</span>

<span class="sd">        TRs_per_window: int</span>
<span class="sd">            the number of EEG signals to simulate</span>
<span class="sd">        node_size: int</span>
<span class="sd">            the number of ROIs</span>
<span class="sd">        output_size: int</span>
<span class="sd">            the number of channels EEG</span>
<span class="sd">        sc: float node_size x node_size array</span>
<span class="sd">            structural connectivity</span>
<span class="sd">        use_fit_gains: bool</span>
<span class="sd">            flag for fitting gains 1: fit 0: not fit</span>
<span class="sd">        use_fit_lfm: bool</span>
<span class="sd">            flag for fitting gains 1: fit 0: not fit</span>
<span class="sd">        param from ParamJR</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RNNJANSEN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_size</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># 6 states JR model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span>  <span class="c1"># tr ms (integration step 0.1 ms)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_size</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">step_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># integration step 0.1 ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps_per_TR</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tr</span> <span class="o">/</span> <span class="n">step_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TRs_per_window</span> <span class="o">=</span> <span class="n">TRs_per_window</span>  <span class="c1"># size of the batch used at each step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_size</span> <span class="o">=</span> <span class="n">node_size</span>  <span class="c1"># num of ROI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">output_size</span>  <span class="c1"># num of EEG channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sc</span> <span class="o">=</span> <span class="n">sc</span>  <span class="c1"># matrix node_size x node_size structure connectivity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span> <span class="o">=</span> <span class="n">lm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_fit_gains</span> <span class="o">=</span> <span class="n">use_fit_gains</span>  <span class="c1"># flag for fitting gains</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_fit_lfm</span> <span class="o">=</span> <span class="n">use_fit_lfm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="n">param</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># number of EEG channels</span>

    <span class="k">def</span> <span class="nf">setModelParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># set states E I f v mean and 1/sqrt(variance)</span>
        <span class="k">return</span> <span class="n">setModelParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external</span><span class="p">,</span> <span class="n">hx</span><span class="p">,</span> <span class="n">hE</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">integration_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external</span><span class="p">,</span> <span class="n">hx</span><span class="p">,</span> <span class="n">hE</span><span class="p">)</span>


<span class="kn">from</span> <span class="nn">torch.nn.parameter</span> <span class="kn">import</span> <span class="n">Parameter</span>
<span class="kn">import</span> <span class="nn">torch</span>


<span class="k">def</span> <span class="nf">sys2nd</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">A</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">u</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="n">a</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span>


<span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">vmax</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="p">(</span><span class="n">v0</span> <span class="o">-</span> <span class="n">x</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">h_tf</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Neuronal input-output functions of excitatory pools and inhibitory pools.</span>
<span class="sd">    Take the variables a, x, and b and convert them to a linear equation (a*x - b) while adding a small</span>
<span class="sd">    amount of noise 0.00001 while dividing that term to an exponential of the linear equation multiplied by the</span>
<span class="sd">    d constant for the appropriate dimensions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num</span> <span class="o">=</span> <span class="mf">0.00001</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">z</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">den</span> <span class="o">=</span> <span class="mf">0.00001</span> <span class="o">*</span> <span class="n">d</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mf">1.0000</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">d</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">z</span> <span class="o">-</span> <span class="n">b</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">den</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">setModelParameters</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;RWW&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_Gaussian_EI</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">E_m</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.16</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">I_m</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="c1"># model.f_m = Parameter(torch.tensor(1.0, dtype=torch.float32))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">v_m</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="c1"># model.x_m = Parameter(torch.tensor(0.16, dtype=torch.float32))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">q_m</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

            <span class="n">model</span><span class="o">.</span><span class="n">E_v_inv</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">2500</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">I_v_inv</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">2500</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="c1"># model.f_v = Parameter(torch.tensor(100, dtype=torch.float32))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">v_v_inv</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="c1"># model.x_v = Parameter(torch.tensor(100, dtype=torch.float32))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">q_v_inv</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

        <span class="c1"># hyper parameters (variables: need to calculate gradient) to fit density</span>
        <span class="c1"># of gEI and gIE (the shape from the bifurcation analysis on an isolated node)</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_Bifurcation</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">sup_ca</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">sup_cb</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">sup_cc</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

        <span class="c1"># set gains_con as Parameter if fit_gain is True</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_fit_gains</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">gains_con</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span>
                                                     <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>  <span class="c1"># connenction gain to modify empirical sc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">gains_con</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">vars_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">a</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_Bifurcation</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;std_in&#39;</span><span class="p">,</span> <span class="s1">&#39;g_IE&#39;</span><span class="p">,</span> <span class="s1">&#39;g_EI&#39;</span><span class="p">]:</span>
                        <span class="n">dict_nv</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">}</span>

                        <span class="n">dict_np</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;_m&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;_v_inv&#39;</span><span class="p">}</span>

                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dict_nv</span><span class="p">:</span>
                            <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dict_np</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dict_nv</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;std_in&#39;</span><span class="p">]:</span>
                        <span class="n">dict_nv</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">}</span>

                        <span class="n">dict_np</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;_m&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;_v_inv&#39;</span><span class="p">}</span>

                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dict_nv</span><span class="p">:</span>
                            <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dict_np</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dict_nv</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;JR&#39;</span><span class="p">:</span>
        <span class="c1"># set model parameters (variables: need to calculate gradient) as Parameter others : tensor</span>
        <span class="c1"># set w_bb as Parameter if fit_gain is True</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_fit_gains</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">w_bb</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span>
                                                <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>  <span class="c1"># connenction gain to modify empirical sc</span>
            <span class="n">model</span><span class="o">.</span><span class="n">w_ff</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span>
                                                <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">w_ll</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span>
                                                <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">w_bb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">w_ff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">w_ll</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_fit_lfm</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">lm</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lm</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>  <span class="c1"># leadfield matrix from sourced data to eeg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">lm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lm</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># leadfield matrix from sourced data to eeg</span>

        <span class="n">vars_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">a</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="c1"># print(type(getattr(param, var)[1]))</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;lm&#39;</span><span class="p">:</span>
                        <span class="n">size</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">(</span>
                            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
                                         <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">size</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">(</span>
                            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                                <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)))</span>
                        <span class="c1"># print(getattr(self, var))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">(</span>
                        <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                     <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">var</span> <span class="o">!=</span> <span class="s1">&#39;std_in&#39;</span><span class="p">:</span>
                    <span class="n">dict_nv</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">}</span>

                    <span class="n">dict_np</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;_m&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;_v_inv&#39;</span><span class="p">}</span>

                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dict_nv</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dict_np</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dict_nv</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;LIN&#39;</span><span class="p">:</span>
        <span class="c1"># set gains_con as Parameter if fit_gain is True</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_fit_gains</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">gains_con</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span>
                                                     <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>  <span class="c1"># connenction gain to modify empirical sc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">gains_con</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">vars_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">a</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)))</span>

                <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;std_in&#39;</span><span class="p">]:</span>
                    <span class="n">dict_nv</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">}</span>

                    <span class="n">dict_np</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;_m&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;_v_inv&#39;</span><span class="p">}</span>

                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dict_nv</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dict_np</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dict_nv</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">integration_forward</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">external</span><span class="p">,</span> <span class="n">hx</span><span class="p">,</span> <span class="n">hE</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;RWW&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forward step in simulating the BOLD signal.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        external: tensor with node_size x steps_per_TR x TRs_per_window x input_size</span>
<span class="sd">            noise for states</span>

<span class="sd">        hx: tensor with node_size x state_size</span>
<span class="sd">            states of WWD model</span>
<span class="sd">        Outputs</span>
<span class="sd">        -------</span>
<span class="sd">        next_state: dictionary with keys:</span>
<span class="sd">        &#39;current_state&#39;&#39;bold_window&#39;&#39;E_window&#39;&#39;I_window&#39;&#39;x_window&#39;&#39;f_window&#39;&#39;v_window&#39;&#39;q_window&#39;</span>
<span class="sd">            record new states and BOLD</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">next_state</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># hx is current state (6) 0: E 1:I (neural activities) 2:x 3:f 4:v 5:f (BOLD)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">step_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Generate the ReLU module for model parameters gEE gEI and gIE</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>

        <span class="c1"># Update the Laplacian based on the updated connection gains gains_con.</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">sc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

            <span class="c1"># Update the Laplacian based on the updated connection gains gains_con.</span>
            <span class="n">sc_mod</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">gains_con</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">sc_mod_normalized</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sc_mod</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">sc_mod</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sc_mod</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">sc_mod</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">sc_fitted</span> <span class="o">=</span> <span class="n">sc_mod_normalized</span>

            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_Laplacian</span><span class="p">:</span>
                <span class="n">lap_adj</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sc_mod_normalized</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">sc_mod_normalized</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lap_adj</span> <span class="o">=</span> <span class="n">sc_mod_normalized</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">lap_adj</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># placeholder for the updated current state</span>
        <span class="n">current_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">hx</span><span class="p">)</span>

        <span class="c1"># placeholders for output BOLD, history of E I x f v and q</span>
        <span class="c1"># placeholders for output BOLD, history of E I x f v and q</span>
        <span class="n">bold_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">))</span>
        <span class="c1"># E_window = torch.zeros((model.node_size,model.TRs_per_window))</span>
        <span class="c1"># I_window = torch.zeros((model.node_size,model.TRs_per_window))</span>

        <span class="n">x_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">))</span>
        <span class="n">f_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">))</span>
        <span class="n">v_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">))</span>
        <span class="n">q_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">))</span>

        <span class="n">E_hist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">steps_per_TR</span><span class="p">))</span>
        <span class="n">I_hist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">steps_per_TR</span><span class="p">))</span>
        <span class="n">E_mean</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">I_mean</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># print(E_m.shape)</span>
        <span class="c1"># Use the forward model to get neural activity at ith element in the window.</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_dynamic_boundary</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">TR_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">):</span>

                <span class="c1"># print(E.shape)</span>

                <span class="c1"># Since tr is about second we need to use a small step size like 0.05 to integrate the model states.</span>
                <span class="k">for</span> <span class="n">step_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">steps_per_TR</span><span class="p">):</span>
                    <span class="n">E</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">sampling_size</span><span class="p">))</span>
                    <span class="n">I</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">sampling_size</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">sample_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sampling_size</span><span class="p">):</span>
                        <span class="n">E</span><span class="p">[:,</span> <span class="n">sample_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">E_mean</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.02</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">)</span>
                        <span class="n">I</span><span class="p">[:,</span> <span class="n">sample_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">I_mean</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.001</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">)</span>

                    <span class="c1"># Calculate the input recurrent.</span>
                    <span class="n">IE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W_E</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">I_0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.001</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g_EE</span><span class="p">))</span> <span class="o">*</span> <span class="n">E</span>
                                      <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">lap_adj</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span>
                                              <span class="mf">0.001</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g_IE</span><span class="p">))</span> <span class="o">*</span> <span class="n">I</span><span class="p">))</span>  <span class="c1"># input currents for E</span>
                    <span class="n">II</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W_I</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">I_0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.001</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g_EI</span><span class="p">))</span> <span class="o">*</span> <span class="n">E</span> <span class="o">-</span> <span class="n">I</span><span class="p">))</span>  <span class="c1"># input currents for I</span>

                    <span class="c1"># Calculate the firing rates.</span>
                    <span class="n">rE</span> <span class="o">=</span> <span class="n">h_tf</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">aE</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">bE</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">dE</span><span class="p">,</span> <span class="n">IE</span><span class="p">)</span>  <span class="c1"># firing rate for E</span>
                    <span class="n">rI</span> <span class="o">=</span> <span class="n">h_tf</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">aI</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">bI</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">dI</span><span class="p">,</span> <span class="n">II</span><span class="p">)</span>  <span class="c1"># firing rate for I</span>
                    <span class="c1"># Update the states by step-size 0.05.</span>
                    <span class="n">E_next</span> <span class="o">=</span> <span class="n">E</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">E</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_E</span><span class="p">)</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">gamma_E</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">E</span><span class="p">)</span> <span class="o">*</span> <span class="n">rE</span><span class="p">)</span> \
                             <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">sampling_size</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.02</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">std_in</span><span class="p">))</span>  <span class="c1">### equlibrim point at E=(tau_E*gamma_E*rE)/(1+tau_E*gamma_E*rE)</span>
                    <span class="n">I_next</span> <span class="o">=</span> <span class="n">I</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">I</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_I</span><span class="p">)</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">gamma_I</span> <span class="o">*</span> <span class="n">rI</span><span class="p">)</span> \
                             <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">sampling_size</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                                     <span class="mf">0.02</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">std_in</span><span class="p">))</span>

                    <span class="c1"># Calculate the saturation for model states (for stability and gradient calculation).</span>

                    <span class="c1"># E_next[E_next&gt;=0.9] = torch.tanh(1.6358*E_next[E_next&gt;=0.9])</span>
                    <span class="n">E</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="mf">0.0000</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">E_next</span><span class="p">))</span>
                    <span class="n">I</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="mf">0.0000</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">I_next</span><span class="p">))</span>

                    <span class="n">I_mean</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                    <span class="n">E_mean</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                    <span class="n">I_mean</span><span class="p">[</span><span class="n">I_mean</span> <span class="o">&lt;</span> <span class="mf">0.00001</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00001</span>
                    <span class="n">E_mean</span><span class="p">[</span><span class="n">E_mean</span> <span class="o">&lt;</span> <span class="mf">0.00001</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00001</span>

                    <span class="n">E_hist</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">,</span> <span class="n">step_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">E_mean</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="n">I_hist</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">,</span> <span class="n">step_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">I_mean</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">TR_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">):</span>

                <span class="k">for</span> <span class="n">step_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">steps_per_TR</span><span class="p">):</span>
                    <span class="n">x_next</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">E_hist</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">,</span> <span class="n">step_i</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">tau_s</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_f</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">f_next</span> <span class="o">=</span> <span class="n">f</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">x</span>
                    <span class="n">v_next</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">alpha</span><span class="p">)))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">tau_0</span><span class="p">)</span>
                    <span class="n">q_next</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span>
                            <span class="n">f</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">f</span><span class="p">)))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">rho</span><span class="p">)</span> <span class="o">-</span> <span class="n">q</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">alpha</span><span class="p">))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> \
                             <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_0</span><span class="p">)</span>

                    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">x_next</span><span class="p">)</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">f_next</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">v_next</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">q_next</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="c1"># Put x f v q from each tr to the placeholders for checking them visually.</span>
                <span class="n">x_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">f_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">v_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">q_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

                <span class="c1"># Put the BOLD signal each tr to the placeholder being used in the cost calculation.</span>

                <span class="n">bold_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mf">0.00</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">std_out</span><span class="p">))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                                        <span class="mf">100.0</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">V</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">E0</span><span class="p">)</span> <span class="o">*</span>
                                        <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">k1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">k2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">q</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">k3</span> <span class="o">*</span> <span class="p">(</span>
                                                <span class="mi">1</span> <span class="o">-</span> <span class="n">v</span><span class="p">)))[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">TR_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">):</span>

                <span class="c1"># print(E.shape)</span>

                <span class="c1"># Since tr is about second we need to use a small step size like 0.05 to integrate the model states.</span>
                <span class="k">for</span> <span class="n">step_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">steps_per_TR</span><span class="p">):</span>
                    <span class="n">E</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">sampling_size</span><span class="p">))</span>
                    <span class="n">I</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">sampling_size</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">sample_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sampling_size</span><span class="p">):</span>
                        <span class="n">E</span><span class="p">[:,</span> <span class="n">sample_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">E_mean</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.001</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">)</span>
                        <span class="n">I</span><span class="p">[:,</span> <span class="n">sample_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">I_mean</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.001</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">)</span>

                    <span class="c1"># Calculate the input recurrent.</span>
                    <span class="n">IE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W_E</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">I_0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.001</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g_EE</span><span class="p">))</span> <span class="o">*</span> <span class="n">E</span> \
                                          <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">lap_adj</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span>
                                                  <span class="mf">0.001</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g_IE</span><span class="p">))</span> <span class="o">*</span> <span class="n">I</span><span class="p">))</span>  <span class="c1"># input currents for E</span>
                    <span class="n">II</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span>
                        <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W_I</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">I_0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.001</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g_EI</span><span class="p">))</span> <span class="o">*</span> <span class="n">E</span> <span class="o">-</span> <span class="n">I</span><span class="p">))</span>  <span class="c1"># input currents for I</span>

                    <span class="c1"># Calculate the firing rates.</span>
                    <span class="n">rE</span> <span class="o">=</span> <span class="n">h_tf</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">aE</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">bE</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">dE</span><span class="p">,</span> <span class="n">IE</span><span class="p">)</span>  <span class="c1"># firing rate for E</span>
                    <span class="n">rI</span> <span class="o">=</span> <span class="n">h_tf</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">aI</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">bI</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">dI</span><span class="p">,</span> <span class="n">II</span><span class="p">)</span>  <span class="c1"># firing rate for I</span>
                    <span class="c1"># Update the states by step-size 0.05.</span>
                    <span class="n">E_next</span> <span class="o">=</span> <span class="n">E</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">E</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_E</span><span class="p">)</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">gamma_E</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">E</span><span class="p">)</span> <span class="o">*</span> <span class="n">rE</span><span class="p">)</span> \
                             <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">sampling_size</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.02</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">std_in</span><span class="p">))</span>  <span class="c1">### equlibrim point at E=(tau_E*gamma_E*rE)/(1+tau_E*gamma_E*rE)</span>
                    <span class="n">I_next</span> <span class="o">=</span> <span class="n">I</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">I</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_I</span><span class="p">)</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">gamma_I</span> <span class="o">*</span> <span class="n">rI</span><span class="p">)</span> \
                             <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">sampling_size</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                                     <span class="mf">0.02</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">std_in</span><span class="p">))</span>

                    <span class="c1"># Calculate the saturation for model states (for stability and gradient calculation).</span>
                    <span class="n">E_next</span><span class="p">[</span><span class="n">E_next</span> <span class="o">&lt;</span> <span class="mf">0.00001</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00001</span>
                    <span class="n">I_next</span><span class="p">[</span><span class="n">I_next</span> <span class="o">&lt;</span> <span class="mf">0.00001</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00001</span>
                    <span class="c1"># E_next[E_next&gt;=0.9] = torch.tanh(1.6358*E_next[E_next&gt;=0.9])</span>
                    <span class="n">E</span> <span class="o">=</span> <span class="n">E_next</span>  <span class="c1"># torch.tanh(0.00001+m(1.0*E_next))</span>
                    <span class="n">I</span> <span class="o">=</span> <span class="n">I_next</span>  <span class="c1"># torch.tanh(0.00001+m(1.0*I_next))</span>

                    <span class="n">I_mean</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                    <span class="n">E_mean</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                    <span class="n">E_hist</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">,</span> <span class="n">step_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">E_mean</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="n">I_hist</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">,</span> <span class="n">step_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">I_mean</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>

                <span class="c1"># E_window[:,TR_i]=E_mean[:,0]</span>
                <span class="c1"># I_window[:,TR_i]=I_mean[:,0]</span>

            <span class="k">for</span> <span class="n">TR_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">):</span>

                <span class="k">for</span> <span class="n">step_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">steps_per_TR</span><span class="p">):</span>
                    <span class="n">x_next</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">E_hist</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">,</span> <span class="n">step_i</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">tau_s</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_f</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">f_next</span> <span class="o">=</span> <span class="n">f</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">x</span>
                    <span class="n">v_next</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">alpha</span><span class="p">)))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">tau_0</span><span class="p">)</span>
                    <span class="n">q_next</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span>
                            <span class="n">f</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">f</span><span class="p">)))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">rho</span><span class="p">)</span> <span class="o">-</span> <span class="n">q</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">alpha</span><span class="p">))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> \
                             <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_0</span><span class="p">)</span>

                    <span class="n">f_next</span><span class="p">[</span><span class="n">f_next</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.001</span>
                    <span class="n">v_next</span><span class="p">[</span><span class="n">v_next</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.001</span>
                    <span class="n">q_next</span><span class="p">[</span><span class="n">q_next</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.001</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">x_next</span>  <span class="c1"># torch.tanh(x_next)</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">f_next</span>  <span class="c1"># (1 + torch.tanh(f_next - 1))</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">v_next</span>  <span class="c1"># (1 + torch.tanh(v_next - 1))</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="n">q_next</span>  <span class="c1"># (1 + torch.tanh(q_next - 1))</span>
                <span class="c1"># Put x f v q from each tr to the placeholders for checking them visually.</span>
                <span class="n">x_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">f_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">v_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">q_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Put the BOLD signal each tr to the placeholder being used in the cost calculation.</span>

                <span class="n">bold_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mf">0.00</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">std_out</span><span class="p">))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                                        <span class="mf">100.0</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">V</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span>
                            <span class="n">model</span><span class="o">.</span><span class="n">E0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">k1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">k2</span> <span class="o">*</span> <span class="p">(</span>
                                <span class="mi">1</span> <span class="o">-</span> <span class="n">q</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">k3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">v</span><span class="p">)))[:,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Update the current state.</span>
        <span class="c1"># print(E_m.shape)</span>
        <span class="n">current_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">E_mean</span><span class="p">,</span> <span class="n">I_mean</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">q</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;current_state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_state</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;bold_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bold_window</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;E_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">E_hist</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;I_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">I_hist</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;x_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_window</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;f_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f_window</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;v_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_window</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;q_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_window</span>

        <span class="k">return</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">hE</span>

    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;JR&#39;</span><span class="p">:</span>

        <span class="c1"># define some constants</span>
        <span class="n">conduct_lb</span> <span class="o">=</span> <span class="mf">1.5</span>  <span class="c1"># lower bound for conduct velocity</span>
        <span class="n">u_2ndsys_ub</span> <span class="o">=</span> <span class="mi">500</span>  <span class="c1"># the bound of the input for second order system</span>
        <span class="n">noise_std_lb</span> <span class="o">=</span> <span class="mi">150</span>  <span class="c1"># lower bound of std of noise</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># lower bound of local gains</span>
        <span class="n">s2o_coef</span> <span class="o">=</span> <span class="mf">0.0001</span>  <span class="c1"># coefficient from states (source EEG) to EEG</span>
        <span class="n">k_lb</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># lower bound of coefficient of external inputs</span>

        <span class="n">next_state</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">M</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># current of main population</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># current of excitory population</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># current of inhibitory population</span>

        <span class="n">Mv</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>  <span class="c1"># voltage of main population</span>
        <span class="n">Ev</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>  <span class="c1"># voltage of exictory population</span>
        <span class="n">Iv</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>  <span class="c1"># voltage of inhibitory population</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">step_size</span>
        <span class="c1"># Generate the ReLU module for model parameters gEE gEI and gIE</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>

        <span class="c1"># define constant 1 tensor</span>
        <span class="n">con_1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">sc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

            <span class="c1"># Update the Laplacian based on the updated connection gains w_bb.</span>
            <span class="n">w_b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">w_bb</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">w_n_b</span> <span class="o">=</span> <span class="n">w_b</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">w_b</span><span class="p">)</span>

            <span class="n">model</span><span class="o">.</span><span class="n">sc_m_b</span> <span class="o">=</span> <span class="n">w_n_b</span>
            <span class="n">dg_b</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w_n_b</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="c1"># Update the Laplacian based on the updated connection gains w_bb.</span>
            <span class="n">w_f</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">w_ff</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">w_n_f</span> <span class="o">=</span> <span class="n">w_f</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">w_f</span><span class="p">)</span>

            <span class="n">model</span><span class="o">.</span><span class="n">sc_m_f</span> <span class="o">=</span> <span class="n">w_n_f</span>
            <span class="n">dg_f</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w_n_f</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="c1"># Update the Laplacian based on the updated connection gains w_bb.</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">w_ll</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">w_n_l</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">w</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">w</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

            <span class="n">model</span><span class="o">.</span><span class="n">sc_fitted</span> <span class="o">=</span> <span class="n">w_n_l</span>
            <span class="n">dg_l</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w_n_l</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l_s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">dg_l</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">dg_b</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">dg_f</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">w_n_l</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">w_n_b</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">w_n_f</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">model</span><span class="o">.</span><span class="n">delays</span> <span class="o">=</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">dist</span> <span class="o">/</span> <span class="p">(</span><span class="n">conduct_lb</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">mu</span><span class="p">)))</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="c1"># print(torch.max(model.delays), model.delays.shape)</span>

        <span class="c1"># placeholder for the updated current state</span>
        <span class="n">current_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">hx</span><span class="p">)</span>

        <span class="c1"># placeholders for output BOLD, history of E I x f v and q</span>
        <span class="n">eeg_window</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">E_window</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">I_window</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">M_window</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Ev_window</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Iv_window</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Mv_window</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Use the forward model to get EEG signal at ith element in the window.</span>
        <span class="k">for</span> <span class="n">i_window</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">):</span>

            <span class="k">for</span> <span class="n">step_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">steps_per_TR</span><span class="p">):</span>
                <span class="n">Ed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># delayed E</span>

<span class="w">                </span><span class="sd">&quot;&quot;&quot;for ind in range(model.node_size):</span>
<span class="sd">                    #print(ind, hE[ind,:].shape, model.delays[ind,:].shape)</span>
<span class="sd">                    Ed[ind] = torch.index_select(hE[ind,:], 0, model.delays[ind,:])&quot;&quot;&quot;</span>
                <span class="n">hE_new</span> <span class="o">=</span> <span class="n">hE</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                <span class="n">Ed</span> <span class="o">=</span> <span class="n">hE_new</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">delays</span><span class="p">)</span>  <span class="c1"># delayed E</span>

                <span class="n">LEd_b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w_n_b</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Ed</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
                                      <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># weights on delayed E</span>
                <span class="n">LEd_f</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w_n_f</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Ed</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
                                      <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># weights on delayed E</span>
                <span class="n">LEd_l</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w_n_l</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Ed</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
                                      <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># weights on delayed E</span>
                <span class="c1"># Input noise for M.</span>

                <span class="n">u_tms</span> <span class="o">=</span> <span class="n">external</span><span class="p">[:,</span> <span class="n">step_i</span><span class="p">:</span><span class="n">step_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i_window</span><span class="p">]</span>
                <span class="c1">#u_aud = external[:, i_hidden:i_hidden + 1, i_window, 1]</span>
                <span class="c1">#u_0 = external[:, i_hidden:i_hidden + 1, i_window, 2]</span>

                <span class="c1"># LEd+torch.matmul(dg,E): Laplacian on delayed E</span>

                <span class="n">rM</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="o">+</span><span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">k0</span><span class="p">))</span><span class="o">+</span> <span class="p">(</span><span class="n">k_lb</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ki</span><span class="p">)</span><span class="o">*</span> <span class="n">u_tms</span> <span class="o">+</span> \
                     <span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">std_in</span><span class="p">))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> \
                     <span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">lb</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span>
                             <span class="n">LEd_l</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">dg_l</span><span class="p">,</span> <span class="n">M</span><span class="p">))</span> <span class="o">+</span> \
                     <span class="n">sigmoid</span><span class="p">(</span><span class="n">E</span> <span class="o">-</span> <span class="n">I</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">vmax</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">v0</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>  <span class="c1"># firing rate for Main population</span>
                <span class="n">rE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">std_in</span><span class="p">))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> \
                     <span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">lb</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g_f</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">LEd_f</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">dg_f</span><span class="p">,</span> <span class="n">E</span> <span class="o">-</span> <span class="n">I</span><span class="p">))</span> <span class="o">+</span> \
                     <span class="p">(</span><span class="n">lb</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">c2</span><span class="p">))</span> <span class="o">*</span> <span class="n">sigmoid</span><span class="p">((</span><span class="n">lb</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">c1</span><span class="p">))</span> <span class="o">*</span> <span class="n">M</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">vmax</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">v0</span><span class="p">,</span>
                                                          <span class="n">model</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>  <span class="c1"># firing rate for Excitory population</span>
                <span class="n">rI</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">std_in</span><span class="p">))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> \
                     <span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">lb</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">g_b</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">LEd_b</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">dg_b</span><span class="p">,</span> <span class="n">E</span> <span class="o">-</span> <span class="n">I</span><span class="p">))</span> <span class="o">+</span> \
                     <span class="p">(</span><span class="n">lb</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">c4</span><span class="p">))</span> <span class="o">*</span> <span class="n">sigmoid</span><span class="p">((</span><span class="n">lb</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">c3</span><span class="p">))</span> <span class="o">*</span> <span class="n">M</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">vmax</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">v0</span><span class="p">,</span>
                                                          <span class="n">model</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>  <span class="c1"># firing rate for Inhibitory population</span>

                <span class="c1"># Update the states by step-size.</span>
                <span class="n">ddM</span> <span class="o">=</span> <span class="n">M</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">Mv</span>
                <span class="n">ddE</span> <span class="o">=</span> <span class="n">E</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">Ev</span>
                <span class="n">ddI</span> <span class="o">=</span> <span class="n">I</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">Iv</span>
                <span class="n">ddMv</span> <span class="o">=</span> <span class="n">Mv</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">sys2nd</span><span class="p">(</span><span class="mi">0</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">),</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span>
                                        <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">a</span><span class="p">),</span>
                                        <span class="n">u_2ndsys_ub</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">rM</span> <span class="o">/</span> <span class="n">u_2ndsys_ub</span><span class="p">),</span> <span class="n">M</span><span class="p">,</span> <span class="n">Mv</span><span class="p">)</span>

                <span class="n">ddEv</span> <span class="o">=</span> <span class="n">Ev</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">sys2nd</span><span class="p">(</span><span class="mi">0</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">),</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span>
                                        <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">a</span><span class="p">),</span>
                                        <span class="n">u_2ndsys_ub</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">rE</span> <span class="o">/</span> <span class="n">u_2ndsys_ub</span><span class="p">),</span> <span class="n">E</span><span class="p">,</span> <span class="n">Ev</span><span class="p">)</span>

                <span class="n">ddIv</span> <span class="o">=</span> <span class="n">Iv</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">sys2nd</span><span class="p">(</span><span class="mi">0</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">B</span><span class="p">),</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">con_1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">b</span><span class="p">),</span>
                                        <span class="n">u_2ndsys_ub</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">rI</span> <span class="o">/</span> <span class="n">u_2ndsys_ub</span><span class="p">),</span> <span class="n">I</span><span class="p">,</span> <span class="n">Iv</span><span class="p">)</span>

                <span class="c1"># Calculate the saturation for model states (for stability and gradient calculation).</span>
                <span class="n">E</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">ddE</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span><span class="c1">#torch.tanh(0.00001+torch.nn.functional.relu(ddE))</span>
                <span class="n">I</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">ddI</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span><span class="c1">#torch.tanh(0.00001+torch.nn.functional.relu(ddI))</span>
                <span class="n">M</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">ddM</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
                <span class="n">Ev</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">ddEv</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span><span class="c1">#(con_1 + torch.tanh(df - con_1))</span>
                <span class="n">Iv</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">ddIv</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span><span class="c1">#(con_1 + torch.tanh(dv - con_1))</span>
                <span class="n">Mv</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">ddMv</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span><span class="c1">#(con_1 + torch.tanh(dq - con_1))</span>

                <span class="c1"># update placeholders for E buffer</span>
                <span class="n">hE</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="c1"># hE = torch.cat([M, hE[:, :-1]], axis=1)</span>

            <span class="c1"># Put M E I Mv Ev and Iv at every tr to the placeholders for checking them visually.</span>
            <span class="n">M_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
            <span class="n">I_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
            <span class="n">E_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
            <span class="n">Mv_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mv</span><span class="p">)</span>
            <span class="n">Iv_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Iv</span><span class="p">)</span>
            <span class="n">Ev_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ev</span><span class="p">)</span>
            <span class="n">hE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">M</span><span class="p">,</span> <span class="n">hE</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># update placeholders for E buffer</span>

            <span class="c1"># Put the EEG signal each tr to the placeholder being used in the cost calculation.</span>
            <span class="n">lm_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lm</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lm</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

            <span class="n">model</span><span class="o">.</span><span class="n">lm_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">lm_t</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">model</span><span class="o">.</span><span class="n">output_size</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">output_size</span><span class="p">)),</span>
                                                                      <span class="n">lm_t</span><span class="p">))</span>  <span class="c1"># s2o_coef *</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">cy0</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lm_t</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">y0</span>
            <span class="n">eeg_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>  <span class="c1"># torch.abs(E) - torch.abs(I) + 0.0*noiseEEG)</span>

        <span class="c1"># Update the current state.</span>
        <span class="n">current_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">M</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">Mv</span><span class="p">,</span> <span class="n">Ev</span><span class="p">,</span> <span class="n">Iv</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;current_state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_state</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;eeg_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">eeg_window</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;E_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">E_window</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;I_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">I_window</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;P_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">M_window</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;Ev_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">Ev_window</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;Iv_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">Iv_window</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;Pv_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">Mv_window</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">hE</span>

    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;LIN&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forward step in simulating the BOLD signal.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        external: tensor with node_size x steps_per_TR x TRs_per_window x input_size</span>
<span class="sd">            noise for states</span>

<span class="sd">        hx: tensor with node_size x state_size</span>
<span class="sd">            states of WWD model</span>
<span class="sd">        Outputs</span>
<span class="sd">        -------</span>
<span class="sd">        next_state: dictionary with keys:</span>
<span class="sd">        &#39;current_state&#39;&#39;bold_window&#39;&#39;E_window&#39;&#39;I_window&#39;&#39;x_window&#39;&#39;f_window&#39;&#39;v_window&#39;&#39;q_window&#39;</span>
<span class="sd">            record new states and BOLD</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">next_state</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># hx is current state (6) 0: E 1:I (neural activities) 2:x 3:f 4:v 5:f (BOLD)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">step_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Generate the ReLU module for model parameters gEE gEI and gIE</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>

        <span class="c1"># Update the Laplacian based on the updated connection gains gains_con.</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">sc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

            <span class="c1"># Update the Laplacian based on the updated connection gains gains_con.</span>
            <span class="n">sc_mod</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">gains_con</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">sc_mod_normalized</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sc_mod</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">sc_mod</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sc_mod</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">sc_mod</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">sc_fitted</span> <span class="o">=</span> <span class="n">sc_mod_normalized</span>

            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_Laplacian</span><span class="p">:</span>
                <span class="n">lap_adj</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sc_mod_normalized</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">sc_mod_normalized</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lap_adj</span> <span class="o">=</span> <span class="n">sc_mod_normalized</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">lap_adj</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># placeholder for the updated current state</span>
        <span class="n">current_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">hx</span><span class="p">)</span>

        <span class="c1"># placeholders for output BOLD, history of E I x f v and q</span>
        <span class="c1"># placeholders for output BOLD, history of E I x f v and q</span>
        <span class="n">bold_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">))</span>
        <span class="n">E_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">))</span>
        <span class="c1"># I_window = torch.zeros((model.node_size,model.TRs_per_window))</span>

        <span class="n">x_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">))</span>
        <span class="n">f_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">))</span>
        <span class="n">v_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">))</span>
        <span class="n">q_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">))</span>

        <span class="c1"># E_hist = torch.zeros((model.node_size, model.TRs_per_window, model.steps_per_TR))</span>

        <span class="n">E</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># print(E_m.shape)</span>
        <span class="c1"># Use the forward model to get neural activity at ith element in the window.</span>

        <span class="k">for</span> <span class="n">TR_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">):</span>

            <span class="c1"># print(E.shape)</span>

            <span class="c1"># Since tr is about second we need to use a small step size like 0.05 to integrate the model states.</span>
            <span class="k">for</span> <span class="n">step_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">steps_per_TR</span><span class="p">):</span>
                <span class="c1"># Calculate the input recurrents.</span>
                <span class="n">IE</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">lap_adj</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span>  <span class="c1"># input currents for E</span>

                <span class="n">E_next</span> <span class="o">=</span> <span class="n">E</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">E</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">IE</span><span class="p">))</span> \
                         <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">std_in</span><span class="p">))</span>  <span class="c1">### equlibrim point at E=(tau_E*gamma_E*rE)/(1+tau_E*gamma_E*rE)</span>

                <span class="n">x_next</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">E</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_s</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_f</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">f_next</span> <span class="o">=</span> <span class="n">f</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">x</span>
                <span class="n">v_next</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">alpha</span><span class="p">)))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_0</span><span class="p">)</span>
                <span class="n">q_next</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="n">f</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">f</span><span class="p">)))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">rho</span><span class="p">)</span>
                        <span class="o">-</span> <span class="n">q</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">alpha</span><span class="p">))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> \
                         <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tau_0</span><span class="p">)</span>

                <span class="c1"># f_next[f_next &lt; 0.001] = 0.001</span>
                <span class="c1"># v_next[v_next &lt; 0.001] = 0.001</span>
                <span class="c1"># q_next[q_next &lt; 0.001] = 0.001</span>

                <span class="n">E</span> <span class="o">=</span> <span class="n">E_next</span>  <span class="c1"># torch.tanh(0.00001+1.0*E_next)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x_next</span>  <span class="c1"># torch.tanh(x_next)</span>
                <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">f_next</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">v_next</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">q_next</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="c1"># Put x f v q from each tr to the placeholders for checking them visually.</span>
            <span class="n">E_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">E</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">x_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">f_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">v_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">q_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Put the BOLD signal each tr to the placeholder being used in the cost calculation.</span>

            <span class="n">bold_window</span><span class="p">[:,</span> <span class="n">TR_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mf">0.001</span> <span class="o">+</span> <span class="n">m</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">std_out</span><span class="p">))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                                    <span class="mf">100.0</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">V</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">E0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">k1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">q</span><span class="p">)</span>
                                                                                    <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">k2</span> <span class="o">*</span> <span class="p">(</span>
                                                                                            <span class="mi">1</span> <span class="o">-</span> <span class="n">q</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span>
                                                                                        <span class="n">v</span><span class="p">))</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">k3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">v</span><span class="p">)))[:,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Update the current state.</span>
        <span class="c1"># print(E_m.shape)</span>
        <span class="n">current_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">E</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">q</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;current_state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_state</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;bold_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bold_window</span>  <span class="c1"># E_window#</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;E_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">E_window</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;x_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_window</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;f_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f_window</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;v_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_window</span>
        <span class="n">next_state</span><span class="p">[</span><span class="s1">&#39;q_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_window</span>

        <span class="k">return</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">hE</span>

<span class="k">class</span> <span class="nc">RNNJANSEN</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A module for forward model (JansenRit) to simulate a batch of EEG signals</span>
<span class="sd">    Attibutes</span>
<span class="sd">    ---------</span>
<span class="sd">    state_size : int</span>
<span class="sd">        the number of states in the JansenRit model</span>
<span class="sd">    input_size : int</span>
<span class="sd">        the number of states with noise as input</span>
<span class="sd">    tr : float</span>
<span class="sd">        tr of image</span>
<span class="sd">    step_size: float</span>
<span class="sd">        Integration step for forward model</span>
<span class="sd">    hidden_size: int</span>
<span class="sd">        the number of step_size in a tr</span>
<span class="sd">    TRs_per_window: int</span>
<span class="sd">        the number of EEG signals to simulate</span>
<span class="sd">    node_size: int</span>
<span class="sd">        the number of ROIs</span>
<span class="sd">    sc: float node_size x node_size array</span>
<span class="sd">        structural connectivity</span>
<span class="sd">    fit_gains: bool</span>
<span class="sd">        flag for fitting gains 1: fit 0: not fit</span>
<span class="sd">    g, c1, c2, c3,c4: tensor with gradient on</span>
<span class="sd">        model parameters to be fit</span>
<span class="sd">    w_bb: tensor with node_size x node_size (grad on depends on fit_gains)</span>
<span class="sd">        connection gains</span>
<span class="sd">    std_in std_out: tensor with gradient on</span>
<span class="sd">        std for state noise and output noise</span>
<span class="sd">    hyper parameters for prior distribution of model parameters</span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    forward(input, noise_out, hx)</span>
<span class="sd">        forward model (JansenRit) for generating a number of EEG signals with current model parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">state_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;Ev&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;Iv&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;Pv&#39;</span><span class="p">]</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;JR&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">TRs_per_window</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">step_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">output_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">tr</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sc</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">dist</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                 <span class="n">use_fit_gains</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">use_fit_lfm</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">param</span><span class="p">:</span> <span class="n">ParamsModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        tr : float</span>
<span class="sd">            tr of image</span>
<span class="sd">        step_size: float</span>
<span class="sd">            Integration step for forward model</span>

<span class="sd">        TRs_per_window: int</span>
<span class="sd">            the number of EEG signals to simulate</span>
<span class="sd">        node_size: int</span>
<span class="sd">            the number of ROIs</span>
<span class="sd">        output_size: int</span>
<span class="sd">            the number of channels EEG</span>
<span class="sd">        sc: float node_size x node_size array</span>
<span class="sd">            structural connectivity</span>
<span class="sd">        use_fit_gains: bool</span>
<span class="sd">            flag for fitting gains 1: fit 0: not fit</span>
<span class="sd">        use_fit_lfm: bool</span>
<span class="sd">            flag for fitting gains 1: fit 0: not fit</span>
<span class="sd">        param from ParamJR</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RNNJANSEN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_size</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># 6 states JR model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span>  <span class="c1"># tr ms (integration step 0.1 ms)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_size</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">step_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># integration step 0.1 ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps_per_TR</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tr</span> <span class="o">/</span> <span class="n">step_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TRs_per_window</span> <span class="o">=</span> <span class="n">TRs_per_window</span>  <span class="c1"># size of the batch used at each step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_size</span> <span class="o">=</span> <span class="n">node_size</span>  <span class="c1"># num of ROI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">output_size</span>  <span class="c1"># num of EEG channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sc</span> <span class="o">=</span> <span class="n">sc</span>  <span class="c1"># matrix node_size x node_size structure connectivity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span> <span class="o">=</span> <span class="n">lm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_fit_gains</span> <span class="o">=</span> <span class="n">use_fit_gains</span>  <span class="c1"># flag for fitting gains</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_fit_lfm</span> <span class="o">=</span> <span class="n">use_fit_lfm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="n">param</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># number of EEG channels</span>

    <span class="k">def</span> <span class="nf">setModelParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># set states E I f v mean and 1/sqrt(variance)</span>
        <span class="k">return</span> <span class="n">setModelParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external</span><span class="p">,</span> <span class="n">hx</span><span class="p">,</span> <span class="n">hE</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">integration_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external</span><span class="p">,</span> <span class="n">hx</span><span class="p">,</span> <span class="n">hE</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>
<span class="kn">from</span> <span class="nn">whobpyt.optimization.cost_funs</span> <span class="kn">import</span> <span class="n">Costs</span>
<span class="kn">from</span> <span class="nn">whobpyt.datatypes.outputs</span> <span class="kn">import</span> <span class="n">OutputNM</span>

<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">cosine_similarity</span>
<span class="k">class</span> <span class="nc">Model_fitting</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Using ADAM and AutoGrad to fit JansenRit to empirical EEG</span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model: instance of class RNNJANSEN</span>
<span class="sd">        forward model JansenRit</span>
<span class="sd">    ts: array with num_tr x node_size</span>
<span class="sd">        empirical EEG time-series</span>
<span class="sd">    num_epoches: int</span>
<span class="sd">        the times for repeating trainning</span>
<span class="sd">    cost: choice of the cost function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># external input</span>

    <span class="c1"># from sklearn.metrics.pairwise import cosine_similarity</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">num_epoches</span><span class="p">,</span> <span class="n">cost</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model: instance of class RNNJANSEN</span>
<span class="sd">            forward model JansenRit</span>
<span class="sd">        ts: array with num_tr x node_size</span>
<span class="sd">            empirical EEG time-series</span>
<span class="sd">        num_epoches: int</span>
<span class="sd">            the times for repeating trainning</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_epoches</span> <span class="o">=</span> <span class="n">num_epoches</span>
        <span class="c1"># placeholder for output(EEG and histoty of model parameters and loss)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span> <span class="o">=</span> <span class="n">OutputNM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_fit_gains</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_fit_lfm</span><span class="p">)</span>
        <span class="c1"># self.u = u</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;if ts.shape[1] != model.node_size:</span>
<span class="sd">            print(&#39;ts is a matrix with the number of datapoint X the number of node&#39;)</span>
<span class="sd">        else:</span>
<span class="sd">            self.ts = ts&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cost</span> <span class="o">=</span> <span class="n">Costs</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">learningrate</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        learningrate : for machine learing speed</span>
<span class="sd">        u: stimulus</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">delays_max</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="n">state_ub</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">state_lb</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;RWW&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_dynamic_boundary</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_fit_gains</span><span class="p">:</span>
                    <span class="n">epoch_min</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># run minimum epoch # part of stop criteria</span>
                    <span class="n">r_lb</span> <span class="o">=</span> <span class="mf">0.85</span>  <span class="c1"># lowest pearson correlation # part of stop criteria</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">epoch_min</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># run minimum epoch # part of stop criteria</span>
                    <span class="n">r_lb</span> <span class="o">=</span> <span class="mf">0.85</span>  <span class="c1"># lowest pearson correlation # part of stop criteria</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epoch_min</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># run minimum epoch # part of stop criteria</span>
                <span class="n">r_lb</span> <span class="o">=</span> <span class="mf">0.85</span>  <span class="c1"># lowest pearson correlation # part of stop criteria</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">epoch_min</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># run minimum epoch # part of stop criteria</span>
            <span class="n">r_lb</span> <span class="o">=</span> <span class="mf">0.95</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">u</span>

        <span class="c1"># define an optimizer(ADAM)</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">learningrate</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span>

        <span class="c1"># initial state</span>
        <span class="n">X</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;RWW&#39;</span><span class="p">:</span>
            <span class="c1"># initial state</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_size</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;LIN&#39;</span><span class="p">:</span>
            <span class="c1"># initial state</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;JR&#39;</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">state_lb</span><span class="p">,</span> <span class="n">state_ub</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_size</span><span class="p">)),</span>
                             <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="c1"># initials of history of E</span>
        <span class="n">hE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">state_lb</span><span class="p">,</span> <span class="n">state_ub</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">delays_max</span><span class="p">)),</span>
                          <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># define masks for getting lower triangle matrix indices</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mask_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">output_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># placeholders for the history of model parameters</span>
        <span class="n">fit_param</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">exclude_param</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fit_sc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fit_lm</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_fit_gains</span><span class="p">:</span>
            <span class="n">exclude_param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;gains_con&#39;</span><span class="p">)</span>
            <span class="n">fit_sc</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>  <span class="c1"># sc weights history</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;JR&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_fit_lfm</span><span class="p">:</span>
            <span class="n">exclude_param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;lm&#39;</span><span class="p">)</span>
            <span class="n">fit_lm</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">lm</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>  <span class="c1"># leadfield matrix history</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_param</span><span class="p">:</span>
                <span class="n">fit_param</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>

        <span class="n">loss_his</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># loss placeholder</span>

        <span class="c1"># define constant 1 tensor</span>

        <span class="c1"># define num_windows</span>
        <span class="n">num_windows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i_epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_epoches</span><span class="p">):</span>

            <span class="c1"># Create placeholders for the simulated states and outputs of entire time series.</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_names</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span><span class="p">]:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_train&#39;</span><span class="p">,</span> <span class="p">[])</span>

            <span class="c1"># initial the external inputs</span>
            <span class="n">external</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps_per_TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">]),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="c1"># Perform the training in windows.</span>

            <span class="k">for</span> <span class="n">TR_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_windows</span><span class="p">):</span>

                <span class="c1"># Reset the gradient to zeros after update model parameters.</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

                <span class="c1"># if the external not empty</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">external</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">TR_i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">:(</span><span class="n">TR_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">]),</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

                <span class="c1"># Use the model.forward() function to update next state and get simulated EEG in this batch.</span>

                <span class="n">next_window</span><span class="p">,</span> <span class="n">hE_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">external</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">hE</span><span class="p">)</span>

                <span class="c1"># Get the batch of empirical EEG signal.</span>
                <span class="n">ts_window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="p">[</span><span class="n">i_epoch</span><span class="p">,</span> <span class="n">TR_i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

                <span class="c1"># total loss calculation</span>
                <span class="n">sim</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;RWW&#39;</span><span class="p">:</span>
                    <span class="n">sim</span> <span class="o">=</span> <span class="n">next_window</span><span class="p">[</span><span class="s1">&#39;bold_window&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;JR&#39;</span><span class="p">:</span>
                    <span class="n">sim</span> <span class="o">=</span> <span class="n">next_window</span><span class="p">[</span><span class="s1">&#39;eeg_window&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;LIN&#39;</span><span class="p">:</span>
                    <span class="n">sim</span> <span class="o">=</span> <span class="n">next_window</span><span class="p">[</span><span class="s1">&#39;bold_window&#39;</span><span class="p">]</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">cost_eff</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">ts_window</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">next_window</span><span class="p">)</span>
                <span class="c1"># Put the batch of the simulated EEG, E I M Ev Iv Mv in to placeholders for entire time-series.</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_names</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span><span class="p">]:</span>
                    <span class="n">name_next</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_window&#39;</span>
                    <span class="n">tmp_ls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_train&#39;</span><span class="p">)</span>
                    <span class="n">tmp_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_window</span><span class="p">[</span><span class="n">name_next</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_train&#39;</span><span class="p">,</span> <span class="n">tmp_ls</span><span class="p">)</span>

                <span class="n">loss_his</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

                <span class="c1"># Calculate gradient using backward (backpropagation) method of the loss function.</span>
                <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">retain_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Optimize the model based on the gradient method in updating the model parameters.</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

                <span class="c1"># Put the updated model parameters into the history placeholders.</span>
                <span class="c1"># sc_par.append(self.model.sc[mask].copy())</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_param</span><span class="p">:</span>
                        <span class="n">fit_param</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_fit_gains</span><span class="p">:</span>
                    <span class="n">fit_sc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sc_fitted</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;JR&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_fit_lfm</span><span class="p">:</span>
                    <span class="n">fit_lm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">lm</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

                <span class="c1"># last update current state using next state...</span>
                <span class="c1"># (no direct use X = X_next, since gradient calculation only depends on one batch no history)</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">next_window</span><span class="p">[</span><span class="s1">&#39;current_state&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">hE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">hE_new</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="c1"># print(hE_new.detach().numpy()[20:25,0:20])</span>
                <span class="c1"># print(hE.shape)</span>
            <span class="n">ts_emp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="p">[</span><span class="n">i_epoch</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">fc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">ts_emp</span><span class="p">)</span>

            <span class="n">tmp_ls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span> <span class="o">+</span> <span class="s1">&#39;_train&#39;</span><span class="p">)</span>
            <span class="n">ts_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">tmp_ls</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">fc_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">ts_sim</span><span class="p">[:,</span> <span class="mi">10</span><span class="p">:])</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;epoch: &#39;</span><span class="p">,</span> <span class="n">i_epoch</span><span class="p">,</span> <span class="n">loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;epoch: &#39;</span><span class="p">,</span> <span class="n">i_epoch</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">fc_sim</span><span class="p">[</span><span class="n">mask_e</span><span class="p">],</span> <span class="n">fc</span><span class="p">[</span><span class="n">mask_e</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;cos_sim: &#39;</span><span class="p">,</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cosine_similarity</span><span class="p">(</span><span class="n">ts_sim</span><span class="p">,</span> <span class="n">ts_emp</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_names</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span><span class="p">]:</span>
                <span class="n">tmp_ls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_train&#39;</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_train&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">tmp_ls</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss_his</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">i_epoch</span> <span class="o">&gt;</span> <span class="n">epoch_min</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">fc_sim</span><span class="p">[</span><span class="n">mask_e</span><span class="p">],</span> <span class="n">fc</span><span class="p">[</span><span class="n">mask_e</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">r_lb</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_fit_gains</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fit_sc</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;JR&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_fit_lfm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">leadfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fit_lm</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fit_param</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">he</span><span class="p">,</span> <span class="n">base_window_num</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        base_window_num: int</span>
<span class="sd">            length of num_windows for resting</span>
<span class="sd">        u : external or stimulus</span>
<span class="sd">        -----------</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># define some constants</span>
        <span class="n">state_lb</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
        <span class="n">state_ub</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">delays_max</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="n">transient_num</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">u</span>

        <span class="c1"># initial state</span>
        <span class="n">X</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;RWW&#39;</span><span class="p">:</span>
            <span class="c1"># initial state</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_size</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;LIN&#39;</span><span class="p">:</span>
            <span class="c1"># initial state</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;JR&#39;</span><span class="p">:</span>
            <span class="c1">#X = torch.tensor(np.random.uniform(state_lb, state_ub, (self.model.node_size, self.model.state_size)),</span>
             <span class="c1">#                dtype=torch.float32)</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="c1">#hE = torch.tensor(np.random.uniform(state_lb, state_ub, (self.model.node_size, 500)), dtype=torch.float32)</span>
        <span class="n">hE</span> <span class="o">=</span> <span class="n">he</span>
        <span class="c1"># placeholders for model parameters</span>

        <span class="c1"># define mask for getting lower triangle matrix</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mask_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">output_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># define num_windows</span>
        <span class="n">num_windows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Create placeholders for the simulated BOLD E I x f and q of entire time series.</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_names</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span><span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">u_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps_per_TR</span><span class="p">,</span>
             <span class="n">base_window_num</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">u_hat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">base_window_num</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>

        <span class="c1"># Perform the training in batches.</span>

        <span class="k">for</span> <span class="n">TR_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_windows</span> <span class="o">+</span> <span class="n">base_window_num</span><span class="p">):</span>

            <span class="c1"># Get the input and output noises for the module.</span>

            <span class="n">external</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                <span class="p">(</span><span class="n">u_hat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">TR_i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">:(</span><span class="n">TR_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">]),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="c1"># Use the model.forward() function to update next state and get simulated EEG in this batch.</span>
            <span class="n">next_window</span><span class="p">,</span> <span class="n">hE_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">external</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">hE</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">TR_i</span> <span class="o">&gt;</span> <span class="n">base_window_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_names</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span><span class="p">]:</span>
                    <span class="n">name_next</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_window&#39;</span>
                    <span class="n">tmp_ls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">)</span>
                    <span class="n">tmp_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_window</span><span class="p">[</span><span class="n">name_next</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">,</span> <span class="n">tmp_ls</span><span class="p">)</span>

            <span class="c1"># last update current state using next state...</span>
            <span class="c1"># (no direct use X = X_next, since gradient calculation only depends on one batch no history)</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">next_window</span><span class="p">[</span><span class="s1">&#39;current_state&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">hE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">hE_new</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="c1"># print(hE_new.detach().numpy()[20:25,0:20])</span>
            <span class="c1"># print(hE.shape)</span>

        <span class="n">ts_emp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">ts_emp</span><span class="p">)</span>
        <span class="n">tmp_ls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">)</span>
        <span class="n">ts_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">tmp_ls</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">fc_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">ts_sim</span><span class="p">[:,</span> <span class="n">transient_num</span><span class="p">:])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">fc_sim</span><span class="p">[</span><span class="n">mask_e</span><span class="p">],</span> <span class="n">fc</span><span class="p">[</span><span class="n">mask_e</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;cos_sim: &#39;</span><span class="p">,</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cosine_similarity</span><span class="p">(</span><span class="n">ts_sim</span><span class="p">,</span> <span class="n">ts_emp</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_names</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span><span class="p">]:</span>
            <span class="n">tmp_ls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">tmp_ls</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_realtime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tr_p</span><span class="p">,</span> <span class="n">step_size_n</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">num_windows</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;RWW&#39;</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">X_np</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_size</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
            <span class="n">variables_p</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">)</span> <span class="k">if</span>
                           <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">a</span><span class="p">))]</span>
            <span class="c1"># get penalty on each model parameters due to prior distribution</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables_p</span><span class="p">:</span>
                <span class="c1"># print(var)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">des</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
                    <span class="n">des</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">des</span><span class="p">)</span>
            <span class="n">model_np</span> <span class="o">=</span> <span class="n">WWD_np</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">,</span> <span class="n">step_size_n</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">tr_p</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sc_fitted</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_dynamic_boundary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_Laplacian</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">)</span>

            <span class="c1"># Create placeholders for the simulated BOLD E I x f and q of entire time series.</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_names</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span><span class="p">]:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">,</span> <span class="p">[])</span>

            <span class="c1"># Perform the training in batches.</span>

            <span class="k">for</span> <span class="n">TR_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_windows</span> <span class="o">+</span> <span class="mi">10</span><span class="p">):</span>

                <span class="n">noise_in_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">tr_p</span> <span class="o">/</span> <span class="n">step_size_n</span><span class="p">),</span>
                                              <span class="mi">2</span><span class="p">)</span>

                <span class="n">noise_BOLD_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">TRs_per_window</span><span class="p">)</span>

                <span class="n">next_window_np</span> <span class="o">=</span> <span class="n">model_np</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">X_np</span><span class="p">,</span> <span class="n">noise_in_np</span><span class="p">,</span> <span class="n">noise_BOLD_np</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">TR_i</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="c1"># Put the batch of the simulated BOLD, E I x f v q in to placeholders for entire time-series.</span>
                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_names</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span><span class="p">]:</span>
                        <span class="n">name_next</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_window&#39;</span>
                        <span class="n">tmp_ls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">)</span>
                        <span class="n">tmp_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_window_np</span><span class="p">[</span><span class="n">name_next</span><span class="p">])</span>

                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">,</span> <span class="n">tmp_ls</span><span class="p">)</span>

                <span class="c1"># last update current state using next state...</span>
                <span class="c1"># (no direct use X = X_next, since gradient calculation only depends on one batch no history)</span>
                <span class="n">X_np</span> <span class="o">=</span> <span class="n">next_window_np</span><span class="p">[</span><span class="s1">&#39;current_state&#39;</span><span class="p">]</span>
            <span class="n">tmp_ls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_names</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">output_name</span><span class="p">]:</span>
                <span class="n">tmp_ls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_test&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">tmp_ls</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;only WWD model for the test_realtime function&quot;</span><span class="p">)</span>


<span class="c1"># array and pd stuff</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.io</span>


<span class="c1"># viz stuff</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">nibabel</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">import</span> <span class="nn">mne</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># @title Importage</span>
</pre></div>
</div>
</div>
</div>
<p>We now are going to import the empirical data and plot the channel level activity using  <code class="docutils literal notranslate"><span class="pre">plot_joint</span></code> function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_path</span> <span class="o">=</span> <span class="s1">&#39;/content/Data/EEG_stim/&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
<span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;sub-02_run-01_epoched.fif&#39;</span>

<span class="n">epoched</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">read_epochs</span><span class="p">(</span><span class="n">data_path</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>

<span class="n">evoked</span> <span class="o">=</span> <span class="n">epoched</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs1</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=-</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.015</span><span class="p">);</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs2</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.05</span><span class="p">);</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs3</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.08</span><span class="p">);</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs4</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.15</span><span class="p">);</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs5</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.25</span><span class="p">);</span>

<span class="n">ts_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.3</span><span class="p">])</span> <span class="c1">#Time to plot</span>

<span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">peak_locs1</span><span class="p">,</span> <span class="n">peak_locs2</span><span class="p">,</span> <span class="n">peak_locs3</span><span class="p">,</span> <span class="n">peak_locs4</span><span class="p">,</span> <span class="n">peak_locs5</span><span class="p">]</span>

<span class="n">evoked_joint_st</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">plot_joint</span><span class="p">(</span><span class="n">ts_args</span><span class="o">=</span><span class="n">ts_args</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>NOTE: pick_channels() is a legacy function. New code should use inst.pick(...).
No projector specified for this dataset. Please consider the method self.add_proj.
NOTE: pick_channels() is a legacy function. New code should use inst.pick(...).
</pre></div>
</div>
<img alt="../_images/5ca67e6e281e1a7197ee2614c96d23de8cf976e05f19b6c1f0279259be5adc3f.png" src="../_images/5ca67e6e281e1a7197ee2614c96d23de8cf976e05f19b6c1f0279259be5adc3f.png" />
</div>
</div>
<p>As you can see we have plot 100ms of baseline/resting-state activity. At 0ms a stimulus was delivered to the right SomatoMotor Network. And we track the waving propagation that generate from this perturbation. This is defined in literature as pertubation mapping approch. That’s the empirical data that we want to model and specifically we want to explore what’s the role of the structural connectivity in shaping this propagtion pattern</p>
<p>In order to answer this question we use a whole-brain models approach. We have alrady modelled the data for you due for saving time. Specifically we have used  Jansen &amp; Ritt in <code class="docutils literal notranslate"><span class="pre">WhoBPyT</span></code>. The nature and purpose of the simulation is not really the main focus of this tutorial but - in a nutshell - we cast the differential equations of the model in a   <code class="docutils literal notranslate"><span class="pre">PyTorch</span></code> enviroment and using a deep-learning framework for finding the optimal paraters of the model which gave a good resemble of the empirical data in model generated timeseries.</p>
<p>Let’s import the simulated timeseries and plot them using <code class="docutils literal notranslate"><span class="pre">plot_joint</span></code> again</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/content/Data/EEG_stim/sub-02_run-01_fittingresults_stim_exp.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">simulated_EEG_st</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


<span class="n">time_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">evoked</span><span class="o">.</span><span class="n">times</span><span class="o">==-</span><span class="mf">0.1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">time_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">evoked</span><span class="o">.</span><span class="n">times</span><span class="o">==</span><span class="mf">0.3</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>


<span class="n">simulated_EEG_st</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="n">time_start</span><span class="p">:</span><span class="n">time_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">eeg_test</span>
<span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">peak_locs1</span><span class="p">,</span> <span class="n">peak_locs2</span><span class="p">,</span> <span class="n">peak_locs3</span><span class="p">,</span> <span class="n">peak_locs4</span><span class="p">,</span> <span class="n">peak_locs5</span><span class="p">]</span>
<span class="n">simulated_joint_st</span> <span class="o">=</span> <span class="n">simulated_EEG_st</span><span class="o">.</span><span class="n">plot_joint</span><span class="p">(</span><span class="n">ts_args</span><span class="o">=</span><span class="n">ts_args</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>No projector specified for this dataset. Please consider the method self.add_proj.
NOTE: pick_channels() is a legacy function. New code should use inst.pick(...).
</pre></div>
</div>
<img alt="../_images/d61163eca2100cb242f577498718afeb6f0d956cf476f73cc9a800f353315040.png" src="../_images/d61163eca2100cb242f577498718afeb6f0d956cf476f73cc9a800f353315040.png" />
</div>
</div>
<p>As you can see from the topomap, the model is able to track the propagation pattern of the induced-activity quite reliably. In order to evaluate the “goodness” of this fit, we can compute the Pearson’s correlation betweeen simulated and empirical timeseries</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">simulated_EEG_st</span><span class="o">.</span><span class="n">_data</span><span class="p">[:,</span> <span class="n">time_start</span><span class="p">:</span><span class="n">time_end</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">evoked</span><span class="o">.</span><span class="n">_data</span><span class="p">[:,</span> <span class="n">time_start</span><span class="p">:</span><span class="n">time_end</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;correlation coeffient is equal to &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">corr</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>correlation coeffient is equal to 0.833032208538631
</pre></div>
</div>
</div>
</div>
<p>Now that we have a model who is reproducing the empirical timeseries, we can use that for investigation what is the role of structural connectivity in shaping the propagation pattern. In order to do that we are going to use a virtual lesion approach.</p>
<p>A crucial aspect to note is that, in order to simulate the activity of the entire brain, we integrated the Jansen &amp; Rit model into each node of the Schaefer et al. 2018 parcellation, which divides the brain into 200 parcels and 7 Network.</p>
<blockquote>
<div><p>Schaefer A. et al. Local-global parcellation of the human cerebral cortex from intrinsic functional connectivity MRI. <em>Cerebral Cortex</em> 28:3095–3114. (2018), doi: 10.1093/cercor/bhx179.</p>
</div></blockquote>
<p>This approach allowed us to capture the complex dynamics and interactions occurring within each specific region of the brain. By implementing the model at a finer scale within the parcellation, we aimed to achieve a more comprehensive and accurate representation of the whole-brain activity.</p>
<p>We are going to start by setting up the path for the Schaefer annotation files</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Grabbing the Schaefer2018_200Parcels_7Networks_order anootation file</span>
<span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lh.Schaefer2018_200Parcels_7Networks_order.annot&#39;</span><span class="p">,</span> <span class="s1">&#39;rh.Schaefer2018_200Parcels_7Networks_order.annot&#39;</span><span class="p">]</span>
<span class="n">save_path</span> <span class="o">=</span> <span class="s1">&#39;/content/Data/EEG_stim/&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>Now we are ready to plot the simulated activity into a surface. The <code class="docutils literal notranslate"><span class="pre">tp</span></code> variable in the code below stands for time point and indicates the frame that it is going to be plotted into the surface.</p>
<p>First we are going to define some function for plotting the activity we have simulated into a brain surface</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib.tri</span> <span class="kn">import</span> <span class="n">Triangulation</span>

<span class="k">def</span> <span class="nf">get_rotation_matrix</span><span class="p">(</span><span class="n">rotation_axis</span><span class="p">,</span> <span class="n">deg</span><span class="p">):</span>

<span class="w">  </span><span class="sd">&#39;&#39;&#39;Return rotation matrix in the x,y,or z plane&#39;&#39;&#39;</span>



  <span class="c1"># (note make deg minus to change from anticlockwise to clockwise rotation)</span>
  <span class="n">th</span> <span class="o">=</span> <span class="o">-</span><span class="n">deg</span> <span class="o">*</span> <span class="p">(</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span> <span class="c1"># convert degrees to radians</span>

  <span class="k">if</span> <span class="n">rotation_axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[[</span>    <span class="mi">1</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span>    <span class="p">],</span>
                      <span class="p">[</span>    <span class="mi">0</span><span class="p">,</span>      <span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">),</span>   <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">)],</span>
                      <span class="p">[</span>    <span class="mi">0</span><span class="p">,</span>      <span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">),</span>    <span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">)]])</span>
  <span class="k">elif</span> <span class="n">rotation_axis</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[[</span>   <span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">),</span>    <span class="mi">0</span><span class="p">,</span>        <span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">)],</span>
                      <span class="p">[</span>    <span class="mi">0</span><span class="p">,</span>         <span class="mi">1</span><span class="p">,</span>          <span class="mi">0</span>    <span class="p">],</span>
                      <span class="p">[</span>  <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">),</span>    <span class="mi">0</span><span class="p">,</span>        <span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">)]])</span>
  <span class="k">elif</span> <span class="n">rotation_axis</span> <span class="o">==</span><span class="mi">2</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span>   <span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">),</span>  <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">),</span>     <span class="mi">0</span>    <span class="p">],</span>
                     <span class="p">[</span>    <span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">),</span>   <span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">),</span>     <span class="mi">0</span>   <span class="p">],</span>
                     <span class="p">[</span>     <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>          <span class="mi">1</span>   <span class="p">]])</span>



<span class="k">def</span> <span class="nf">get_combined_rotation_matrix</span><span class="p">(</span><span class="n">rotations</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&#39;&#39;&#39;Return a combined rotation matrix from a dictionary of rotations around</span>
<span class="sd">     the x,y,or z axes&#39;&#39;&#39;</span>
  <span class="n">rotmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

  <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rotations</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span> <span class="n">rotations</span> <span class="o">=</span> <span class="p">[</span><span class="n">rotations</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rotations</span><span class="p">:</span>
    <span class="n">newrot</span> <span class="o">=</span> <span class="n">get_rotation_matrix</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">rotmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotmat</span><span class="p">,</span><span class="n">newrot</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">rotmat</span>

<span class="k">def</span> <span class="nf">plot_surface_mpl</span><span class="p">(</span><span class="n">vtx</span><span class="p">,</span><span class="n">tri</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">reorient</span><span class="o">=</span><span class="s1">&#39;tvb&#39;</span><span class="p">,</span><span class="n">view</span><span class="o">=</span><span class="s1">&#39;superior&#39;</span><span class="p">,</span>
                     <span class="n">shaded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">lthr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">uthr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nz_thr</span> <span class="o">=</span> <span class="mf">1E-20</span><span class="p">,</span>
                     <span class="n">shade_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;edgecolors&#39;</span><span class="p">:</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                                     <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;cmap&#39;</span><span class="p">:</span> <span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;vmin&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;vmax&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}):</span>

<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Plot surfaces, surface patterns, and region patterns with matplotlib</span>

<span class="sd">  This is a general-use function for neuroimaging surface-based data, and</span>
<span class="sd">  does not necessarily require construction of or interaction with tvb</span>
<span class="sd">  datatypes.</span>

<span class="sd">  See also:  plot_surface_mpl_mv</span>



<span class="sd">  Parameters</span>
<span class="sd">  ----------</span>

<span class="sd">  vtx           : N vertices x 3 array of surface vertex xyz coordinates</span>

<span class="sd">  tri           : N faces x 3 array of surface faces</span>

<span class="sd">  data          : array of numbers to colour surface with. Can be either</span>
<span class="sd">                  a pattern across surface vertices (N vertices x 1 array),</span>
<span class="sd">                  or a pattern across the surface&#39;s region mapping</span>
<span class="sd">                  (N regions x 1 array), in which case the region mapping</span>
<span class="sd">                  bust also be given as an argument.</span>

<span class="sd">  rm            : region mapping - N vertices x 1 array with (up to) N</span>
<span class="sd">                  regions unique values; each element specifies which</span>
<span class="sd">                  region the corresponding surface vertex is mapped to</span>

<span class="sd">  reorient      : modify the vertex coordinate frame and/or orientation</span>
<span class="sd">                  so that the same default rotations can subsequently be</span>
<span class="sd">                  used for image views. The standard coordinate frame is</span>
<span class="sd">                  xyz; i.e. first,second,third axis = left-right,</span>
<span class="sd">                  front-back, and up-down, respectively. The standard</span>
<span class="sd">                  starting orientation is axial view; i.e. looking down on</span>
<span class="sd">                  the brain in the x-y plane.</span>

<span class="sd">                  Options:</span>

<span class="sd">                    tvb (default)   : swaps the first 2 axes and applies a rotation</span>

<span class="sd">                    fs              : for the standard freesurfer (RAS) orientation;</span>
<span class="sd">                                      e.g. fsaverage lh.orig.</span>
<span class="sd">                                      No transformations needed for this; so is</span>
<span class="sd">                                      gives same result as reorient=None</span>

<span class="sd">  view          : specify viewing angle.</span>

<span class="sd">                  This can be done in one of two ways: by specifying a string</span>
<span class="sd">                  corresponding to a standard viewing angle, or by providing</span>
<span class="sd">                  a tuple or list of tuples detailing exact rotations to apply</span>
<span class="sd">                  around each axis.</span>

<span class="sd">                  Standard view options are:</span>

<span class="sd">                  lh_lat / lh_med / rh_lat / rh_med /</span>
<span class="sd">                  superior / inferior / posterior / anterior</span>

<span class="sd">                  (Note: if the surface contains both hemispheres, then medial</span>
<span class="sd">                   surfaces will not be visible, so e.g. &#39;rh_med&#39; will look the</span>
<span class="sd">                   same as &#39;lh_lat&#39;)</span>

<span class="sd">                  Arbitrary rotations can be specied by a tuple or a list of</span>
<span class="sd">                  tuples, each with two elements, the first defining the axis</span>
<span class="sd">                  to rotate around [0,1,2], the second specifying the angle in</span>
<span class="sd">                  degrees. When a list is given the rotations are applied</span>
<span class="sd">                  sequentially in the order given.</span>

<span class="sd">                  Example: rotations = [(0,45),(1,-45)] applies 45 degrees</span>
<span class="sd">                  rotation around the first axis, followed by 45 degrees rotate</span>
<span class="sd">                  around the second axis.</span>

<span class="sd">  lthr/uthr     : lower/upper thresholds - set to zero any datapoints below /</span>
<span class="sd">                  above these values</span>

<span class="sd">  nz_thr        : near-zero threshold - set to zero all datapoints with absolute</span>
<span class="sd">                  values smaller than this number. Default is a very small</span>
<span class="sd">                  number (1E-20), which unless your data has very small numbers,</span>
<span class="sd">                  will only mask out actual zeros.</span>

<span class="sd">  shade_kwargs  : dictionary specifiying shading options</span>

<span class="sd">                  Most relevant options (see matplotlib &#39;tripcolor&#39; for full details):</span>

<span class="sd">                    - &#39;shading&#39;        (either &#39;gourand&#39; or omit;</span>
<span class="sd">                                        default is &#39;flat&#39;)</span>
<span class="sd">                    - &#39;edgecolors&#39;     &#39;k&#39; = black is probably best</span>
<span class="sd">                    - &#39;linewidth&#39;      0.1 works well; note that the visual</span>
<span class="sd">                                       effect of this will depend on both the</span>
<span class="sd">                                       surface density and the figure size</span>
<span class="sd">                    - &#39;cmap&#39;           colormap</span>
<span class="sd">                    - &#39;vmin&#39;/&#39;vmax&#39;    scale colormap to these values</span>
<span class="sd">                    - &#39;alpha&#39;          surface opacity</span>

<span class="sd">  ax            : figure axis</span>

<span class="sd">  figsize       : figure size (ignore if ax provided)</span>

<span class="sd">  title         : text string to place above figure</span>




<span class="sd">  Usage</span>
<span class="sd">  -----</span>


<span class="sd">  Basic freesurfer example:</span>

<span class="sd">  import nibabel as nib</span>
<span class="sd">  vtx,tri = nib.freesurfer.read_geometry(&#39;subjects/fsaverage/surf/lh.orig&#39;)</span>
<span class="sd">  plot_surface_mpl(vtx,tri,view=&#39;lh_lat&#39;,reorient=&#39;fs&#39;)</span>



<span class="sd">  Basic tvb example:</span>

<span class="sd">  ctx = cortex.Cortex.from_file(source_file = ctx_file,</span>
<span class="sd">                                region_mapping_file =rm_file)</span>
<span class="sd">  vtx,tri,rm = ctx.vertices,ctx.triangles,ctx.region_mapping</span>
<span class="sd">  conn = connectivity.Connectivity.from_file(conn_file); conn.configure()</span>
<span class="sd">  isrh_reg = conn.is_right_hemisphere(range(conn.number_of_regions))</span>
<span class="sd">  isrh_vtx = np.array([isrh_reg[r] for r in rm])</span>
<span class="sd">  dat = conn.tract_lengths[:,5]</span>

<span class="sd">  plot_surface_mpl(vtx=vtx,tri=tri,rm=rm,data=dat,view=&#39;inferior&#39;,title=&#39;inferior&#39;)</span>

<span class="sd">  fig, ax = plt.subplots()</span>
<span class="sd">  plot_surface_mpl(vtx=vtx,tri=tri,rm=rm,data=dat, view=[(0,-90),(1,55)],ax=ax,</span>
<span class="sd">                   title=&#39;lh angle&#39;,shade_kwargs={&#39;shading&#39;: &#39;gouraud&#39;, &#39;cmap&#39;: &#39;rainbow&#39;})</span>


<span class="sd">  &quot;&quot;&quot;</span>

  <span class="c1"># Copy things to make sure we don&#39;t modify things</span>
  <span class="c1"># in the namespace inadvertently.</span>

  <span class="n">vtx</span><span class="p">,</span><span class="n">tri</span> <span class="o">=</span> <span class="n">vtx</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="n">tri</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

  <span class="c1"># 1. Set the viewing angle</span>

  <span class="k">if</span> <span class="n">reorient</span> <span class="o">==</span> <span class="s1">&#39;tvb&#39;</span><span class="p">:</span>
    <span class="c1"># The tvb default brain has coordinates in the order</span>
    <span class="c1"># yxz for some reason. So first change that:</span>
    <span class="n">vtx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">vtx</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">vtx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">vtx</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Also need to reflect in the x axis</span>
    <span class="n">vtx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*=-</span><span class="mi">1</span>

  <span class="c1"># (reorient == &#39;fs&#39; is same as reorient=None; so not strictly needed</span>
  <span class="c1">#  but is included for clarity)</span>



  <span class="c1"># ...get rotations for standard view options</span>

  <span class="k">if</span>   <span class="n">view</span> <span class="o">==</span> <span class="s1">&#39;lh_lat&#39;</span>    <span class="p">:</span> <span class="n">rots</span> <span class="o">=</span>  <span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">90</span><span class="p">)</span>  <span class="p">]</span>
  <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s1">&#39;lh_med&#39;</span>    <span class="p">:</span> <span class="n">rots</span> <span class="o">=</span>  <span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span> <span class="p">]</span>
  <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s1">&#39;rh_lat&#39;</span>    <span class="p">:</span> <span class="n">rots</span> <span class="o">=</span>  <span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span> <span class="p">]</span>
  <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s1">&#39;rh_med&#39;</span>    <span class="p">:</span> <span class="n">rots</span> <span class="o">=</span>  <span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">90</span><span class="p">)</span>  <span class="p">]</span>
  <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s1">&#39;superior&#39;</span>  <span class="p">:</span> <span class="n">rots</span> <span class="o">=</span>   <span class="kc">None</span>
  <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s1">&#39;inferior&#39;</span>  <span class="p">:</span> <span class="n">rots</span> <span class="o">=</span>   <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">180</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s1">&#39;anterior&#39;</span>  <span class="p">:</span> <span class="n">rots</span> <span class="o">=</span>   <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s1">&#39;posterior&#39;</span> <span class="p">:</span> <span class="n">rots</span> <span class="o">=</span>  <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">180</span><span class="p">)]</span>
  <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">view</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">view</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">):</span> <span class="n">rots</span> <span class="o">=</span> <span class="n">view</span>

  <span class="c1"># (rh_lat is the default &#39;view&#39; argument because no rotations are</span>
  <span class="c1">#  for that one; so if no view is specified when the function is called,</span>
  <span class="c1">#  the &#39;rh_lat&#39; option is chose here and the surface is shown &#39;as is&#39;</span>


  <span class="c1"># ...apply rotations</span>

  <span class="k">if</span> <span class="n">rots</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">rotmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>            <span class="n">rotmat</span> <span class="o">=</span> <span class="n">get_combined_rotation_matrix</span><span class="p">(</span><span class="n">rots</span><span class="p">)</span>
  <span class="n">vtx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vtx</span><span class="p">,</span><span class="n">rotmat</span><span class="p">)</span>



  <span class="c1"># 2. Sort out the data</span>


  <span class="c1"># ...if no data is given, plot a vector of 1s.</span>
  <span class="c1">#    if using region data, create corresponding surface vector</span>
  <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">vtx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">vtx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rm</span><span class="p">])</span>

  <span class="c1"># ...apply thresholds</span>
  <span class="k">if</span> <span class="n">uthr</span><span class="p">:</span> <span class="n">data</span> <span class="o">*=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="n">uthr</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">lthr</span><span class="p">:</span> <span class="n">data</span> <span class="o">*=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">lthr</span><span class="p">)</span>
  <span class="n">data</span> <span class="o">*=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">nz_thr</span><span class="p">)</span>


  <span class="c1"># 3. Create the surface triangulation object</span>

  <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">vtx</span><span class="o">.</span><span class="n">T</span>
  <span class="n">tx</span><span class="p">,</span><span class="n">ty</span><span class="p">,</span><span class="n">tz</span> <span class="o">=</span> <span class="n">vtx</span><span class="p">[</span><span class="n">tri</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
  <span class="n">tr</span> <span class="o">=</span> <span class="n">Triangulation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">tri</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">tz</span><span class="p">)])</span>

  <span class="c1"># 4. Make the figure</span>

  <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

  <span class="c1">#if shade = &#39;gouraud&#39;: shade_opts[&#39;shade&#39;] =</span>
  <span class="n">tc</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">tripcolor</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="o">**</span><span class="n">shade_kwargs</span><span class="p">)</span>

  <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">tc</span>
<span class="c1">#@title function for plotting surface</span>

<span class="k">def</span> <span class="nf">plot_surface_mpl_mv</span><span class="p">(</span><span class="n">vtx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tri</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">hemi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>   <span class="c1"># Option 1</span>
                        <span class="n">vtx_lh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tri_lh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">data_lh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rm_lh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># Option 2</span>
                        <span class="n">vtx_rh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tri_rh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">data_rh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rm_rh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Convenience wrapper on plot_surface_mpl for multiple views</span>

<span class="sd">  This function calls plot_surface_mpl five times to give a complete</span>
<span class="sd">  picture of a surface- or region-based spatial pattern.</span>

<span class="sd">  As with plot_surface_mpl, this function is written so as to be</span>
<span class="sd">  generally usable with neuroimaging surface-based data, and does not</span>
<span class="sd">  require construction of of interaction with tvb datatype objects.</span>

<span class="sd">  In order for the medial surfaces to be displayed properly, it is</span>
<span class="sd">  necessary to separate the left and right hemispheres. This can be</span>
<span class="sd">  done in one of two ways:</span>

<span class="sd">  1. Provide single arrays for vertices, faces, data, and</span>
<span class="sd">     region mappings, and addition provide arrays of indices for</span>
<span class="sd">     each of these (vtx_inds,tr_inds,rm_inds) with 0/False</span>
<span class="sd">     indicating left hemisphere vertices/faces/regions, and 1/True</span>
<span class="sd">     indicating right hemisphere.</span>

<span class="sd">     Note: this requires that</span>

<span class="sd">  2. Provide separate vertices,faces,data,and region mappings for</span>
<span class="sd">     each hemisphere (vtx_lh,tri_lh; vtx_rh,tri_rh,etc...)</span>



<span class="sd">  Parameters</span>
<span class="sd">  ----------</span>

<span class="sd">  (see also plot_surface_mpl parameters info for more details)</span>

<span class="sd">  (Option 1)</span>

<span class="sd">  vtx               :  surface vertices</span>

<span class="sd">  tri               : surface faces</span>

<span class="sd">  data              : spatial pattern to plot</span>

<span class="sd">  rm                : surface vertex to region mapping</span>

<span class="sd">  hemi              : hemisphere labels for each vertex</span>
<span class="sd">                      (1/True = right, 0/False = left) -</span>


<span class="sd">  OR</span>

<span class="sd">  (Option 2)</span>

<span class="sd">  vtx_lh            : left hemisphere surface_vertices</span>
<span class="sd">  vtx_rh            : right ``      ``    ``     ``</span>

<span class="sd">  tri_lh            : left hemisphere surface faces</span>
<span class="sd">  tri_rh            : right ``      ``    ``     ``</span>

<span class="sd">  data_lh          : left hemisphere surface_vertices</span>
<span class="sd">  data_rh          : right ``      ``    ``     ``</span>

<span class="sd">  rm_lh            : left hemisphere region_mapping</span>
<span class="sd">  rm_rh            : right ``      ``    ``     ``</span>


<span class="sd">  title            : title to show above middle plot</span>

<span class="sd">  kwargs           : additional tripcolor kwargs; see plot_surface_mpl</span>



<span class="sd">  Examples</span>
<span class="sd">  ----------</span>

<span class="sd">  # TVB default data</span>

<span class="sd">  # Plot one column of the region-based tract lengths</span>
<span class="sd">  # connectivity matrix. The corresponding region is</span>
<span class="sd">  # right auditory cortex (&#39;rA1&#39;)</span>

<span class="sd">  ctx = cortex.Cortex.from_file(source_file = ctx_file,</span>
<span class="sd">                                region_mapping_file =rm_file)</span>
<span class="sd">  vtx,tri,rm = ctx.vertices,ctx.triangles,ctx.region_mapping</span>
<span class="sd">  conn = connectivity.Connectivity.from_file(conn_file); conn.configure()</span>
<span class="sd">  isrh_reg = conn.is_right_hemisphere(range(conn.number_of_regions))</span>
<span class="sd">  isrh_vtx = np.array([isrh_reg[r] for r in rm])</span>
<span class="sd">  dat = conn.tract_lengths[:,5]</span>

<span class="sd">  plot_surface_mpl_mv(vtx=vtx,tri=tri,rm=rm,data=dat,</span>
<span class="sd">                      hemi=isrh_vtx,title=u&#39;rA1 \ntract length&#39;)</span>

<span class="sd">  plot_surface_mpl_mv(vtx=vtx,tri=tri,rm=rm,data=dat,</span>
<span class="sd">                    hemi=isrh_vtx,title=u&#39;rA1 \ntract length&#39;,</span>
<span class="sd">                    shade_kwargs = {&#39;shading&#39;: &#39;gouraud&#39;,</span>
<span class="sd">                                    &#39;cmap&#39;: &#39;rainbow&#39;})</span>


<span class="sd">  &quot;&quot;&quot;</span>



  <span class="k">if</span> <span class="n">vtx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                    <span class="c1"># Option 1</span>
    <span class="n">tri_hemi</span> <span class="o">=</span> <span class="n">hemi</span><span class="p">[</span><span class="n">tri</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">tri_lh</span><span class="p">,</span><span class="n">tri_rh</span> <span class="o">=</span> <span class="n">tri</span><span class="p">[</span><span class="n">tri_hemi</span><span class="o">==</span><span class="mi">0</span><span class="p">],</span><span class="n">tri</span><span class="p">[</span><span class="n">tri_hemi</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
  <span class="k">elif</span> <span class="n">vtx_lh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                               <span class="c1"># Option 2</span>
    <span class="n">vtx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">vtx_lh</span><span class="p">,</span><span class="n">vtx_rh</span><span class="p">])</span>
    <span class="n">tri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">tri_lh</span><span class="p">,</span><span class="n">tri_rh</span><span class="o">+</span><span class="n">tri_lh</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

  <span class="k">if</span> <span class="n">data_lh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                <span class="c1"># Option 2</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">data_lh</span><span class="p">,</span><span class="n">data_rh</span><span class="p">])</span>

  <span class="k">if</span> <span class="n">rm_lh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                  <span class="c1"># Option 2</span>
    <span class="n">rm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">rm_lh</span><span class="p">,</span><span class="n">rm_rh</span> <span class="o">+</span> <span class="n">rm_lh</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>



  <span class="c1"># 2. Now do the plots for each view</span>

  <span class="c1"># (Note: for the single hemispheres we only need lh/rh arrays for the</span>
  <span class="c1">#  faces (tri); the full vertices, region mapping, and data arrays</span>
  <span class="c1">#  can be given as arguments, they just won&#39;t be shown if they aren&#39;t</span>
  <span class="c1">#  connected by the faces in tri )</span>
  <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
  <span class="c1"># LH lateral</span>
  <span class="n">plot_surface_mpl</span><span class="p">(</span><span class="n">vtx</span><span class="p">,</span><span class="n">tri_lh</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span><span class="n">rm</span><span class="o">=</span><span class="n">rm</span><span class="p">,</span><span class="n">view</span><span class="o">=</span><span class="s1">&#39;lh_lat&#39;</span><span class="p">,</span>
                   <span class="n">ax</span><span class="o">=</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

  <span class="c1"># LH medial</span>
  <span class="n">plot_surface_mpl</span><span class="p">(</span><span class="n">vtx</span><span class="p">,</span><span class="n">tri_lh</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span><span class="n">rm</span><span class="o">=</span><span class="n">rm</span><span class="p">,</span><span class="n">view</span><span class="o">=</span><span class="s1">&#39;lh_med&#39;</span><span class="p">,</span>
                   <span class="n">ax</span><span class="o">=</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

  <span class="c1"># RH lateral</span>
  <span class="n">plot_surface_mpl</span><span class="p">(</span><span class="n">vtx</span><span class="p">,</span><span class="n">tri_rh</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span><span class="n">rm</span><span class="o">=</span><span class="n">rm</span><span class="p">,</span><span class="n">view</span><span class="o">=</span><span class="s1">&#39;rh_lat&#39;</span><span class="p">,</span>
                   <span class="n">ax</span><span class="o">=</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

  <span class="c1"># RH medial</span>
  <span class="n">plot_surface_mpl</span><span class="p">(</span><span class="n">vtx</span><span class="p">,</span><span class="n">tri_rh</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span><span class="n">rm</span><span class="o">=</span><span class="n">rm</span><span class="p">,</span><span class="n">view</span><span class="o">=</span><span class="s1">&#39;rh_med&#39;</span><span class="p">,</span>
                   <span class="n">ax</span><span class="o">=</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

  <span class="c1"># Both superior</span>
  <span class="n">im</span> <span class="o">=</span><span class="n">plot_surface_mpl</span><span class="p">(</span><span class="n">vtx</span><span class="p">,</span><span class="n">tri</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span><span class="n">rm</span><span class="o">=</span><span class="n">rm</span><span class="p">,</span><span class="n">view</span><span class="o">=</span><span class="s1">&#39;superior&#39;</span><span class="p">,</span>
                   <span class="n">ax</span><span class="o">=</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

  <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">.8</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                      <span class="n">top</span><span class="o">=</span><span class="mf">.8</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="c1">#@title function for plot brain in one picture</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lh_annot</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">freesurfer</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_annot</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">rh_annot</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">freesurfer</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_annot</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="n">files</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">rh_annot_nl</span> <span class="o">=</span> <span class="n">rh_annot</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rh_annot</span><span class="p">)</span>
<span class="n">rh_annot_nl</span><span class="p">[</span><span class="n">rh_annot_nl</span> <span class="o">==</span> <span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">reg_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">lh_annot</span><span class="p">,</span> <span class="n">rh_annot_nl</span><span class="p">])</span>
<span class="n">hemi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">reg_map</span><span class="p">)</span>

<span class="n">hemi</span><span class="p">[:</span><span class="n">reg_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">lhp_vtx_new</span><span class="p">,</span><span class="n">lhp_tri_new</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">freesurfer</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="s1">&#39;/rh+lh.pial&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we are ready to plot the activity on the surface. As default it is set to 180, which corresponds to 80ms after the stimulation (considering the first 100ms/100time points are baseline)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tp</span> <span class="o">=</span> <span class="mi">180</span>

<span class="n">data_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">P_test</span><span class="p">[:,</span><span class="n">tp</span><span class="p">])</span>
<span class="n">data2plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="mi">0</span><span class="o">*</span><span class="n">data_pos</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">)),</span><span class="n">data_pos</span><span class="p">])[</span><span class="n">reg_map</span><span class="p">]</span>

<span class="n">kws</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;edgecolors&#39;</span><span class="p">:</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;cmap&#39;</span><span class="p">:</span>  <span class="s1">&#39;RdBu_r&#39;</span><span class="p">,</span> <span class="c1">#$ &#39;Reds_r&#39;, #RdBu_r&#39;, # jet&#39;,</span>
       <span class="s1">&#39;vmax&#39;</span><span class="p">:</span>  <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">P_test</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span>
       <span class="s1">&#39;vmin&#39;</span><span class="p">:</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">P_test</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">),</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">}</span>


<span class="n">plot_surface_mpl_mv</span><span class="p">(</span><span class="n">vtx</span><span class="o">=</span><span class="n">lhp_vtx_new</span><span class="p">,</span> <span class="n">tri</span><span class="o">=</span><span class="n">lhp_tri_new</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data2plot</span><span class="p">,</span> <span class="n">reorient</span><span class="o">=</span><span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="n">hemi</span><span class="o">=</span><span class="n">hemi</span><span class="p">,</span> <span class="n">rm</span><span class="o">=</span><span class="n">reg_map</span><span class="p">,</span> <span class="n">shade_kwargs</span><span class="o">=</span><span class="n">kws</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;activity at &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">epoched</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="n">tp</span><span class="o">+</span><span class="mi">200</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;ms&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5cdcf194f21cd0feaacd2a7dfae0481c00e175e6e113382f27c98a7f2b59cf05.png" src="../_images/5cdcf194f21cd0feaacd2a7dfae0481c00e175e6e113382f27c98a7f2b59cf05.png" />
</div>
</div>
<p>By running the following cell, we will generate a visualization in the form of a movie that showcases the activity of the system over time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="c1"># Specify the path of the .gif file</span>
<span class="n">gif_path</span> <span class="o">=</span> <span class="s1">&#39;intact_source_brain_activity.gif&#39;</span>

<span class="c1"># Display the .gif file</span>
<span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">gif_path</span><span class="p">))</span>

<span class="c1">#@title #plot movie</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Output hidden; open in https://colab.research.google.com to view.
</pre></div>
</div>
</div>
</div>
<p>So far the simulation has been run using an intact structural connectome. Now we are going to apply some lesion to the structural connectome 😈😛✂️ to investigate if it would affect the propagation pattern induced by the external pertubation.</p>
<p>We have developed an interactive window for exploration. It provides four adjustable parameters to analyze the effects:</p>
<ul class="simple">
<li><p>`threshold’: This parameter represents the percentage of connections to be preserved. For instance, a value of 90 indicates that 10% of the connections will be damaged.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">when_damage</span></code>: This parameter specifies the time in milliseconds (ms) after the stimulation when the damage is applied. For example, a value of 20 means that the damage will occur 20 ms after the stimulation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">direction</span></code>: This parameter determines which connections will be damaged. The options are ‘both’, ‘forward’, and ‘backward’.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">type_of_damage</span></code>: This parameter defines the type of damage to be applied. The options are ‘target attack’ or ‘random attack’. ‘Target attack’ refers to removing the node’s most relevant connection for stimulus propagation, while ‘random attack’ involves randomly selecting the node’s connections to damage.</p></li>
</ul>
<p>Please takes some time to explore how all this possible combination will affect the propagation pattern</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;/content/Data/EEG_stim/&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">myround</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">base</span> <span class="o">*</span> <span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">base</span><span class="p">)</span>


<span class="n">node_size</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">step_size</span> <span class="o">=</span> <span class="mf">0.0001</span>
<span class="n">tr</span> <span class="o">=</span> <span class="mf">0.001</span>
<span class="n">time_dim</span> <span class="o">=</span> <span class="mi">400</span>
<span class="n">hidden_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tr</span><span class="o">/</span><span class="n">step_size</span><span class="p">)</span>
<span class="n">base_batch_num</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">node_size</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">state_size</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">state_lb</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
<span class="n">state_ub</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">delays_max</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">transient_num</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">final_ouput</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">final_ouput_eeg</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;sub-02_run-01_fittingresults_stim_exp.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">threshold</span> <span class="o">=</span> <span class="s2">&quot;95&quot;</span> <span class="c1"># @param [80, 85, 90, 95, 99]</span>
<span class="n">threshold</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>
<span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span><span class="o">/</span><span class="mi">100</span>


<span class="n">when_damage</span> <span class="o">=</span> <span class="s2">&quot;40&quot;</span> <span class="c1"># @param [20, 40, 60, 100]</span>
<span class="n">when_damage</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">when_damage</span><span class="p">)</span>
<span class="n">when_damage</span> <span class="o">=</span> <span class="n">when_damage</span> <span class="o">+</span> <span class="mi">100</span>


<span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;both&#39;</span> <span class="c1"># @param [&#39;both&#39;, &#39;forward&#39;, &#39;feedback&#39;]</span>
<span class="n">type_of_damage</span> <span class="o">=</span> <span class="s1">&#39;random attack&#39;</span> <span class="c1"># @param [&#39;target attack&#39;, &#39;random attack&#39;]</span>

<span class="n">damage_strength</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
<span class="n">source_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">P_test</span>
<span class="n">degree</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">source_data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ref_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">degree</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">degree</span><span class="p">)))</span> <span class="o">*</span> <span class="n">threshold</span>
<span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">degree</span><span class="o">&gt;=</span><span class="n">ref_value</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>


<span class="n">x0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">state_lb</span><span class="p">,</span> <span class="n">state_ub</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_size</span><span class="p">)),</span>
                         <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">he0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">state_lb</span><span class="p">,</span> <span class="n">state_ub</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_size</span><span class="p">,</span> <span class="n">delays_max</span><span class="p">)),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">empirical_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">evoked</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">evoked</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">empirical_ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">data</span>


<span class="c1">#0-150ms</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">200</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">when_damage</span><span class="p">))</span>

<span class="n">u</span><span class="p">[:,:,</span><span class="mi">90</span><span class="p">:</span><span class="mi">120</span><span class="p">]</span><span class="o">=</span> <span class="mi">1000</span>
<span class="n">data</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ts</span><span class="p">[:,:(</span><span class="nb">int</span><span class="p">(</span><span class="n">when_damage</span> <span class="o">*</span> <span class="mi">20</span><span class="o">/</span> <span class="mi">400</span><span class="p">)),:,:]</span>
<span class="n">data</span><span class="o">.</span><span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">empirical_ts</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">200</span><span class="p">:</span><span class="mi">200</span><span class="o">+</span><span class="n">when_damage</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">when_damage</span> <span class="o">*</span> <span class="mi">20</span><span class="o">/</span> <span class="mi">400</span><span class="p">),</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="n">data</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">he0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">)</span>
<span class="n">final_ouput</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">P_test</span><span class="p">)</span>
<span class="n">final_ouput_eeg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">eeg_test</span><span class="p">)</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">P_test</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">E_test</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">I_test</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">Pv_test</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">Ev_test</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">Iv_test</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

<span class="n">he0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">P_test</span><span class="p">[:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                      <span class="n">he0</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[:,:</span><span class="mi">500</span><span class="o">-</span><span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">E_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>


<span class="c1">#100-400ms</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;sub-02_run-01_fittingresults_stim_exp.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">empirical_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">evoked</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">evoked</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">empirical_ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">data</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">200</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">400</span><span class="o">-</span><span class="n">when_damage</span><span class="p">)))</span>
<span class="n">data</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ts</span><span class="p">[:,:(</span><span class="nb">int</span><span class="p">((</span><span class="mi">400</span><span class="o">-</span><span class="n">when_damage</span><span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="o">/</span> <span class="mi">400</span><span class="p">)),:,:]</span>
<span class="n">data</span><span class="o">.</span><span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">empirical_ts</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">200</span><span class="o">+</span><span class="n">when_damage</span><span class="p">:</span><span class="mi">600</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="mi">400</span><span class="o">-</span><span class="n">when_damage</span><span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="o">/</span> <span class="mi">400</span><span class="p">),</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="n">original</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">w_ll</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">wll</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">w_ll</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


<span class="k">if</span> <span class="n">type_of_damage</span> <span class="o">==</span> <span class="s1">&#39;random attack&#39;</span><span class="p">:</span>
  <span class="n">random_values</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
      <span class="n">random_value</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">199</span><span class="p">)</span>
      <span class="n">random_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">random_value</span><span class="p">)</span>
  <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">random_value</span><span class="p">)</span>

<span class="k">if</span> <span class="n">direction</span><span class="o">==</span><span class="s1">&#39;forward&#39;</span><span class="p">:</span>
    <span class="n">wll</span><span class="p">[:,</span> <span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">damage_strength</span>
<span class="k">elif</span> <span class="n">direction</span><span class="o">==</span><span class="s1">&#39;feedback&#39;</span><span class="p">:</span>
    <span class="n">wll</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">damage_strength</span>
<span class="k">elif</span> <span class="n">direction</span><span class="o">==</span><span class="s1">&#39;both&#39;</span><span class="p">:</span>
    <span class="n">wll</span><span class="p">[:,</span> <span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">damage_strength</span>
    <span class="n">wll</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">damage_strength</span>


<span class="n">data</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">w_ll</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">wll</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

<span class="n">data</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">he0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">)</span>
<span class="n">final_ouput</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">P_test</span><span class="p">)</span>
<span class="n">final_ouput_eeg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">eeg_test</span><span class="p">)</span>
<span class="n">new_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">final_ouput</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">final_ouput</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">new_eeg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">final_ouput_eeg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">final_ouput_eeg</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="n">epoched</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">read_epochs</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">evoked</span> <span class="o">=</span> <span class="n">epoched</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>



<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;sub-02_run-01_fittingresults_stim_exp.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">simulated_EEG_st</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">simulated_EEG_st</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">200</span><span class="p">:</span><span class="mi">600</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">eeg_test</span>


<span class="n">ts_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.3</span><span class="p">])</span>

<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs1</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=-</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.03</span><span class="p">)</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs2</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs3</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.12</span><span class="p">)</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs4</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs5</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.20</span><span class="p">)</span>

<span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">peak_locs1</span><span class="p">,</span> <span class="n">peak_locs2</span><span class="p">,</span> <span class="n">peak_locs3</span><span class="p">,</span> <span class="n">peak_locs4</span><span class="p">,</span> <span class="n">peak_locs5</span><span class="p">]</span>


<span class="n">plot</span> <span class="o">=</span> <span class="n">simulated_EEG_st</span><span class="o">.</span><span class="n">plot_joint</span><span class="p">(</span><span class="n">ts_args</span><span class="o">=</span><span class="n">ts_args</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">);</span>



<span class="n">simulated_EEG_st_lesion</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">simulated_EEG_st_lesion</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">200</span><span class="p">:</span><span class="mi">600</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_eeg</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs1</span> <span class="o">=</span> <span class="n">simulated_EEG_st_lesion</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=-</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs2</span> <span class="o">=</span> <span class="n">simulated_EEG_st_lesion</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs3</span> <span class="o">=</span> <span class="n">simulated_EEG_st_lesion</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.12</span><span class="p">)</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs4</span> <span class="o">=</span> <span class="n">simulated_EEG_st_lesion</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs5</span> <span class="o">=</span> <span class="n">simulated_EEG_st_lesion</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.20</span><span class="p">)</span>


<span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">peak_locs1</span><span class="p">,</span> <span class="n">peak_locs2</span><span class="p">,</span> <span class="n">peak_locs3</span><span class="p">,</span> <span class="n">peak_locs4</span><span class="p">,</span> <span class="n">peak_locs5</span><span class="p">]</span>

<span class="n">simulated_joint_st</span> <span class="o">=</span> <span class="n">simulated_EEG_st_lesion</span><span class="o">.</span><span class="n">plot_joint</span><span class="p">(</span><span class="n">ts_args</span><span class="o">=</span><span class="n">ts_args</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.7650800313916309 cos_sim:  0.5978724262237854
0.8514699526110175 cos_sim:  0.21625480090820665
NOTE: pick_channels() is a legacy function. New code should use inst.pick(...).
No projector specified for this dataset. Please consider the method self.add_proj.
NOTE: pick_channels() is a legacy function. New code should use inst.pick(...).
</pre></div>
</div>
<img alt="../_images/fb6f18d14d5b9accf9920eea711d05692f9b1f64643ac4c65ce015e06c0f864a.png" src="../_images/fb6f18d14d5b9accf9920eea711d05692f9b1f64643ac4c65ce015e06c0f864a.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>No projector specified for this dataset. Please consider the method self.add_proj.
NOTE: pick_channels() is a legacy function. New code should use inst.pick(...).
</pre></div>
</div>
<img alt="../_images/8396d157ff55f73908405ccb8d2f0b9742a2ef5869c0c8ca3c072ad04caeb10c.png" src="../_images/8396d157ff55f73908405ccb8d2f0b9742a2ef5869c0c8ca3c072ad04caeb10c.png" />
</div>
</div>
<p>Now let’s make the same plot than before (at the same time point) for the new simulation and explore how the lesion that we applied affects the propagation of the signal</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tp</span> <span class="o">=</span> <span class="mi">180</span>

<span class="n">data_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">new_ts</span><span class="p">[:,</span><span class="n">tp</span><span class="p">])</span>
<span class="n">data2plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="mi">0</span><span class="o">*</span><span class="n">data_pos</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">)),</span><span class="n">data_pos</span><span class="p">])[</span><span class="n">reg_map</span><span class="p">]</span>

<span class="n">kws</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;edgecolors&#39;</span><span class="p">:</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;cmap&#39;</span><span class="p">:</span>  <span class="s1">&#39;RdBu_r&#39;</span><span class="p">,</span> <span class="c1">#$ &#39;Reds_r&#39;, #RdBu_r&#39;, # jet&#39;,</span>
       <span class="s1">&#39;vmax&#39;</span><span class="p">:</span>  <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">P_test</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span>
       <span class="s1">&#39;vmin&#39;</span><span class="p">:</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">P_test</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">),</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">}</span>


<span class="n">plot_surface_mpl_mv</span><span class="p">(</span><span class="n">vtx</span><span class="o">=</span><span class="n">lhp_vtx_new</span><span class="p">,</span> <span class="n">tri</span><span class="o">=</span><span class="n">lhp_tri_new</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data2plot</span><span class="p">,</span> <span class="n">reorient</span><span class="o">=</span><span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="n">hemi</span><span class="o">=</span><span class="n">hemi</span><span class="p">,</span> <span class="n">rm</span><span class="o">=</span><span class="n">reg_map</span><span class="p">,</span> <span class="n">shade_kwargs</span><span class="o">=</span><span class="n">kws</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;activity at &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">epoched</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="n">tp</span><span class="o">+</span><span class="mi">200</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;ms&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/749df7c2124579f6e9bcd236ef5efbf5e26c14a6db130863702b737910443950.png" src="../_images/749df7c2124579f6e9bcd236ef5efbf5e26c14a6db130863702b737910443950.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="c1"># Specify the path of the .gif file</span>
<span class="n">gif_path</span> <span class="o">=</span> <span class="s1">&#39;lesioned_source_brain_activity.gif&#39;</span>

<span class="c1"># Display the .gif file</span>
<span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">gif_path</span><span class="p">))</span>

<span class="c1">#@title #plot movie</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Output hidden; open in https://colab.research.google.com to view.
</pre></div>
</div>
</div>
</div>
<p>Take a moment to compare this lesioned activity with the previous one 👀👀</p>
<div class="section" id="propagation-spreading-of-simulated-stimulated-evoked-activity">
<h2><strong>Propagation spreading of simulated stimulated-evoked activity</strong><a class="headerlink" href="#propagation-spreading-of-simulated-stimulated-evoked-activity" title="Permalink to this heading">#</a></h2>
<p>In this section we are going to track the propagation spreading for the timeseries we have simulated.</p>
<p><strong>OUR GOAL</strong>: WE want to track in which region the stimulus is propagating and the direction of that propation.</p>
<p>order to do that we are going to loop over the roi of the parcellations and we are going to collect the distance between two different time windows:</p>
<ul class="simple">
<li><p>source = [95:150]</p></li>
<li><p>target = [125:180]</p></li>
</ul>
<p>Remember stimulation was injected at 100</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;sub-02_run-01_fittingresults_stim_exp.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">directional_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">200</span><span class="p">,</span><span class="mi">200</span><span class="p">))</span>


<span class="n">direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">200</span><span class="p">))</span>

<span class="k">for</span> <span class="n">roi_x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
  <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">200</span><span class="p">))</span>
  <span class="k">for</span> <span class="n">roi_y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
    <span class="n">corr</span><span class="p">[</span><span class="n">roi_y</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">P_test</span><span class="p">[</span><span class="n">roi_x</span><span class="p">,</span><span class="mi">95</span><span class="p">:</span><span class="mi">150</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">P_test</span><span class="p">[</span><span class="n">roi_y</span><span class="p">,</span><span class="mi">125</span><span class="p">:</span><span class="mi">180</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

  <span class="n">direction</span><span class="p">[</span><span class="n">roi_x</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">corr</span> <span class="o">==</span><span class="n">corr</span><span class="o">.</span><span class="n">min</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">directional_matrix</span><span class="p">[</span><span class="n">roi_x</span><span class="p">,</span><span class="n">direction</span><span class="p">[</span><span class="n">roi_x</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">corr</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

<span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
<span class="n">directional_matrix</span> <span class="o">=</span> <span class="n">directional_matrix</span> <span class="o">/</span> <span class="n">directional_matrix</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="n">thr</span> <span class="o">=</span> <span class="mf">0.70</span>
<span class="n">directional_matrix</span><span class="p">[</span><span class="n">directional_matrix</span><span class="o">&lt;</span><span class="n">thr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">net_colours</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s1">&#39;https://github.com/Davi1990/DissNet/raw/10755322a87e8ce8d22f0641651334f86088fc6d/examples/new_atlas_coords.xlsx&#39;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">RGB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(([</span><span class="n">net_colours</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mf">255.0</span><span class="p">,</span> <span class="n">net_colours</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mf">255.0</span><span class="p">,</span> <span class="n">net_colours</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">/</span><span class="mf">255.0</span><span class="p">]))</span>
<span class="n">RGB</span> <span class="o">=</span> <span class="n">RGB</span><span class="p">[:,:</span><span class="mi">200</span><span class="p">]</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
<span class="n">display</span> <span class="o">=</span> <span class="n">plotting</span><span class="o">.</span><span class="n">plot_connectome</span><span class="p">(</span><span class="n">directional_matrix</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span>
                                   <span class="n">node_color</span><span class="o">=</span><span class="n">RGB</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                   <span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/593103ab203e9d4efd690014c191903435e0575ceaa9554584004b78d65ca565.png" src="../_images/593103ab203e9d4efd690014c191903435e0575ceaa9554584004b78d65ca565.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plotting</span><span class="o">.</span><span class="n">view_connectome</span><span class="p">(</span><span class="n">directional_matrix</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span>
                                   <span class="n">node_color</span><span class="o">=</span><span class="n">RGB</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">edge_threshold</span><span class="o">=</span><span class="s2">&quot;97%&quot;</span><span class="p">,</span>
                                   <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Output hidden; open in https://colab.research.google.com to view.
</pre></div>
</div>
</div>
</div>
<p>Next we are going to use the equation from:</p>
<blockquote>
<div><p>Pang JC., Aquino KM, Oldehinkel M., Robinson PA., Fulcher BD., Breakspear M., Fornito A. (2023) <strong>Geometric constraints on human brain function.</strong> <em>Nature</em>, 618(7965):566-574. doi: 10.1038/s41586-023-06098-1.</p>
</div></blockquote>
<br/>
\begin{equation}
\left[\frac{1}{{\gamma_s}^2} \frac{{\partial^2 \phi}}{{\partial t^2}} + \frac{2}{\gamma_s} \frac{{\partial^2 \phi}}{{\partial t \partial s}} + 1 - {r_s}^2 {\nabla}^2 \phi\right] \phi(\mathbf{r}, t) = Q(\mathbf{r}, t)
\end{equation}
<br/>
<p>Specifically we are going to estimate the <span class="math notranslate nohighlight">\(\phi(\mathbf{r}, t)\)</span> for the timeseries we just modelled and see how the stimulus evkoed is travelling to the brain.
First we are going to import the atlas and compute the distance matrix which we will need to estimate <span class="math notranslate nohighlight">\({\gamma_s}\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://raw.githubusercontent.com/ThomasYeoLab/CBIG/master/stable_projects/brain_parcellation/Schaefer2018_LocalGlobal/Parcellations/MNI/Centroid_coordinates/Schaefer2018_200Parcels_7Networks_order_FSLMNI152_2mm.Centroid_RAS.csv&#39;</span>
<span class="n">atlas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">label</span> <span class="o">=</span> <span class="n">atlas</span><span class="p">[</span><span class="s1">&#39;ROI Name&#39;</span><span class="p">]</span>

<span class="n">label_stripped</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">label</span><span class="p">)):</span>
    <span class="n">label_stripped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="n">xx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;7Networks_&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>


<span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">atlas</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">],</span> <span class="n">atlas</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">],</span> <span class="n">atlas</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
<span class="n">conduction_velocity</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1">#in ms</span>

<span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<span class="k">for</span> <span class="n">roi1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
  <span class="k">for</span> <span class="n">roi2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">distance</span><span class="p">[</span><span class="n">roi1</span><span class="p">,</span> <span class="n">roi2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">coords</span><span class="p">[</span><span class="n">roi1</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="n">roi2</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">distance</span><span class="p">[</span><span class="n">roi1</span><span class="p">,</span> <span class="n">roi2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">coords</span><span class="p">[</span><span class="n">roi1</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="n">roi2</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Next we are going to use the function <code class="docutils literal notranslate"><span class="pre">model_neural_waves_python()</span></code>. In our case:</p>
<ul class="simple">
<li><p>the <span class="math notranslate nohighlight">\(Q(\mathbf{r}, t)\)</span> is going to be the output of the model <code class="docutils literal notranslate"><span class="pre">data.output_sim.P_test</span></code></p></li>
<li><p>the eigenvalues and eigenvectors are going to be the ouput of the structural connectivity matrix <code class="docutils literal notranslate"><span class="pre">np.linalg.svd(data.model.sc_fitted.detach().numpy())</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sim_eigenvectors</span><span class="p">,</span> <span class="n">sim_eigenvalues</span><span class="p">,</span> <span class="n">sim_eigenvectors_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sc_fitted</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

<span class="n">n_mode</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;ODE&#39;</span>
<span class="n">sim_eigenvectors</span><span class="p">[:,:</span><span class="n">n_mode</span><span class="p">]</span>
<span class="c1"># Simulate resting-state activity using Gaussian white noise</span>
<span class="n">param</span> <span class="o">=</span> <span class="n">loadParameters_wave_func</span><span class="p">()</span>
<span class="n">param</span><span class="p">[</span><span class="s1">&#39;tstep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># in ms</span>
<span class="n">param</span><span class="p">[</span><span class="s1">&#39;tmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">400</span>  <span class="c1"># in ms</span>
<span class="n">param</span><span class="p">[</span><span class="s1">&#39;tspan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;tmax&#39;</span><span class="p">]]</span>
<span class="n">param</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;tmax&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;tstep&#39;</span><span class="p">],</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;tstep&#39;</span><span class="p">])[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<span class="c1"># Change value of param.is_time_ms to 1 because the time defined above is</span>
<span class="c1"># in ms. This is necessary as param.gamma_s needs to match the scale.</span>
<span class="n">param</span><span class="p">[</span><span class="s1">&#39;is_time_ms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.4</span>
<span class="n">param</span><span class="p">[</span><span class="s1">&#39;r_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span> <span class="c1"># (default) in mm</span>
<span class="n">param</span><span class="p">[</span><span class="s1">&#39;gamma_s&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">distance</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">data</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="c1"># (default) in s^-1</span>
<span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;is_time_ms&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.4</span><span class="p">:</span>
    <span class="n">param</span><span class="p">[</span><span class="s1">&#39;gamma_s&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">distance</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">data</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e-3</span>

<span class="n">sim_mode_activity_rest</span><span class="p">,</span> <span class="n">sim_simulated_activity_rest</span> <span class="o">=</span> <span class="n">model_neural_waves_python</span><span class="p">(</span><span class="n">sim_eigenvectors</span><span class="p">[:,:</span><span class="n">n_mode</span><span class="p">],</span>
                                                                              <span class="n">sim_eigenvalues</span><span class="p">[:</span><span class="n">n_mode</span><span class="p">],</span>
                                                                              <span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">P_test</span><span class="p">,</span>
                                                                              <span class="n">param</span><span class="p">,</span>
                                                                              <span class="n">method</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sim_simulated_activity_rest</span><span class="p">[:,</span><span class="mi">50</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/01894e58af9704421e90066a7ef9de0f1020b012039431fef99f33e3c89078c3.png" src="../_images/01894e58af9704421e90066a7ef9de0f1020b012039431fef99f33e3c89078c3.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hemisphere</span> <span class="o">=</span> <span class="s1">&#39;rh&#39;</span>

<span class="n">roi_corr</span> <span class="o">=</span> <span class="n">sim_simulated_activity_rest</span><span class="p">[:,</span><span class="mi">120</span><span class="p">]</span>

<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;../travelling_brain_waves/fsLR_32k_Schaefer200-rh.txt&#39;</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">contents</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">numbers</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">contents</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">num</span><span class="p">])</span>


<span class="n">roi_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">lh_simulated_activity_rest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
  <span class="n">idx2use</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">numbers</span><span class="o">==</span><span class="n">roi</span><span class="o">+</span><span class="mi">100</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">roi_map</span><span class="p">[</span><span class="n">idx2use</span><span class="p">]</span> <span class="o">=</span> <span class="n">roi_corr</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="s1">&#39;3d&#39;</span><span class="p">},</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">view</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;lateral&#39;</span><span class="p">,</span> <span class="s1">&#39;medial&#39;</span><span class="p">]):</span>
    <span class="c1">#for n, (col, hemi) in enumerate(zip(row, [&#39;infl_left&#39;, &#39;infl_left&#39;])):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;../travelling_brain_waves/fsLR_32kmidthickness-&#39;</span> <span class="o">+</span> <span class="n">hemisphere</span> <span class="o">+</span> <span class="s1">&#39;.gii&#39;</span>

        <span class="k">if</span> <span class="n">hemisphere</span><span class="o">==</span><span class="s1">&#39;rh&#39;</span><span class="p">:</span>
          <span class="n">hemi</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">hemi</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span>

        <span class="n">plotting</span><span class="o">.</span><span class="n">plot_surf_stat_map</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span>
                            <span class="n">stat_map</span><span class="o">=</span><span class="n">roi_map</span><span class="p">,</span> <span class="n">hemi</span><span class="o">=</span><span class="n">hemi</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="n">view</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">row</span><span class="p">,</span>
                            <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;blue_red&#39;</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">roi_map</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>


<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/9f2c07b5657ad051df6541baeb01276c2e4bfe13559fc2ffa3a0bfc1a9dacf26.png" src="../_images/9f2c07b5657ad051df6541baeb01276c2e4bfe13559fc2ffa3a0bfc1a9dacf26.png" />
</div>
</div>
</div>
</div>
<div class="section" id="conclusions">
<h1>Conclusions<a class="headerlink" href="#conclusions" title="Permalink to this heading">#</a></h1>
<p>This collaborative notebook has provided a comprehensive exploration of:</p>
<ul class="simple">
<li><p><strong>Implementation of the Robinson-model single node in numpy:</strong>
we successfully implemented the Robinson-model single node using the numpy library. By accurately replicating the model, we established a solid foundation for further analysis and exploration of brain dynamics.</p></li>
<li><p><strong>Exploring the effects of diffusion coupling on brain dynamics:</strong>
Using the Robinson-model, we delved into the influence of diffusion coupling on brain dynamics. Through our investigations, we uncovered how specific parameters related to diffusion coupling impact the integration and segregation structures within the brain.</p></li>
<li><p><strong>Unveiling the emergence of brain functions from inner geometric structure features:</strong> Through our exploration, we discovered that brain functions emerge from the inner geometric structure features of the brain. By studying the implemented model, we gained valuable insights into how these geometric characteristics contribute to the complex dynamics observed in the brain. This knowledge advances our understanding of the fundamental principles governing brain functionality.</p></li>
<li><p><strong>Dissecting signal propagation dynamics using a brain stimulation model and virtual lesion approach:</strong>
To further investigate signal propagation dynamics, we employed a brain stimulation model and a virtual lesion approach. This allowed us to dissect the intricate mechanisms involved in the transmission of signals within the brain. By simulating various scenarios and observing the effects of virtual lesions, we gained valuable insights into the network dynamics and connectivity patterns, providing a deeper understanding of brain function.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span>

<span class="c1"># Replace the form_link with your Google Form link</span>
<span class="n">form_link</span> <span class="o">=</span> <span class="s2">&quot;https://forms.gle/1HjC5vsBKYXUDmiu6&quot;</span>

<span class="c1"># Create the hyperlink and open the form in a new tab with increased font size</span>
<span class="n">HTML</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&lt;a href=&quot;</span><span class="si">{</span><span class="n">form_link</span><span class="si">}</span><span class="s1">&quot; target=&quot;_blank&quot; style=&quot;font-size: 30px;&quot;&gt;Click here to access the survey&lt;/a&gt;&#39;</span><span class="p">)</span>


<span class="c1">#@title #Survey</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><a href="https://forms.gle/1HjC5vsBKYXUDmiu6" target="_blank" style="font-size: 30px;">Click here to access the survey</a></div></div>
</div>
<p>##References</p>
<blockquote>
<div><p>Breakspear M. (2017). <strong>Dynamic models of large-scale brain activity.</strong> <em>Nat Neurosci</em>, 15(1), 20(3):340-352. doi: 10.1038/nn.4497.</p>
</div></blockquote>
<blockquote>
<div><p>David, O. and Friston, K.J. (2003) <strong>A neural mass model for MEG/EEG: coupling and neuronal dynamics.</strong> <em>Nat Neurosci</em>, 0:340–352. doi:10.1038/nn.4497.</p>
</div></blockquote>
<blockquote>
<div><p>Jansen, B.H. and Rit, V.G. (1995) <strong>Electroencephalogram and visual evoked potential generation in a mathematical model of coupled cortical columns.</strong> <em>Biological cybernetics</em>, 73(4), pp.357-366.</p>
</div></blockquote>
<blockquote>
<div><p>Jirsa VK, Proix T, Perdikis D, Woodman MM, Wang H, Gonzalez-Martinez J, Bernard C, Bénar C, Guye M, Chauvel P, Bartolomei F. (2017) <strong>The Virtual Epileptic Patient: Individualized whole-brain models of epilepsy spread.</strong> <em>NeuroImage</em>, 145:377–388. doi:10.1016/j.neuroimage.2016.04.049.</p>
</div></blockquote>
<blockquote>
<div><p>Jirsa VK, Stacey WC, Quilichini PP, Ivanov AI, Bernard C. (2017) <strong>On the nature of seizure dynamics.</strong> <em>Brain J Neurol</em>, 137:2210–2230. doi:10.1093/brain/awu133.</p>
</div></blockquote>
<blockquote>
<div><p>Momi, D., Wang, Z., Griffiths, J.D. (2023). <strong>TMS-Evoked Responses Are Driven by Recurrent Large-Scale Network Dynamics.</strong> <em>eLife</em>, 111, pp.385-430.</p>
</div></blockquote>
<blockquote>
<div><p>Munn BR., Müller EJ., Wainstein G., Shine JM. (2021) <strong>The ascending arousal system shapes neural dynamics to mediate awareness of cognitive states</strong> <em>Nature Communications</em>, 12, 6016 doi: 10.1038/s41467-021-26268-x</p>
</div></blockquote>
<blockquote>
<div><p>Pang JC., Aquino KM, Oldehinkel M., Robinson PA., Fulcher BD., Breakspear M., Fornito A. (2023) <strong>Geometric constraints on human brain function.</strong> <em>Nature</em>, 618(7965):566-574. doi: 10.1038/s41586-023-06098-1.</p>
</div></blockquote>
<blockquote>
<div><p>Roberts JA, Gollo LL., Abeysuriya RG., Roberts G., Mitchell PG, Woolrich MW,  Breakspear B. (2019) <strong>Metastable brain waves.</strong> <em>Nat Commun</em>, 10(1):1056. doi: 10.1038/s41467-019-08999-0.</p>
</div></blockquote>
<blockquote>
<div><p>Robinson PA., Rennie CJ., Wright JJ. (1997) <strong>Propagation and stability of waves of electrical activity in the cerebral cortex.</strong> <em>Physical Review</em>, 56, 826  doi: 10.1103/PhysRevE.56.826.</p>
</div></blockquote>
<blockquote>
<div><p>Robinson PA., Rennie CJ., Rowe DL., O’Connor SC., Wright JJ., Gordon E., Whitehouse RW. (2003) <strong>Neurophysical modeling of brain dynamics.</strong> <em>Neuropsychopharmacology</em>, 1:S74-9. doi: 10.1038/sj.npp.1300143.</p>
</div></blockquote>
<blockquote>
<div><p>Suárez LE, Richards BA, Lajoie G., Misic B. (2021) <strong>Learning function from structure in neuromorphic networks.</strong> <em>Nature Machine Intelligence</em>, 3, pp.771–786.</p>
</div></blockquote>
<blockquote>
<div><p>Shine JM., Breakspear M., Bell PT., Ehgoetz Martens KA., Shine R., Koyejo O., Sporns O., Poldrack RA. (2019). <strong>Human cognition involves the dynamic integration of neural activity and neuromodulatory systems.</strong> <em>Nat Neurosci</em> 22:289–296. doi:10.1038/s41593-018-0312-0.</p>
</div></blockquote>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./materials"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="1_Background_Theory.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">1) Background / Theory</p>
      </div>
    </a>
    <a class="right-next"
       href="3_Clinical.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">3) Applications 2: Clinical</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">2) Applications 1: Systems/Cognitive <br/></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#sessions-s-speakers"><strong>Sessions’s Speakers</strong></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#contents">Contents</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#nftsim-implementation-of-corticothalamic-model">NFTsim implementation of corticothalamic model</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#energy-landscape">Energy Landscape</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#traveling-brain-waves"><strong>Traveling brain waves</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-to-resting-state-activity-simulation"><strong>Introduction to Resting-State Activity Simulation</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-eigenmodes-and-eigenvalues"><strong>Loading Eigenmodes and Eigenvalues</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simulation-parameters"><strong>Simulation Parameters</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#wave-model-solution-method"><strong>Wave Model Solution Method</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gaussian-white-noise-external-input"><strong>Gaussian White Noise External Input</strong></a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#dissect-the-signal-propagation-spreading"><strong>Dissect the signal propagation spreading</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#propagation-spreading-of-simulated-stimulated-evoked-activity"><strong>Propagation spreading of simulated stimulated-evoked activity</strong></a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions">Conclusions</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By GriffLab
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>